---
title: "Storytelling with Data: Let‚Äôs Practice, Improve this table!"
description: "Practicing to improve a cross-tab report table using Python"
author:
  - name: "Tuan Le Khac"
    url: https://lktuan.github.io/
date: 05-22-2024
categories: [Python, Visualization] # self-defined categories
image: SWD-Cover-FULL-R5-MED.png
draft: false # setting this to `true` will prevent your post from appearing on your listing page until you're ready!

format: 
  html: 
    code-fold: false
    code-summary: "Show the code"
    code-line-numbers: true
css: html/styles.scss
editor: visual
---

# 1. Motivation
L·∫•y c·∫£m h·ª©ng t·ª´ b√†i [post](https://rpubs.com/chidungkt/1139405) c·ªßa th·∫ßy Nguy·ªÖn Ch√≠ D≈©ng v·ªÅ vi·ªác gi·∫£i c√°c exercise thu·ªôc Ch∆∞∆°ng 2 cu·ªën s√°ch **Storytelling with Data: Let‚Äôs Practice** c·ªßa t√°c gi·∫£ [Cole Nussbaumer Knaflic](https://www.linkedin.com/in/colenussbaumer/) s·ª≠ d·ª•ng R, m√¨nh mu·ªën c·∫£i thi·ªán 1 b·∫£ng bi·ªÉu nh∆∞ng s·ª≠ d·ª•ng Python (trong cu·ªën s√°ch g·ªëc, c√≥ l·∫Ω t√°c gi·∫£ s·ª≠ d·ª•ng Excel).

# 2. Let's Practice
M√¨nh ƒëang h·ªçc `{ggplot2}` tr√™n R ƒë·ªÉ th·ª±c h√†nh h√¨nh ·∫£nh h√≥a d·ªØ li·ªáu, tuy nhi√™n c√≥ v·∫ª package n√†y (v√† t∆∞∆°ng ·ª©ng l√† `plotnine` tr√™n Python kh√¥ng ph√π h·ª£p cho b√°o c√°o b·∫£ng). Trong b√†i post, th·∫ßy D≈©ng c≈©ng s·ª≠ d·ª•ng m·ªôt library kh√°c l√† `kableExtra` (tham kh·∫£o [ƒë√¢y](https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html)).

Sau m·ªôt l√∫c google th√¨ c√≥ v·∫ª c√≥ m·ªôt package c·ªßa Python ph√π h·ª£p ƒë·ªÉ l√†m nhi·ªám v·ª• n√†y, ƒë√≥ l√† `great_tables` (tham kh·∫£o [ƒë√¢y](https://posit-dev.github.io/great-tables/articles/intro.html)).

## 2.1. Import the data
Okay ƒë·∫ßu ti√™n c·∫ßn import v√† l√†m s·∫°ch d·ªØ li·ªáu. B·∫£ng c√≥ s·∫µn trong file Exercise c√≥ v·∫ª d√πng ƒë·ªÉ b√°o c√°o h∆°n l√† l∆∞u tr·ªØ d·ªØ li·ªáu.
```{python}
import pandas as pd

data = pd.read_excel(
  "2.1 EXERCISE.xlsx",
  sheet_name = "EXERCISE 2.1",
  skiprows=6
)

data = data.drop('Unnamed: 0', axis=1)
data = data.rename(columns={ "Tier": "tier"
                    ,"# of Accounts": "no_of_account"
                    ,"% Accounts": "pct_of_account"
                    ,"Revenue ($M)": "revenue"
                    ,"% Revenue": "pct_of_revenue"})
```

## 2.2. Data manipulation
Yep gi·ªù ta ƒë√£ c√≥ 1 b·∫£ng data kh√° s·∫°ch, tuy nhi√™n l∆∞u √Ω l√† b·∫£ng ƒëang kh√¥ng th·ªÉ hi·ªán to√†n b·ªô d·ªØ li·ªáu (total c·ªßa `pct_of_account` ch·ªâ l√† `81.86%`). Ta c·∫ßn t√≠nh to√°n th√™m `All other` v√† `Grand Total` (l√Ω do l√† m√¨nh ch∆∞a t√¨m th·∫•y function hi·ªÉn th·ªã Grand Total v·ªõi package ƒëang s·ª≠ d·ª•ng, ngay c·∫£ trong v√≠ d·ª• [n√†y](https://posit-dev.github.io/great-tables/blog/pycon-2024-great-tables-are-possible/), GT c≈©ng s·ª≠ d·ª•ng data ƒë√£ c√≥ s·∫µn Grand Total).

```{python}
all_other_pct_of_account = 1 - data["pct_of_account"].sum()
all_other_no_of_account = round(all_other_pct_of_account / data["pct_of_account"][0] * data["no_of_account"][0],0)

all_other_pct_of_revenue = 1 - data["pct_of_revenue"].sum()
all_other_revenue = round(all_other_pct_of_revenue / data["pct_of_revenue"][0] * data["revenue"][0],3)

all_other = pd.Series({ "tier": "All other",
                        "no_of_account": all_other_no_of_account,
                        "pct_of_account": all_other_pct_of_account,
                        "revenue":all_other_revenue,
                        "pct_of_revenue": all_other_pct_of_revenue})

data = pd.concat([data, all_other.to_frame().T], ignore_index=True)

data.loc[len(data.index)] = data.sum()
data.loc[data.index[-1], 'tier'] = 'Grand Total'
```
Show the data:
```{python}
from great_tables import GT

( 
  GT(data)
  .fmt_number(columns= ["no_of_account","pct_of_account","revenue","pct_of_revenue"],decimals=2))
```
## 2.3. Visualization
ƒê∆∞·ª£c r·ªìi, gi·ªù ta c√≥ th·ªÉ d√πng `great_tables` ƒë·ªÉ ti·∫øn h√†nh visualize. V·ªÅ c∆° b·∫£n, ch·ªâ c·∫ßn kh·ªüi t·∫°o m·ªôt object `GT()` c√≥  th·ªÉ m·ªü r·ªông ƒë∆∞·ª£c, c√°c element/ho·∫∑c format ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a v·ªÅ sau.

D∆∞·ªõi ƒë√¢y ch√∫ng ta tr√¨nh b√†y m·ªôt b·∫£ng ƒë∆°n gi·∫£n v·ªõi ti√™u ƒë·ªÅ, t√™n c·ªôt, c≈©ng nh∆∞ ƒë·ªãnh d·∫°ng l·∫°i d·ªØ li·ªáu.
```{python}
(
  GT(data)
  .tab_header(title="New client tier share")
  .cols_label(
    tier = "Tier",
    no_of_account = "# of Accounts",
    pct_of_account = "% Accounts",
    revenue = "Revenue ($M)",
    pct_of_revenue = "% Revenue"
  )
  .fmt_number(columns="no_of_account",decimals=0)
  .fmt_percent(columns=["pct_of_account", "pct_of_revenue"], decimals=2)
  .fmt_currency(columns = "revenue", currency="USD", decimals=2)
  .tab_source_note(source_note="Figure 2.1b: Slightly improved table")
)
```
Tr√¥ng ·ªïn (√≠t nh·∫•t l√† tr√¨nh b√†y s·ªë li·ªáu m·ªôt c√°ch to√†n v·∫πn) so v·ªõi b·∫£n g·ªëc r·ªìi!

Ti·∫øp t·ª•c, ta d√πng
- helper `md()` ƒë·ªÉ ƒë·ªãnh d·∫°ng l·∫°i ti√™u ƒë·ªÅ;
- s·ª≠ d·ª•ng `.data_color()` ƒë·ªÉ t·∫°o heatmapping;
- s·ª≠ d·ª•ng `tab_style()` ƒë·ªÉ format d√≤ng Grand Total;
- s·ª≠ d·ª•ng `.opt_stylize()` ƒë·ªÉ theming.

```{python}
from great_tables import md, style, loc

(
  GT(data)
  .tab_header(title=md("<strong>New client tier share</strong>"))
  .opt_align_table_header(align="left")
  .cols_label(
    tier = "Tier",
    no_of_account = "# of Accounts",
    pct_of_account = "% Accounts",
    revenue = "($M) Revenue", # change the label
    pct_of_revenue = "% Revenue"
  )
  .fmt_number(columns="no_of_account",decimals=0)
  .fmt_percent(columns=["pct_of_account", "pct_of_revenue"], decimals=0) # changed decimals
  .fmt_currency(columns = "revenue", currency="USD", decimals=1)# changed decimals
  .tab_source_note(source_note="Figure 2.1c: Table with heatmapping")
  .data_color(
    columns=["pct_of_account", "pct_of_revenue"],
    palette=["#57A6A1", "#577B8D", "#344C64", "#240750"],
    domain=[0, 1],
    na_color="lightgray",
    autocolor_text = False
  )
  .tab_style(
        style=[
          style.text(style="bolder"),
          style.fill("#EEEEEE"),
          style.borders(sides=["top", "bottom"], weight='2px', color="grey")
          ],
        locations=loc.body(rows=[6])
  )
  .opt_stylize(style=5 ,color='blue')
)
```
Ti·∫øp theo, ch√∫ng ta s·∫Ω th·ª≠ d√πng `fmt_nanoplot()` ƒë·ªÉ t·∫°o m·ªôt bar plots thay cho hai c·ªôt percentage.

ƒê√¢y l√† m·ªôt t√≠nh nƒÉng trong giai ƒëo·∫°n th·ª≠ nghi·ªám n√™n m√¨nh th·∫•y ch∆∞a th·ª±c s·ª≠ ·ªïn ƒë·ªãnh v√† tu√¢n theo document m√† nh√† ph√°t tri·ªÉn ƒë·ªÅ c·∫≠p. Trong v√≠ d·ª• d∆∞·ªõi ƒë√¢y m√¨nh s·ª≠ d·ª•ng data bar, lo·∫°i b·ªè format do h√†ng cu·ªëi c√πng. Tuy nhi√™n, ƒë·ªì th·ªã v·∫´n include gi√° tr·ªã `100%` ·ªü h√†ng Grand Total ƒë·ªÉ ƒëi·ªÅu ch·ªânh bar scale.

Th√™m n·ªØa m√¨nh c·∫ßn chuy·ªÉn dataframe v·ªÅ polar dataframe, khi ƒë√≥ m·ªôt column c·ªßa dl.df l√† iterable.
```{python}
from great_tables import md, style, loc, nanoplot_options
import numpy as np
import polars as pl

data.at[6, "pct_of_account"] = np.nan
data.at[6, "pct_of_revenue"] = np.nan
# so that the data scale looks better

pl_data = pl.from_pandas(data)

(
  GT(pl_data, rowname_col="tier")
  .tab_header(title=md("<strong>New client tier share</strong>"))
  .opt_align_table_header(align="left")
  .tab_source_note(source_note="Figure 2.1d: Table with data bar")
  .cols_label(
    tier = "Tier",
    no_of_account = "# of Accounts",
    pct_of_account = "% Accounts",
    revenue = "($M) Revenue", # change the label
    pct_of_revenue = "% Revenue"
  )
  .fmt_number(columns="no_of_account",decimals=0)
  .fmt_currency(columns = "revenue", currency="USD", decimals=1)
  .fmt_percent(columns=["pct_of_account", "pct_of_revenue"], decimals=0) # changed decimals
  .cols_width(
    cases={
        "tier": "20%",
        "no_of_account": "20%",
        "pct_of_account": "20%",
        "revenue": "20%",
        "pct_of_revenue": "20%"      
    }
    )
  .fmt_nanoplot(
    columns="pct_of_account",
    rows = [0,1,2,3,4,5],
    plot_type="bar",
    plot_height = "3em",
    autoscale=True,
    options=nanoplot_options(
      data_bar_stroke_color="#577B8D",
      data_bar_stroke_width=80,
      data_bar_fill_color="#577B8D",)
    )
  .fmt_nanoplot(
    columns="pct_of_revenue",
    rows = [0,1,2,3,4,5],
    plot_type="bar",
    plot_height = "3em",
    autoscale=True,
    options=nanoplot_options(
      data_bar_stroke_color="#577B8D",
      data_bar_stroke_width=80,
      data_bar_fill_color="#577B8D",)
  )
  .tab_style(
        style=[
          style.text(style="bolder"),
          style.fill("#EEEEEE"),
          style.borders(sides=["top", "bottom"], weight='2px', color="grey")
          ],
        locations=loc.body(rows=[6])
  )
  .tab_style(
        style=[
          style.text(color="#EEEEEE", size=0.5),
          ],
        locations=loc.body(rows=[6], columns=["pct_of_account", "pct_of_revenue"])
  )
  .opt_stylize(style=3 ,color='blue')
)
```
`great_tables` v·∫´n ch∆∞a th·ª±c s·ª± render ra ƒë∆∞·ª£c b·∫£ng bi·ªÉu ƒë√∫ng nh∆∞ setting.

B√†i th·ª±c h√†nh ƒë·∫øn ƒë√¢y l√† k·∫øt th√∫c! üöÄ

# References
1. <https://www.storytellingwithdata.com/books>
2. <https://rpubs.com/chidungkt/1139405>
3. <https://posit-dev.github.io/great-tables/articles/intro.html>

