---
title: "Vá» quy Æ°á»›c Ä‘áº·t tÃªn dá»¯ liá»‡u"
description: "Danh phÃ¡p quy Æ°á»›c Ä‘á»ƒ Ä‘áº·t tÃªn cho dá»¯ liá»‡u dáº¡ng báº£ng, tÄƒng tá»‘c Ä‘á»™ hiá»ƒu biáº¿t vÃ  sá»­ dá»¥ng dá»¯ liá»‡u"
author:
  - name: "Tuan Le Khac"
    url: https://lktuan.github.io/
date: 06-05-2024
modified-date: 06-06-2024
categories: [data quality, name convention, controlled vocabulary, metadata] 
image: pepe.jpg
draft: false
format: 
  html: 
    code-fold: false
    code-summary: "Show the code"
    code-line-numbers: true
css: html/styles.scss
fig-cap-location: bottom
editor: visual
---

ÄÃ¢y lÃ  keynote tá»« article [Column Names as Contracts](https://emilyriederer.netlify.app/post/column-name-contracts/) cá»§a [Emily Riederer](https://emilyriederer.netlify.app/about).

CÃ¡c sáº£n pháº©m pháº§n má»m luÃ´n tuÃ¢n theo má»™t quy Æ°á»›c nháº¥t Ä‘á»‹nh (vá» hÃ¬nh áº£nh, kÃ½ tá»±) nháº±m Ä‘á»ƒ ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ ngay láº­p tá»©c náº¯m báº¯t Ä‘Æ°á»£c cÃ¡ch thá»©c sá»­ dá»¥ng, giao tiáº¿p vá»›i nÃ³. VÃ­ dá»¥, nÃºt Home thÆ°á»ng sáº½ Ä‘Æ°a ngÆ°á»i dÃ¹ng vá» trang chá»§ cá»§a má»™t mobile app, nÃºt "blog" trÃªn blog cá»§a tÃ´i sáº½ Ä‘Æ°a cÃ¡c báº¡n tiáº¿p cáº­n danh má»¥c bÃ i viáº¿t, etc. á» layer phÃ­a sau, cÃ¡c API Ä‘Æ°á»£c BE viáº¿t cáº§n tuÃ¢n thá»§ documented inputs & outputs, Ä‘á»ƒ cÃ¡c BE khÃ¡c hay FE cÃ³ thá»ƒ sá»­ dá»¥ng.

Tuy nhiÃªn cÃ¡c báº£ng dá»¯ liá»‡u láº¡i náº±m á»Ÿ má»™t vÃ¹ng mÃ u xÃ¡m khÃ´ng rÃµ rÃ ng. Data service (tá»« producer i.e DE -> user i.e DA, DS) Ä‘á»§ tÄ©nh Ä‘á»ƒ khÃ´ng Ä‘Æ°á»£c xem lÃ  normal service, nhÆ°ng cÅ©ng Ä‘á»§ thÃ´ Ä‘á»ƒ ngÆ°á»i ta Ã­t chÃº Ã½ Ä‘áº¿n nÃ³ vá» máº·t giao diá»‡n. DE cá»© thá»ƒ láº¥y háº¿t má»i dá»¯ liá»‡u trong há»‡ thá»‘ng, DA nhÃ¬n dá»¯ liá»‡u vÃ  ngay láº­p tá»©c giáº£ Ä‘á»‹nh Ä‘Æ°á»£c ná»™i dung cá»§a (cá»™t) dá»¯ liá»‡u Ä‘Ã³.

> Producers wonder why consumers arenâ€™t satisfied, and consumers wonder why the data is never â€œrightâ€.

CÅ©ng cÃ³ má»™t cÃ¡ch Ä‘Æ°á»£c nhiá»u tá»• chá»©c sá»­ dá»¥ng nhÆ° lÃ  Metadata managament, nhÆ°:

- Lyftâ€™s [Amundsen](https://eng.lyft.com/amundsen-lyfts-data-discovery-metadata-engine-62d27254fbb9)
- LinkedInâ€™s [DataHub](https://www.linkedin.com/blog/engineering/archive/data-hub)
- Netflixâ€™s [Metacat](https://netflixtechblog.com/building-and-scaling-data-lineage-at-netflix-to-improve-data-infrastructure-reliability-and-1a52526a7977)

Tuy nhiÃªn giáº£i phÃ¡p nÃ y lÃ  documentation oriented, producer vÃ  user Ä‘á»u pháº£i tuÃ¢n thá»§ nghiÃªm ngáº·t. NÃ³ khÃ´ng *trá»±c diá»‡n* khi DE Ä‘áº·t tÃªn cá»™t, hay DA Ä‘á»c dá»¯ liá»‡u.

Ã tÆ°á»Ÿng cá»§a Emily lÃ  chuáº©n hÃ³a cÃ¡c quy Æ°á»›c Ä‘áº·t tÃªn dá»¯ liá»‡u báº±ng [Controlled vocabulary](https://en.wikipedia.org/wiki/Controlled_vocabulary). Minh há»a báº±ng `pointblank`, `collapsibleTree`, vÃ  `dplyr`.

# Controlled Vocabulary

CV lÃ  phÆ°Æ¡ng phÃ¡p sá»­ dá»¥ng má»™t táº­p há»£p cÃ¡c tá»«, cá»¥m tá»«, tá»« viáº¿t táº¯t Ä‘á»ƒ kÃ½ hiá»‡u thÃ´ng tin. Quy Æ°á»›c nÃ y cáº§n Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a Ä‘á» phÃ¹ há»£p cho tÃ­nh cháº¥t bá»™ dá»¯ liá»‡u, vÃ  cÅ©ng Ä‘á»§ Ä‘Æ¡n giáº£n Ä‘á»ƒ ngÆ°á»i táº¡o dá»¯ liá»‡u, ngÆ°á»i sá»­ dá»¥ng dá»¯ liá»‡u sá»­ dá»¥ng.

VÃ­ dá»¥, 1 á»©ng dá»¥ng booking.

## Level 1: Kiá»ƒu dá»¯ liá»‡u, kiá»ƒu Ä‘o lÆ°á»ng
- `ID`: chá»‰ Ä‘á»‘i tÆ°á»£ng, dáº¡ng numberic, tá»‘i Æ°u cho viá»‡c lÆ°u trá»¯ vÃ  thÆ°á»ng lÃ m khÃ³a chÃ­nh cÃ¡c báº£ng'
- `IND`: giÃ¡ trá»‹ boolean 0/1, tÃ´i thÃ¬ thÆ°á»ng sá»­ dá»¥ng cÃ¡c tá»« nhÆ° `IS`, `FLAG`;
- `N`: chá»‰ cÃ¡c dáº¡ng thÃ´ng tin *cÃ³ thá»ƒ Ä‘áº¿m (count)* Ä‘Æ°á»£c;
- `AMT`: chá»‰ cÃ¡c dáº¡ng thÃ´ng tin cÃ³ thá»ƒ tá»•ng, thÆ°á»ng Ä‘á» cáº­p Ä‘áº¿n *currency*;
- `VAL`: cÅ©ng lÃ  sá»‘ nhÆ°ng khÃ´ng thá»ƒ tá»•ng Ä‘Æ°á»£c (khÃ´ng cÃ³ Ã½ nghÄ©a), vÃ­ dá»¥ nhÆ° *kinh Ä‘á»™*, *vÄ© Ä‘á»™*;
- `DT`: ngÃ y;
- `TM`: giá» hoáº·c ngÃ y giá»;
- `CAT`: category

CÅ©ng tÃ¹y vÃ o dá»¯ liá»‡u, cÃ³ thá»ƒ thÃªm cÃ¡c cá»¥m tá»« nháº¥t Ä‘á»‹nh Ä‘á» Ä‘á» cáº­p Ä‘áº¿n thÃ´ng tin dá»¯ liá»‡u Ä‘Ã³ mang láº¡i, vÃ­ dá»¥ `ADD` cho address.

## Level 2: Äá»‘i tÆ°á»£ng, chá»§ Ä‘á»

Má»‘i quan tÃ¢m cá»§a ngÆ°á»i dÃ¹ng dá»¯ liá»‡u cÅ©ng giá»‘ng nhÆ° nhÃ  quáº£n trá»‹, xung quanh cÃ¡c Ä‘á»‘i tÆ°á»£ng cá»§a business: `USER`, `TRANSACTION`, etc. 

Äá»‘i vá»›i á»©ng dá»¥ng Ä‘áº·t xe, cÃ¡c chá»§ thá»ƒ cÃ³ thá»ƒ cáº§n quan tÃ¢m lÃ  `TRIP`, `TRAVELER`, `ACCOMODATION`, `TRANSPORTATION`, etc.

## Level 3-n: Chi tiáº¿t

Hai táº§ng trÃªn vá» cÆ¡ báº£n Ä‘Ã£ cho phÃ©p chÃºng ta mÃ´ táº£ Ä‘Æ°á»£c cá»™t thÃ´ng tin, chÃºng Ä‘á»u thá»ƒ hiá»‡n Ä‘Æ°á»£c thuá»™c tÃ­nh cá»§a chá»§ thá»ƒ. VÃ­ dá»¥:

- `AMT_TRIP`: giÃ¡ trá»‹ deal cá»§a Trip;
- `ADD_DESTINATION`: Äiá»ƒm Ä‘áº¿n cá»§a trip.

Tuy nhiÃªn tÃ¹y vÃ o tá»«ng use case, chÃºng ta hoÃ n toÃ n cÃ³ thá»ƒ má»Ÿ rá»™ng Ä‘Æ°á»£c vá» cáº£ hai phÃ­a. VÃ­ dá»¥:

- Vá» phÃ­a trÆ°á»›c: khi lÃ m viá»‡c vá»›i nhiá»u layer dá»¯ liá»‡u, ta cÃ³ thá»ƒ dÃ¹ng `RAW`, `STAGING`, `DW`, `DL`, `DM`, etc  
- Vá» phÃ­a sau: `DAY` hoáº·c `MONTH` cho `N_DURATION`, `VND` hoáº·c `USD` cho currency `AMT`. 

Miá»…n lÃ  cÃ³ má»™t quy chuáº©n, vÃ  nÃ³ Ä‘á»§ Ä‘Æ¡n giáº£n Ä‘á»ƒ sá»­ dá»¥ng.

## Káº¿t há»£p chÃºng láº¡i

Táº¥t nhiÃªn rÃ ng buá»™c viá»‡c Ä‘áº·t tÃªn nhÆ° váº­y khÃ´ng chá»‰ Ä‘á»ƒ trang trÃ­, nÃ³ sáº½ giÃºp chÃºng ta tá»± Ä‘á»™ng hÃ³a quy trÃ¬nh kiá»ƒm soÃ¡t cháº¥t lÆ°á»£ng dá»¯ liá»‡u, .

TÃ´i sá»­ dá»¥ng [bá»™ dá»¯ liá»‡u](https://www.kaggle.com/datasets/rkiattisak/traveler-trip-data) nÃ y Ä‘á»ƒ thá»±c hÃ nh (cá»™t dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c Ä‘á»•i tÃªn).
```{r}
#| eval: true # Do evaluate this chunk
#| echo: false # Do show this chunk in the final rendered document
#| output: false # Do show the output / results of this chunk in the rendered document
library(tidyverse)
trip_data = read_csv('C:\\Users\\Tuan Le\\git\\lktuan.github.io\\blog\\2024-06-05-cnac\\Travel details dataset.csv')
names(trip_data) <- c("ID_TRIP", "CAT_DESTINATION_CITY", "DT_START", "DT_END","N_DURATION_DAY","CAT_TRAVELER_NAME","VAL_AGE_TRAVELER","IND_GENDER_TRAVELER","CAT_TRAVELER_NATIONALITY", "CAT_ACCOMMODATION_TYPE", "AMT_ACCOMMODATION_COST", "CAT_TRANSPORTATION_TYPE","AMT_TRANSPORTATION_COST")
```

```{r}
head(trip_data)
```

# Data Validation

Sá»­ dá»¥ng `pointblank` cá»§a R Ä‘á»ƒ kiáº¿m tra má»™t sá»‘ tÃ­nh cháº¥t cá»§a dá»¯ liá»‡u:

```{r}
library(pointblank)

agent <-
  trip_data  %>% 
  create_agent(actions = action_levels(stop_at = 0.001)) %>% 
  col_vals_gte(starts_with("N"), 0) %>% # check if cols start with N is GTE 0 or not
  col_vals_gte(starts_with("VAL"), 0) %>% # check if cols start with VAL is GTE 0 or not
  col_vals_not_null(starts_with("IND")) %>% # check if cols start with IND contain Null or not
  col_vals_in_set(starts_with("IND"), c("Male","Female")) %>% # validate the value of only column started with IND - Gender
  col_is_date(starts_with("DT")) %>% # check validation of date columns
  interrogate()
```

:::{.column-margin}
Note: To type `pipe` operator in VS Code, use this in the `keybindings.json` file:
```json
{
  "key": "Ctrl+Shift+m",             
  "command": "type", 
  "args": { "text": " %>% " },
  "when": "editorTextFocus 
            && !editorHasSelection 
            && editorLangId 
            == 'quarto'" 
}
```
Then you can get the `pipe` when type `Ctrl + Shift + M`.
:::



```{r}
agent
```
Cool! KhÃ´ng chá»‰ kiá»ƒm tra Ä‘Æ°á»£c tÃ­nh Ä‘Ãºng Ä‘áº¯n cá»§a dá»¯ liá»‡u, cÅ©ng cÃ³ thá»ƒ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c biáº¿n nÃ o khÃ´ng tuÃ¢n theo quy táº¯c Ä‘áº·t tÃªn.

# Data Discoverability

```{r}
cols_data <- names(trip_data)
cols_data_split <- strsplit(cols_data,"_")
cols_components <- data.frame(
  variable = cols_data,
  level1 = vapply(cols_data_split, FUN = function(x) x[1], FUN.VALUE = character(1)),
  level2 = vapply(cols_data_split, FUN = function(x) x[2], FUN.VALUE = character(1))
)
head(cols_components)
```

ÄÃ¢y lÃ  má»™t cÃ¡ch Ä‘á»ƒ xÃ¢y dá»±ng metadata, chÃºng ta cÃ³ thá»ƒ touch má»™t cÃ¡ch interactive vá»›i:
```{r}
library(DT)
datatable(cols_components,  filter = list(position = 'top', clear = FALSE))
```
CÅ©ng cÃ³ thá»ƒ visualize thÃ nh má»™t tree nhÆ° bÃªn dÆ°á»›i:
```{r}
library(collapsibleTree)
collapsibleTree(cols_components, 
                hierarchy = paste0("level", 1:2),
                nodeSize = "leafCount"
                )
```
ÄÃ¢y lÃ  cÃ¡ch xem tá»« kiá»ƒu dá»¯ liá»‡u -> chá»§ thá»ƒ, chÃºng ta cÅ©ng cÃ³ thá»ƒ lÃ m ngÆ°á»£c láº¡i:
```{r}
collapsibleTree(cols_components, 
                hierarchy = paste0("level", c(2,1)),
                nodeSize = "leafCount"
                )
```

Bá»™ dá»¯ liá»‡u mÃ¬nh sá»­ dá»¥ng khÃ¡ nghÃ¨o nÃ n vÃ  táº­p trung vá» má»™t chá»§ thá»ƒ duy nháº¥t lÃ  `TRIP`, nÃªn kháº£ nÄƒng minh há»a khÃ´ng Ä‘Æ°á»£c phong phÃº ğŸ˜‚. NgoÃ i ra, viá»‡c Ä‘áº·t tÃªn nhÆ° tháº¿ cÅ©ng giÃºp ta dá»… dÃ ng gá»i biáº¿n á»Ÿ IDE.

# Data Wrangling

TÆ°Æ¡ng tá»±, vá»›i viá»‡c sá»­ dá»¥ng má»™t bá»™ tá»« Ä‘iá»ƒn cÃ³ há»‡ thá»‘ng, lá»›p lang cÅ©ng support chÃºng ta trong viá»‡c biáº¿n Ä‘á»•i dá»¯ liá»‡u. VÃ­ dá»¥ chÃºng ta cÃ³ thá»ƒ táº­n dá»¥ng "select helpers" trong gÃ³i `dplyr`:

```{r}
library(dplyr)
trip_data <- as.data.frame(trip_data)
trip_data %>%
  filter(if_any(everything(), ~ !is.na(.))) %>% 
  group_by(CAT_TRAVELER_NATIONALITY) %>%
  summarize(
    across(starts_with("DT_"), c(min,max))
  )
```


# Other languages

## Generating SQL
Sá»­ dá»¥ng R Ä‘á»ƒ generate SQL query
```{r}
library(dbplyr)
library(RSQLite)
df_mem <- memdb_frame(trip_data, .name = "example_table")

df_mem %>%
  group_by(CAT_TRAVELER_NATIONALITY) %>%
  summarize_at(vars(starts_with("N_")), mean, na.rm = TRUE) %>%
  show_query()
```
## R - `base` & `data.table`
sá»­ dá»¥ng `base::grep` Ä‘á»ƒ tÃ¬m táº¥t cáº£ cÃ¡c columns báº¯t Ä‘áº§u báº±ng `AMT_`
```{r}
cols_n <- grep("^AMT_", names(trip_data), value = TRUE)
print(cols_n)
```
sá»­ dá»¥ng vector Ä‘á»ƒ lÆ°u cÃ¡c cá»™t chÃºng ta muá»‘n group by:
```{r}
cols_grp <- c("CAT_TRAVELER_NATIONALITY")
```
chÃºng ta cÃ³ thá»ƒ dÃ¹ng vector nÃ y trong `stats::aggregate`
```{r}
#| eval: false 
#| echo: false
aggregate(trip_data[cols_n], by = trip_data[cols_grp], FUN = sum)
```
hoáº·c trong `data.table` 
```{r}
#| eval: false 
#| echo: false
library(data.table)
dt <- as.data.table(trip_data)
dt[, lapply(.SD, sum), by = cols_grp, .SDcols = cols_n]
```
## python `pandas`
tÆ°Æ¡ng tá»± trong python, sá»­ dá»¥ng list comprehension:
```{{python}}

import pandas as pd
cols_n   = [vbl for vbl in trip_data.columns if vbl[0:2] == 'AMT_']
cols_grp = ["CAT_TRAVELER_NATIONALITY"]
trip_data.groupby(cols_grp)[cols_n].sum()
```
# Updates by Emily

## Concept Map
```{mermaid}
%%{init: {'theme':'dark'}}%%
flowchart LR
  A(dataframe)-- has --> B(columns)
  A(dataframe)-- has --> C(names)
  B -- have --> D(data types)
  B -- have --> E(units)
  B -- have --> F(meaning)
  C -- should encode --> D
  C -- should encode --> E
  C -- should encode --> F
  C -- can support --> G(validation)
  C -- explained in --> H(documentation)
  G -- should check consistency of --> C
  G -- should check consistency of --> H
  H --> I(data dictionary)
  H --> K(ERD)
```
## New Package (Dec 2020)
[`convo`](https://emilyriederer.github.io/convo/articles/quickstart-guide.html) lÃ  má»™t thÆ° viá»‡n released bá»Ÿi Emily phá»¥c vá»¥ cho viá»‡c quáº£n lÃ½ controlled vocabulary:

```{r}
#| eval: false 
#| echo: true
library(convo)
```

```{yaml filename = 'vocab.yaml'}
level1:
  ID:
    desc: Unique identifier
    valid:
      - col_vals_not_null()
      - col_is_numeric()
      - col_vals_between(1000, 99999)
  IND:
    desc: Binary indicator
    valid:
      - col_is_numeric()
      - col_vals_in_set(c(0,1))
    rename:
      - when: SUM
        then: 'N'
      - when: AVG
        then: P
  AMT:
    desc: Non-negative, summable quantity
    valid:
      - col_is_numeric()
      - col_vals_gte(0)
  VAL:
    desc: Value
    valid:
      - col_is_numeric()
    rename:
      - when: AVG
        then: VALAV
```

## New Package (April 2021)

[`dbtplyr`](https://emilyriederer.github.io/dbtplyr/#!/overview) lÃ  má»™t package port tÃ­nh nÄƒng "select helpers" cá»§a `dplyr` sang `dbt`.
