---
title: "Hi Docker ğŸ³"
description: "A single-member full-stack data team me learning Docker ğŸ˜‚"
author:
  - name: "Tuan Le Khac"
    url: https://lktuan.github.io/
categories: [docker, python] 
date: 06-24-2024
date-modified: 06-28-2024
image: docker.png
code-tools: true
code-fold: show
code-annotations: hover
draft: false
css: html/styles.scss
fig-cap-location: bottom
editor: visual

format:
  html:
    code-overflow: wrap
---

Edit: an other great source for Docker - <https://levelup.gitconnected.com/working-with-docker-and-docker-compose-9773295b4d51>

:::: {.columns}

::: {.column width="40%"}
Xuáº¥t phÃ¡t lÃ  dÃ¢n Kinh táº¿ vÃ  hiá»‡n táº¡i Ä‘i theo hÆ°á»›ng DS, mÃ¬nh khÃ´ng giá»i lÃ m viá»‡c vá»›i cÃ¡c cÃ´ng cá»¥ phÃ¡t triá»ƒn pháº§n má»m, Docker lÃ  má»™t trong sá»‘ Ä‘Ã³. Tuy nhiÃªn trong má»™t dá»± Ã¡n Data cá»§a team, mÃ¬nh cáº§n sá»­ dá»¥ng cÃ¡c cÃ´ng vá»¥ nhÆ° Airflow, Airbyte hay DBT. Háº§u háº¿t cÃ¡c setup Ä‘á»u cáº§n Docker. Do Ä‘Ã³ thÃ¬, pháº£i há»c thÃ´i!

MÃ¬nh há»c táº­p theo video ["HÆ°á»›ng dáº«n tá»« A-Z tá»± xÃ¢y dá»±ng á»©ng dá»¥ng vá»›i Docker"](https://www.youtube.com/watch?v=Gh1Sgknc6Fg&t=358s) cá»§a anh [**Viá»‡t Nguyá»…n AI**](https://www.youtube.com/@vietnh1009).
:::

::: {.column width="10%"}
<!-- empty column to create gap -->
:::

::: {.column width="50%"}
![VS Code-song ğŸ˜ª, áº£nh nháº·t tá»« J2Team community](vs_cot_song.png){width="100%"}
:::

::::

# Introduction / Docker Desktop / Docker Image vs Docker Container

- CÃ¡ch cÃ i Ä‘áº·t: trÃªn trang get started, phiÃªn báº£n Window (ráº¥t dá»… Ä‘á»ƒ mÃ¬nh follow do mÃ¬nh cÅ©ng xÃ i Win).
- Nháº¯c láº¡i vá» Docker Image vÃ  Docker Container: giá»‘ng nhÆ° Class vÃ  Object trong OOP, Image chá»‰ cho chÃºng ta biáº¿t má»™t cÃ¡ch lÃ½ thuyáº¿t vá» thá»±c thá»ƒ Ä‘Ã³, khi dá»±a vÃ o lÃ½ thuyáº¿t Ä‘Ã³ táº¡o ra má»™t Container thÃ¬ chÅ©ng ta má»›i cÃ³ má»™t thá»±c thá»ƒ dá»± vÃ o lÃ½ thuyáº¿t Ä‘Ã³.
- TrÆ°á»›c Docker Image, cÃ²n cÃ³ Dockerfile (giá»‘ng nhÆ° cÃ´ng thá»©c náº¥u Äƒn) giÃºp Ä‘á»‹nh nghÄ©a má»™t sá»‘ phÆ°Æ¡ng thá»©c táº¡o ra Image.

::: {layout-ncol="1"}
![Image vs Container ~ Class vs Object](class_vs_object.png){width="100%"}
:::

# Docker tutorial

Thá»±c hÃ nh theo tutorial trÃªn Docker Desktop: "How do I run a container?"

:::{.callout-tip}
Xem ná»™i dung cá»§a má»™t file thÃ´ng qua powershell:
```bash
cat file_name
```
Trong trÆ°á»ng há»£p thá»±c hÃ nh cá»§a mÃ¬nh lÃ 

```bash
cd welcome-to-docker
cat .\Dockerfile
```
:::

Ná»™i dung Dockerfile:

```md
# Start your image with a node base image
FROM node:18-alpine 
# Má»—i custome docker image Ä‘á»u dá»±a vÃ o má»™t base image, nhÆ° má»™t class con káº¿ thá»«a má»™t class cha. NÆ¡i tÃ¬m Docker Image: Docker Hub.

# The /app directory should act as the main application directory
WORKDIR /app
# ChÃºng ta lÃ m viá»‡c á»Ÿ bÃªn trong thÆ° má»¥c nÃ o (náº¿u khÃ´ng Ä‘á» cáº­p thÃ¬ sáº½ táº¡o trong má»™t thÆ° má»¥c máº·c Ä‘á»‹nh)

# Copy the app package and package-lock.json file
COPY package*.json ./
# Copy cÃ¡c file trong mÃ¡y vÃ o bÃªn trong Docker Image - file nÃ y cháº¯c lÃ  file cáº¥u hÃ¬nh

# Copy local directories to the current local directory of our docker image (/app)
COPY ./src ./src
COPY ./public ./public
# Copy cÃ¡c thÆ° má»¥c source

# Install node packages, install serve, build the app, and remove dependencies at the end
RUN npm install \
    && npm install -g serve \
    && npm run build \
    && rm -fr node_modules
# Run, cÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n, package

EXPOSE 3000
# Má»Ÿ má»™t cá»•ng á»Ÿ trong Docker container, sau nÃ y chÃºng ta sáº½ káº¿t ná»‘i cá»•ng nÃ y vá»›i má»™t cá»•ng trong mÃ¡y cá»§a chÃºng ta.

# Start the app using serve command
CMD [ "serve", "-s", "build" ]
# ChÃºng ta muá»‘n cháº¡y lá»‡nh gÃ¬ trong CMD, chá»‰ má»™t lá»‡nh CMD (lá»‡nh cuá»‘i cÃ¹ng) sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng trong má»™t Dockerfile.
```

Build fist image:

```bash
docker build -t welcome-to-docker .
```

Breaking down this command:

> The -t flag tags your image with a name. (welcome-to-docker in this case). And the . lets Docker know where it can find the Dockerfile.

# Tá»± xÃ¢y dá»±ng Docker Image Ä‘á»ƒ huáº¥n luyá»‡n mÃ´ hÃ¬nh AI

## Giá»›i thiá»‡u vá» script Python

MÃ¬nh cÃ³ má»™t file python Ä‘Æ¡n giáº£n, huáº¥n luyá»‡n má»™t mÃ´ hÃ¬nh `ml_project` Random forest Ä‘á»ƒ nháº­n diá»‡n hoa diá»…n vÄ© tá»« bá»™ `iris` dataset vá»›i thÆ° viá»‡n `sklearn` nhÆ° sau:
```{.python filename="iris_classification.py"}
#| eval: false
# importing required libraries
# importing Scikit-learn library and datasets package
from sklearn import datasets
# Splitting arrays or matrices into random train and test subsets
from sklearn.model_selection import train_test_split
# importing random forest classifier from assemble module
from sklearn.ensemble import RandomForestClassifier
# importing scaler
from sklearn.preprocessing import StandardScaler
# metrics are used to find accuracy or error
from sklearn.metrics import accuracy_score 

# Loading the iris plants dataset (classification)
iris = datasets.load_iris()
# dividing the datasets into two parts i.e. training datasets and test datasets
X = iris.data[:, [2, 3]]
y = iris.target
# i.e. 70 % training dataset and 30 % test datasets
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size = 0.20, random_state=0)


scaler = StandardScaler()
x_train = scaler.fit_transform(X_train)
x_test = scaler.transform(X_test)

model = RandomForestClassifier()
model.fit(x_train, y_train)
y_pred = model.predict(x_test)

for pred, label in zip(y_pred, y_test):
    print("Prediction: {}. Label: {}".format(pred, label))

print("Accuracy: %.2f" % accuracy_score(y_test, y_pred))
```

## TÃ¬m Base Image trÃªn Docker Hub

ChÃºng ta cÃ³ thá»ƒ tÃ¬m cÃ¡c class cha ~ base image trÃªn `hub.docker.com`, chÃºng ta muá»‘n app ml nÃ y cháº¡y trÃªn `ubuntu`, do Ä‘Ã³ cÃ³ thá»ƒ start tá»« image `ubuntu`.

MÃ¬nh xÃ¢y dá»±ng `Dockerfile` má»™t cÃ¡ch Ä‘Æ¡n giáº£n nhÆ° sau:

```{.bash filename="Dockerfile"}
FROM ubuntu
```

Tá»« Dockerfile nÃ y mÃ¬nh cÃ³ thá»ƒ build image thÃ´ng qua command sau:

```bash
docker -t ml_project .
```

Run má»™t docker container (container vá»«a run sáº½ láº­p tá»©c exit):

```bash
docker run image_name container_name
```

Náº¿u muá»‘n "chui" vÃ o bÃªn trong container:

```bash
docker run -it image_name container_name bash
```
`-it` nghÄ©a lÃ  chÃºng ta cháº¡y container dÆ°á»›i **interactive** mode, `bash` nghÄ©a lÃ  cháº¡y trong **bash** mode, chÃºng ta cÃ³ thá»ƒ thá»±c hiá»‡n cÃ¡c cÃ¢u lá»‡nh bash tá»« Ä‘Ã¢y.

## CÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n trong Docker Image

BÃ¢y giá» ta má»›i chá»‰ cÃ³ duy nháº¥t há»‡ Ä‘iá»u hÃ nh ubuntu trong container, chÆ°a cÃ³ python Ä‘á»ƒ cháº¡y á»©ng dá»¥ng. Trong ubuntu, ta dÃ¹ng `apt-get` Ä‘á»ƒ cÃ i Ä‘áº·t python. ChÃºng ta sáº½ thá»±c hiá»‡n cÃ¡c lá»‡nh trÃªn bash á»Ÿ container hiá»‡n táº¡i trÆ°á»›c, sau Ä‘Ã³ má»›i Ä‘Æ°a vÃ o Dockerfile vá»›i lá»‡nh `RUN`. DÆ°á»›i Ä‘Ã¢y lÃ  Dockerfile cáº­p nháº­t:

```{.bash filename="Dockerfile"}
FROM ubuntu

RUN apt-get update
RUN apt-get -y install python3
# -y tá»± Ä‘á»™ng Ä‘iá»n yes khi cÃ³ cÃ¡c cÃ¢u há»i Y/N
```

:::{.callout-tip}
Sá»­ dá»¥ng exit() hoáº·c Ctrl-D Ä‘á»ƒ thoÃ¡t Python mode hoáº·c Container trong Powershell.
:::

ChÃºng láº¡i truy cáº­p bash cá»§a container Ä‘ang cháº¡y tá»« Docker desktop hoáº·c Powershell:

::: {layout-ncol="1"}
![Bash inside container](bash_inside_container.png){width="100%"}
:::

## Copy dá»¯ liá»‡u tá»« host vÃ o Docker Image

BÃ¢y giá» chÃºng ta muá»‘n ráº±ng sau khi vÃ o container, chÃºng ta khÃ´ng á»Ÿ thÆ° má»¥c `root` ná»¯a mÃ  á»Ÿ `src` ~ á»©ng chÃºng cá»§a chÃºng ta, vá»›i má»¥c Ä‘Ã­ch dá»… lÃ m viá»‡c hÆ¡n. ChÃºng ta thÃªm cÃº phÃ¡p `WORKDIR /src`. Äá»“ng thá»i cÅ©ng cáº§n cÃ i Ä‘áº·t `sklearn` Ä‘á»ƒ á»©ng dá»¥ng cÃ³ thá»ƒ cháº¡y. Äá»“ng thá»i, sau khi táº¥t cáº£ Ä‘Æ°á»£c cÃ i Ä‘áº·t, mÃ¬nh cÅ©ng muá»‘n cháº¡y luÃ´n á»©ng dá»¥ng, sá»­ dá»¥ng `CMD`.

Cáº­p nháº­t Dockerfile nhÆ° sau:

```{.bash filename="Dockerfile"}
FROM ubuntu

WORKDIR /src
# Khi á»Ÿ trong docker container, máº·c Ä‘á»‹nh chÃºng ta sáº½ á»Ÿ root, giá» ta muá»‘n khi vÃ o container, chÃºng ta sáº½ vÃ o /src

RUN apt-get update
RUN apt-get -y install python3
RUN apt-get -y install python3-sklearn
# -y tá»± Ä‘á»™ng Ä‘iá»n yes khi cÃ³ cÃ¡c cÃ¢u há»i Y/N

COPY iris_classification.py ./iris_classification.py 

CMD [ "python3", "iris_classification.py" ]
```

# End

Sau khi hoÃ n thiá»‡n, mÃ¬nh khÃ´ng cáº§n cháº¡y containter á»Ÿ interactive mode vÃ  tÆ°Æ¡ng tÃ¡c báº±ng bash ná»¯a. Lá»‡nh run cÃ³ thá»ƒ viáº¿t gá»n nhÆ° sau:

```bash
docker run ml_project
```

BÃ i thá»±c hÃ nh Ä‘áº¿n Ä‘Ã¢y káº¿t thÃºc ğŸ‰.