<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Le Khac Tuan</title>
<link>https://lktuan.github.io/blog.html</link>
<atom:link href="https://lktuan.github.io/blog.xml" rel="self" type="application/rss+xml"/>
<description>This is Tuan&#39;s blog</description>
<generator>quarto-1.4.554</generator>
<lastBuildDate>Wed, 11 Dec 2024 17:00:00 GMT</lastBuildDate>
<item>
  <title>Intro to Large Language Models: A Summary of Andrej Karpathy‚Äôs Talk</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-12-12-intro-llm/</link>
  <description><![CDATA[ 





<div class="callout callout-style-default callout-warning callout-titled" title="AI-assisted content">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
AI-assisted content
</div>
</div>
<div class="callout-body-container callout-body">
<p>This summary is conducted with the help of ‚Äú<a href="https://aistudio.google.com/prompts/new_chat?model=gemini-2.0-flash-exp">Gemini 2.0 Flash Experimental</a>‚Äù in Google AI Studio.</p>
</div>
</div>
<section id="part-1-understanding-llms" class="level1">
<h1>Part 1: Understanding LLMs</h1>
<section id="intro-large-language-model-llm-talk" class="level2">
<h2 class="anchored" data-anchor-id="intro-large-language-model-llm-talk">Intro: Large Language Model (LLM) Talk</h2>
<p>Karpathy begins by explaining the motivation for re-recording his talk, emphasizing its popularity. He frames it as a ‚Äúbusy person‚Äôs intro‚Äù to large language models, aiming to provide a concise yet informative overview. He quickly dives into the core of what constitutes an LLM.</p>
</section>
<section id="llm-inference-the-essence-of-llms" class="level2">
<h2 class="anchored" data-anchor-id="llm-inference-the-essence-of-llms">LLM Inference: The Essence of LLMs</h2>
<p>In its most basic form, a large language model is just two files:</p>
<ul>
<li>a ‚Äúparameters‚Äù file; and</li>
<li>a ‚Äúrun‚Äù file.</li>
</ul>
<p>Using the example of the Llama 2 70B model, released by Meta AI, he clarifies these points. The parameters file contains the model‚Äôs weights, essentially a vast list of numbers representing the trained neural network. These parameters, stored as 2-byte <code>float16</code> numbers, for the 70B model, come up to about 140 GB (<em>because each param is 2 bytes</em>). The ‚Äúrun‚Äù file is the code (often in C or Python) that executes the neural network using the parameters. This code is surprisingly compact, requiring approximately 500 lines of C code without external dependencies. This is the essence of the model itself ‚Äì a <strong>self-contained package</strong> requiring no internet connectivity once compiled.</p>
<p>Karpathy uses the example of providing text to the model (‚Äúwrite a poem about scale AI‚Äù), which generates a poem, to demonstrate what inference (running the model) looks like. He emphasizes that the computational complexity comes in obtaining those parameters via training, not running the model itself. The demonstration is not actually the 70B model in real time but a much smaller 7B model, running about 10 times faster for illustrative purposes.</p>
<p>The magic lies under the parameters. <em>But how can we obtain them?</em></p>
</section>
<section id="llm-training-the-heavy-lifting" class="level2">
<h2 class="anchored" data-anchor-id="llm-training-the-heavy-lifting">LLM Training: The Heavy Lifting</h2>
<p>The bulk of the computational effort and cost is tied to <em>training</em> the model. This involves creating the parameters, a process far more complex than running it (inference). The training is conceptualized as a compression process of the internet.</p>
<p>The resources required for training Llama 2 70B:</p>
<ul>
<li>roughly 10 terabytes of text from a crawl of the internet,</li>
<li>processed by 6,000 GPUs over 12 days,</li>
<li>at a cost of around $2 million.</li>
</ul>
<p>This process compresses the massive text dataset into the 140GB parameters file, which he refers to as ‚Äú<em>like a zip file of the internet</em>‚Äù with a compression ratio of approximately <strong>100x</strong>. Importantly, this is a <em>lossy</em> compression, meaning the model doesn‚Äôt store an exact copy of the text, but a generalized representation, a kind of ‚ÄúGestalt.‚Äù Karpathy points out that the numbers associated with Llama 2 70B, while significant, are ‚Äúrookie numbers‚Äù compared to the training efforts for state-of-the-art models used in ChatGPT or Claude which are of magnitude 10x or more and costing tens or hundreds of millions of dollars.</p>
<p>After being <em>trained</em> (and <em>fine-tuned</em> - which is discussed later), running the LLM model which is neural network is faily computationally cheap. <em>So what is neural network is really doing?</em></p>
</section>
<section id="llm-dreams-text-generation-hallucination" class="level2">
<h2 class="anchored" data-anchor-id="llm-dreams-text-generation-hallucination">LLM Dreams: Text Generation &amp; Hallucination</h2>
<p>Fundamentally, a language model‚Äôs primary task during training is to predict the <em>next word</em> in a sequence. For example, from a sequence ‚ÄúCat sat on a‚Äù, the neural network will predict what word comes next, e.g.&nbsp;‚Äúmat‚Äù with a 97% probability. Karpathy explains that this prediction task has a very close mathematical relationship to compression. This simple prediction is a powerful objective, forcing the model to learn vast amounts of world knowledge. He uses a sample from Wikipedia about Ruth Handler to highlight how even seemingly mundane text is full of information that the model internalizes.</p>
<p>After training, running the model (inference) involves iterative text generation. The model predicts a word, feeds it back in, predicts the next, and so on, in a process Karpathy describes as ‚Äúdreaming internet documents.‚Äù He shows examples of generated text resembling Java code, Amazon product listings, and Wikipedia articles. This generated text is often plausible but <em>hallucinated</em> ‚Äì not necessarily true or derived directly from the training data. He gives examples of made up ISBNs and text referencing an obscure fish species, demonstrating that the model is not simply memorizing the training set.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-12-intro-llm/1_network_dreams.png" class="img-fluid figure-img"></p>
<figcaption>All of these are dreamed by neural networks</figcaption>
</figure>
</div>
</section>
<section id="how-do-they-work-the-transformer-architecture" class="level2">
<h2 class="anchored" data-anchor-id="how-do-they-work-the-transformer-architecture">How Do They Work? The Transformer Architecture</h2>
<p>Into the inner workings of LLMs, they are based on a neural network architecture called the ‚Äú<em>Transformer</em>‚Äù. The full details of the mathematical operations and architecture are available. The challenge is that parameters are spread across the network and the exact nature of their interactions and contributions to the whole is unknown. While we know how to iteratively adjust the parameters to improve next-word prediction accuracy, we don‚Äôt truly understand <em>how</em> these parameters collaborate to produce specific outputs. We do have some models suggesting they build up knowledge databases but this knowledge is imperfect and strange. Karpathy illustrates the weirdness of LLM knowledge using the viral ‚Äúreversal course‚Äù example of Chat GPT‚Äôs inability to recognize ‚ÄúTom Cruise‚Äù as ‚ÄúMerily Feifer‚Äôs son,‚Äù showing the knowledge is one-dimensional and directionally dependent. He summarizes that LLMs should be viewed as ‚Äú<strong>mostly inscrutable artifacts</strong>‚Äù, unlike engineered systems (like cars). He emphasizes that they are empirical artifacts that necessitate sophisticated evaluation methods.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-12-intro-llm/2_reversal_course.png" class="img-fluid figure-img"></p>
<figcaption>Reversal Course</figcaption>
</figure>
</div>
</section>
<section id="fine-tuning-into-an-assistant-from-document-generators-to-chatbots" class="level2">
<h2 class="anchored" data-anchor-id="fine-tuning-into-an-assistant-from-document-generators-to-chatbots">Fine-tuning into an Assistant: From Document Generators to Chatbots</h2>
<p>The first training phase results in an internet document generator, which is not that helpful. The second major step is <em>fine-tuning</em>, the process of transforming this into a helpful ‚Äúassistant model‚Äù. This transformation is achieved by switching from training on a large collection of internet text to training on a smaller, <strong>carefully curated dataset of conversations</strong>.</p>
<p>This dataset is typically created manually by human labelers who are provided with labeling instructions to generate questions and model answers. An example is provided of a question, with the correct assistant answer. The pre-training stage prioritizes data quantity but low quality, while the fine-tuning stage favors high-quality, carefully labelled Q&amp;A documents. A dataset of 100,000 high-quality Q&amp;A documents would be more than sufficient for fine tuning. The fine tuning stage leverages the knowledge from pre-training and reconfigures the LLM to answer questions in a helpful manner. He gives the example of the prompt ‚Äúcan you help me with this code‚Äù with the corresponding helpful response. The model is able to ‚Äúformat‚Äù itself into an assistant that knows how to answer and responds to these kinds of questions, by learning patterns from the training data, and generating text word by word.</p>
</section>
<section id="summary-so-far-pre-training-vs.-fine-tuning" class="level2">
<h2 class="anchored" data-anchor-id="summary-so-far-pre-training-vs.-fine-tuning">Summary So Far: Pre-training vs.&nbsp;Fine-tuning</h2>
<p>Karpathy summarizes the two-stage process: * <strong>Pre-training:</strong> training on a massive internet dataset, resulting in a base model with world knowledge, this is computationally very expensive (millions of dollars) and done infrequently. * <strong>Fine-tuning:</strong> training on high-quality Q&amp;A data, resulting in an assistant model, this is computationally cheaper and done more frequently (daily or weekly).</p>
<p>The Llama 2 series included both base and assistant models. The base model, without fine tuning, is not directly usable because it just samples documents rather than responding with an answer. Meta performed the pre-training and released the result. This allows others to do their own fine-tuning, providing tremendous freedom.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-12-intro-llm/3_2stage.png" class="img-fluid figure-img"></p>
<figcaption>How to train your <del>dragon</del> ChatGPT</figcaption>
</figure>
</div>
</section>
<section id="appendix-comparisons-labeling-docs-rlhf-synthetic-data-leaderboard" class="level2">
<h2 class="anchored" data-anchor-id="appendix-comparisons-labeling-docs-rlhf-synthetic-data-leaderboard">Appendix: Comparisons, Labeling Docs, RLHF, Synthetic Data, Leaderboard</h2>
<p>This section expands on finer aspects of training and evaluation. Fine-tuning is followed by an <em>optional</em> third stage that leverages comparison labels. It is typically easier for a human labeler to rank options vs.&nbsp;generating the content. The labelers are given example Haikus and they are asked to pick the best one. These comparisons are used to further fine-tune the model via Reinforcement Learning from Human Feedback (RLHF). Karpathy shows an example of labeling instructions from the InstructGPT paper asking labelers to be ‚Äúhelpful, truthful, and harmless‚Äù. He notes that these instructions can be tens or hundreds of pages long and very complicated.</p>
<p>He then explains that human labelers are used, although increasingly, machine assisted. Models can be used to sample answers and a human can do the cherry picking to improve efficiency. He then displays the Chatbot Arena leaderboard where Language Models are ranked according to their ELO ratings (just like chess). This ranking system determines which model does better on user queries. He observes the closed, proprietary models like those from OpenAI and Anthropic generally perform better. However, open-weights models (Llama series, Zephyr) are available and can be fine-tuned and used by everyone. The open-source models may be less accurate, but good enough for many applications.</p>
</section>
</section>
<section id="part-2-future-of-llms" class="level1">
<h1>Part 2: Future of LLMs</h1>
<section id="llm-scaling-laws-the-path-to-better-performance" class="level2">
<h2 class="anchored" data-anchor-id="llm-scaling-laws-the-path-to-better-performance">LLM Scaling Laws: The Path to Better Performance</h2>
<p>Karpathy highlights the importance of <em>scaling laws</em>: the performance of LLMs in terms of next-word prediction accuracy is a predictable function of:</p>
<ul>
<li>the number of parameters (N), and</li>
<li>the amount of training data (D).</li>
</ul>
<p>Increased parameters and increased dataset always result in better performance (predictability), so algorithmic progress is a bonus. It‚Äôs not necessarily needed for improvement, which creates a gold rush, because bigger and better clusters can provide better results. He emphasizes this is correlated with performance across many downstream tasks.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-12-intro-llm/4_free_scaling.png" class="img-fluid figure-img"></p>
<figcaption>Free scaling!</figcaption>
</figure>
</div>
</section>
<section id="tool-use-expanding-capabilities" class="level2">
<h2 class="anchored" data-anchor-id="tool-use-expanding-capabilities">Tool Use: Expanding Capabilities</h2>
<p>He uses a concrete example to demonstrate the <em>tool use</em> capabilities of LLMs using ChatGPT, by providing a query to find information on Scale AI‚Äôs funding rounds. ChatGPT can browse the internet using <em>search tools</em>, it then takes the information from search results, and uses that to answer the prompt. The model then can use a <em>calculator tool</em> to perform arithmetic tasks, and generates an estimation based on ratios from data it previously received. It can then use a <em>python interpreter</em> with the matplotlib library to generate graphs and visualizations to the data. This allows the language model to solve problems just as humans might, using external tools to aid in problem solving. It can also use <em>DALL-E</em> for image generation. The LLM orchestrates the various tools to solve the prompt and return the result to the user.</p>
</section>
<section id="multimodality-beyond-text" class="level2">
<h2 class="anchored" data-anchor-id="multimodality-beyond-text">Multimodality: Beyond Text</h2>
<p>The next major aspect is <em>multimodality</em>, showing how LLMs can interact beyond text with images, audio, etc. Karpathy gives the example of ChatGPT analyzing a hand-sketched website diagram, generating functional HTML and JavaScript. ChatGPT can also hear and speak and thus enable speech-to-speech interactions.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-12-intro-llm/5_multimodality.png" class="img-fluid figure-img"></p>
<figcaption>Multimodality</figcaption>
</figure>
</div>
</section>
<section id="thinking-system-12-reasoning-and-planning" class="level2">
<h2 class="anchored" data-anchor-id="thinking-system-12-reasoning-and-planning">Thinking, System 1/2: Reasoning and Planning</h2>
<p>Karpathy introduces the concept of <em>System 1</em> and <em>System 2</em> thinking, inspired by Daniel Kahneman‚Äôs work. System 1 is fast, instinctive thinking (<em>the answer is cached already</em>), whereas System 2 is slower, more deliberate reasoning.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-12-intro-llm/6_2_sytems.png" class="img-fluid figure-img"></p>
<figcaption>2 systems of thinking</figcaption>
</figure>
</div>
<p>LLMs currently only operate in System 1 mode, sampling word by word without deep planning. A major future direction is to enable <em>System 2</em> thinking, where models can spend more time to improve quality. The idea is to make a trade off between compute time and accuracy. Karpathy notes how this is not possible today, where the LLM just goes <em>chunk chunk chunk x3.14</em> and sampling words in the sequence without ‚Äúthinking‚Äù through it. He emphasizes the importance of converting time into accuracy using tree-of-thought and other techniques.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-12-intro-llm/7_ToT.png" class="img-fluid figure-img"></p>
<figcaption>Towarding the Tree of Thoughts</figcaption>
</figure>
</div>
</section>
<section id="self-improvement-going-beyond-human-limits" class="level2">
<h2 class="anchored" data-anchor-id="self-improvement-going-beyond-human-limits">Self-improvement: Going Beyond Human Limits</h2>
<p>He references DeepMind‚Äôs AlphaGo, which initially learned by imitating human players but later surpassed human performance through self-improvement. Karpathy argues that current LLMs are only in the <strong>imitation</strong> stage, and the next challenge is to achieve <em>self-improvement</em> for them, similar to the AlphaGo step two. The lack of a <strong>general reward function</strong>, unlike the win/loss criteria of the go game, is the main challenge. In narrow domains though, this may be achievable.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-12-intro-llm/8_alpha_go.png" class="img-fluid figure-img"></p>
<figcaption>Self-improvement is key for AlphaGo to surpass the best human in 40 days</figcaption>
</figure>
</div>
</section>
<section id="llm-customization-expert-systems" class="level2">
<h2 class="anchored" data-anchor-id="llm-customization-expert-systems">LLM Customization: Expert Systems</h2>
<p>Karpathy explains the need for customization to allow LLMs to become specialized in specific tasks. This is especially important due to the diversity of needs in the real world. He provides the example of the GPT Store by OpenAI, which allows users to create custom GPTs using custom instructions, and <strong>retrieval augmented generation</strong>. Fine-tuning LLMs may be needed to have experts in specific areas.</p>
<p>This is what people are hyped doing nowaday üò™.</p>
</section>
<section id="llm-os-a-new-paradigm" class="level2">
<h2 class="anchored" data-anchor-id="llm-os-a-new-paradigm">LLM OS: A New Paradigm</h2>
<p>Karpathy proposes that LLMs should not be seen as mere chatbots, but rather the <em>kernel process of an emerging operating system</em>. He explains that the LLM is coordinating a lot of resources for problem solving, acting like the kernel of an operating system. He then goes to show an analog of a computer‚Äôs components, and what they might correspond to in LLM space. He outlines the LLM OS‚Äôs capabilities, such as internet browsing, local file referencing, access to software tools, ability to generate/interpret images, videos, and audio, long-term ‚Äúthinking‚Äù, customization, and self-improvement. This maps directly to what we expect an operating system to do. He makes an analogy to a computer‚Äôs memory hierarchy with hard disks (internet/local files), random access memory (context window). He also draws a parallel between the diverse OS landscape of today with the proprietary desktop OS like Windows and MacOS vs open-source alternatives. In the LLM space, similarly there‚Äôs GPT/Claude/Bard and the open-source landscape built around Llama.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-12-intro-llm/9_llm_os.png" class="img-fluid figure-img"></p>
<figcaption>Embed the LLMs into the kernel</figcaption>
</figure>
</div>
</section>
</section>
<section id="part-3-llm-security" class="level1">
<h1>Part 3: LLM Security</h1>
<section id="llm-security-intro-the-new-battleground" class="level2">
<h2 class="anchored" data-anchor-id="llm-security-intro-the-new-battleground">LLM Security Intro: The New Battleground</h2>
<p>Karpathy then switches gears to security challenges, arguing that the new paradigm of LLMs introduce new security vulnerabilities. He emphasizes that cat and mouse security game that we are familiar with in computer security also exists in LLM security.</p>
</section>
<section id="jailbreaks-bypassing-safety-restrictions" class="level2">
<h2 class="anchored" data-anchor-id="jailbreaks-bypassing-safety-restrictions">Jailbreaks: Bypassing Safety Restrictions</h2>
<p>He starts with <em>jailbreak attacks</em>, demonstrating how prompts can circumvent safety restrictions and elicit harmful information from LLMs. One example given is the grandmother-role-play where the LLM was tricked to give instructions on how to make Napalm. There are many ways to trick a system into providing unsafe responses. He gives the example of base64 encoding a dangerous request to elicit unsafe information because training for safety often focuses on English text. The universal transferable suffix is another attack vector: adding the suffix will bypass safety filters. Image noise based jailbreaks are also possible by carefully crafting the noise pattern.</p>
</section>
<section id="prompt-injection-hijacking-the-model" class="level2">
<h2 class="anchored" data-anchor-id="prompt-injection-hijacking-the-model">Prompt Injection: Hijacking the Model</h2>
<p>Karpathy moves to <em>prompt injection attacks</em>, where hidden or injected prompts hijack the model, causing it to follow undesirable instructions. One example is using faint text hidden in an image, containing a prompt injection, to make ChatGPT talk about Sephora sales. He explains that prompt injection can exist in web pages. This is demonstrated using the scenario of searching for movies in Bing and having Bing inject a fraud link due to a web page the search accessed having a prompt injection vulnerability. He also uses a recent example of injecting malicious content into a Google doc and using Bard‚Äôs image rendering and URL capabilities to exfiltrate user data. He explains that while engineers implement mitigations, determined attackers always find a loophole (Google Apps scripts).</p>
</section>
<section id="data-poisoning-the-backdoor-threat" class="level2">
<h2 class="anchored" data-anchor-id="data-poisoning-the-backdoor-threat">Data Poisoning: The Backdoor Threat</h2>
<p>The final attack vector is <em>data poisoning</em> or <em>backdoor attacks</em>. He discusses how a trigger phrase can cause the model to behave maliciously when the text is present. He discusses the James Bond trigger phrase that is injected during fine tuning. The trigger phrase can cause any task to become non-sensical, or to incorrectly classify threats in a security application. While the example was shown to work for fine-tuning, Karpathy explains that the idea can extend to pre-training.</p>
</section>
<section id="llm-security-conclusions-a-constant-battle" class="level2">
<h2 class="anchored" data-anchor-id="llm-security-conclusions-a-constant-battle">LLM Security Conclusions: A Constant Battle</h2>
<p>Karpathy summarizes that while defenses exist, the security landscape in LLMs will likely be a constant ‚Äúcat and mouse game,‚Äù mirroring traditional computer security. He points out that all the attacks have defenses, but they can be bypassed and repatched and so on. The field is very new and actively evolving.</p>
</section>
<section id="outro" class="level2">
<h2 class="anchored" data-anchor-id="outro">Outro</h2>
<p>Karpathy ends the talk by summarizing all major aspects he touched upon. He restates the main message: LLMs are a new emerging field and it‚Äôs important to keep track of its ongoing work and exciting developments.</p>
</section>
</section>
<section id="resources" class="level1">
<h1>resources</h1>
<ol type="1">
<li>video: <a href="https://www.youtube.com/watch?v=zjkBMFhNj_g" class="uri">https://www.youtube.com/watch?v=zjkBMFhNj_g</a>;</li>
<li>pdf slide: <a href="https://drive.google.com/file/d/1pxx_ZI7O-Nwl7ZLNk5hI3WzAsTLwvNU7/view" class="uri">https://drive.google.com/file/d/1pxx_ZI7O-Nwl7ZLNk5hI3WzAsTLwvNU7/view</a></li>
<li>a recommended to read blog post: <a href="https://karpathy.github.io/2015/05/21/rnn-effectiveness/" class="uri">https://karpathy.github.io/2015/05/21/rnn-effectiveness/</a></li>
<li>a <code>run.c</code> file: <a href="https://github.com/karpathy/llama2.c/blob/master/run.c" class="uri">https://github.com/karpathy/llama2.c/blob/master/run.c</a></li>
</ol>


<!-- -->

</section>

 ]]></description>
  <category>andrej karpathy</category>
  <category>llm</category>
  <category>neural networks</category>
  <guid>https://lktuan.github.io/blog/2024-12-12-intro-llm/</guid>
  <pubDate>Wed, 11 Dec 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-12-12-intro-llm/llmintro.png" medium="image" type="image/png" height="81" width="144"/>
</item>
<item>
  <title>NN-Z2H Lesson 6: Building makemore part 5 - Building a WaveNet</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-12-09-nn-z2h-p6/</link>
  <description><![CDATA[ 





<div class="callout callout-style-default callout-important callout-titled" title="This is not orginal content!">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This is not orginal content!
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is my study notes / codes along with Andrej Karpathy‚Äôs ‚Äú<a href="https://www.youtube.com/watch?v=VMj-3S1tku0&amp;list=PLAqhIrjkxbuWI23v9cThsA9GvCAUhRvKZ">Neural Networks: Zero to Hero</a>‚Äù series.</p>
</div>
</div>
<p><em>Codes are executed in Colab, this calculation capacity exceeds my computer‚Äôs ability.</em></p>
<section id="intro" class="level1">
<h1>1 intro</h1>
<p>We are going to take the 2-layer MLP in the part 3 of <code>makemore</code> and complexify it by:</p>
<ul>
<li>extending the block size: from 3 to 8 characters;</li>
<li>making it deeper rather than 1 hidden layer.</li>
</ul>
<p>then end of with a Convoluntional Neural Network architecture similar to <code>WaveNet</code> (2016) by <a href="https://deepmind.google/">Google DeepMind</a>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-09-nn-z2h-p6/wavenet.png" class="img-fluid figure-img"></p>
<figcaption>WaveNet model architecture, <a href="https://www.researchgate.net/figure/WaveNet-Model-Architecture-38_fig2_380566531">source</a></figcaption>
</figure>
</div>
<section id="starter-code-walk-through" class="level2">
<h2 class="anchored" data-anchor-id="starter-code-walk-through">starter code walk through</h2>
<section id="import-libraries" class="level4">
<h4 class="anchored" data-anchor-id="import-libraries">import libraries</h4>
<div id="2e5ccfda" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>matplotlib inline</span></code></pre></div>
</details>
</div>
</section>
<section id="reading-data" class="level4">
<h4 class="anchored" data-anchor-id="reading-data">reading data</h4>
<div id="751b09c6" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb2-2"></span>
<span id="cb2-3">url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/karpathy/makemore/refs/heads/master/names.txt"</span></span>
<span id="cb2-4">words <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(url, header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>).iloc[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].tolist()</span>
<span id="cb2-5">words[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>]</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt;&gt;&gt; ['emma', 'olivia', 'ava', 'isabella', 'sophia', 'charlotte', 'mia', 'amelia']</span></span></code></pre></div>
</details>
</div>
</section>
<section id="building-vocab" class="level4">
<h4 class="anchored" data-anchor-id="building-vocab">building vocab</h4>
<div id="5d90dac7" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># build the vocabulary of characters and mapping to/from integer</span></span>
<span id="cb3-2">chars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(words))))</span>
<span id="cb3-3">stoi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {s:i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i, s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(chars)}</span>
<span id="cb3-4">stoi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb3-5">itos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {i: s <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s, i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> stoi.items()}</span>
<span id="cb3-6">vocab_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(itos)</span>
<span id="cb3-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(itos)</span>
<span id="cb3-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(vocab_size)</span>
<span id="cb3-9"></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># itos: {1: 'a', 2: 'b', 3: 'c', 4: 'd', 5: 'e', 6: 'f', 7: 'g', 8: 'h', 9: 'i', 10: 'j', </span></span>
<span id="cb3-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 11: 'k', 12: 'l', 13: 'm', 14: 'n', 15: 'o', 16: 'p', 17: 'q', 18: 'r', 19: 's', 20: 't', </span></span>
<span id="cb3-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 21: 'u', 22: 'v', 23: 'w', 24: 'x', 25: 'y', 26: 'z', 0: '.'}</span></span>
<span id="cb3-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vocab_size: 27</span></span></code></pre></div>
</details>
</div>
</section>
<section id="initializing-randomization" class="level4">
<h4 class="anchored" data-anchor-id="initializing-randomization">initializing randomization</h4>
<div id="3359dd8a" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb4-2">random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb4-3">random.shuffle(words)</span></code></pre></div>
</details>
</div>
</section>
<section id="create-traindevtest-splits" class="level4">
<h4 class="anchored" data-anchor-id="create-traindevtest-splits">create train/dev/test splits</h4>
<div id="5dd7e13d" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1">block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># context length: how many characters do we take to predict the next one?</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># build the dataset</span></span>
<span id="cb5-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> buid_dataset(words):</span>
<span id="cb5-4">    X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [], []</span>
<span id="cb5-5"></span>
<span id="cb5-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words:</span>
<span id="cb5-7">        context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size</span>
<span id="cb5-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>:</span>
<span id="cb5-9">            ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch]</span>
<span id="cb5-10">            X.append(context)</span>
<span id="cb5-11">            Y.append(ix)</span>
<span id="cb5-12">            context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> context[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [ix]</span>
<span id="cb5-13"></span>
<span id="cb5-14">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(X)</span>
<span id="cb5-15">    Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(Y)</span>
<span id="cb5-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(X.shape, Y.shape)</span>
<span id="cb5-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> X, Y</span>
<span id="cb5-18"></span>
<span id="cb5-19">n1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(words))</span>
<span id="cb5-20">n2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(words))</span>
<span id="cb5-21"></span>
<span id="cb5-22">Xtr, Ytr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[:n1])        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 80#</span></span>
<span id="cb5-23">Xdev, Ydev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[n1:n2])    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 10%</span></span>
<span id="cb5-24">Xte, Yte <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[n2:])        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 10%</span></span>
<span id="cb5-25"></span>
<span id="cb5-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># torch.Size([182625, 3]) torch.Size([182625])</span></span>
<span id="cb5-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># torch.Size([22655, 3]) torch.Size([22655])</span></span>
<span id="cb5-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># torch.Size([22866, 3]) torch.Size([22866])</span></span></code></pre></div>
</details>
</div>
</section>
<section id="input-and-response-preview" class="level4">
<h4 class="anchored" data-anchor-id="input-and-response-preview">input and response preview</h4>
<div id="f723bfb9" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> x, y <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(Xtr[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>], Ytr[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>]):</span>
<span id="cb6-2">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(itos[ix.item()] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ix <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> x), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'---&gt;'</span>, itos[y.item()])</span></code></pre></div>
</details>
</div>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb7-1">... ---&gt; y</span>
<span id="cb7-2">..y ---&gt; u</span>
<span id="cb7-3">.yu ---&gt; h</span>
<span id="cb7-4">yuh ---&gt; e</span>
<span id="cb7-5">uhe ---&gt; n</span>
<span id="cb7-6">hen ---&gt; g</span>
<span id="cb7-7">eng ---&gt; .</span>
<span id="cb7-8">... ---&gt; d</span>
<span id="cb7-9">..d ---&gt; i</span>
<span id="cb7-10">.di ---&gt; o</span>
<span id="cb7-11">dio ---&gt; n</span>
<span id="cb7-12">ion ---&gt; d</span>
<span id="cb7-13">ond ---&gt; r</span>
<span id="cb7-14">ndr ---&gt; e</span>
<span id="cb7-15">dre ---&gt; .</span>
<span id="cb7-16">... ---&gt; x</span>
<span id="cb7-17">..x ---&gt; a</span>
<span id="cb7-18">.xa ---&gt; v</span>
<span id="cb7-19">xav ---&gt; i</span>
<span id="cb7-20">avi ---&gt; e</span></code></pre></div>
</section>
<section id="initializing-objects-in-networks" class="level4">
<h4 class="anchored" data-anchor-id="initializing-objects-in-networks">initializing objects in networks</h4>
<p>Near copy paste of the layers we have developed in Part 3, I added some docstring to the classes.</p>
<section id="class-linear" class="level5">
<h5 class="anchored" data-anchor-id="class-linear">class <code>Linear</code></h5>
<div id="5557ffd8" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Linear:</span>
<span id="cb8-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""    </span></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Applies an affine linear transformation to the incoming data: y = xA^T + b.</span></span>
<span id="cb8-4"></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  This class implements a linear (fully connected) layer, which performs a linear </span></span>
<span id="cb8-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  transformation on the input tensor. It is typically used in neural network architectures </span></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  to transform input features between layers.</span></span>
<span id="cb8-8"></span>
<span id="cb8-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Args:</span></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      fan_in (int): Number of input features (input dimension).</span></span>
<span id="cb8-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      fan_out (int): Number of output features (output dimension).</span></span>
<span id="cb8-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      bias (bool, optional): Whether to include a learnable bias term. </span></span>
<span id="cb8-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">          Defaults to True.</span></span>
<span id="cb8-14"></span>
<span id="cb8-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Attributes:</span></span>
<span id="cb8-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      weight (torch.Tensor): Weight matrix of shape (fan_in, fan_out), </span></span>
<span id="cb8-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">          initialized using Kaiming initialization.</span></span>
<span id="cb8-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      bias (torch.Tensor or None): Bias vector of shape (fan_out), </span></span>
<span id="cb8-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">          initialized to zeros if bias is True, otherwise None.</span></span>
<span id="cb8-20"></span>
<span id="cb8-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Methods:</span></span>
<span id="cb8-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      __call__(x): Applies the linear transformation to the input tensor x.</span></span>
<span id="cb8-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      parameters(): Returns a list of trainable parameters (weight and bias).</span></span>
<span id="cb8-24"></span>
<span id="cb8-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Example:</span></span>
<span id="cb8-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      &gt;&gt;&gt; layer = Linear(10, 5)  # Creates a linear layer with 10 input features and 5 output features</span></span>
<span id="cb8-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      &gt;&gt;&gt; x = torch.randn(3, 10)  # Input tensor with batch size 3 and 10 features</span></span>
<span id="cb8-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      &gt;&gt;&gt; output = layer(x)  # Applies linear transformation</span></span>
<span id="cb8-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      &gt;&gt;&gt; output.shape</span></span>
<span id="cb8-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      torch.Size([3, 5])</span></span>
<span id="cb8-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  """</span></span>
<span id="cb8-32"></span>
<span id="cb8-33">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, fan_in, fan_out, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb8-34">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((fan_in, fan_out)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> fan_in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note: kaiming init</span></span>
<span id="cb8-35">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(fan_out) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> bias <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb8-36">  </span>
<span id="cb8-37">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb8-38">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.weight</span>
<span id="cb8-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb8-40">      <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias</span>
<span id="cb8-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out</span>
<span id="cb8-42">  </span>
<span id="cb8-43">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> parameters(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb8-44">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.weight] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ([] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias])</span></code></pre></div>
</details>
</div>
</section>
<section id="class-batchnorm1d" class="level5">
<h5 class="anchored" data-anchor-id="class-batchnorm1d">class <code>BatchNorm1d</code></h5>
<div id="47b91978" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> BatchNorm1d:</span>
<span id="cb9-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Applies Batch Normalization to the input tensor, a technique to improve </span></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  training stability and performance in deep neural networks.</span></span>
<span id="cb9-5"></span>
<span id="cb9-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Batch Normalization normalizes the input across the batch dimension, </span></span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  reducing internal covariate shift and allowing higher learning rates. </span></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  This implementation supports both training and inference modes.</span></span>
<span id="cb9-9"></span>
<span id="cb9-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Args:</span></span>
<span id="cb9-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      dim (int): Number of features or channels to be normalized.</span></span>
<span id="cb9-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      eps (float, optional): A small constant added to the denominator for </span></span>
<span id="cb9-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">          numerical stability to prevent division by zero. </span></span>
<span id="cb9-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">          Defaults to 1e-5.</span></span>
<span id="cb9-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      momentum (float, optional): Momentum for updating running mean and </span></span>
<span id="cb9-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">          variance during training. Controls the degree of exponential </span></span>
<span id="cb9-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">          moving average. Defaults to 0.1.</span></span>
<span id="cb9-18"></span>
<span id="cb9-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Attributes:</span></span>
<span id="cb9-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      eps (float): Epsilon value for numerical stability.</span></span>
<span id="cb9-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      momentum (float): Momentum for running statistics update.</span></span>
<span id="cb9-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      training (bool): Indicates whether the layer is in training or inference mode.</span></span>
<span id="cb9-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      gamma (torch.Tensor): Learnable scale parameter of shape (dim,).</span></span>
<span id="cb9-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      beta (torch.Tensor): Learnable shift parameter of shape (dim,).</span></span>
<span id="cb9-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      running_mean (torch.Tensor): Exponential moving average of batch means.</span></span>
<span id="cb9-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      running_var (torch.Tensor): Exponential moving average of batch variances.</span></span>
<span id="cb9-27"></span>
<span id="cb9-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Methods:</span></span>
<span id="cb9-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      __call__(x): Applies batch normalization to the input tensor.</span></span>
<span id="cb9-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      parameters(): Returns learnable parameters (gamma and beta).</span></span>
<span id="cb9-31"></span>
<span id="cb9-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Key Normalization Steps:</span></span>
<span id="cb9-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  1. Compute batch mean and variance (in training mode)</span></span>
<span id="cb9-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  2. Normalize input by subtracting mean and dividing by standard deviation</span></span>
<span id="cb9-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  3. Apply learnable scale (gamma) and shift (beta) parameters</span></span>
<span id="cb9-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  4. Update running statistics during training</span></span>
<span id="cb9-37"></span>
<span id="cb9-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Example:</span></span>
<span id="cb9-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      &gt;&gt;&gt; batch_norm = BatchNorm1d(64)  # For 64-channel input</span></span>
<span id="cb9-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      &gt;&gt;&gt; x = torch.randn(32, 64)  # Batch of 32 samples with 64 features</span></span>
<span id="cb9-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      &gt;&gt;&gt; normalized_x = batch_norm(x)  # Apply batch normalization</span></span>
<span id="cb9-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      &gt;&gt;&gt; normalized_x.shape</span></span>
<span id="cb9-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      torch.Size([32, 64])</span></span>
<span id="cb9-44"></span>
<span id="cb9-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Note:</span></span>
<span id="cb9-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      - Supports both 2D (batch, features) and 3D (batch, channels, sequence) input tensors</span></span>
<span id="cb9-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      - During inference, uses running statistics instead of batch statistics</span></span>
<span id="cb9-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  """</span></span>
<span id="cb9-49">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, dim, eps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span>, momentum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>):</span>
<span id="cb9-50">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.eps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> eps</span>
<span id="cb9-51">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.momentum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> momentum</span>
<span id="cb9-52">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.training <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb9-53">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># parameters (trained with backprop)</span></span>
<span id="cb9-54">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ones(dim)</span>
<span id="cb9-55">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(dim)</span>
<span id="cb9-56">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># buffers (trained with a running 'momentum update')</span></span>
<span id="cb9-57">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(dim)</span>
<span id="cb9-58">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ones(dim)</span>
<span id="cb9-59">  </span>
<span id="cb9-60">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb9-61">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calculate the forward pass</span></span>
<span id="cb9-62">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.training:</span>
<span id="cb9-63">      xmean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.mean(dim, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch mean</span></span>
<span id="cb9-64">      xvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.var(dim, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch variance</span></span>
<span id="cb9-65">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb9-66">      xmean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_mean</span>
<span id="cb9-67">      xvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_var</span>
<span id="cb9-68">    xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xmean) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> torch.sqrt(xvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.eps) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># normalize to unit variance</span></span>
<span id="cb9-69">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.beta</span>
<span id="cb9-70">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update the buffers</span></span>
<span id="cb9-71">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.training:</span>
<span id="cb9-72">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb9-73">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.momentum) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.momentum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> xmean</span>
<span id="cb9-74">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.momentum) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.momentum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> xvar</span>
<span id="cb9-75">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out</span>
<span id="cb9-76">  </span>
<span id="cb9-77">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> parameters(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb9-78">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gamma, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.beta]</span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="class-tanh" class="level4">
<h4 class="anchored" data-anchor-id="class-tanh">class <code>Tanh</code></h4>
<div id="02fd3e7d" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Tanh:</span>
<span id="cb10-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Hyperbolic Tangent (Tanh) Activation Function</span></span>
<span id="cb10-4"></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Applies the hyperbolic tangent activation function element-wise to the input tensor. </span></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Tanh maps input values to the range [-1, 1], providing a symmetric and non-linear </span></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    transformation that helps neural networks learn complex patterns.</span></span>
<span id="cb10-8"></span>
<span id="cb10-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Mathematical Definition:</span></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    tanh(x) = (e^x - e^-x) / (e^x + e^-x)</span></span>
<span id="cb10-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb10-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Key Characteristics:</span></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - Output Range: [-1, 1]</span></span>
<span id="cb10-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - Symmetric around the origin</span></span>
<span id="cb10-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - Gradient is always less than 1, which helps mitigate the vanishing gradient problem</span></span>
<span id="cb10-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - Commonly used in recurrent neural networks and hidden layers</span></span>
<span id="cb10-17"></span>
<span id="cb10-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Methods:</span></span>
<span id="cb10-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        __call__(x): Applies the Tanh activation to the input tensor.</span></span>
<span id="cb10-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        parameters(): Returns an empty list, as Tanh has no learnable parameters.</span></span>
<span id="cb10-21"></span>
<span id="cb10-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Attributes:</span></span>
<span id="cb10-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        out (torch.Tensor): Stores the output of the most recent forward pass.</span></span>
<span id="cb10-24"></span>
<span id="cb10-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Example:</span></span>
<span id="cb10-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        &gt;&gt;&gt; activation = Tanh()</span></span>
<span id="cb10-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        &gt;&gt;&gt; x = torch.tensor([-2.0, 0.0, 2.0])</span></span>
<span id="cb10-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        &gt;&gt;&gt; y = activation(x)</span></span>
<span id="cb10-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        &gt;&gt;&gt; y</span></span>
<span id="cb10-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        tensor([-0.9640, 0.0000, 0.9640])</span></span>
<span id="cb10-31"></span>
<span id="cb10-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Note:</span></span>
<span id="cb10-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        This implementation is stateless and does not modify the input tensor.</span></span>
<span id="cb10-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        The activation is applied element-wise, preserving the input tensor's shape.</span></span>
<span id="cb10-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb10-36"></span>
<span id="cb10-37">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb10-38">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(x)</span>
<span id="cb10-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out</span>
<span id="cb10-40"></span>
<span id="cb10-41">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> parameters(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb10-42">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> []</span></code></pre></div>
</details>
</div>
<section id="random-number-generator" class="level5">
<h5 class="anchored" data-anchor-id="random-number-generator">random number generator</h5>
<div id="9b15b200" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">torch.manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># seed rng for reproducibility</span></span></code></pre></div>
</details>
</div>
</section>
<section id="network-architecture" class="level5">
<h5 class="anchored" data-anchor-id="network-architecture">network architecture</h5>
<div id="dc0bd9d9" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># original network</span></span>
<span id="cb12-2">n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the dimensionality of the character embedding vectors</span></span>
<span id="cb12-3">n_hidden <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the number of neurons in the hidden layer of the MLP</span></span>
<span id="cb12-4"></span>
<span id="cb12-5">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.rand((vocab_size, n_embd))</span>
<span id="cb12-6">layers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb12-7">  Linear(n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>),</span>
<span id="cb12-8">  BatchNorm1d(n_hidden),</span>
<span id="cb12-9">  Tanh(),</span>
<span id="cb12-10">  Linear(n_hidden, vocab_size),</span>
<span id="cb12-11">]</span>
<span id="cb12-12"></span>
<span id="cb12-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># parameter init</span></span>
<span id="cb12-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb12-15">  layers[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># last layer make less confident</span></span>
<span id="cb12-16"></span>
<span id="cb12-17">parameters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [C] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [p <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layer.parameters()]</span>
<span id="cb12-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p.nelement() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of parameters in total</span></span>
<span id="cb12-19"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb12-20">  p.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb12-21"></span>
<span id="cb12-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># model params: 12097</span></span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="optimization" class="level4">
<h4 class="anchored" data-anchor-id="optimization">optimization</h4>
<div id="2bebbf1e" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># same optimization as last time</span></span>
<span id="cb13-2">max_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200000</span></span>
<span id="cb13-3">batch_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb13-4">lossi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb13-5"></span>
<span id="cb13-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(max_steps):</span>
<span id="cb13-7">  </span>
<span id="cb13-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minibatch construct</span></span>
<span id="cb13-9">  ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Xtr.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], (batch_size,))</span>
<span id="cb13-10">  Xb, Yb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Xtr[ix], Ytr[ix] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch X,Y</span></span>
<span id="cb13-11">  </span>
<span id="cb13-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass</span></span>
<span id="cb13-13">  emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xb] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># embed the characters into vectors   </span></span>
<span id="cb13-14">  x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># concatenate the vectors</span></span>
<span id="cb13-15">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers:</span>
<span id="cb13-16">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layer(x)</span>
<span id="cb13-17">  loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(x, Yb) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss function</span></span>
<span id="cb13-18">  </span>
<span id="cb13-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass</span></span>
<span id="cb13-20">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb13-21">    p.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb13-22">  loss.backward()</span>
<span id="cb13-23">  </span>
<span id="cb13-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update: simple SGD</span></span>
<span id="cb13-25">  lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150000</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># step learning rate decay</span></span>
<span id="cb13-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb13-27">    p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p.grad</span>
<span id="cb13-28"></span>
<span id="cb13-29">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># track stats</span></span>
<span id="cb13-30">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print every once in a while</span></span>
<span id="cb13-31">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:7d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>max_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:7d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb13-32">  lossi.append(loss.log10().item())</span></code></pre></div>
</details>
</div>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb14-1"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">     0/ 200000: 3.2885</span></span>
<span id="cb14-2">  10000/ 200000: 2.3938</span>
<span id="cb14-3">  20000/ 200000: 2.1235</span>
<span id="cb14-4">  30000/ 200000: 1.9222</span>
<span id="cb14-5">  40000/ 200000: 2.2440</span>
<span id="cb14-6">  50000/ 200000: 2.1108</span>
<span id="cb14-7">  60000/ 200000: 2.0624</span>
<span id="cb14-8">  70000/ 200000: 2.0893</span>
<span id="cb14-9">  80000/ 200000: 2.4173</span>
<span id="cb14-10">  90000/ 200000: 1.9744</span>
<span id="cb14-11"> 100000/ 200000: 2.0883</span>
<span id="cb14-12"> 110000/ 200000: 2.4538</span>
<span id="cb14-13"> 120000/ 200000: 1.9535</span>
<span id="cb14-14"> 130000/ 200000: 1.8980</span>
<span id="cb14-15"> 140000/ 200000: 2.1196</span>
<span id="cb14-16"> 150000/ 200000: 2.3550</span>
<span id="cb14-17"> 160000/ 200000: 2.2957</span>
<span id="cb14-18"> 170000/ 200000: 2.0286</span>
<span id="cb14-19"> 180000/ 200000: 2.2379</span>
<span id="cb14-20"> 190000/ 200000: 2.3866</span></code></pre></div>
</section>
<section id="observe-training-processevaluation" class="level4">
<h4 class="anchored" data-anchor-id="observe-training-processevaluation">observe training process/evaluation</h4>
<div id="da90737f" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1">plt.plot(lossi)</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-09-nn-z2h-p6/1_pre_lossi.png" class="img-fluid figure-img"></p>
<figcaption><code>lossi</code> plot at the beginning</figcaption>
</figure>
</div>
</section>
<section id="calibrate-the-batchnorm-after-training" class="level4">
<h4 class="anchored" data-anchor-id="calibrate-the-batchnorm-after-training">calibrate the <code>batchnorm</code> after training</h4>
<p>We should be using the running mean/variance of the whole dataset splits rather than the last mini-batch.</p>
<div id="6ed190bf" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># put layers into eval mode (needed for batchnorm especially)</span></span>
<span id="cb16-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> model.layers:</span>
<span id="cb16-3">  layer.training <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span></code></pre></div>
</details>
</div>
</section>
<section id="calculate-on-whole-training-and-validation-splits" class="level4">
<h4 class="anchored" data-anchor-id="calculate-on-whole-training-and-validation-splits">calculate on whole training and validation splits</h4>
<div id="9fb248a8" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># evaluate the loss</span></span>
<span id="cb17-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@torch.no_grad</span>() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this decorator disables gradient tracking inside pytorch</span></span>
<span id="cb17-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> split_loss(split):</span>
<span id="cb17-4">  x,y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb17-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>: (Xtr, Ytr),</span>
<span id="cb17-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val'</span>: (Xdev, Ydev),</span>
<span id="cb17-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>: (Xte, Yte),</span>
<span id="cb17-8">  }[split]</span>
<span id="cb17-9">  logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model(x)</span>
<span id="cb17-10">  loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, y)</span>
<span id="cb17-11">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(split, loss.item())</span>
<span id="cb17-12"></span>
<span id="cb17-13">split_loss(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>)</span>
<span id="cb17-14">split_loss(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val'</span>)</span></code></pre></div>
</details>
</div>
<p>Pretty loss but there are still room for improve:</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb18-1">train 2.0467958450317383</span>
<span id="cb18-2">val 2.0989298820495605</span></code></pre></div>
</section>
<section id="sample-from-the-model" class="level4">
<h4 class="anchored" data-anchor-id="sample-from-the-model">sample from the model</h4>
<p>Here are Names generated by the model till now, we have relatively name-like results that do not exist in the training set.</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb19-1">liz.</span>
<span id="cb19-2">layah.</span>
<span id="cb19-3">dan.</span>
<span id="cb19-4">hilon.</span>
<span id="cb19-5">avani.</span>
<span id="cb19-6">korron.</span>
<span id="cb19-7">aua.</span>
<span id="cb19-8">noon.</span>
<span id="cb19-9">bethalyn.</span>
<span id="cb19-10">thia.</span>
<span id="cb19-11">bote.</span>
<span id="cb19-12">jereanail.</span>
<span id="cb19-13">vitorien.</span>
<span id="cb19-14">zarashivonna.</span>
<span id="cb19-15">yakurrren.</span>
<span id="cb19-16">jovon.</span>
<span id="cb19-17">malynn.</span>
<span id="cb19-18">vanna.</span>
<span id="cb19-19">caparmana.</span>
<span id="cb19-20">shantymonse.</span></code></pre></div>
</section>
</section>
<section id="lets-fix-the-learning-rate-plot" class="level2">
<h2 class="anchored" data-anchor-id="lets-fix-the-learning-rate-plot">let‚Äôs fix the learning rate plot</h2>
<p>The plot for <code>lossi</code> looks very crazy, it‚Äôs because the batch size of 32 is way too few so this time we got lucky, and next time we got unlucky. And the mini-batch loss splashed too much. We should probably fix it.</p>
<p>We pivot to a row for every 1000 observations of <code>lossi</code> and calculate the mean, we end up have 200 observations which is easier to see.</p>
<div id="26addc8b" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1">plt.plot(torch.tensor(lossi).view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>).mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
</details>
</div>
<p>We can also observe the learning rate decay at 150k training loops.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-09-nn-z2h-p6/2_enhance_lossi.png" class="img-fluid figure-img"></p>
<figcaption><code>lossi</code> plot fixed</figcaption>
</figure>
</div>
</section>
<section id="pytorchifying-our-code-layers-containers-torch.nn-fun-bugs" class="level2">
<h2 class="anchored" data-anchor-id="pytorchifying-our-code-layers-containers-torch.nn-fun-bugs">pytorchifying our code: layers, containers, <code>torch.nn</code>, fun bugs</h2>
<p>Now we notice that we still have the embedding operation lying outside the pytorch-ified layers. It basically creating a lookup table <code>C</code>, embedding it with our data <code>Y</code> (or <code>Yb</code>), then stretching out to row with <code>view()</code> which is very cheap in PyTorch as no more memory creation is needed.</p>
<p>We modulize this by constructing 2 classes:</p>
<div id="5c3a864e" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Embedding:</span>
<span id="cb21-2">  </span>
<span id="cb21-3">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, num_embeddings, embedding_dim):</span>
<span id="cb21-4">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((num_embeddings, embedding_dim))</span>
<span id="cb21-5">    </span>
<span id="cb21-6">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, IX):</span>
<span id="cb21-7">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.weight[IX]</span>
<span id="cb21-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out</span>
<span id="cb21-9">  </span>
<span id="cb21-10">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> parameters(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb21-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.weight]</span>
<span id="cb21-12"></span>
<span id="cb21-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -----------------------------------------------------------------------------------------------</span></span>
<span id="cb21-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Flatten:</span>
<span id="cb21-15"></span>
<span id="cb21-16">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb21-17">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.view(x.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb21-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out</span>
<span id="cb21-19">  </span>
<span id="cb21-20">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> parameters(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb21-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> []</span></code></pre></div>
</details>
</div>
<p>Now we can re-define the <code>layers</code> like this:</p>
<div id="35de4af3" class="cell" data-execution_count="18">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1">layers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb22-2">  Embedding(vocab_size, n_embd),</span>
<span id="cb22-3">  Flatten(),</span>
<span id="cb22-4">  Linear(n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>),</span>
<span id="cb22-5">  BatchNorm1d(n_hidden),</span>
<span id="cb22-6">  Tanh(),</span>
<span id="cb22-7">  Linear(n_hidden, vocab_size),</span>
<span id="cb22-8">]</span></code></pre></div>
</details>
</div>
<p>and also remove the <code>C</code>, <code>emb</code> definition in the forward pass construction. Going futher, we will be not only pytorchifying the elements of <code>layers</code> only, but also the <code>layers</code> itself. In PyTorch, we have term <code>containers</code>, which specifying how we organize the layers in a network. And what are we doing here is constructing layers sequentially, which is equivalent to <code>Sequential</code> in the <code>containers</code>:</p>
<div id="d2bdc1c8" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Sequential:</span>
<span id="cb23-2">  </span>
<span id="cb23-3">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, layers):</span>
<span id="cb23-4">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.layers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layers</span>
<span id="cb23-5">  </span>
<span id="cb23-6">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb23-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.layers:</span>
<span id="cb23-8">      x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layer(x)</span>
<span id="cb23-9">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x</span>
<span id="cb23-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out</span>
<span id="cb23-11">  </span>
<span id="cb23-12">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> parameters(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb23-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get parameters of all layers and stretch them out into one list</span></span>
<span id="cb23-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> [p <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.layers <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layer.parameters()]</span></code></pre></div>
</details>
</div>
<p>and wrapp the layers into our <code>model</code>:</p>
<div id="44bc2bff" class="cell" data-execution_count="20">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Sequential([</span>
<span id="cb24-2">  Embedding(vocab_size, n_embd),</span>
<span id="cb24-3">  Flatten(),</span>
<span id="cb24-4">  Linear(n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>),</span>
<span id="cb24-5">  BatchNorm1d(n_hidden),</span>
<span id="cb24-6">  Tanh(),</span>
<span id="cb24-7">  Linear(n_hidden, vocab_size),</span>
<span id="cb24-8">])</span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="implementing-wavenet" class="level1">
<h1>2 implementing <code>WaveNet</code></h1>
<p>So far with the classical MLP following Bengio et al.&nbsp;(2003), we have a <em>embedding layer</em> followed by a <em>hidden layer</em> and end up with a <em>activation layer</em>. Although we added more layer after the embedding, we could not make a significant progress.</p>
<p>The problem is we dont have a <strong>naive way</strong> of making the model bigger in a productive way. We are still in the case that we crushing all the characters into a single all the way at the begining. And even if we make this a bigger layer and add neurons it‚Äôs still like silly to squash all that information so fast into a single step.</p>
<section id="overview-wavenet" class="level2">
<h2 class="anchored" data-anchor-id="overview-wavenet">overview: <code>WaveNet</code></h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-09-nn-z2h-p6/fig3_wavenet.png" class="img-fluid figure-img"></p>
<figcaption>Visualization of the <code>WaveNet</code> idea - Progressive Fusion</figcaption>
</figure>
</div>
</section>
<section id="dataset-bump-the-context-size-to-8" class="level2">
<h2 class="anchored" data-anchor-id="dataset-bump-the-context-size-to-8">dataset bump the context size to 8</h2>
<p>first we change the <code>block_size</code> into <code>8</code> and now our dataset looks like:</p>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb25-1">........ ---&gt; y</span>
<span id="cb25-2">.......y ---&gt; u</span>
<span id="cb25-3">......yu ---&gt; h</span>
<span id="cb25-4">.....yuh ---&gt; e</span>
<span id="cb25-5">....yuhe ---&gt; n</span>
<span id="cb25-6">...yuhen ---&gt; g</span>
<span id="cb25-7">..yuheng ---&gt; .</span>
<span id="cb25-8">........ ---&gt; d</span>
<span id="cb25-9">.......d ---&gt; i</span>
<span id="cb25-10">......di ---&gt; o</span>
<span id="cb25-11">.....dio ---&gt; n</span>
<span id="cb25-12">....dion ---&gt; d</span>
<span id="cb25-13">...diond ---&gt; r</span>
<span id="cb25-14">..diondr ---&gt; e</span>
<span id="cb25-15">.diondre ---&gt; .</span>
<span id="cb25-16">........ ---&gt; x</span>
<span id="cb25-17">.......x ---&gt; a</span>
<span id="cb25-18">......xa ---&gt; v</span>
<span id="cb25-19">.....xav ---&gt; i</span>
<span id="cb25-20">....xavi ---&gt; e</span></code></pre></div>
<p>The model size now bumps up to 22k.</p>
</section>
<section id="re-running-baseline-code-on-block_size-8" class="level2">
<h2 class="anchored" data-anchor-id="re-running-baseline-code-on-block_size-8">re-running baseline code on <code>block_size = 8</code></h2>
<p>Just by lazily extending the context size to 8, we can already improve the model a little bit, the loss on validation split now is around <code>2.045</code>. The names generated now look prettier:</p>
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb26-1">zamari.</span>
<span id="cb26-2">brennis.</span>
<span id="cb26-3">shavia.</span>
<span id="cb26-4">wililke.</span>
<span id="cb26-5">obalyid.</span>
<span id="cb26-6">leenoluja.</span>
<span id="cb26-7">rianny.</span>
<span id="cb26-8">jordanoe.</span>
<span id="cb26-9">yuvalfue.</span>
<span id="cb26-10">ozleega.</span>
<span id="cb26-11">jemirene.</span>
<span id="cb26-12">polton.</span>
<span id="cb26-13">jawi.</span>
<span id="cb26-14">meyah.</span>
<span id="cb26-15">gekiniq.</span>
<span id="cb26-16">angelinne.</span>
<span id="cb26-17">tayler.</span>
<span id="cb26-18">catrician.</span>
<span id="cb26-19">kyearie.</span>
<span id="cb26-20">anderias.</span></code></pre></div>
<p>Let‚Äôs deem this as a baseline then we can start to implement <code>WaveNet</code> and see how far we can go!</p>
</section>
<section id="implementing-wavenet-1" class="level2">
<h2 class="anchored" data-anchor-id="implementing-wavenet-1">implementing <code>WaveNet</code></h2>
<p>First, let‚Äôs revisit the shape of the tensors along the way of the forward pass in our neural net:</p>
<div id="add830ca" class="cell" data-execution_count="21">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Look at a batch of just 4 examples</span></span>
<span id="cb27-2">ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Xtr.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,))</span>
<span id="cb27-3">Xb, Yb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Xtr[ix], Ytr[ix]</span>
<span id="cb27-4">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model(Xb)</span>
<span id="cb27-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(Xb.shape)</span>
<span id="cb27-6">Xb</span>
<span id="cb27-7"></span>
<span id="cb27-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; torch.Size([4, 8]) # because the context length is now 8</span></span>
<span id="cb27-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; tensor([[ 0,  0,  0,  0,  0,  0, 13,  9],</span></span>
<span id="cb27-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         [ 0,  0,  0,  0,  0,  0,  0,  0],</span></span>
<span id="cb27-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         [ 0,  0,  0, 11,  5, 18, 15, 12],</span></span>
<span id="cb27-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         [ 0,  0,  4, 15, 13,  9, 14,  9]])</span></span>
<span id="cb27-13"></span>
<span id="cb27-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Output of the embedding layer, each input is translated</span></span>
<span id="cb27-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to 10 dimensional vector</span></span>
<span id="cb27-16">model.layers[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].out.shape</span>
<span id="cb27-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; torch.Size([4, 8, 10])</span></span>
<span id="cb27-18"></span>
<span id="cb27-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Output of Flatten layer, each 10-dim vector is concatenated</span></span>
<span id="cb27-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to each other for all 8-dim context vectors</span></span>
<span id="cb27-21">model.layers[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].out.shape</span>
<span id="cb27-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; torch.Size([4, 80])</span></span>
<span id="cb27-23"></span>
<span id="cb27-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Output of the Linear layer, take 80 and create 200 channels,</span></span>
<span id="cb27-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># just via matrix mult</span></span>
<span id="cb27-26">model.layers[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>].out.shape</span>
<span id="cb27-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; torch.Size([4, 200])</span></span></code></pre></div>
</details>
</div>
<p>Now look into the Linear layer, which take the input <code>x</code> in the forward pass, multiply by <code>weight</code> and add the <code>bias</code> in (there is broadcasting here). So the transformation in this layer looks like:</p>
<div id="9f9b90c8" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1">(torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)).shape</span>
<span id="cb28-2"></span>
<span id="cb28-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; torch.Size([4, 200])</span></span></code></pre></div>
</details>
</div>
<p>Input <code>x</code> matrix here does not need to be 2 dimensional array. The matrix multiplication in PyTorch is quite powerfull, you can pass more than 2 dimensional array. And all dimensions will be preserved except the last one. Like this:</p>
<div id="2ce7af19" class="cell" data-execution_count="23">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1">(torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)).shape</span>
<span id="cb29-2"></span>
<span id="cb29-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; torch.Size([4, 5, 200])</span></span></code></pre></div>
</details>
</div>
<p>Which we want to improve now is not just flatten the 8 characters input too fast at the beginning, we want to group them pair by pair to process them in parallel.</p>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb30-1">(x1 x2) (x3 x4) (x5 x6) (x7 x8)</span></code></pre></div>
<p>Particularly for 8 characters block size we want to divide it into 4 groups ~ 4 pair of <em>bigrams</em>. We are increasing <strong>the dimensions of the batch</strong>.</p>
<div id="79b033d0" class="cell" data-execution_count="24">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1">(torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)).shape</span>
<span id="cb31-2"></span>
<span id="cb31-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; torch.Size([4, 4, 200])</span></span></code></pre></div>
</details>
</div>
<p>How can we achieve this in PyTorch, we can index the odd and even indexes then pair them up.</p>
<div id="158ed936" class="cell" data-execution_count="25">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1">e <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4 examples, 8 chars context size, 10-d embedding</span></span>
<span id="cb32-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># goal: want this to be (4, 4, 20) where consecutive 10-d vectors get concatenated</span></span>
<span id="cb32-3"></span>
<span id="cb32-4">explicit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cat([e[:, ::<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, :], e[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>::<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, :]], dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># cat in the third dim</span></span>
<span id="cb32-5">explicit.shape </span>
<span id="cb32-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; torch.Size([4, 4, 20])</span></span></code></pre></div>
</details>
</div>
<p>Of course, PyTorch provide a more efficient way to do this, using <code>view()</code>:</p>
<div id="31c1a763" class="cell" data-execution_count="26">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1">(e.view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> explicit).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>()</span>
<span id="cb33-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; tensor(True)</span></span></code></pre></div>
</details>
</div>
<p>We are going to modulize the <code>FlattenConsecutive</code>:</p>
<div id="b97f2bd7" class="cell" data-execution_count="27">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> FlattenConsecutive:</span>
<span id="cb34-2">  </span>
<span id="cb34-3">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, n):</span>
<span id="cb34-4">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n</span>
<span id="cb34-5">    </span>
<span id="cb34-6">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb34-7">    B, T, C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.shape</span>
<span id="cb34-8">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.view(B, T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n, C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n)</span>
<span id="cb34-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> x.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># spurious tensor, if it's 1, squeeze it</span></span>
<span id="cb34-10">      x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.squeeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb34-11">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x</span>
<span id="cb34-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out</span>
<span id="cb34-13">  </span>
<span id="cb34-14">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> parameters(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb34-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> []</span></code></pre></div>
</details>
</div>
<p>and update the flatten layer to <code>FlattenConsecutive(block_size)</code> (8) in our <code>model</code>. We can observe the dimension of tensors in all layers:</p>
<div id="22b61dcd" class="cell" data-execution_count="28">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> model.layers:</span>
<span id="cb35-2">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(layer.__class__.<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">": "</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(layer.out.shape))</span>
<span id="cb35-3"></span>
<span id="cb35-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Embedding :  (4, 8, 10)</span></span>
<span id="cb35-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Flatten :  (4, 80)</span></span>
<span id="cb35-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Linear :  (4, 200)</span></span>
<span id="cb35-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BatchNorm1d :  (4, 200)</span></span>
<span id="cb35-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tanh :  (4, 200)</span></span>
<span id="cb35-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Linear :  (4, 27)</span></span></code></pre></div>
</details>
</div>
<p>This is what we have currently. But as said, we dont want to flatten too fast, so we gonna flatten by 2 character, here is the update of the <code>model</code> - 3 layers present the consecutive flatten <code>4 -&gt; 2 -&gt; 1</code>:</p>
<div id="5a4b2f0c" class="cell" data-execution_count="29">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb36-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Sequential([</span>
<span id="cb36-2">  Embedding(vocab_size, n_embd),</span>
<span id="cb36-3">  FlattenConsecutive(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), Linear(n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(n_hidden), Tanh(),</span>
<span id="cb36-4">  FlattenConsecutive(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), Linear(n_hidden<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(n_hidden), Tanh(),</span>
<span id="cb36-5">  FlattenConsecutive(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), Linear(n_hidden<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(n_hidden), Tanh(),</span>
<span id="cb36-6">  Linear(n_hidden, vocab_size),</span>
<span id="cb36-7">])</span></code></pre></div>
</details>
</div>
<p>and here is tensors dimension flowing in forward pass:</p>
<div class="sourceCode" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb37-1"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Embedding :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (4, 8, 10)</span></span>
<span id="cb37-2"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">FlattenConsecutive :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (4, 4, 20)</span></span>
<span id="cb37-3"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Linear :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (4, 4, 200)</span></span>
<span id="cb37-4"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">BatchNorm1d :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (4, 4, 200)</span></span>
<span id="cb37-5"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Tanh :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (4, 4, 200)</span></span>
<span id="cb37-6"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">FlattenConsecutive :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (4, 2, 400)</span></span>
<span id="cb37-7"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Linear :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (4, 2, 200)</span></span>
<span id="cb37-8"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">BatchNorm1d :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (4, 2, 200)</span></span>
<span id="cb37-9"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Tanh :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (4, 2, 200)</span></span>
<span id="cb37-10"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">FlattenConsecutive :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (4, 400)</span></span>
<span id="cb37-11"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Linear :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (4, 200)</span></span>
<span id="cb37-12"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">BatchNorm1d :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (4, 200)</span></span>
<span id="cb37-13"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Tanh :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (4, 200)</span></span>
<span id="cb37-14"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Linear :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (4, 27)</span></span></code></pre></div>
<p>That‚Äôs is, we have successfully implemented the <code>WaveNet</code>.</p>
</section>
<section id="training-the-wavenet-first-pass" class="level2">
<h2 class="anchored" data-anchor-id="training-the-wavenet-first-pass">training the <code>WaveNet</code>: first pass</h2>
<p>Now assume we use the same size of network (number of neurons), let‚Äôs see if the <code>loss</code> can be improved. We change the <code>n_hidden = 68</code>, so that the total parameters of our network remain 22k. Below is update tensor dims for a batch (32):</p>
<div class="sourceCode" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb38-1"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Embedding :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (32, 8, 10)</span></span>
<span id="cb38-2"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">FlattenConsecutive :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (32, 4, 20)</span></span>
<span id="cb38-3"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Linear :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (32, 4, 68)</span></span>
<span id="cb38-4"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">BatchNorm1d :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (32, 4, 68)</span></span>
<span id="cb38-5"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Tanh :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (32, 4, 68)</span></span>
<span id="cb38-6"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">FlattenConsecutive :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (32, 2, 136)</span></span>
<span id="cb38-7"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Linear :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (32, 2, 68)</span></span>
<span id="cb38-8"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">BatchNorm1d :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (32, 2, 68)</span></span>
<span id="cb38-9"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Tanh :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (32, 2, 68)</span></span>
<span id="cb38-10"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">FlattenConsecutive :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (32, 136)</span></span>
<span id="cb38-11"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Linear :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (32, 68)</span></span>
<span id="cb38-12"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">BatchNorm1d :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (32, 68)</span></span>
<span id="cb38-13"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Tanh :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (32, 68)</span></span>
<span id="cb38-14"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Linear :</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  (32, 27)</span></span></code></pre></div>
<p>It turns out that we got almost identical result. There are 2 things:</p>
<ol type="1">
<li>We just constructed the architecture of <code>WaveNet</code> but not tortured the model enough to find best set of hyperparameters; and</li>
<li>We may have a bug in <code>BatchNorm1d</code> layer, let‚Äôs take a look into this.</li>
</ol>
</section>
<section id="fixing-batchnorm1d-bug" class="level2">
<h2 class="anchored" data-anchor-id="fixing-batchnorm1d-bug">fixing <code>batchnorm1d</code> bug</h2>
<p>Let‚Äôs look at the <code>BatchNorm1d</code> happen in the first flatten layer:</p>
<div id="caf5b82c" class="cell" data-execution_count="30">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1">e <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> , <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">68</span>)</span>
<span id="cb39-2">emean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> e.mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1, 4, 68</span></span>
<span id="cb39-3">evar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> e.var(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1, 4, 68</span></span>
<span id="cb39-4"></span>
<span id="cb39-5">ehat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (e <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> emean) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> torch.sqrt(evar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span>)</span>
<span id="cb39-6">ehat.shape</span>
<span id="cb39-7"></span>
<span id="cb39-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; torch.Size([32, 4, 68])</span></span></code></pre></div>
</details>
</div>
<p>For <code>ehat</code>, everything is calculated properly, mean and variance are calculated to the batch and the 2nd dim <code>4</code> is preserved. But for the <code>running_mean</code>:</p>
<div id="4be097e7" class="cell" data-execution_count="31">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1">model.layers[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>].running_mean.shape</span>
<span id="cb40-2"></span>
<span id="cb40-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; torch.Size([1, 4, 68])</span></span></code></pre></div>
</details>
</div>
<p>We see it is (1, 4, 68) while we are expected it‚Äôs 1 dimensional only which is defined in the init method (<code>torch.zeros(dim)</code>). We are maintaining the batch norm in parallel over 4 x 68 channels individually and independently instead of just 68 channels. We want to treat this <code>4</code> just like a batch norm dimension, ie everaging of <code>32 * 4</code> numbers for 68 channels. Fortunately PyTorch <code>mean()</code> method offer the reducing dimension not only for integer but also tuple.</p>
<div id="35a55976" class="cell" data-execution_count="32">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb41-1">e <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> , <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">68</span>)</span>
<span id="cb41-2">emean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> e.mean((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), keepdim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1, 1, 68</span></span>
<span id="cb41-3">evar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> e.var((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), keepdim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1, 1, 68</span></span>
<span id="cb41-4"></span>
<span id="cb41-5">ehat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (e <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> emean) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> torch.sqrt(evar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span>)</span>
<span id="cb41-6">ehat.shape</span>
<span id="cb41-7"></span>
<span id="cb41-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; torch.Size([32, 4, 68])</span></span>
<span id="cb41-9"></span>
<span id="cb41-10">model.layers[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>].running_mean.shape</span>
<span id="cb41-11"></span>
<span id="cb41-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; torch.Size([1, 1, 68])</span></span></code></pre></div>
</details>
</div>
<p>We now modify the <code>BatchNorm1d</code> definition accordingly, only the training mean/var in the <code>__call__</code> method:</p>
<div id="074709a9" class="cell" data-execution_count="33">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- remains the same</span></span>
<span id="cb42-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb42-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calculate the forward pass</span></span>
<span id="cb42-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.training:</span>
<span id="cb42-5">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> x.ndim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:</span>
<span id="cb42-6">        dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb42-7">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">elif</span> x.ndim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>:</span>
<span id="cb42-8">        dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb42-9">      xmean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.mean(dim, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch mean</span></span>
<span id="cb42-10">      xvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.var(dim, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch variance</span></span>
<span id="cb42-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb42-12">      xmean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_mean</span>
<span id="cb42-13">      xvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_var</span>
<span id="cb42-14">    xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xmean) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> torch.sqrt(xvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.eps) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># normalize to unit variance</span></span>
<span id="cb42-15">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.beta</span>
<span id="cb42-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- remaind the same</span></span></code></pre></div>
</details>
</div>
</section>
<section id="re-training-wavenet-with-bug-fix" class="level2">
<h2 class="anchored" data-anchor-id="re-training-wavenet-with-bug-fix">re-training <code>WaveNet</code> with bug fix</h2>
<p>Now retraining the network with bug fixed, we obtain a slightly better loss of <code>2.022</code>. We just fixed the normalization term inside the network so they did not thrush too much so a little improvement only is expected.</p>
</section>
<section id="scaling-up-our-wavenet" class="level2">
<h2 class="anchored" data-anchor-id="scaling-up-our-wavenet">scaling up our <code>WaveNet</code></h2>
<p>Now we‚Äôre ready to scale up our network and retrain everything, the model now have roughly 76k paramters. We finally passed the <code>2.0</code> threshold and achieved the loss of <code>1.99</code> on the validation split.</p>
<div id="bd4775e3" class="cell" data-execution_count="34">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1">n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span></span>
<span id="cb43-2">n_hidden <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span></code></pre></div>
</details>
</div>
<p>And here is final loss plot:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-09-nn-z2h-p6/final_lossi.png" class="img-fluid figure-img"></p>
<figcaption><code>lossi</code> final</figcaption>
</figure>
</div>
</section>
</section>
<section id="conclusions" class="level1">
<h1>3 conclusions</h1>
<section id="performance-log" class="level2">
<h2 class="anchored" data-anchor-id="performance-log">performance log</h2>
<table class="table-striped table-hover table">
<caption>Loss logs</caption>
<colgroup>
<col style="width: 10%">
<col style="width: 40%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>What we did</th>
<th>Loss we got (accum)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>original (3 character context + 200 hidden neurons, 12K params)</td>
<td><p>train 2.0467958450317383</p>
<p>val 2.0989298820495605</p></td>
</tr>
<tr class="even">
<td>2</td>
<td>context: 3 -&gt; 8 (22K params)</td>
<td><p>train 1.9028635025024414</p>
<p>val 2.044949769973755</p></td>
</tr>
<tr class="odd">
<td>3</td>
<td>flat -&gt; hierarchical (22K params)</td>
<td><p>train 1.9366059303283691</p>
<p>val 2.017268419265747</p></td>
</tr>
<tr class="even">
<td>4</td>
<td>fix bug in <code>batchnorm1d</code></td>
<td><p>train 1.9156142473220825</p>
<p>val 2.0228867530822754</p></td>
</tr>
<tr class="odd">
<td>5</td>
<td>scale up the network: <code>n_embd</code> 24, <code>n_hidden</code> 128 (76K params)</td>
<td><p>train 1.7680459022521973</p>
<p>val 1.994154691696167</p></td>
</tr>
</tbody>
</table>
</section>
<section id="experimental-harness" class="level2">
<h2 class="anchored" data-anchor-id="experimental-harness">experimental harness</h2>
<p>The ‚Äúharness‚Äù metaphor is apt because it‚Äôs like a structured support system that allows researchers to systematically explore and optimize neural network configurations, much like a harness helps guide and support an athlete during training.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>An experimental harness typically includes several key components:</p>
<ol type="1">
<li>Hyperparameter Search Space Definition: This involves specifying the range of hyperparameters to be explored, such as:</li>
</ol>
<ul>
<li>Learning rates</li>
<li>Batch sizes</li>
<li>Network architecture depths</li>
<li>Activation functions</li>
<li>Regularization techniques</li>
<li>Dropout rates</li>
</ul>
<ol start="2" type="1">
<li>Search Strategy: Methods for exploring the hyperparameter space, which can include:</li>
</ol>
<ul>
<li>Grid search</li>
<li>Random search</li>
<li>Bayesian optimization</li>
<li>Evolutionary algorithms</li>
<li>Gradient-based optimization techniques</li>
</ul>
<ol start="3" type="1">
<li>Evaluation Metrics: Predefined metrics to assess model performance, such as:</li>
</ol>
<ul>
<li>Validation accuracy</li>
<li>Loss function values</li>
<li>Precision and recall</li>
<li>F1 score</li>
<li>Computational efficiency</li>
</ul>
<ol start="4" type="1">
<li>Automated Experiment Management: Tools and scripts that can:</li>
</ol>
<ul>
<li>Automatically generate and run different model configurations</li>
<li>Log results</li>
<li>Track experiments</li>
<li>Compare performance across different hyperparameter settings</li>
</ul>
<ol start="5" type="1">
<li>Reproducibility Mechanisms: Ensuring that experiments can be repeated and validated, which includes:</li>
</ol>
<ul>
<li>Fixed random seeds</li>
<li>Consistent data splitting</li>
<li>Versioning of datasets and configurations</li>
</ul>
</div>
</div>
</section>
<section id="wavenet-but-with-dilated-causal-convolutions" class="level2">
<h2 class="anchored" data-anchor-id="wavenet-but-with-dilated-causal-convolutions"><code>WaveNet</code> but with ‚Äúdilated causal convolutions‚Äù</h2>
<ul>
<li>Convolution is a ‚Äúfor loop‚Äù applying a linear filter over space of some input sequence;</li>
<li>Not happen only in Python but also in Kernel</li>
</ul>
</section>
<section id="torch.nn" class="level2">
<h2 class="anchored" data-anchor-id="torch.nn"><code>torch.nn</code></h2>
<p>We have implement alot of concepts in <code>torch.nn</code>:</p>
<ul>
<li>containers: <code>Sequential</code></li>
<li><code>Linear</code>, <code>BatchNorm1d</code>, <code>Tanh</code>, <code>FlattenConsecutive</code>, ‚Ä¶</li>
</ul>
</section>
<section id="the-development-process-of-building-deep-neural-nets-going-forward" class="level2">
<h2 class="anchored" data-anchor-id="the-development-process-of-building-deep-neural-nets-going-forward">the development process of building deep neural nets &amp; going forward</h2>
<ul>
<li>Spending a ton of time exploring PyTorch documentation, unfortunately it‚Äôs not a good one;</li>
<li>Ton of time to make the shapes work: fan in, fan out, NLC or NLC, broadcasting, viewing, etc;</li>
<li>What we:
<ul>
<li>done: implemented dilated causal convoluntional network;</li>
<li>to be explores: residual and skip connections;</li>
<li>to be explores: experimental harness;</li>
<li>more mordern networks: RNN, LSTM, Transformer.</li>
</ul></li>
</ul>
</section>
</section>
<section id="resources" class="level1">
<h1>4 resources</h1>
<ol type="1">
<li>WaveNet 2016 from DeepMind: <a href="https://arxiv.org/abs/1609.03499" class="uri">https://arxiv.org/abs/1609.03499</a>;</li>
<li>Bengio et al.&nbsp;2003 MLP LM: <a href="https://www.jmlr.org/papers/volume3/bengio03a/bengio03a.pdf" class="uri">https://www.jmlr.org/papers/volume3/bengio03a/bengio03a.pdf</a>;</li>
<li>Notebook: <a href="https://github.com/karpathy/nn-zero-to-hero/blob/master/lectures/makemore/makemore_part5_cnn1.ipynb" class="uri">https://github.com/karpathy/nn-zero-to-hero/blob/master/lectures/makemore/makemore_part5_cnn1.ipynb</a>;</li>
<li>DeepMind‚Äôs blog post from 2016: <a href="https://deepmind.google/discover/blog/wavenet-a-generative-model-for-raw-audio/" class="uri">https://deepmind.google/discover/blog/wavenet-a-generative-model-for-raw-audio/</a></li>
</ol>


<!-- -->

</section>

 ]]></description>
  <category>til</category>
  <category>python</category>
  <category>andrej karpathy</category>
  <category>nn-z2h</category>
  <category>neural networks</category>
  <guid>https://lktuan.github.io/blog/2024-12-09-nn-z2h-p6/</guid>
  <pubDate>Sun, 08 Dec 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-12-09-nn-z2h-p6/wavenet.png" medium="image" type="image/png" height="73" width="144"/>
</item>
<item>
  <title>Advanced SQL</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-12-06-adv_sql/</link>
  <description><![CDATA[ <p>This is my note/workaround for the article ‚Äú<a href="https://www.startdataengineering.com/post/n-sql-tips-de/">25 SQL tips to level up your data engineering skills</a>‚Äù by Start Data Engineering, authored by <a href="https://github.com/josephmachado">Joseph Machado</a>.</p>
<section id="setup" class="level1"><h1>setup</h1>
<p>Joseph provided a ready-to-go project regarding this advanced SQL transformation topics in this <a href="https://github.com/josephmachado/adv_data_transformation_in_sql">repo</a> using <strong>DuckDB</strong> in <strong>Jupyter Notebook</strong>. We can either run it in the Github codespace or in our local machine with minimal setup.</p>
<p>We use the TPC-H database for demonstration:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/sample-data-tpch-schema.png" class="img-fluid figure-img"></p>
<figcaption>The TPC-H Schema, source: <a href="https://www.tpc.org/tpc_documents_current_versions/pdf/tpc-h_v2.17.1.pdf">TPC Benchmark H Standard Specification</a></figcaption></figure>
</div>
</section><section id="handy-functions-for-data-wrangling" class="level1"><h1>#1 handy functions for data wrangling</h1>
<section id="qualify" class="level2"><h2 class="anchored" data-anchor-id="qualify">#1.1 <code>QUALIFY</code>
</h2>
<p>We use <code>QUALIFY</code> to filter the output column of <code>WINDOW</code> function without creating more CTEs/Subqueries. It‚Äôs not available in many traditional/on-prem RDBMS (MySQL, Oracle, MSSQL, PostgreSQL) but available in mordern/cloud-based databases (Snowflake, BigQuery, Databricks, MS Fabric, Teradata).</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span></span>
<span id="cb1-2">    o_orderkey, </span>
<span id="cb1-3">    o_totalprice, </span>
<span id="cb1-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RANK</span>() <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">OVER</span> (<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ORDER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> o_totalprice <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">DESC</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> price_rank <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- rank the order by `o_totalprice` in desc</span></span>
<span id="cb1-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders</span>
<span id="cb1-6">QUALIFY price_rank <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>; <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- filter top 10</span></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/* would need a CTE or Sub-query without QUALIFY */</span></span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/1_qualify.png" class="img-fluid figure-img"></p>
<figcaption>output - first 10 rows</figcaption></figure>
</div>
</section><section id="distinct-on" class="level2"><h2 class="anchored" data-anchor-id="distinct-on">#1.2 <code>DISTINCT ON</code>
</h2>
<p>Orginated from PostgreSQL, now support by some cloud-based like Snowflake but not in MySQL, SQL Server, Oracle, <code>DISTINCT ON</code> allows us to get 1 detailed row (first or last) for a particular partition.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">DISTINCT</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ON</span> (o_custkey) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- distinct only `o_custkey`</span></span>
<span id="cb2-2">    o_custkey, </span>
<span id="cb2-3">    o_orderdate, </span>
<span id="cb2-4">    o_totalprice</span>
<span id="cb2-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders</span>
<span id="cb2-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ORDER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> o_custkey, o_orderdate <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">DESC</span>; <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- make sure to get the latest order by `o_orderdate`</span></span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/2_distinct_on.png" class="img-fluid figure-img"></p>
<figcaption>output - first 10 rows</figcaption></figure>
</div>
</section><section id="this-can-also-be-done-with-row_number-qualify" class="level2"><h2 class="anchored" data-anchor-id="this-can-also-be-done-with-row_number-qualify">#1.3 This can also be done with <code>ROW_NUMBER()</code> + <code>QUALIFY</code>:</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> </span>
<span id="cb3-2">    o_custkey, </span>
<span id="cb3-3">    o_orderdate, </span>
<span id="cb3-4">    o_totalprice,</span>
<span id="cb3-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ROW_NUMBER</span>() <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">OVER</span> (<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">PARTITION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> o_custkey <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ORDER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> o_orderdate <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">DESC</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> rn</span>
<span id="cb3-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders</span>
<span id="cb3-7">QUALIFY rn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ORDER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> o_custkey <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">DESC</span>; <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- ROW_NUMBER() shuffle the order of the data</span></span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/3_rn_qualify.png" class="img-fluid figure-img"></p>
<figcaption>output - first 10 rows</figcaption></figure>
</div>
</section><section id="struct_pack" class="level2"><h2 class="anchored" data-anchor-id="struct_pack">#1.4 <code>STRUCT_PACK()</code>
</h2>
<p><code>STRUCT_PACK()</code> is a function primarily associated with DuckDB:</p>
<ul>
<li>Creates a compact, binary representation of multiple values;</li>
<li>Allows you to pack different data types into a single column;</li>
<li>Useful for data compression and efficient storage.</li>
</ul>
<p>Below picture depicts how struct works:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/struck_pack.png" class="img-fluid figure-img"></p>
<figcaption>struct packing</figcaption></figure>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">WITH</span> order_struct <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> (</span>
<span id="cb4-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> </span>
<span id="cb4-3">        o_orderkey,</span>
<span id="cb4-4">        STRUCT_PACK(o_orderdate, o_totalprice, o_orderkey) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> order_info</span>
<span id="cb4-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders</span>
<span id="cb4-6">)</span>
<span id="cb4-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> </span>
<span id="cb4-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MIN</span>(order_info) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> min_order_date, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- get min of information from left to right</span></span>
<span id="cb4-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MAX</span>(order_info) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> max_order_date_price <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- get of information from left to right, </span></span>
<span id="cb4-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- if there are many txn in that latest day, get the transaction with max price</span></span>
<span id="cb4-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> order_struct;</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/4_struct.png" class="img-fluid figure-img"></p>
<figcaption>output</figcaption></figure>
</div>
</section><section id="bool_or-bool_and" class="level2"><h2 class="anchored" data-anchor-id="bool_or-bool_and">#1.5 <code>BOOL_OR()</code> &amp; <code>BOOL_AND()</code>
</h2>
<p><code>BOOL_OR()</code> &amp; <code>BOOL_AND()</code> allows you to check a logical statement along all rows of a columns, supported in PostgreSQL, Snowflake, DuckDB, BigQuery, Databricks:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> </span>
<span id="cb5-2">    o_custkey, </span>
<span id="cb5-3">    BOOL_OR(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cast</span>(o_shippriority <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">as</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">boolean</span>)) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> has_atleast_one_priority_order, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- check whether AT LEAST 1 order of that customer has Is Priority = True</span></span>
<span id="cb5-4">    BOOL_AND(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cast</span>(o_shippriority <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">as</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">boolean</span>)) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> has_all_priority_order <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- check whether ALL orders of that customer has Is Priority = True</span></span>
<span id="cb5-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders</span>
<span id="cb5-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">GROUP</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> o_custkey;</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/5_bool_or_and.png" class="img-fluid figure-img"></p>
<figcaption>output - first 10 rows</figcaption></figure>
</div>
</section><section id="exclude" class="level2"><h2 class="anchored" data-anchor-id="exclude">#1.6 <code>EXCLUDE()</code>
</h2>
<p>When you want to select all (<code>*</code>) columns excet few ones:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> EXCLUDE (o_orderdate, o_totalprice)</span>
<span id="cb6-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders;</span></code></pre></div>
</details>
</div>
</section><section id="group-by-all-saves-the-day" class="level2"><h2 class="anchored" data-anchor-id="group-by-all-saves-the-day">#1.7 <code>GROUP BY ALL</code> saves the day</h2>
<p>Repeating all the columns listed in the <code>SELECT</code> statement in <code>GROUP BY</code> is annoying, just use <code>ALL</code>:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> </span>
<span id="cb7-2">    o_orderkey, </span>
<span id="cb7-3">    o_custkey, </span>
<span id="cb7-4">    o_orderstatus, </span>
<span id="cb7-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SUM</span>(o_totalprice) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> total_price</span>
<span id="cb7-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders</span>
<span id="cb7-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">GROUP</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span>;</span></code></pre></div>
</details>
</div>
</section><section id="count_if" class="level2"><h2 class="anchored" data-anchor-id="count_if">#1.8 <code>COUNT_IF()</code>
</h2>
<p>Filter over rows in specific column:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> </span>
<span id="cb8-2">    o_custkey, </span>
<span id="cb8-3">    COUNT_IF(o_totalprice <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100000</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> high_value_orders, </span>
<span id="cb8-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- equivalent to SUM(CASE WHEN o_totalprice &gt; 100000 THEN 1 ELSE 0 </span><span class="re">END</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb8-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">COUNT</span>(o_totalprice) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">as</span> all_orders</span>
<span id="cb8-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders</span>
<span id="cb8-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">GROUP</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> o_custkey;</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/8_count_if.png" class="img-fluid figure-img"></p>
<figcaption>output - first 10 rows</figcaption></figure>
</div>
</section><section id="string_agg" class="level2"><h2 class="anchored" data-anchor-id="string_agg">#1.9 <code>STRING_AGG()</code>
</h2>
<p>Concatenate rows of string in a <code>GROUP BY</code> statement:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> STRING_AGG(c_name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> customer_names</span>
<span id="cb9-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> customer;</span></code></pre></div>
</details>
</div>
</section><section id="null-handling-with-coalesce" class="level2"><h2 class="anchored" data-anchor-id="null-handling-with-coalesce">#1.10 Null handling with <code>COALESCE()</code>
</h2>
<p>Handling null value in a column with value from another column or default value:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">WITH</span> fake_orders <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> (</span>
<span id="cb10-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> o_orderkey, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> o_totalprice, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">NULL</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> discount</span>
<span id="cb10-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb10-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> o_orderkey, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> o_totalprice, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> discount</span>
<span id="cb10-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb10-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> o_orderkey, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> o_totalprice, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">NULL</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> discount</span>
<span id="cb10-7">)</span>
<span id="cb10-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> </span>
<span id="cb10-9">    o_orderkey, </span>
<span id="cb10-10">    o_totalprice, </span>
<span id="cb10-11">    discount,</span>
<span id="cb10-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">COALESCE</span>(discount, o_totalprice <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.10</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> final_discount</span>
<span id="cb10-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> fake_orders;</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/10_coalesce.png" class="img-fluid figure-img"></p>
<figcaption>output</figcaption></figure>
</div>
</section><section id="generate_series" class="level2"><h2 class="anchored" data-anchor-id="generate_series">#1.11 <code>GENERATE_SERIES()</code>
</h2>
<p>This helps you generate a sequence/series of data over a range with an interval which facilitating data simulation or joining with other tables.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb11-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> generate_series(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>);</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/11a_gen.png" class="img-fluid figure-img"></p>
<figcaption>output</figcaption></figure>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb12-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> generate_series(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2024-01-01'</span>:<span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">:DATE</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2024-01-10'</span>:<span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">:DATE</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">INTERVAL</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DAY</span>);</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/11b_gen.png" class="img-fluid figure-img"></p>
<figcaption>output</figcaption></figure>
</div>
</section><section id="unnest" class="level2"><h2 class="anchored" data-anchor-id="unnest">#1.12 <code>UNNEST()</code>
</h2>
<p>Unpacking data wrapped in JSON array or list <code>[...]</code> using <code>UNNEST()</code>:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">WITH</span> nested_data <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> (</span>
<span id="cb13-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">id</span>, [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">values</span></span>
<span id="cb13-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb13-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">id</span>, [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">values</span></span>
<span id="cb13-5">)</span>
<span id="cb13-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> </span>
<span id="cb13-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">id</span>, </span>
<span id="cb13-8">    UNNEST(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">values</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> flattened_value</span>
<span id="cb13-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> nested_data;</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/12_unnest.png" class="img-fluid figure-img"></p>
<figcaption>output</figcaption></figure>
</div>
</section></section><section id="set-operations" class="level1"><h1>#2 <code>SET</code> operations</h1>
<section id="exists" class="level2"><h2 class="anchored" data-anchor-id="exists">#2.1 <code>EXISTS</code>
</h2>
<p><code>EXISTS</code> is used to test for the existence of rows in a subquery, return TRUE if any row in the subquery returned. I think it‚Äôs often used for logic check to correlate queries.</p>
<p>It checks the existence like <code>INNER JOIN</code> but does not join full rows or select columns from the subquery.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> </span>
<span id="cb14-2">    c_custkey, </span>
<span id="cb14-3">    c_name</span>
<span id="cb14-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> customer </span>
<span id="cb14-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">WHERE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">EXISTS</span> (</span>
<span id="cb14-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> o_orderkey</span>
<span id="cb14-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders</span>
<span id="cb14-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">WHERE</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb14-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- AND o_totalprice &gt; 5000000 -- Return customer who has at least 1 order with total price &gt; 500k</span></span>
<span id="cb14-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AND</span> o_custkey <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> c_custkey  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- Return customer who has at least 1 order</span></span>
<span id="cb14-11">);</span></code></pre></div>
</details>
</div>
</section><section id="intersect" class="level2"><h2 class="anchored" data-anchor-id="intersect">#2.2 <code>INTERSECT</code>
</h2>
<p>Below query return all <code>c_custkey</code> that appears in both <code>customer</code> and <code>orders</code> table.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> c_custkey </span>
<span id="cb15-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> customer</span>
<span id="cb15-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">INTERSECT</span></span>
<span id="cb15-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> o_custkey </span>
<span id="cb15-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders;</span></code></pre></div>
</details>
</div>
</section><section id="except" class="level2"><h2 class="anchored" data-anchor-id="except">#2.3 <code>EXCEPT</code>
</h2>
<p>And the below query return all <code>c_custkey</code> that appears <code>customer</code> <strong>but not in</strong> <code>orders</code> table.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> c_custkey</span>
<span id="cb16-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> customer</span>
<span id="cb16-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">EXCEPT</span></span>
<span id="cb16-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> o_custkey</span>
<span id="cb16-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders;</span></code></pre></div>
</details>
</div>
<p>Using this, we can perform delta/data diff checking!</p>
</section></section><section id="macros" class="level1"><h1>#3 macros</h1>
<p>We can create UDF (User Define Function) or Macros in SQL for abstracting complex logic and reusing it in different parts of the query, this improves both readability and maintainability. When executing, the macros are expanded inline, which avoids the overhead of function calls. Below is a simple function/macro:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">CREATE</span> MACRO percentage(numerator, denominator) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> (</span>
<span id="cb17-2">    (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CAST</span>(numerator <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DOUBLE</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CAST</span>(denominator <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DOUBLE</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb17-3">);</span></code></pre></div>
</details>
</div>
</section><section id="jinja2" class="level1"><h1>#4 jinja2</h1>
<blockquote class="blockquote">
<p><a href="https://pypi.org/project/Jinja2/">Jinja</a> is a fast, expressive, extensible templating engine.</p>
</blockquote>
<p>In data engineering, Jinja2 is widely used in:</p>
<ul>
<li>
<p>DBT (Data Build Tool)</p>
<ul>
<li>Template SQL transformations</li>
<li>Parameterize database queries</li>
<li>Dynamic model generation</li>
</ul>
</li>
<li>
<p>Airflow</p>
<ul>
<li>Dynamic DAG (Directed Acyclic Graph) generation</li>
<li>Parameterize task configurations</li>
</ul>
</li>
<li>
<p>Great Expectations</p>
<ul>
<li>Configure data validation rules</li>
<li>Generate dynamic expectations</li>
</ul>
</li>
</ul>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> jinja2 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Template</span>
<span id="cb18-2"></span>
<span id="cb18-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define a Jinja2 SQL template with a loop</span></span>
<span id="cb18-4">sql_template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb18-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">SELECT o_orderkey, o_custkey, o_totalprice</span></span>
<span id="cb18-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">FROM orders</span></span>
<span id="cb18-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">WHERE o_totalprice &gt; </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> price_threshold </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span></span>
<span id="cb18-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">{</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">% i</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">f customer_keys %}</span></span>
<span id="cb18-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  AND o_custkey IN (</span></span>
<span id="cb18-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    {</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">% f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">or custkey in customer_keys %}</span></span>
<span id="cb18-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> custkey </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">{</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">% i</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">f not loop.last %}, {</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">% e</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">ndif %}</span></span>
<span id="cb18-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    {</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">% e</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">ndfor %}</span></span>
<span id="cb18-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  )</span></span>
<span id="cb18-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">{</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">% e</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">ndif %}</span></span>
<span id="cb18-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">ORDER BY o_totalprice DESC;</span></span>
<span id="cb18-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb18-17"></span>
<span id="cb18-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Render the template with dynamic parameters</span></span>
<span id="cb18-19">template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Template(sql_template)</span>
<span id="cb18-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters to be passed to the template</span></span>
<span id="cb18-21">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb18-22">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"price_threshold"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20000</span>,</span>
<span id="cb18-23">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"customer_keys"</span>: [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1001</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1002</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1003</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># A list of customer keys to filter on</span></span>
<span id="cb18-24">}</span>
<span id="cb18-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Render the SQL query (do not execute, just generate SQL)</span></span>
<span id="cb18-26">rendered_sql <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> template.render(params)</span>
<span id="cb18-27"></span>
<span id="cb18-28"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(rendered_sql)</span></code></pre></div>
</details>
</div>
<p>And the query be generated:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb19-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> o_orderkey, o_custkey, o_totalprice</span>
<span id="cb19-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders</span>
<span id="cb19-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">WHERE</span> o_totalprice <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20000</span></span>
<span id="cb19-4"></span>
<span id="cb19-5">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AND</span> o_custkey <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">IN</span> (</span>
<span id="cb19-6">    </span>
<span id="cb19-7">      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1001</span>, </span>
<span id="cb19-8">    </span>
<span id="cb19-9">      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1002</span>, </span>
<span id="cb19-10">    </span>
<span id="cb19-11">      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1003</span></span>
<span id="cb19-12">    </span>
<span id="cb19-13">  )</span>
<span id="cb19-14"></span>
<span id="cb19-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ORDER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> o_totalprice <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">DESC</span>;</span></code></pre></div>
</details>
</div>
</section><section id="metadata" class="level1"><h1>#5 metadata</h1>
<p>The database documentation is normally stored in the <code>information_schema</code>, the first schema that created in DB:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- Information about our tables are stored here</span></span>
<span id="cb20-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> schema_name,</span>
<span id="cb20-3">    view_name</span>
<span id="cb20-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> duckdb_views();</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/information_schema.png" class="img-fluid figure-img"></p>
<figcaption>output - first 10 rows</figcaption></figure>
</div>
<p>Dive into the table <code>tables</code>:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb21-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span></span>
<span id="cb21-2">table_catalog, table_schema, table_name </span>
<span id="cb21-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">from</span> information_schema.<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">tables</span>;</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/information_schema_table.png" class="img-fluid figure-img"></p>
<figcaption>output - first 10 rows</figcaption></figure>
</div>
<p>Other useful query for DB admin in DuckDB:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- database level settings</span></span>
<span id="cb22-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> duckdb_settings();</span>
<span id="cb22-3"></span>
<span id="cb22-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- list of all tables in our DuckDB </span></span>
<span id="cb22-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> schema_name,</span>
<span id="cb22-6">    table_name</span>
<span id="cb22-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> duckdb_tables();</span></code></pre></div>
</details>
</div>
</section><section id="de-duplicate" class="level1"><h1>#6 de-duplicate</h1>
<p>We can use UPSERT (or MERGE INTO) - INsert new data and UPdate existing data. The syntaxes vary among DBs:</p>
<ul>
<li>PostgreSQL: <code>INSERT ... ON CONFLICT</code>
</li>
<li>MySQL: <code>INSERT ... ON DUPLICATE KEY UPDATE</code>
</li>
<li>SQLite: <code>INSERT OR REPLACE</code>
</li>
<li>SQL Server: <code>MERGE</code> statement</li>
<li>Oracle: <code>MERGE</code> statement</li>
</ul>
<p>For eg., in DuckDB:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb23-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">DROP</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">TABLE</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">IF</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">EXISTS</span> dim_customer_scd2;</span>
<span id="cb23-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- Create a Slowly Changing Dimension (SCD Type 2) table for customer</span></span>
<span id="cb23-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">CREATE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">TABLE</span> dim_customer_scd2 (</span>
<span id="cb23-4">    c_custkey <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">INTEGER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">PRIMARY</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">KEY</span>,</span>
<span id="cb23-5">    c_name <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">VARCHAR</span>,</span>
<span id="cb23-6">    c_address <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">VARCHAR</span>,</span>
<span id="cb23-7">    c_nationkey <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">INTEGER</span>,</span>
<span id="cb23-8">    c_phone <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">VARCHAR</span>,</span>
<span id="cb23-9">    c_acctbal <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DOUBLE</span>,</span>
<span id="cb23-10">    c_mktsegment <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">VARCHAR</span>,</span>
<span id="cb23-11">    c_comment <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">VARCHAR</span>,</span>
<span id="cb23-12">    valid_from <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DATE</span>,</span>
<span id="cb23-13">    valid_to <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">DATE</span>,</span>
<span id="cb23-14">    is_current <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">BOOLEAN</span></span>
<span id="cb23-15">);</span>
<span id="cb23-16"></span>
<span id="cb23-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- Insert current data from the TPCH customer table into the SCD2 table</span></span>
<span id="cb23-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">INSERT</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">INTO</span> dim_customer_scd2</span>
<span id="cb23-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> </span>
<span id="cb23-20">    c_custkey, </span>
<span id="cb23-21">    c_name, </span>
<span id="cb23-22">    c_address, </span>
<span id="cb23-23">    c_nationkey, </span>
<span id="cb23-24">    c_phone, </span>
<span id="cb23-25">    c_acctbal, </span>
<span id="cb23-26">    c_mktsegment, </span>
<span id="cb23-27">    c_comment,</span>
<span id="cb23-28">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2024-10-17'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> valid_from,</span>
<span id="cb23-29">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">NULL</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> valid_to,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- NULL means it's the current active record</span></span>
<span id="cb23-30">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">TRUE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> is_current</span>
<span id="cb23-31"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> customer;</span></code></pre></div>
</details>
</div>
<p>This query create a new SCD2 table and UPSERT data into it. When managing a table, we can handle (INSERT or UPDATE) like this:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb24-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">INSERT</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">INTO</span> dim_customer_scd2 (</span>
<span id="cb24-2">    c_custkey, </span>
<span id="cb24-3">    c_name, </span>
<span id="cb24-4">    c_address, </span>
<span id="cb24-5">    c_nationkey, </span>
<span id="cb24-6">    c_phone, </span>
<span id="cb24-7">    c_acctbal, </span>
<span id="cb24-8">    c_mktsegment, </span>
<span id="cb24-9">    c_comment, </span>
<span id="cb24-10">    valid_from, </span>
<span id="cb24-11">    valid_to, </span>
<span id="cb24-12">    is_current</span>
<span id="cb24-13">)</span>
<span id="cb24-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">VALUES</span></span>
<span id="cb24-15">    (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Customer#000000001'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'New Address 1'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'25-989-741-2988'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">711.56</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'BUILDING'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'comment1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2024-10-18'</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">NULL</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb24-16">    (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Customer#000000002'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'New Address 2'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'12-423-790-3665'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">879.49</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'FURNITURE'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'comment2'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2024-10-18'</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">NULL</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb24-17">    (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1501</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Customer#000001501'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'New Address 1501'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'11-345-678-9012'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">500.50</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MACHINERY'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'comment1501'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2024-10-18'</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">NULL</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb24-18">    (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1502</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Customer#000001502'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'New Address 1502'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'22-456-789-0123'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">600.75</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AUTOMOBILE'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'comment1502'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2024-10-18'</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">NULL</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb24-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ON</span> CONFLICT (c_custkey) DO </span>
<span id="cb24-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-- Handle existing customers (Customer#000000001 and Customer#000000002) for SCD Type 2</span></span>
<span id="cb24-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UPDATE</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SET</span> valid_to <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EXCLUDED.valid_from, is_current <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb24-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">WHERE</span> dim_customer_scd2.c_custkey <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EXCLUDED.c_custkey <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AND</span> dim_customer_scd2.is_current <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">TRUE</span>;</span></code></pre></div>
</details>
</div>
</section><section id="joins-that-youve-never-ever-seen-before" class="level1"><h1>#7 <code>JOIN</code>s that you‚Äôve never ever seen before</h1>
<section id="asof-join" class="level2"><h2 class="anchored" data-anchor-id="asof-join">#7.1 <code>ASOF JOIN</code>
</h2>
<p>An ASOF JOIN (As-Of Join) is a time-series specific join operation that matches rows based on the closest timestamp, typically used in financial and time-series data analysis.</p>
<ul>
<li>
<p>Key characteristics:</p>
<ul>
<li>Matches each row from one table to the most recent row in another table by time</li>
<li>Useful for tracking historical state changes</li>
<li>Common in financial databases and time-series analysis</li>
</ul>
</li>
<li>
<p>Example use case:</p>
<ul>
<li>Joining stock prices with trading orders</li>
<li>Matching historical prices at the nearest timestamp</li>
<li>Tracking changes in reference data over time</li>
</ul>
</li>
</ul>
<p>For eg. ‚Äú<strong>give me the value of the property as of this time</strong>‚Äù:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb25-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">WITH</span> stock_prices <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> (</span>
<span id="cb25-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'APPL'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> ticker, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:00:00'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">"when"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> price</span>
<span id="cb25-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'APPL'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:01:00'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb25-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'APPL'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:02:00'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb25-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MSFT'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:00:00'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb25-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MSFT'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:01:00'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb25-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MSFT'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:02:00'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb25-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GOOG'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:00:00'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb25-15">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-16">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GOOG'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:01:00'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb25-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-18">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GOOG'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:02:00'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb25-19">),</span>
<span id="cb25-20">portfolio_holdings <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> (</span>
<span id="cb25-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'APPL'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> ticker, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2000-12-31 23:59:30'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">"when"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.16</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> shares</span>
<span id="cb25-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-23">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'APPL'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:00:30'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.94</span></span>
<span id="cb25-24">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-25">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'APPL'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:01:30'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">24.13</span></span>
<span id="cb25-26">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-27">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GOOG'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2000-12-31 23:59:30'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9.33</span></span>
<span id="cb25-28">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-29">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GOOG'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:00:30'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">23.45</span></span>
<span id="cb25-30">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-31">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GOOG'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:01:30'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.58</span></span>
<span id="cb25-32">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-33">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DATA'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2000-12-31 23:59:30'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.65</span></span>
<span id="cb25-34">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-35">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DATA'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:00:30'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">17.95</span></span>
<span id="cb25-36">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">UNION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ALL</span></span>
<span id="cb25-37">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DATA'</span>, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">TIMESTAMP</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2001-01-01 00:01:30'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">18.37</span></span>
<span id="cb25-38">)</span>
<span id="cb25-39"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> h.ticker,</span>
<span id="cb25-40">    h.<span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">when</span>,</span>
<span id="cb25-41">    p.<span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">when</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">as</span> stock_price_ts,</span>
<span id="cb25-42">    price,</span>
<span id="cb25-43">    shares,</span>
<span id="cb25-44">    price <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> shares <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">value</span></span>
<span id="cb25-45"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> portfolio_holdings h</span>
<span id="cb25-46">ASOF <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">JOIN</span> stock_prices p</span>
<span id="cb25-47">       <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ON</span> h.ticker <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p.ticker</span>
<span id="cb25-48">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AND</span> h.<span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">when</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> p.<span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">when</span></span>
<span id="cb25-49"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ORDER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>;</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/asof_join.png" class="img-fluid figure-img"></p>
<figcaption>output</figcaption></figure>
</div>
<p>Without <code>ASOF JOIN</code>, we must use a WINDOW function to achieve this.</p>
</section><section id="anti-join" class="level2"><h2 class="anchored" data-anchor-id="anti-join">#7.2 <code>ANTI JOIN</code>
</h2>
<p>The pattern is to get rows in one table that are not in another table:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb26-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> c.c_custkey</span>
<span id="cb26-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> customer c</span>
<span id="cb26-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">LEFT</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">JOIN</span> orders o</span>
<span id="cb26-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ON</span> c.c_custkey <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o.o_custkey</span>
<span id="cb26-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">WHERE</span> o.o_custkey <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">IS</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb26-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ORDER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> c.c_custkey</span>
<span id="cb26-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">LIMIT</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>;</span></code></pre></div>
</details>
</div>
<p>Some DBs have native support for <code>ANTI JOIN</code>:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb27-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> c.c_custkey</span>
<span id="cb27-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> customer c</span>
<span id="cb27-3">ANTI <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">JOIN</span> orders o</span>
<span id="cb27-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ON</span> c.c_custkey <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o.o_custkey</span>
<span id="cb27-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ORDER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> c.c_custkey</span>
<span id="cb27-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">LIMIT</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>;</span></code></pre></div>
</details>
</div>
</section><section id="lateral-join" class="level2"><h2 class="anchored" data-anchor-id="lateral-join">#7.3 <code>LATERAL JOIN</code>
</h2>
<p>LATERAL JOIN is a powerful SQL join type that allows a subquery in the FROM clause to reference columns from preceding tables in the same FROM clause.</p>
<ul>
<li>Enables per-row dynamic subqueries</li>
<li>Allows correlated subqueries in the FROM clause</li>
<li>Supported in PostgreSQL, BigQuery, some other modern databases</li>
</ul>
<p>For e.g, for each row in the orders table (<code>o</code>), the subquery in the LATERAL JOIN selects line items (<code>l</code>) that match certain conditions.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb28-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> </span>
<span id="cb28-2">    o.o_orderkey, </span>
<span id="cb28-3">    o.o_totalprice, </span>
<span id="cb28-4">    l.l_linenumber,</span>
<span id="cb28-5">    l.l_extendedprice</span>
<span id="cb28-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders o,</span>
<span id="cb28-7">LATERAL (</span>
<span id="cb28-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> l.l_linenumber,</span>
<span id="cb28-9">    l_extendedprice</span>
<span id="cb28-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> lineitem l</span>
<span id="cb28-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">WHERE</span> l.l_orderkey <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o.o_orderkey</span>
<span id="cb28-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AND</span> l.l_linenumber <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb28-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AND</span> l.l_extendedprice <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> (o.o_totalprice <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb28-14">) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> l</span>
<span id="cb28-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ORDER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>;</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/lateral_join_1.png" class="img-fluid figure-img"></p>
<figcaption>output - first 10 rows</figcaption></figure>
</div>
<p>For each row in the orders table (<code>o</code>), the subquery in the LATERAL JOIN counts the number of line items (<code>lineitem_count</code>) related to that order.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb29-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> </span>
<span id="cb29-2">    o.o_orderkey, </span>
<span id="cb29-3">    o.o_totalprice, </span>
<span id="cb29-4">    l.lineitem_count</span>
<span id="cb29-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders o,</span>
<span id="cb29-6">LATERAL (</span>
<span id="cb29-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">COUNT</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> lineitem_count</span>
<span id="cb29-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> lineitem l</span>
<span id="cb29-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">WHERE</span> l.l_orderkey <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o.o_orderkey</span>
<span id="cb29-10">) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> l;</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/lateral_join_2.png" class="img-fluid figure-img"></p>
<figcaption>output - first 10 rows</figcaption></figure>
</div>
</section></section><section id="use-cases" class="level1"><h1>#8 use cases</h1>
<p>Some real business use cases:</p>
<section id="pivot" class="level2"><h2 class="anchored" data-anchor-id="pivot">#8.1 <code>PIVOT</code>
</h2>
<p>We often want to change a value of a column into individual columns, we can use <code>CASE ... WHEN ...</code>:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb30-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> </span>
<span id="cb30-2">    o_custkey,</span>
<span id="cb30-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SUM</span>(<span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">CASE</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">WHEN</span> o_orderstatus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'F'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">THEN</span> o_totalprice <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">ELSE</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">END</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> fulfilled_total,</span>
<span id="cb30-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SUM</span>(<span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">CASE</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">WHEN</span> o_orderstatus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">THEN</span> o_totalprice <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">ELSE</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">END</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> open_total,</span>
<span id="cb30-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SUM</span>(<span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">CASE</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">WHEN</span> o_orderstatus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'P'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">THEN</span> o_totalprice <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">ELSE</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">END</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> pending_total</span>
<span id="cb30-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders</span>
<span id="cb30-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">GROUP</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> o_custkey</span>
<span id="cb30-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ORDER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> o_custkey;</span></code></pre></div>
</details>
</div>
<p>But also leverage <code>PIVOT</code>:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb31-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders</span>
<span id="cb31-2">PIVOT (</span>
<span id="cb31-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(o_totalprice)</span>
<span id="cb31-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">FOR</span></span>
<span id="cb31-5">        o_orderstatus <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">IN</span> (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'F'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'O'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'P'</span>)</span>
<span id="cb31-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">GROUP</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> o_custkey</span>
<span id="cb31-7">)</span>
<span id="cb31-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ORDER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> o_custkey;</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/pivot.png" class="img-fluid figure-img"></p>
<figcaption>output - first 10 rows</figcaption></figure>
</div>
</section><section id="cube" class="level2"><h2 class="anchored" data-anchor-id="cube">#8.1 <code>CUBE</code>
</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb32-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">SELECT</span> </span>
<span id="cb32-2">    o_orderpriority,</span>
<span id="cb32-3">    o_orderstatus,</span>
<span id="cb32-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">EXTRACT</span>(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">YEAR</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> o_orderdate) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> order_year,</span>
<span id="cb32-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SUM</span>(o_totalprice) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">AS</span> total_sales</span>
<span id="cb32-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">FROM</span> orders</span>
<span id="cb32-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">GROUP</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">CUBE</span> (o_orderpriority, o_orderstatus, order_year)</span>
<span id="cb32-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">ORDER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">BY</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>;</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://lktuan.github.io/blog/2024-12-06-adv_sql/cube.png" class="img-fluid figure-img"></p>
<figcaption>output - first 10 rows</figcaption></figure>
</div>
<ul>
<li>
<code>CUBE (o_custkey, o_orderstatus, order_year)</code>: This will group the data and calculate subtotals and grand totals for all possible combinations of <code>o_custkey</code>, <code>o_orderstatus</code>, and <code>order_year</code>.</li>
<li>It will generate all combinations of the grouping columns, including:
<ul>
<li>Grouping by just o_custkey</li>
<li>Grouping by just o_orderstatus</li>
<li>Grouping by just order_year</li>
<li>Grouping by all three together</li>
<li>Grouping by pairs of columns</li>
<li>A grand total (no grouping by any column)</li>
<li>
<code>SUM(o_totalprice)</code>: For each combination of groupings, it sums the total order price.</li>
</ul>
</li>
</ul>
<p>Use cases:</p>
<blockquote class="blockquote">
<ol type="1">
<li>OLAP Reporting: CUBE is commonly used in OLAP scenarios where you need to analyze data from multiple perspectives. For instance, you may want to generate reports that show total sales by customer, by order status, by year, and all possible combinations of these dimensions.</li>
<li>Sales Analysis: In sales analysis, CUBE can help create pivot-like summaries that show how different attributes (e.g., region, product, time period) contribute to the overall sales.</li>
<li>Financial Reports: Financial departments often use CUBE to calculate totals and subtotals across dimensions like departments, time periods, and account categories, making it easier to prepare comprehensive financial reports.</li>
</ol>
</blockquote>
<p>Happy learning!</p>
</section></section><section id="resource" class="level1"><h1>resource</h1>
<ol type="1">
<li>Article by Start Data Engineering: <a href="https://www.startdataengineering.com/post/n-sql-tips-de/" class="uri">https://www.startdataengineering.com/post/n-sql-tips-de/</a>;</li>
<li>Repo and workbook: <a href="https://github.com/josephmachado/adv_data_transformation_in_sql/blob/main/concepts/sql_tips/sql_tips.ipynb">‚Ä¶concepts/sql_tips/sql_tips.ipynb</a>
</li>
</ol>
<div class="cell">
<details class="code-fold"><summary>Show the code</summary><div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I added this R code chunk and somehow knitr engine successfully rendered SQL formatting block code.</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Workaround: https://github.com/quarto-dev/quarto-cli/issues/2137"</span>)</span></code></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>I added this R code chunk and somehow knitr engine successfully rendered SQL formatting block code.
Workaround: https://github.com/quarto-dev/quarto-cli/issues/2137</code></pre>
</div>
</div>


<!-- -->

</section> ]]></description>
  <category>til</category>
  <category>sql</category>
  <guid>https://lktuan.github.io/blog/2024-12-06-adv_sql/</guid>
  <pubDate>Thu, 05 Dec 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-12-06-adv_sql/duckdb.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>NN-Z2H Lesson 5: Building makemore part 4 - Becoming a Backprop Ninja</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-12-02-nn-z2h-p5/</link>
  <description><![CDATA[ 





<div class="callout callout-style-default callout-important callout-titled" title="This is not orginal content!">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This is not orginal content!
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is my study notes / codes along with Andrej Karpathy‚Äôs ‚Äú<a href="https://www.youtube.com/watch?v=VMj-3S1tku0&amp;list=PLAqhIrjkxbuWI23v9cThsA9GvCAUhRvKZ">Neural Networks: Zero to Hero</a>‚Äù series.</p>
</div>
</div>
<section id="intro-why-you-should-care" class="level1">
<h1>intro: why you should care</h1>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-02-nn-z2h-p5/swole_doggo.jpg" class="img-fluid figure-img"></p>
<figcaption>swole doge style backpropagation, image credit to <a href="https://www.youtube.com/watch?v=LzxnmqnctmA">this video</a></figcaption>
</figure>
</div>
<p>In the previous lecture, we‚Äôre introduced to some common issues with our ‚Äúshallow‚Äù (and of course for deep as well) neural network and how to fix with the initialization setting and Batch Normalization. We‚Äôre also learned some diagnostic tools to observe <em>forward pass activations</em>, <em>backward pass gradients</em>, and <em>weights update</em>, to calibrate the training loop. In this lecture, we aim to replace this line of code:</p>
<div id="7b071bf9" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1">... loss.backward() ...</span></code></pre></div>
</details>
</div>
<p>with from-scratch-code. It‚Äôs basically identical to <code>MicroGrad</code>, but on <em>Tensor</em> rather than <em>Scalar</em>. But why we should care?</p>
<blockquote class="blockquote">
<p>The problem with Backpropagation is that it is a <a href="https://en.wikipedia.org/wiki/Leaky_abstraction">leaky abstraction</a>. ‚Äì Andrej Karpathy</p>
</blockquote>
<p>readmore: - <a href="https://karpathy.medium.com/yes-you-should-understand-backprop-e2f06eab496b" class="uri">https://karpathy.medium.com/yes-you-should-understand-backprop-e2f06eab496b</a>, - and <a href="https://kratzert.github.io/2016/02/12/understanding-the-gradient-flow-through-the-batch-normalization-layer.html" class="uri">https://kratzert.github.io/2016/02/12/understanding-the-gradient-flow-through-the-batch-normalization-layer.html</a>.</p>
<p>inshort, to effectively debug neural network, we should be deeply understanding how back propagation work under the hood. Let‚Äôs do it!</p>
</section>
<section id="starter-code" class="level1">
<h1>starter code</h1>
<section id="import-libraries" class="level3">
<h3 class="anchored" data-anchor-id="import-libraries">import libraries:</h3>
<div id="1243f470" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb2-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>matplotlib inline</span></code></pre></div>
</details>
</div>
</section>
<section id="read-data" class="level3">
<h3 class="anchored" data-anchor-id="read-data">read data:</h3>
<div id="103070cd" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb3-2"></span>
<span id="cb3-3">url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/karpathy/makemore/refs/heads/master/names.txt"</span></span>
<span id="cb3-4">words <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(url, header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>).iloc[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].tolist()</span>
<span id="cb3-5">words[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>]</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>['emma', 'olivia', 'ava', 'isabella', 'sophia', 'charlotte', 'mia', 'amelia']</code></pre>
</div>
</div>
</section>
<section id="build-vocab" class="level3">
<h3 class="anchored" data-anchor-id="build-vocab">build vocab:</h3>
<div id="8e67c084" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># build the vocabulary of characters and mapping to/from integer</span></span>
<span id="cb5-2">chars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(words))))</span>
<span id="cb5-3">stoi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {s:i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i, s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(chars)}</span>
<span id="cb5-4">stoi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb5-5">itos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {i: s <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s, i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> stoi.items()}</span>
<span id="cb5-6">vocab_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(itos)</span>
<span id="cb5-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(itos)</span>
<span id="cb5-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(vocab_size)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>{1: 'a', 2: 'b', 3: 'c', 4: 'd', 5: 'e', 6: 'f', 7: 'g', 8: 'h', 9: 'i', 10: 'j', 11: 'k', 12: 'l', 13: 'm', 14: 'n', 15: 'o', 16: 'p', 17: 'q', 18: 'r', 19: 's', 20: 't', 21: 'u', 22: 'v', 23: 'w', 24: 'x', 25: 'y', 26: 'z', 0: '.'}
27</code></pre>
</div>
</div>
</section>
<section id="build-dataset-splits-identical-to-previous-so-i-folded-it" class="level3">
<h3 class="anchored" data-anchor-id="build-dataset-splits-identical-to-previous-so-i-folded-it">build dataset splits (identical to previous so I folded it):</h3>
<div id="984c87b0" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># context length: how many characters do we take to predict the next one.</span></span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># build the dataset</span></span>
<span id="cb7-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> buid_dataset(words):</span>
<span id="cb7-4">    X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [], []</span>
<span id="cb7-5"></span>
<span id="cb7-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words:</span>
<span id="cb7-7">        context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size</span>
<span id="cb7-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>:</span>
<span id="cb7-9">            ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch]</span>
<span id="cb7-10">            X.append(context)</span>
<span id="cb7-11">            Y.append(ix)</span>
<span id="cb7-12">            context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> context[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [ix]</span>
<span id="cb7-13"></span>
<span id="cb7-14">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(X)</span>
<span id="cb7-15">    Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(Y)</span>
<span id="cb7-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(X.shape, Y.shape)</span>
<span id="cb7-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> X, Y</span>
<span id="cb7-18"></span>
<span id="cb7-19"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb7-20">random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb7-21">random.shuffle(words)</span>
<span id="cb7-22">n1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(words))</span>
<span id="cb7-23">n2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(words))</span>
<span id="cb7-24"></span>
<span id="cb7-25">Xtr, Ytr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[:n1])        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 80#</span></span>
<span id="cb7-26">Xdev, Ydev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[n1:n2])    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 10%</span></span>
<span id="cb7-27">Xte, Yte <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[n2:])        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 10%</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([182625, 3]) torch.Size([182625])
torch.Size([22655, 3]) torch.Size([22655])
torch.Size([22866, 3]) torch.Size([22866])</code></pre>
</div>
</div>
</section>
<section id="utility-function-we-will-use-later-when-comparing-manual-gradients-to-pytorch-gradients." class="level3">
<h3 class="anchored" data-anchor-id="utility-function-we-will-use-later-when-comparing-manual-gradients-to-pytorch-gradients.">utility function we will use later when comparing manual gradients to PyTorch gradients.</h3>
<div id="e06fbba4" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(s, dt, t):</span>
<span id="cb9-2">  ex <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>(dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> t.grad).item()</span>
<span id="cb9-3">  app <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.allclose(dt, t.grad)</span>
<span id="cb9-4">  maxdiff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t.grad).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>().item()</span>
<span id="cb9-5">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>s<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:15s}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> | exact: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(ex)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:5s}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> | approximate: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(app)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:5s}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> | maxdiff: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>maxdiff<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
</details>
</div>
</section>
<section id="network-construction" class="level3">
<h3 class="anchored" data-anchor-id="network-construction">network construction:</h3>
<div id="8b9e5f6d" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1">n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the dimensionality of the character embedding vectors</span></span>
<span id="cb10-2">n_hidden <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the number of neurons in the hidden layer of the MLP</span></span>
<span id="cb10-3"></span>
<span id="cb10-4">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for reproducibility</span></span>
<span id="cb10-5">C  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((vocab_size, n_embd),            generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 1</span></span>
<span id="cb10-7">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size, n_hidden), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>((n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb10-8">b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(n_hidden,                        generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># using b1 just for fun, it's useless because of BN</span></span>
<span id="cb10-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 2</span></span>
<span id="cb10-10">W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((n_hidden, vocab_size),          generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb10-11">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(vocab_size,                      generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb10-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BatchNorm parameters</span></span>
<span id="cb10-13">bngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_hidden))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb10-14">bnbias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_hidden))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb10-15"></span>
<span id="cb10-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Note: I am initializating many of these parameters in non-standard ways</span></span>
<span id="cb10-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># because sometimes initializating with e.g. all zeros could mask an incorrect</span></span>
<span id="cb10-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># implementation of the backward pass.</span></span>
<span id="cb10-19"></span>
<span id="cb10-20">parameters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [C, W1, b1, W2, b2, bngain, bnbias]</span>
<span id="cb10-21"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p.nelement() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of parameters in total</span></span>
<span id="cb10-22"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb10-23">  p.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>4137</code></pre>
</div>
</div>
</section>
<section id="mini-batch-construction" class="level3">
<h3 class="anchored" data-anchor-id="mini-batch-construction">mini-batch construction:</h3>
<div id="7e0d9c87" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1">batch_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb12-2">n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> batch_size <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># a shorter variable also, for convenience</span></span>
<span id="cb12-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># construct a minibatch</span></span>
<span id="cb12-4">ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Xtr.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], (batch_size,), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb12-5">Xb, Yb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Xtr[ix], Ytr[ix] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch X,Y</span></span></code></pre></div>
</details>
</div>
</section>
<section id="forward-pass-chunkated-into-smaller-steps-that-are-possible-to-backward-one-at-a-time." class="level3">
<h3 class="anchored" data-anchor-id="forward-pass-chunkated-into-smaller-steps-that-are-possible-to-backward-one-at-a-time.">forward pass, ‚Äúchunkated‚Äù into smaller steps that are possible to backward one at a time.</h3>
<div id="125c48cb" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1">emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xb] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># embed the characters into vectors</span></span>
<span id="cb13-2">embcat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># concatenate the vectors</span></span>
<span id="cb13-3"></span>
<span id="cb13-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Linear layer 1</span></span>
<span id="cb13-5">hprebn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> embcat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hidden layer pre-activation</span></span>
<span id="cb13-6"></span>
<span id="cb13-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BatchNorm layer</span></span>
<span id="cb13-8">bnmeani <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>hprebn.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb13-9">bndiff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hprebn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> bnmeani</span>
<span id="cb13-10">bndiff2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bndiff<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb13-11">bnvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(bndiff2).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note: Bessel's correction (dividing by n-1, not n)</span></span>
<span id="cb13-12">bnvar_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (bnvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb13-13">bnraw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bndiff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bnvar_inv</span>
<span id="cb13-14">hpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bnraw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bnbias</span>
<span id="cb13-15"></span>
<span id="cb13-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Non-linearity</span></span>
<span id="cb13-17">h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(hpreact) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hidden layer</span></span>
<span id="cb13-18"></span>
<span id="cb13-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Linear layer 2</span></span>
<span id="cb13-20">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># output layer</span></span>
<span id="cb13-21"></span>
<span id="cb13-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># cross entropy loss (same as F.cross_entropy(logits, Yb)), Kullback‚ÄìLeibler divergence</span></span>
<span id="cb13-23">logit_maxes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logits.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>).values</span>
<span id="cb13-24">norm_logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> logit_maxes <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># subtract max for numerical stability</span></span>
<span id="cb13-25">counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> norm_logits.exp()</span>
<span id="cb13-26">counts_sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> counts.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb13-27">counts_sum_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> counts_sum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if I use (1.0 / counts_sum) instead then I can't get backprop to be bit exact...</span></span>
<span id="cb13-28">probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> counts_sum_inv</span>
<span id="cb13-29">logprobs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> probs.log()</span>
<span id="cb13-30">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>logprobs[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n), Yb].mean()</span>
<span id="cb13-31"></span>
<span id="cb13-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PyTorch backward pass</span></span>
<span id="cb13-33"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb13-34">  p.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb13-35"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [logprobs, probs, counts, counts_sum, counts_sum_inv, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># afaik there is no cleaner way</span></span>
<span id="cb13-36">          norm_logits, logit_maxes, logits, h, hpreact, bnraw,</span>
<span id="cb13-37">         bnvar_inv, bnvar, bndiff2, bndiff, hprebn, bnmeani,</span>
<span id="cb13-38">         embcat, emb]:</span>
<span id="cb13-39">  t.retain_grad()</span>
<span id="cb13-40"></span>
<span id="cb13-41">hprebn.retain_grad() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tuan added this line since code above does not ensure hprebn's grad to be retained.</span></span>
<span id="cb13-42"></span>
<span id="cb13-43">loss.backward()</span>
<span id="cb13-44">loss</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>tensor(3.3267, grad_fn=&lt;NegBackward0&gt;)</code></pre>
</div>
</div>
</section>
</section>
<section id="exercise-1-backproping-the-atomic-compute-graph" class="level1">
<h1>exercise 1: backproping the atomic compute graph</h1>
<p>I can do 60, 70% of this myself ~ for popular mathematics operations. What I need to remember after these excercises are backwards of:</p>
<ul>
<li>elements in matrix mult;</li>
<li>max operator;</li>
<li>indexing operator; and</li>
<li>broadcasting behavior.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-02-nn-z2h-p5/explain_matrix_mult_grad.png" class="img-fluid figure-img"></p>
<figcaption>Andrej inductive reasoning, explains how to get a derivative from matrix multiplication.</figcaption>
</figure>
</div>
<p>Given the matrix mult expression <img src="https://latex.codecogs.com/png.latex?d%20=%20a%20@%20b%20+%20c">, we have:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cpartial%20L%7D%7B%5Cpartial%20%5Cmathbf%7Ba%7D%7D%20=%20%5Cfrac%7B%5Cpartial%20L%7D%7B%5Cpartial%20%5Cmathbf%7Bd%7D%7D%20@%20%5Cmathbf%7Bb%7D%5ET"></li>
<li><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cpartial%20L%7D%7B%5Cpartial%20%5Cmathbf%7Bb%7D%7D%20=%20%5Cmathbf%7Ba%7D%5ET%20@%20%5Cfrac%7B%5Cpartial%20L%7D%7B%5Cpartial%20%5Cmathbf%7Bd%7D%7D"></li>
<li><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cpartial%20L%7D%7B%5Cpartial%20%5Cmathbf%7Bc%7D%7D%20=%20%5Cfrac%7B%5Cpartial%20L%7D%7B%5Cpartial%20%5Cmathbf%7Bd%7D%7D.sum(0)"></li>
</ul>
<div id="ab2473d9" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="annotated-cell-10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exercise 1: backprop through the whole thing manually, </span></span>
<span id="annotated-cell-10-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backpropagating through exactly all of the variables </span></span>
<span id="annotated-cell-10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># as they are defined in the forward pass above, one by one</span></span>
<span id="annotated-cell-10-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cross entropy loss"</span>.upper())</span>
<span id="annotated-cell-10-5">dlogprobs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(logprobs) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create zeros tensor with same size</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="1">1</button><span id="annotated-cell-10-6" class="code-annotation-target">dlogprobs[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n), Yb] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> n</span>
<span id="annotated-cell-10-7">dprobs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(probs) </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="2">2</button><span id="annotated-cell-10-8" class="code-annotation-target">dprobs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> probs) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dlogprobs</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="3">3</button><span id="annotated-cell-10-9" class="code-annotation-target">dcounts_sum_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dprobs).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="annotated-cell-10-10">dcounts_sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> counts_sum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dcounts_sum_inv</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="4">4</button><span id="annotated-cell-10-11" class="code-annotation-target">dcounts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ones_like(counts) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dcounts_sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> counts_sum_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dprobs</span>
<span id="annotated-cell-10-12">dnorm_logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (norm_logits.exp()) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dcounts <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># = counts * dcounts</span></span>
<span id="annotated-cell-10-13">dlogit_maxes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> dnorm_logits).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># broadcasting, again</span></span>
<span id="annotated-cell-10-14"></span>
<span id="annotated-cell-10-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logprobs'</span>, dlogprobs, logprobs)</span>
<span id="annotated-cell-10-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'probs'</span>, dprobs, probs)</span>
<span id="annotated-cell-10-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'counts_sum_inv'</span>, dcounts_sum_inv, counts_sum_inv)</span>
<span id="annotated-cell-10-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'counts_sum'</span>, dcounts_sum, counts_sum)</span>
<span id="annotated-cell-10-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'counts'</span>, dcounts, counts)</span>
<span id="annotated-cell-10-20"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'norm_logits'</span>, dnorm_logits, norm_logits)</span>
<span id="annotated-cell-10-21"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logit_maxes'</span>, dlogit_maxes, logit_maxes)</span>
<span id="annotated-cell-10-22"></span>
<span id="annotated-cell-10-23"></span>
<span id="annotated-cell-10-24">dlogits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (dnorm_logits.clone() </span>
<span id="annotated-cell-10-25">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> F.one_hot( logits.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).indices, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># broadcasting, again</span></span>
<span id="annotated-cell-10-26">                        num_classes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>logits.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="5">5</button><span id="annotated-cell-10-27" class="code-annotation-target">                        ) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dlogit_maxes)</span>
<span id="annotated-cell-10-28"></span>
<span id="annotated-cell-10-29"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Layer 2 with Linear and Non-linearity tanh"</span>.upper())</span>
<span id="annotated-cell-10-30">dh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>  dlogits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2.T</span>
<span id="annotated-cell-10-31">dW2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> dlogits</span>
<span id="annotated-cell-10-32">db2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dlogits.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sum by column, vertical, to eliminate the 0-index dim</span></span>
<span id="annotated-cell-10-33"></span>
<span id="annotated-cell-10-34"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logits'</span>, dlogits, logits)</span>
<span id="annotated-cell-10-35"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h'</span>, dh, h)</span>
<span id="annotated-cell-10-36"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W2'</span>, dW2, W2)</span>
<span id="annotated-cell-10-37"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b2'</span>, db2, b2)</span>
<span id="annotated-cell-10-38"></span>
<span id="annotated-cell-10-39"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Batch Norm layer"</span>.upper())</span>
<span id="annotated-cell-10-40">dhpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dh <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># output of the tanh, square</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="6">6</button><span id="annotated-cell-10-41" class="code-annotation-target">dbngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (bnraw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dhpreact).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="annotated-cell-10-42">dbnbias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dhpreact.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="annotated-cell-10-43">dbnraw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dhpreact</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="7">7</button><span id="annotated-cell-10-44" class="code-annotation-target">dbnvar_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (bndiff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dbnraw).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="annotated-cell-10-45">dbnvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (bnvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dbnvar_inv</span>
<span id="annotated-cell-10-46">dbndiff2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> torch.ones_like(bndiff2) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dbnvar</span>
<span id="annotated-cell-10-47">dbndiff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bnvar_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dbnraw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bndiff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dbndiff2</span>
<span id="annotated-cell-10-48">dbnmeani <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> torch.ones_like(dbndiff) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dbndiff).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="annotated-cell-10-49"></span>
<span id="annotated-cell-10-50"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hpreact'</span>, dhpreact, hpreact)</span>
<span id="annotated-cell-10-51"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bngain'</span>, dbngain, bngain)</span>
<span id="annotated-cell-10-52"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bnbias'</span>, dbnbias, bnbias)</span>
<span id="annotated-cell-10-53"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bnraw'</span>, dbnraw, bnraw)</span>
<span id="annotated-cell-10-54"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bnvar_inv'</span>, dbnvar_inv, bnvar_inv)</span>
<span id="annotated-cell-10-55"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bnvar'</span>, dbnvar, bnvar)</span>
<span id="annotated-cell-10-56"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bndiff2'</span>, dbndiff2, bndiff2)</span>
<span id="annotated-cell-10-57"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bndiff'</span>, dbndiff, bndiff)</span>
<span id="annotated-cell-10-58"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bnmeani'</span>, dbnmeani, bnmeani)</span>
<span id="annotated-cell-10-59"></span>
<span id="annotated-cell-10-60"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Linear layer 1"</span>.upper())</span>
<span id="annotated-cell-10-61">dhprebn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dbndiff.clone() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (torch.ones_like(hprebn) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dbnmeani))</span>
<span id="annotated-cell-10-62">dembcat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dhprebn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1.T</span>
<span id="annotated-cell-10-63">dW1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> embcat.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> dhprebn</span>
<span id="annotated-cell-10-64">db1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dhprebn.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="8">8</button><span id="annotated-cell-10-65" class="code-annotation-target">demb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dembcat.view(emb.shape)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="9">9</button><span id="annotated-cell-10-66" class="code-annotation-target">dC <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(C)</span>
<span id="annotated-cell-10-67"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(Xb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]): <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># iterate all elements of the Xb</span></span>
<span id="annotated-cell-10-68">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(Xb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]):</span>
<span id="annotated-cell-10-69">    ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Xb[k,j]</span>
<span id="annotated-cell-10-70">    dC[ix] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> demb[k,j]</span>
<span id="annotated-cell-10-71"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Method 2</span></span>
<span id="annotated-cell-10-72">dC <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(C)</span>
<span id="annotated-cell-10-73">dC.index_add_(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Xb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), demb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span>
<span id="annotated-cell-10-74"></span>
<span id="annotated-cell-10-75"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hprebn'</span>, dhprebn, hprebn)</span>
<span id="annotated-cell-10-76"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'embcat'</span>, dembcat, embcat)</span>
<span id="annotated-cell-10-77"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W1'</span>, dW1, W1)</span>
<span id="annotated-cell-10-78"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b1'</span>, db1, b1)</span>
<span id="annotated-cell-10-79"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'emb'</span>, demb, emb)</span>
<span id="annotated-cell-10-80"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C'</span>, dC, C)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-10" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="6" data-code-annotation="1"><code>dlogprobs</code>: <code>logprobs</code> is an (32, 27) array - contains log probabilities of every character in 27 vocab for 32 output. <code>loss</code> just indexes (<code>(range(n), Yb)</code>) to pick out the corresponding numbers of the ground trues, then do mean (<code>1 / n</code>) and get negative (<code>-</code>). So the grad for each element that had been picked out is <code>-1/n</code>, while for others is <code>0</code>;</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="8" data-code-annotation="2"><code>dprobs</code>: d/dx log(x) is just <code>1/x</code> - local derivative, then multiply by next leaf grad <code>dlogprobs</code>, element wise;</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="9" data-code-annotation="3"><code>dcounts_sum_inv</code>: should be <code>counts * dprobs</code> according to chainrule. But remember <code>counts.shape</code> is (32, 27), and <code>counts_sum_inv.shape</code> is (32, 1), then there is <strong>broadcasting</strong> to 27 columns. <code>counts_sum_inv</code> is being used multiple times in the topo/diagram -&gt; we need to sum them (grad) up. We do it by columns so <code>Keepdim=True</code>;</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="11" data-code-annotation="4"><code>dcount</code>: was used in 2 expression, so it would be the sum of (1) <code>counts_sum_inv * dprobs</code> - same with <code>dcounts_sum_inv</code> by symmetry, and (2) <code>torch.ones_like(counts) * dcounts_sum</code> - the gradient flow from <code>dcounts_sum</code> equally, and equal to <code>1</code>;</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="27" data-code-annotation="5"><code>dlogits</code>: sum of 2 flows, the 2nd one for <code>max()</code> operations -&gt; gradient should be the <code>1</code> for those max elements, the remain would be <code>0</code>;</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="41" data-code-annotation="6">Notice the <strong>vertical broadcasting</strong> of <code>bngain</code> and <code>bnbias</code>;</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="44" data-code-annotation="7">Need to sum up vertically because <code>bnvar_inv</code> is (1, 64) while 2 multipliers are (32, 64);</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="65" data-code-annotation="8">Undo the concatenation;</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="66" data-code-annotation="9">Undo the indexing: <code>emb.shape = (32, 3, 10)</code>, <code>C.shape = (27, 10)</code>, <code>Xb.shape = (32, 3)</code>.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CROSS ENTROPY LOSS
logprobs        | exact: True  | approximate: True  | maxdiff: 0.0
probs           | exact: True  | approximate: True  | maxdiff: 0.0
counts_sum_inv  | exact: True  | approximate: True  | maxdiff: 0.0
counts_sum      | exact: True  | approximate: True  | maxdiff: 0.0
counts          | exact: True  | approximate: True  | maxdiff: 0.0
norm_logits     | exact: True  | approximate: True  | maxdiff: 0.0
logit_maxes     | exact: True  | approximate: True  | maxdiff: 0.0
LAYER 2 WITH LINEAR AND NON-LINEARITY TANH
logits          | exact: True  | approximate: True  | maxdiff: 0.0
h               | exact: True  | approximate: True  | maxdiff: 0.0
W2              | exact: True  | approximate: True  | maxdiff: 0.0
b2              | exact: True  | approximate: True  | maxdiff: 0.0
BATCH NORM LAYER
hpreact         | exact: True  | approximate: True  | maxdiff: 0.0
bngain          | exact: True  | approximate: True  | maxdiff: 0.0
bnbias          | exact: True  | approximate: True  | maxdiff: 0.0
bnraw           | exact: True  | approximate: True  | maxdiff: 0.0
bnvar_inv       | exact: True  | approximate: True  | maxdiff: 0.0
bnvar           | exact: True  | approximate: True  | maxdiff: 0.0
bndiff2         | exact: True  | approximate: True  | maxdiff: 0.0
bndiff          | exact: True  | approximate: True  | maxdiff: 0.0
bnmeani         | exact: True  | approximate: True  | maxdiff: 0.0
LINEAR LAYER 1
hprebn          | exact: True  | approximate: True  | maxdiff: 0.0
embcat          | exact: True  | approximate: True  | maxdiff: 0.0
W1              | exact: True  | approximate: True  | maxdiff: 0.0
b1              | exact: True  | approximate: True  | maxdiff: 0.0
emb             | exact: True  | approximate: True  | maxdiff: 0.0
C               | exact: True  | approximate: True  | maxdiff: 0.0</code></pre>
</div>
</div>
</section>
<section id="brief-digression-bessels-correction-in-batchnorm" class="level1">
<h1>brief digression: bessel‚Äôs correction in batchnorm</h1>
<p>The paper of Batch Norm inconsistantly mentioned that:</p>
<ul>
<li>they used biased variance for training;</li>
<li>and used un-biased variance for inference.</li>
</ul>
<p>We train on small mini-batch, so should be using un-biased variance. PyTorch, since implemented what exactly paper wrote, has this discrepancy.</p>
</section>
<section id="exercise-2-cross-entropy-loss-backward-pass" class="level1">
<h1>exercise 2: cross entropy loss backward pass</h1>
<p>We are realizing that we doing too much work since we need to break the <code>loss</code> calculation from <code>logits</code> into too many steps that (1) they are easy enough for us to do backpropagation, but (2) most of them can cancel each other out. So in exercise two, we need to convert those bunch of atomic pieces of calculation to a shorter formula of cross entropy that can facilitate the backpropating.</p>
<div id="4fae76b8" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exercise 2: backprop through cross_entropy but all in one go</span></span>
<span id="cb16-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to complete this challenge look at the mathematical expression of the loss,</span></span>
<span id="cb16-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># take the derivative, simplify the expression, and just write it out</span></span>
<span id="cb16-4"></span>
<span id="cb16-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass</span></span>
<span id="cb16-6"></span>
<span id="cb16-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># before:</span></span>
<span id="cb16-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># logit_maxes = logits.max(1, keepdim=True).values</span></span>
<span id="cb16-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># norm_logits = logits - logit_maxes # subtract max for numerical stability</span></span>
<span id="cb16-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># counts = norm_logits.exp()</span></span>
<span id="cb16-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># counts_sum = counts.sum(1, keepdims=True)</span></span>
<span id="cb16-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># counts_sum_inv = counts_sum**-1 # if I use (1.0 / counts_sum) instead then I can't get backprop to be bit exact...</span></span>
<span id="cb16-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># probs = counts * counts_sum_inv</span></span>
<span id="cb16-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># logprobs = probs.log()</span></span>
<span id="cb16-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss = -logprobs[range(n), Yb].mean()</span></span>
<span id="cb16-16"></span>
<span id="cb16-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># now:</span></span>
<span id="cb16-18">loss_fast <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Yb)</span>
<span id="cb16-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(loss_fast.item(), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'diff:'</span>, (loss_fast <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> loss).item())</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>3.3267292976379395 diff: 4.76837158203125e-07</code></pre>
</div>
</div>
<p>Mathematically given the Cross-Entropy loss formula:</p>
<p><img src="https://latex.codecogs.com/png.latex?L%20=%20-%5Cfrac%7B1%7D%7Bn%7D%20%5Csum_%7Bi=1%7D%5E%7Bn%7D%20%5Csum_%7Bj=1%7D%5E%7Bk%7D%20Y_%7Bij%7D%20%5Clog(%5Chat%7BY%7D_%7Bij%7D)"></p>
<p>with <img src="https://latex.codecogs.com/png.latex?%5Chat%7BY%7D%7Bij%7D"> is calculated by the softmax transformation:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Chat%7BY%7D%7Bij%7D%20=%20%5Cfrac%7B%5Cexp(%5Ctext%7Blogits%7D%7Bij%7D)%7D%7B%5Csum_%7Bc=1%7D%5E%7Bk%7D%20%5Cexp(%5Ctext%7Blogits%7D_%7Bic%7D)%7D"></p>
<p>where:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?n">: batch size, in this case is 32 - <code>n</code>;</li>
<li><img src="https://latex.codecogs.com/png.latex?k">: vocab size or number of classes, in this case is 27 - <code>vocab_size</code>;</li>
<li><img src="https://latex.codecogs.com/png.latex?Y%20%5Cin%20%7B0,1%7D%5E%7Bn%20%5Ctimes%20k%7D">: one-hot encoding maxtrix (ground truth) - <code>Y</code>;</li>
<li><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Blogits%7D%20%5Cin%20%5Cmathbb%7BR%7D%5E%7Bn%20%5Ctimes%20k%7D">: raw logits, input of softmax layer - <code>logits</code>;</li>
<li><img src="https://latex.codecogs.com/png.latex?%5Chat%7BY%7D%20%5Cin%20%5B0,1%5D%5E%7Bn%20%5Ctimes%20k%7D">: probabilities after softmax layer - <code>probs</code>.</li>
</ul>
<p>I actually can not do this exercise so AK‚Äôs solution here:</p>
<div id="916684f2" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass</span></span>
<span id="cb18-2"></span>
<span id="cb18-3">dlogits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.softmax(logits, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb18-4">dlogits[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n), Yb] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb18-5">dlogits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb18-6"></span>
<span id="cb18-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logits'</span>, dlogits, logits) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I can only get approximate to be true, my maxdiff is 6e-9</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>logits          | exact: False | approximate: True  | maxdiff: 6.752088665962219e-09</code></pre>
</div>
</div>
<p>I will comeback with another post on thisss: the backward for cross entropy loss.</p>
<section id="what-is-dlogits-intuitively" class="level3">
<h3 class="anchored" data-anchor-id="what-is-dlogits-intuitively">what is <code>dlogits</code> intuitively?</h3>
<p>Now let‚Äôs look how <code>dlogits</code> look like.</p>
<p>This is the first row of <code>logits</code> through softmax layer, it‚Äôs probabilities of every possible character in vocab size 27, they are all small and sum of them is 1.</p>
<div id="15dbe1ac" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1">F.softmax(logits, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>tensor([0.0765, 0.0852, 0.0175, 0.0537, 0.0181, 0.0835, 0.0274, 0.0357, 0.0181,
        0.0319, 0.0393, 0.0355, 0.0382, 0.0277, 0.0341, 0.0135, 0.0096, 0.0207,
        0.0163, 0.0540, 0.0484, 0.0206, 0.0263, 0.0672, 0.0549, 0.0257, 0.0205],
       grad_fn=&lt;SelectBackward0&gt;)</code></pre>
</div>
</div>
<p>And this is the first row of <code>dlogits</code> multiplied by <code>n</code> for comparision, it‚Äôs all identical excep the 8th probability (<code>Xb[0] = 8</code>). <strong>And sum of them is 0!</strong></p>
<div id="34526715" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1">dlogits[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>tensor([ 0.0765,  0.0852,  0.0175,  0.0537,  0.0181,  0.0835,  0.0274,  0.0357,
        -0.9819,  0.0319,  0.0393,  0.0355,  0.0382,  0.0277,  0.0341,  0.0135,
         0.0096,  0.0207,  0.0163,  0.0540,  0.0484,  0.0206,  0.0263,  0.0672,
         0.0549,  0.0257,  0.0205], grad_fn=&lt;MulBackward0&gt;)</code></pre>
</div>
</div>
<p>So for each data point in the batch of 32, we pushnish super hard the correct character, making the magnitude of it‚Äôs grad is so high (negative number), then the prob of that predict-character can change toward to correct one. This push and pull is somehow the way that network learn.</p>
<div id="1fe23009" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>))</span>
<span id="cb24-2">plt.imshow(dlogits.detach(), cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-02-nn-z2h-p5/index_files/figure-html/cell-16-output-1.png" width="544" height="633" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>When the network perfectly predict, softmax will have a full row vector except the 8th prob, which is 1. Then the <code>dlogits</code> will be full of 0, the network stop learning.</p>
</section>
</section>
<section id="exercise-3-batch-norm-layer-backward-pass" class="level1">
<h1>exercise 3: batch norm layer backward pass</h1>
<div id="eb71c90f" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exercise 3: backprop through batchnorm but all in one go</span></span>
<span id="cb25-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to complete this challenge look at the mathematical expression of the output of batchnorm,</span></span>
<span id="cb25-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># take the derivative w.r.t. its input, simplify the expression, and just write it out</span></span>
<span id="cb25-4"></span>
<span id="cb25-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass</span></span>
<span id="cb25-6"></span>
<span id="cb25-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># before:</span></span>
<span id="cb25-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bnmeani = 1/n*hprebn.sum(0, keepdim=True)</span></span>
<span id="cb25-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bndiff = hprebn - bnmeani</span></span>
<span id="cb25-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bndiff2 = bndiff**2</span></span>
<span id="cb25-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bnvar = 1/(n-1)*(bndiff2).sum(0, keepdim=True) # note: Bessel's correction (dividing by n-1, not n)</span></span>
<span id="cb25-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bnvar_inv = (bnvar + 1e-5)**-0.5</span></span>
<span id="cb25-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bnraw = bndiff * bnvar_inv</span></span>
<span id="cb25-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hpreact = bngain * bnraw + bnbias</span></span>
<span id="cb25-15"></span>
<span id="cb25-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># now:</span></span>
<span id="cb25-17">hpreact_fast <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (hprebn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> hprebn.mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> torch.sqrt(hprebn.var(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, unbiased<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bnbias</span>
<span id="cb25-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max diff:'</span>, (hpreact_fast <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> hpreact).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>())</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>max diff: tensor(4.7684e-07, grad_fn=&lt;MaxBackward1&gt;)</code></pre>
</div>
</div>
<p>Below is the image of Batch Norm algorithm:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-12-02-nn-z2h-p5/bn_algo.png" class="img-fluid figure-img"></p>
<figcaption>Batch Normalization algo, <a href="https://arxiv.org/abs/1502.03167">source</a></figcaption>
</figure>
</div>
<p>And this is flowchart</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR

Input(...) --&gt; X(x)
X(x) -- "(4) dL/dx" --&gt; Mu(mu)
X(x) -- "(4) dL/dx" --&gt; Si("sigma (square)")
X(x) -- "(4) dL/dx" --&gt; Xh(x_hat)
Si("sigma (square)") -- "(2) dL/dsigma" --&gt; Xh(x_hat)
Mu(mu) -- "(3.1) dL/dmu" --&gt; Xh(x_hat)
Mu(mu) -- "(3.2) dL/dmu" --&gt; Si("sigma (square)")
Xh(x_hat) -- "(1) dL/dx_hat" --&gt; Y(y)

G(gamma) --&gt; Y(y)
B(beta) --&gt; Y(y)
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>We will need to calculate <code>dL/dx</code> given <code>dL/dy</code>, we will calculate by hand reversely:</p>
<ol type="1">
<li>scale and shift: <code>dL/dx_hat = gamma * dL/dy</code> easy enough;</li>
<li>normalize: <code>dL/dsigma = -1/2 * gamma * SUM[dL/dy * (x - mu) * (sigma^2 + eps)^(-3/2)]</code>;</li>
<li>normalize &amp; mini-batch variance: <code>dL/dmu = - SUM[dL/dy * gamma * (sigma^2 + eps)^(-1/2)]</code>, this is path (3.1), we can prove that path (3.2) equal to zero - since <code>mu</code> is average of <code>x</code>, we can think of change in <code>mu</code> will be eliminated by <code>x</code> itself w.r.t. <code>L</code>;</li>
<li>given all the gradients above, we just write the expressions down and do some transformation, this is the final: <code>dL/dx = gamma * (sigma^2 + eps)^(-1/2) / m { [m * dL/dy] - SUMj[dL/dy] - m/(m-1) * x_hat * SUMj[dL/dy * x_hat]}</code>, where <code>m</code> is mini-batch size (in our data is <code>n</code>)</li>
</ol>
<div id="5da129a6" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass</span></span>
<span id="cb27-2"></span>
<span id="cb27-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># before we had:</span></span>
<span id="cb27-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dbnraw = bngain * dhpreact</span></span>
<span id="cb27-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dbndiff = bnvar_inv * dbnraw</span></span>
<span id="cb27-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dbnvar_inv = (bndiff * dbnraw).sum(0, keepdim=True)</span></span>
<span id="cb27-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dbnvar = (-0.5*(bnvar + 1e-5)**-1.5) * dbnvar_inv</span></span>
<span id="cb27-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dbndiff2 = (1.0/(n-1))*torch.ones_like(bndiff2) * dbnvar</span></span>
<span id="cb27-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dbndiff += (2*bndiff) * dbndiff2</span></span>
<span id="cb27-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dhprebn = dbndiff.clone()</span></span>
<span id="cb27-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dbnmeani = (-dbndiff).sum(0)</span></span>
<span id="cb27-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dhprebn += 1.0/n * (torch.ones_like(hprebn) * dbnmeani)</span></span>
<span id="cb27-13"></span>
<span id="cb27-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calculate dhprebn given dhpreact (i.e. backprop through the batchnorm)</span></span>
<span id="cb27-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (you'll also need to use some of the variables from the forward pass up above)</span></span>
<span id="cb27-16"></span>
<span id="cb27-17">dhprebn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bnvar_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ( n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dhpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> dhpreact.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bnraw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (dhpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bnraw).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb27-18"></span>
<span id="cb27-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hprebn'</span>, dhprebn, hprebn) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I can only get approximate to be true, my maxdiff is 9e-10</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>hprebn          | exact: False | approximate: True  | maxdiff: 9.313225746154785e-10</code></pre>
</div>
</div>
</section>
<section id="exercise-4-putting-it-all-together" class="level1">
<h1>exercise 4: putting it all together</h1>
<div id="c726fc27" class="cell" data-execution_count="18">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exercise 4: putting it all together!</span></span>
<span id="cb29-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train the MLP neural net with your own backward pass</span></span>
<span id="cb29-3"></span>
<span id="cb29-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># init</span></span>
<span id="cb29-5">n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the dimensionality of the character embedding vectors</span></span>
<span id="cb29-6">n_hidden <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the number of neurons in the hidden layer of the MLP</span></span>
<span id="cb29-7"></span>
<span id="cb29-8">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for reproducibility</span></span>
<span id="cb29-9">C  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((vocab_size, n_embd),            generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb29-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 1</span></span>
<span id="cb29-11">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size, n_hidden), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>((n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb29-12">b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(n_hidden,                        generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb29-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 2</span></span>
<span id="cb29-14">W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((n_hidden, vocab_size),          generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb29-15">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(vocab_size,                      generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb29-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BatchNorm parameters</span></span>
<span id="cb29-17">bngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_hidden))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb29-18">bnbias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_hidden))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb29-19"></span>
<span id="cb29-20">parameters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [C, W1, b1, W2, b2, bngain, bnbias]</span>
<span id="cb29-21"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p.nelement() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of parameters in total</span></span>
<span id="cb29-22"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb29-23">  p.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb29-24"></span>
<span id="cb29-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># same optimization as last time</span></span>
<span id="cb29-26">max_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200000</span></span>
<span id="cb29-27">batch_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb29-28">n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> batch_size <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convenience</span></span>
<span id="cb29-29">lossi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb29-30"></span>
<span id="cb29-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use this context manager for efficiency once your backward pass is written (</span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">TODO</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb29-32"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb29-33"></span>
<span id="cb29-34">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># kick off optimization</span></span>
<span id="cb29-35">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(max_steps):</span>
<span id="cb29-36"></span>
<span id="cb29-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minibatch construct</span></span>
<span id="cb29-38">    ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Xtr.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], (batch_size,), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb29-39">    Xb, Yb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Xtr[ix], Ytr[ix] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch X,Y</span></span>
<span id="cb29-40"></span>
<span id="cb29-41">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass</span></span>
<span id="cb29-42">    emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xb] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># embed the characters into vectors</span></span>
<span id="cb29-43">    embcat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># concatenate the vectors</span></span>
<span id="cb29-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Linear layer</span></span>
<span id="cb29-45">    hprebn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> embcat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hidden layer pre-activation</span></span>
<span id="cb29-46">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BatchNorm layer</span></span>
<span id="cb29-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -------------------------------------------------------------</span></span>
<span id="cb29-48">    bnmean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hprebn.mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb29-49">    bnvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hprebn.var(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, unbiased<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb29-50">    bnvar_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (bnvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb29-51">    bnraw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (hprebn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> bnmean) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bnvar_inv</span>
<span id="cb29-52">    hpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bnraw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bnbias</span>
<span id="cb29-53">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -------------------------------------------------------------</span></span>
<span id="cb29-54">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Non-linearity</span></span>
<span id="cb29-55">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(hpreact) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hidden layer</span></span>
<span id="cb29-56">    logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># output layer</span></span>
<span id="cb29-57">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Yb) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss function</span></span>
<span id="cb29-58"></span>
<span id="cb29-59">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass</span></span>
<span id="cb29-60">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb29-61">      p.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb29-62">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss.backward() # use this for correctness comparisons, delete it later!</span></span>
<span id="cb29-63"></span>
<span id="cb29-64">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># manual backprop! #swole_doge_meme</span></span>
<span id="cb29-65">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -----------------</span></span>
<span id="cb29-66">    dlogits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.softmax(logits, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb29-67">    dlogits[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n), Yb] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb29-68">    dlogits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/=</span> n</span>
<span id="cb29-69">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2nd layer backprop</span></span>
<span id="cb29-70">    dh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dlogits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2.T</span>
<span id="cb29-71">    dW2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> dlogits</span>
<span id="cb29-72">    db2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dlogits.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb29-73">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tanh</span></span>
<span id="cb29-74">    dhpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dh</span>
<span id="cb29-75">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batchnorm backprop</span></span>
<span id="cb29-76">    dbngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (bnraw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dhpreact).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb29-77">    dbnbias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dhpreact.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb29-78">    dhprebn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bngain<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bnvar_inv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>dhpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> dhpreact.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bnraw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(dhpreact<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bnraw).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb29-79">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1st layer</span></span>
<span id="cb29-80">    dembcat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dhprebn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1.T</span>
<span id="cb29-81">    dW1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> embcat.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> dhprebn</span>
<span id="cb29-82">    db1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dhprebn.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb29-83">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># embedding</span></span>
<span id="cb29-84">    demb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dembcat.view(emb.shape)</span>
<span id="cb29-85">    dC <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(C)</span>
<span id="cb29-86">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(Xb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]):</span>
<span id="cb29-87">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(Xb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]):</span>
<span id="cb29-88">        ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Xb[k,j]</span>
<span id="cb29-89">        dC[ix] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> demb[k,j]</span>
<span id="cb29-90">    grads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [dC, dW1, db1, dW2, db2, dbngain, dbnbias]</span>
<span id="cb29-91">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -----------------</span></span>
<span id="cb29-92"></span>
<span id="cb29-93">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update</span></span>
<span id="cb29-94">    lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100000</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># step learning rate decay</span></span>
<span id="cb29-95">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p, grad <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(parameters, grads):</span>
<span id="cb29-96">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#p.data += -lr * p.grad # old way of cheems doge (using PyTorch grad from .backward())</span></span>
<span id="cb29-97">      p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> grad <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># new way of swole doge </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">TODO</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">: enable</span></span>
<span id="cb29-98"></span>
<span id="cb29-99">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># track stats</span></span>
<span id="cb29-100">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print every once in a while</span></span>
<span id="cb29-101">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:7d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>max_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:7d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb29-102">    lossi.append(loss.log10().item())</span>
<span id="cb29-103"></span>
<span id="cb29-104">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if i &gt;= 100: # </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">TODO</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">: delete early breaking when you're ready to train the full net</span></span>
<span id="cb29-105">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   break</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>12297
      0/ 200000: 3.8430
  10000/ 200000: 2.1560
  20000/ 200000: 2.4334
  30000/ 200000: 2.4665
  40000/ 200000: 1.9888
  50000/ 200000: 2.3378
  60000/ 200000: 2.4149
  70000/ 200000: 2.0440
  80000/ 200000: 2.3377
  90000/ 200000: 2.1847
 100000/ 200000: 1.9861
 110000/ 200000: 2.2556
 120000/ 200000: 2.0190
 130000/ 200000: 2.4322
 140000/ 200000: 2.3159
 150000/ 200000: 2.2161
 160000/ 200000: 1.8835
 170000/ 200000: 1.8359
 180000/ 200000: 2.0352
 190000/ 200000: 1.8955</code></pre>
</div>
</div>
<p>We can check gradients using this:</p>
<div id="a76e3259" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># useful for checking your gradients</span></span>
<span id="cb31-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p,g <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(parameters, grads):</span>
<span id="cb31-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># g.requires_grad = True</span></span>
<span id="cb31-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># g.retain_grad()</span></span>
<span id="cb31-5">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cmp</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(p.shape)), g, p)</span></code></pre></div>
</details>
</div>
<p>Calibrate the batch norm at the end of training:</p>
<div id="5e1f517e" class="cell" data-execution_count="20">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb32-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pass the training set through</span></span>
<span id="cb32-3">  emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xtr]</span>
<span id="cb32-4">  embcat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb32-5">  hpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> embcat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1</span>
<span id="cb32-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># measure the mean/std over the entire training set</span></span>
<span id="cb32-7">  bnmean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hpreact.mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb32-8">  bnvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hpreact.var(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, unbiased<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
</details>
</div>
<p>Evaluate train and val loss:</p>
<div id="e40f68a9" class="cell" data-execution_count="21">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@torch.no_grad</span>() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this decorator disables gradient tracking</span></span>
<span id="cb33-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> split_loss(split):</span>
<span id="cb33-3">  x,y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb33-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>: (Xtr, Ytr),</span>
<span id="cb33-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val'</span>: (Xdev, Ydev),</span>
<span id="cb33-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>: (Xte, Yte),</span>
<span id="cb33-7">  }[split]</span>
<span id="cb33-8">  emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[x] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (N, block_size, n_embd)</span></span>
<span id="cb33-9">  embcat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># concat into (N, block_size * n_embd)</span></span>
<span id="cb33-10">  hpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> embcat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1</span>
<span id="cb33-11">  hpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (hpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> bnmean) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (bnvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bnbias</span>
<span id="cb33-12">  h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(hpreact) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (N, n_hidden)</span></span>
<span id="cb33-13">  logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (N, vocab_size)</span></span>
<span id="cb33-14">  loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, y)</span>
<span id="cb33-15">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(split, loss.item())</span>
<span id="cb33-16"></span>
<span id="cb33-17">split_loss(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>)</span>
<span id="cb33-18">split_loss(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>train 2.0704638957977295
val 2.10821533203125</code></pre>
</div>
</div>
<p>Similar to what we achieved before!</p>
<p>Sample from model:</p>
<div id="4cbe2740" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample from the model</span></span>
<span id="cb35-2">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb35-3"></span>
<span id="cb35-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>):</span>
<span id="cb35-5">    </span>
<span id="cb35-6">    out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb35-7">    context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize with all ...</span></span>
<span id="cb35-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>:</span>
<span id="cb35-9">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ------------</span></span>
<span id="cb35-10">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass:</span></span>
<span id="cb35-11">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Embedding</span></span>
<span id="cb35-12">      emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[torch.tensor([context])] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (1,block_size,d)      </span></span>
<span id="cb35-13">      embcat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># concat into (N, block_size * n_embd)</span></span>
<span id="cb35-14">      hpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> embcat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1</span>
<span id="cb35-15">      hpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (hpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> bnmean) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (bnvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bnbias</span>
<span id="cb35-16">      h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(hpreact) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (N, n_hidden)</span></span>
<span id="cb35-17">      logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (N, vocab_size)</span></span>
<span id="cb35-18">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ------------</span></span>
<span id="cb35-19">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sample</span></span>
<span id="cb35-20">      probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.softmax(logits, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb35-21">      ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.multinomial(probs, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g).item()</span>
<span id="cb35-22">      context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> context[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [ix]</span>
<span id="cb35-23">      out.append(ix)</span>
<span id="cb35-24">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb35-25">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb35-26">    </span>
<span id="cb35-27">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(itos[i] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> out))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>mora.
mayah.
see.
madyn.
alayethruthadra.
gradelyn.
elin.
shi.
jenleigh.
sana.
arleigh.
malaia.
noshubergshira.
sten.
joselle.
jose.
casun.
macder.
yarulyeh.
yuma.</code></pre>
</div>
</div>
</section>
<section id="outro" class="level1">
<h1>outro</h1>
<p>We have gone through and learned how can we manually do the gradients in our networks, it‚Äôs just some line of code for each step and pretty simple (<em>but not for the Batch Norm formula</em> üò™). And I‚Äôll also be back with another post to calculate how the grad of cross entropy is coming.</p>
<p>In next lesson we will build RNN, LSTM, GRU, etc. Interesting and happly leanring!</p>
</section>
<section id="resources" class="level1">
<h1>resources</h1>
<ol type="1">
<li>Notebook: <a href="https://github.com/karpathy/nn-zero-to-hero/blob/master/lectures/makemore/makemore_part4_backprop.ipynb" class="uri">https://github.com/karpathy/nn-zero-to-hero/blob/master/lectures/makemore/makemore_part4_backprop.ipynb</a>;</li>
<li>Colab notebook: <a href="https://colab.research.google.com/drive/1WV2oi2fh9XXyldh02wupFQX0wh5ZC-z-?usp=sharing" class="uri">https://colab.research.google.com/drive/1WV2oi2fh9XXyldh02wupFQX0wh5ZC-z-?usp=sharing</a></li>
</ol>


<!-- -->

</section>

 ]]></description>
  <category>til</category>
  <category>python</category>
  <category>andrej karpathy</category>
  <category>nn-z2h</category>
  <category>neural networks</category>
  <category>backpropagation</category>
  <guid>https://lktuan.github.io/blog/2024-12-02-nn-z2h-p5/</guid>
  <pubDate>Sun, 01 Dec 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-12-02-nn-z2h-p5/backprop_ninja.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>NN-Z2H Lesson 4: Building makemore part 3 - Activations &amp; Gradients, BatchNorm</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/</link>
  <description><![CDATA[ 





<div class="callout callout-style-default callout-important callout-titled" title="This is not orginal content!">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This is not orginal content!
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is my study notes / codes along with Andrej Karpathy‚Äôs ‚Äú<a href="https://www.youtube.com/watch?v=VMj-3S1tku0&amp;list=PLAqhIrjkxbuWI23v9cThsA9GvCAUhRvKZ">Neural Networks: Zero to Hero</a>‚Äù series.</p>
</div>
</div>
<p>We want to stay a bit longer with the MLPs, to have more concrete intuitive of the <strong>activations</strong> in the neural nets and <strong>gradients</strong> that flowing backwards. It‚Äôs good to learn about the development history of these architectures. Since Recurrent Neural Network (RNN), they are although very <em>expressive</em> but not easily <em>optimizable</em> with current gradient techniques we have so far. Let‚Äôs get started!</p>
<section id="part-1-intro" class="level1">
<h1>Part 1: intro</h1>
<section id="starter-code" class="level2">
<h2 class="anchored" data-anchor-id="starter-code">starter code</h2>
<div id="56ff6a7c" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>matplotlib inline</span></code></pre></div>
</details>
</div>
<div id="2f02400f" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb2-2"></span>
<span id="cb2-3">url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/karpathy/makemore/refs/heads/master/names.txt"</span></span>
<span id="cb2-4">words <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(url, header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>).iloc[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].tolist()</span>
<span id="cb2-5">words[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>]</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>['emma', 'olivia', 'ava', 'isabella', 'sophia', 'charlotte', 'mia', 'amelia']</code></pre>
</div>
</div>
<div id="f548b189" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(words)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>32033</code></pre>
</div>
</div>
<div id="f3c3b0fa" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># build the vocabulary of characters and mapping to/from integer</span></span>
<span id="cb6-2">chars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(words))))</span>
<span id="cb6-3">stoi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {s:i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i, s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(chars)}</span>
<span id="cb6-4">stoi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb6-5">itos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {i: s <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s, i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> stoi.items()}</span>
<span id="cb6-6">vocab_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(itos)</span>
<span id="cb6-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(itos)</span>
<span id="cb6-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(vocab_size)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>{1: 'a', 2: 'b', 3: 'c', 4: 'd', 5: 'e', 6: 'f', 7: 'g', 8: 'h', 9: 'i', 10: 'j', 11: 'k', 12: 'l', 13: 'm', 14: 'n', 15: 'o', 16: 'p', 17: 'q', 18: 'r', 19: 's', 20: 't', 21: 'u', 22: 'v', 23: 'w', 24: 'x', 25: 'y', 26: 'z', 0: '.'}
27</code></pre>
</div>
</div>
<div id="9e1be96b" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># build the dataset</span></span>
<span id="cb8-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> buid_dataset(words):</span>
<span id="cb8-4">    X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [], []</span>
<span id="cb8-5"></span>
<span id="cb8-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words:</span>
<span id="cb8-7">        context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size</span>
<span id="cb8-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>:</span>
<span id="cb8-9">            ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch]</span>
<span id="cb8-10">            X.append(context)</span>
<span id="cb8-11">            Y.append(ix)</span>
<span id="cb8-12">            context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> context[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [ix]</span>
<span id="cb8-13"></span>
<span id="cb8-14">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(X)</span>
<span id="cb8-15">    Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(Y)</span>
<span id="cb8-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(X.shape, Y.shape)</span>
<span id="cb8-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> X, Y</span>
<span id="cb8-18"></span>
<span id="cb8-19"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb8-20">random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb8-21">random.shuffle(words)</span>
<span id="cb8-22">n1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(words))</span>
<span id="cb8-23">n2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(words))</span>
<span id="cb8-24"></span>
<span id="cb8-25">Xtr, Ytr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[:n1])        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 80#</span></span>
<span id="cb8-26">Xdev, Ydev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[n1:n2])    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 10%</span></span>
<span id="cb8-27">Xte, Yte <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[n2:])        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 10%</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([182625, 3]) torch.Size([182625])
torch.Size([22655, 3]) torch.Size([22655])
torch.Size([22866, 3]) torch.Size([22866])</code></pre>
</div>
</div>
<div id="06cb447b" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MLP revisited</span></span>
<span id="cb10-2">n_emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># no of dimensions of the embedding space.</span></span>
<span id="cb10-3">n_hidden <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># size of the hidden - tanh layer</span></span>
<span id="cb10-4"></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Lookup table - 10 dimensional space</span></span>
<span id="cb10-6">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for reproductivity</span></span>
<span id="cb10-7">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((vocab_size, n_emb),                  generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb10-8"></span>
<span id="cb10-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 1 - tanh - 300 neurons</span></span>
<span id="cb10-10">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n_emb, n_hidden),      generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb10-11">b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(n_hidden,                            generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb10-12"></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 2 - softmax</span></span>
<span id="cb10-14">W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((n_hidden, vocab_size),              generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb10-15">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(vocab_size,                          generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb10-16"></span>
<span id="cb10-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All params</span></span>
<span id="cb10-18">parameters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [C, W1, b1, W2, b2]</span>
<span id="cb10-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No of params: "</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p.nelement() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters))</span>
<span id="cb10-20"></span>
<span id="cb10-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pre-training</span></span>
<span id="cb10-22"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb10-23">    p.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>No of params:  11897</code></pre>
</div>
</div>
<div id="e65c93ea" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Optimization</span></span>
<span id="cb12-2">max_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50_000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#200_000</span></span>
<span id="cb12-3">batch_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb12-4"></span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stats holders</span></span>
<span id="cb12-6">lossi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb12-7"></span>
<span id="cb12-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training on Xtr, Ytr</span></span>
<span id="cb12-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(max_steps):</span>
<span id="cb12-10"></span>
<span id="cb12-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minibatch construct      </span></span>
<span id="cb12-12">    ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Xtr.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], (batch_size,)) </span>
<span id="cb12-13">    Xb, Yb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Xtr[ix], Ytr[ix] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch X, Y</span></span>
<span id="cb12-14"></span>
<span id="cb12-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass:</span></span>
<span id="cb12-16">    emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xb] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># embed the characters into vectors   </span></span>
<span id="cb12-17">    emb_cat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># concatenate the vectors</span></span>
<span id="cb12-18">    h_pre_act <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb_cat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hidden layer pre-activation</span></span>
<span id="cb12-19">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(h_pre_act) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hidden layer</span></span>
<span id="cb12-20">    logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># output layer</span></span>
<span id="cb12-21">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Yb) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss function</span></span>
<span id="cb12-22"></span>
<span id="cb12-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass:</span></span>
<span id="cb12-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb12-25">        p.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb12-26">    loss.backward()</span>
<span id="cb12-27"></span>
<span id="cb12-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update</span></span>
<span id="cb12-29">    lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> max_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># step learning rate decay</span></span>
<span id="cb12-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb12-31">        p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p.grad</span>
<span id="cb12-32"></span>
<span id="cb12-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># track stats</span></span>
<span id="cb12-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print once every while</span></span>
<span id="cb12-35">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:7d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>max_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:7d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb12-36">    lossi.append(loss.log10().item())</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      0/  50000: 22.5552
  10000/  50000: 2.3148
  20000/  50000: 2.1559
  30000/  50000: 2.3941
  40000/  50000: 2.2245</code></pre>
</div>
</div>
<div id="ac4de265" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1">plt.plot(lossi)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/index_files/figure-html/cell-9-output-1.png" width="571" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="b12a3f1f" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@torch.no_grad</span>() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># disables gradient tracking</span></span>
<span id="cb15-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> split_loss(split: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb15-3">  x, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb15-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>: (Xtr, Ytr),</span>
<span id="cb15-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val'</span>: (Xdev, Ydev),</span>
<span id="cb15-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>: (Xte, Yte)</span>
<span id="cb15-7">  }[split]</span>
<span id="cb15-8">  emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[x] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (N, block_size, n_emb)</span></span>
<span id="cb15-9">  emb_cat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># concatenate into (N, block_size * n_emb)</span></span>
<span id="cb15-10">  h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb_cat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (N, n_hidden)</span></span>
<span id="cb15-11">  logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (N, vocab_size)</span></span>
<span id="cb15-12">  loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, y) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss function</span></span>
<span id="cb15-13">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(split, loss.item())</span>
<span id="cb15-14"></span>
<span id="cb15-15">split_loss(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>)</span>
<span id="cb15-16">split_loss(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>train 2.22798752784729
val 2.250197410583496</code></pre>
</div>
</div>
<div id="72b69df6" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample from the model</span></span>
<span id="cb17-2">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb17-3"></span>
<span id="cb17-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>):</span>
<span id="cb17-5">    </span>
<span id="cb17-6">    out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb17-7">    context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize with all ...</span></span>
<span id="cb17-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>:</span>
<span id="cb17-9">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass the neural net</span></span>
<span id="cb17-10">      emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[torch.tensor([context])] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (1,block_size,n_embd)</span></span>
<span id="cb17-11">      h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1)</span>
<span id="cb17-12">      logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2</span>
<span id="cb17-13">      probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.softmax(logits, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb17-14">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample from the distribution</span></span>
<span id="cb17-15">      ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.multinomial(probs, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g).item()</span>
<span id="cb17-16">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shift the context window and track the samples</span></span>
<span id="cb17-17">      context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> context[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [ix]</span>
<span id="cb17-18">      out.append(ix)</span>
<span id="cb17-19">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if we sample the special '.' token, break</span></span>
<span id="cb17-20">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb17-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb17-22">    </span>
<span id="cb17-23">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(itos[i] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> out)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># decode and print the generated word</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>moraagmyaz.
seel.
npyn.
alarethastendrarg.
aderedieliighlynnelle.
elieananaraelyn.
malara.
noshabergihimies.
kindreelle.
jeberorius.
kynd.
riyah.
faeha.
kaysh.
samyah.
hil.
salynnsti.
zakel.
juren.
cresti.</code></pre>
</div>
</div>
<p>Okay so now our network has multiple things wrong at the initialization, let‚Äôs list down below. The final code will be presented in the end of part 1, with <code># üëà</code> for lines that had been added / modified. The right code cell below re-initializes states at the beginning of network‚Äôs parameter (in my notebook, it‚Äôs rendered <strong>linearly</strong>!).</p>
<div id="a8e6bffa" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1">n_emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># no of dimensions of the embedding space.</span></span>
<span id="cb19-2">n_hidden <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># size of the hidden - tanh layer</span></span>
<span id="cb19-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Lookup table - 10 dimensional space</span></span>
<span id="cb19-4">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for reproductivity</span></span>
<span id="cb19-5">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((vocab_size, n_emb),                  generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb19-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 1 - tanh - 300 neurons</span></span>
<span id="cb19-7">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n_emb, n_hidden),      generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb19-8">b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(n_hidden,                            generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb19-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 2 - softmax</span></span>
<span id="cb19-10">W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((n_hidden, vocab_size),              generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb19-11">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(vocab_size,                          generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb19-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All params</span></span>
<span id="cb19-13">parameters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [C, W1, b1, W2, b2]</span>
<span id="cb19-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pre-training</span></span>
<span id="cb19-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb19-16">    p.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb19-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Optimization</span></span>
<span id="cb19-18">max_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50_000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#200_000</span></span>
<span id="cb19-19">batch_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb19-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training on Xtr, Ytr</span></span>
<span id="cb19-21"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(max_steps):</span>
<span id="cb19-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minibatch construct      </span></span>
<span id="cb19-23">    ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Xtr.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], (batch_size,)) </span>
<span id="cb19-24">    Xb, Yb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Xtr[ix], Ytr[ix] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch X, Y</span></span>
<span id="cb19-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass:</span></span>
<span id="cb19-26">    emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xb] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># embed the characters into vectors   </span></span>
<span id="cb19-27">    emb_cat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># concatenate the vectors</span></span>
<span id="cb19-28">    h_pre_act <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb_cat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hidden layer pre-activation</span></span>
<span id="cb19-29">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(h_pre_act) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hidden layer</span></span>
<span id="cb19-30">    logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># output layer</span></span>
<span id="cb19-31">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Yb) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss function</span></span>
<span id="cb19-32"></span>
<span id="cb19-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span></code></pre></div>
</details>
</div>
</section>
<section id="fixing-the-initial-loss" class="level2">
<h2 class="anchored" data-anchor-id="fixing-the-initial-loss">fixing the initial loss</h2>
<p>We can see at the <code>step = 0</code>, the loss was <code>27</code> and after some <code>k</code>s training loops it decreased to <code>1</code> or <code>2</code>. It extremely high at the begining. In practice, we should give the network somehow the expectation we want when generating a character after some characters (<code>3</code>).</p>
<div id="e977daf8" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1">loss.item()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>24.27707862854004</code></pre>
</div>
</div>
<p>In this case, without training yet, we expect all <code>27</code> characters‚Äô possibilities to be equal (<code>1 / 27.0</code>) ~ <strong>uniform distribution</strong>, so the loss ~ negative log likelihood would be:</p>
<div id="f8423883" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> torch.tensor(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">27.0</span>).log()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>tensor(3.2958)</code></pre>
</div>
</div>
<p>It‚Äôs far lower than <code>27</code>, we say that the network is <strong>confidently wrong</strong>. Andrej demonstrated by another simple 5 elements tensor and showed that the loss is lowest when all elements are equal.</p>
<p>We want the <code>logits</code> to be low entropy as possible (but not equal to <code>0</code>, which will be showed later), we added multipliers <code>0.01</code> to <code>W2</code>, and <code>0</code> to <code>b2</code>. We got the loss to be <code>3.xx</code> at the beginning.</p>
<div id="0ce2432b" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 2 - softmax</span></span>
<span id="cb24-2">W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((n_hidden, vocab_size),              generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb24-3">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(vocab_size,                          generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span></code></pre></div>
</details>
</div>
<p>Now re-train the model and we will notice the the <code>lossi</code> will not look like the <em>hookey stick</em> anymore! Morever the final loss on train set and dev set is better!</p>
</section>
<section id="fixing-the-saturated-tanh" class="level2">
<h2 class="anchored" data-anchor-id="fixing-the-saturated-tanh">fixing the saturated <code>tanh</code></h2>
<p>The <code>logits</code> are now okay, the next problem is about the <code>h</code> - the activations of the hidden states! It‚Äôs hard to see but in the output of code cell below, there are too many values of <code>1</code> and <code>-1</code> in this tensor.</p>
<div id="2fb2a237" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1">h</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>tensor([[-0.9999, -0.7462, -0.9995,  ...,  0.6402, -1.0000, -0.9974],
        [-0.9983, -1.0000, -1.0000,  ...,  1.0000, -1.0000, -1.0000],
        [-0.9793, -0.9999, -1.0000,  ...,  0.7836, -0.7058,  0.2913],
        ...,
        [-1.0000, -0.9995, -0.9891,  ...,  0.9995, -0.8793,  0.9375],
        [-0.9997, -0.9674, -1.0000,  ..., -0.8636, -0.0804,  0.7250],
        [ 0.9988,  1.0000,  0.9998,  ..., -1.0000,  0.9901,  0.9985]],
       grad_fn=&lt;TanhBackward0&gt;)</code></pre>
</div>
</div>
<p>Recall that <code>tanh</code> is activation function that squashing arbitrary numbers to the range <code>[-1:1]</code>. Let‚Äôs visualize the distribution of <code>h</code>.</p>
<div id="6f7b0e2e" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1">plt.hist(h.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).tolist(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the ";" removes the presenting of data in code-block's output</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/index_files/figure-html/cell-17-output-1.png" width="583" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Most of them were distributed to the extreme values <code>-1</code> and <code>1</code>. Now come to the <code>h_pre_act</code>, we can see a <strong>flat-tails distribution</strong> from <code>-15</code> to <code>15</code>.</p>
<div id="8d15022a" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1">plt.hist(h_pre_act.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).tolist(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/index_files/figure-html/cell-18-output-1.png" width="575" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Looking back to how we implemented <code>tanh</code> in <code>micrograd</code> (which is mathematically the same with <code>PyTorch</code>), we‚Äôre multiplying the forward node‚Äôs gradient with <code>(1 - t**2)</code>, which <code>t</code> is local <code>tanh</code>. When <code>tanh</code> is near <code>-1</code> or <code>1</code>, this is close to <code>0</code>, we are <strong>killing the gradients</strong>. We are stopping the backpropagation through this <code>tanh</code> unit.</p>
<div id="4f627b75" class="cell" data-execution_count="18">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1">...</span>
<span id="cb29-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> tanh(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb29-3">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.data</span>
<span id="cb29-4">        t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (math.exp(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (math.exp(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb29-5">        out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Value(t, (<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, ), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tanh'</span>)</span>
<span id="cb29-6"></span>
<span id="cb29-7">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> _backward():</span>
<span id="cb29-8">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> out.grad</span>
<span id="cb29-9">        out._backward <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _backward</span>
<span id="cb29-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> out</span>
<span id="cb29-11">...</span></code></pre></div>
</details>
</div>
<p>When the gradients become zero, the previous nodes‚Äô gradients will be <strong>vanishing</strong>. We call this <strong>saturated <code>tanh</code></strong>, this leads to <strong>dead neurons</strong> ~ always off and because the gradient is zero then they will never be turned on, and happens for other activations as well: <code>sigmoid</code>, <code>ReLU</code>, etc (but less significant on <code>Leaky ReLU</code> or <code>ELU</code>). The network is not learning!</p>
<p>The same with <code>logits</code>, now we want <code>h</code> to be more near zero, we add multipliers to the <code>W1</code> and <code>b1</code>:</p>
<div id="561c7af5" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 1 - tanh - 300 neurons</span></span>
<span id="cb30-2">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n_emb, n_hidden),      generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span></span>
<span id="cb30-3">b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(n_hidden,                            generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># keep a little bit entropy, </span></span>
<span id="cb30-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># It's okay to initialize the b1 to zero but AK found emperically this will enhance the optimiaztion</span></span></code></pre></div>
</details>
</div>
<p>We can see now less peak distribution of <code>h</code>:</p>
<div class="columns">
<div class="column" style="width:50%;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/tanh_0.2mult.png" class="img-fluid figure-img"></p>
<figcaption><code>tanh</code></figcaption>
</figure>
</div>
</div><div class="column" style="width:50%;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/pre_act_tanh_0.2mult.png" class="img-fluid figure-img"></p>
<figcaption>pre-activation <code>tanh</code></figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="calculating-the-init-scale-kaiming-init" class="level2">
<h2 class="anchored" data-anchor-id="calculating-the-init-scale-kaiming-init">calculating the init scale: ‚ÄúKaiming init‚Äù</h2>
<p>Now let‚Äôs look to the number <code>0.02</code>, in practice no one will set it manually. Let‚Äôs look into the example below to see how parameters of Gaussian Distribution of <code>y</code> differ from <code>x</code> when multiplying by <code>W</code>.</p>
<p>The question is how we set the <code>W</code> to preserve the Gaussian Distribution of X. Emperical researches found out that the multiplier to <code>W</code> should be square root of the ‚Äúfan in‚Äù, in this case is <code>10^0.5</code>.</p>
<div id="04c0a932" class="cell" data-execution_count="20">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb31-2">W <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb31-3">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W</span>
<span id="cb31-4"></span>
<span id="cb31-5">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb31-6">y1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1</span>
<span id="cb31-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(x.mean(), x.std())</span>
<span id="cb31-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(y.mean(), y.std())</span>
<span id="cb31-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(y1.mean(), y1.std())</span>
<span id="cb31-10">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb31-11">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">131</span>).set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input X"</span>)</span>
<span id="cb31-12">plt.hist(x.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).tolist(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, density<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb31-13">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">132</span>).set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Initial output y, expanded by W"</span>)</span>
<span id="cb31-14">plt.hist(y.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).tolist(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, density<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb31-15">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">133</span>).set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y1, preserve the X's Gaussian Dist"</span>)</span>
<span id="cb31-16">plt.hist(y1.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).tolist(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, density<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>tensor(-0.0039) tensor(1.0023)
tensor(-0.0044) tensor(3.1220)
tensor(-0.0002) tensor(1.0091)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/index_files/figure-html/cell-21-output-2.png" width="1546" height="431" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Please investigate more here:</p>
<ol type="1">
<li>Kaiming et al.&nbsp;paper: <a href="https://arxiv.org/abs/1502.01852" class="uri">https://arxiv.org/abs/1502.01852</a></li>
<li>Implementation in <code>Pytorch</code>: <a href="https://pytorch.org/docs/stable/nn.init.html#torch.nn.init.kaiming_normal_" class="uri">https://pytorch.org/docs/stable/nn.init.html#torch.nn.init.kaiming_normal_</a></li>
</ol>
<p>It‚Äôs recommended in Kaiming paper to use a <strong>gain</strong> multiplier base on nonlinearity/activation function (<a href="https://pytorch.org/docs/stable/nn.init.html#torch.nn.init.calculate_gain">here</a>), for <code>tanh</code> it‚Äôs <code>5/3</code>. We endup modified the initialization of <code>W1</code> with:</p>
<div id="af695900" class="cell" data-execution_count="21">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n_emb, n_hidden),      generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ((block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n_emb)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># * 0.2</span></span></code></pre></div>
</details>
</div>
<p>In this case is roughly <code>0.3</code>, re-train and although the loss only improved so insignificant (because previously we set it to be <code>0.2</code> - very close), but we‚Äôve parameterized this hyper-constant.</p>
</section>
<section id="batch-normalization" class="level2">
<h2 class="anchored" data-anchor-id="batch-normalization">batch normalization</h2>
<p>As discussed before, we dont want the <code>h_pre_act</code> to be way too small (~is not doing anything) or too large (~saturated), we want it to just roughly follow the standardized Gaussian Distribution (ie. mean equal to 0, std equal to 1).</p>
<p>We‚Äôve done it at the initialization, <em>why don‚Äôt we just normalize the hidden states to be unit Gaussian</em>? in batch normalization, this can be achieved by 4 steps, demonstrated with our case:</p>
<div id="6c69275c" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. mini-batch mean</span></span>
<span id="cb34-2">hpa_mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h_pre_act.mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb34-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. mini-batch variance / standard deviation</span></span>
<span id="cb34-4">hpa_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h_pre_act.std(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb34-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. normalize</span></span>
<span id="cb34-6">h_pre_act <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (h_pre_act <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> hpa_mean) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> hpa_std</span>
<span id="cb34-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4. scale and shift</span></span>
<span id="cb34-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># multiply by a "gain" then "shift" it with a bias</span></span>
<span id="cb34-9">bngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ones((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_hidden))</span>
<span id="cb34-10">bnbias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_hidden))</span>
<span id="cb34-11">h_pre_act <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> h_pre_act <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bnbias</span></code></pre></div>
</details>
</div>
<p>We modified our code accordingly and re-run the code, actually this time the model did not improve much. Because actually this is very <strong>simple and shallow</strong> neural network. We also notice that the training loop now is slower than before, because the calculation volumn is bigger. Batch Normalization also unexpectedly comes up with a side effect, the forward and backward pass of any input now also depend on the mini-batch, not just itself (because of <code>mean()</code>/<code>std()</code>). This effect is suprisingly a good thing and acts as a <strong>regularizer</strong>.</p>
<p>There are also non-coupling regularizers such as: Linear Normalization, Layer Normalization, Group Normalization.</p>
<p>One othering to consider is in the deployment/testing phase, we dont want to use the batch norm calculated by a mini-batch. Instead we want to use the mean and standard deviation from the whole training data set:</p>
<div id="dcbe96c8" class="cell" data-execution_count="23">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calibrate the batch norm after training</span></span>
<span id="cb35-2"></span>
<span id="cb35-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb35-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pass the training set through</span></span>
<span id="cb35-5">    emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[x_train]</span>
<span id="cb35-6">    embcat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb35-7">    hpreact <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> embcat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1</span>
<span id="cb35-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># measure the mean/std over the entire training set</span></span>
<span id="cb35-9">    bnmean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hpreact.mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb35-10">    bnstd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hpreact.std(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
</details>
</div>
<p>Rather, we can also use the running mean and standard deviation as implemented below which will give close estimates. Remaining 2 notes on the BN are:</p>
<ol type="1">
<li>Dividing zeros: we add a <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> value to the <strong>variance</strong> to avoid. We do not include this here as it likely not to happen with out example;</li>
<li>The bias <code>b1</code> will be subtracting in BN calculation, we will notice the <code>b1.grad</code> will be zeros as it does not impact any other calculation. Thus when using the BN, for layer before like weight, we should remove the bias. The <code>bnbias</code> now will be incharge for biasing the distributions.</li>
</ol>
</section>
<section id="real-example-resnet50-walkthrough" class="level2">
<h2 class="anchored" data-anchor-id="real-example-resnet50-walkthrough">real example: <code>resnet50</code> walkthrough</h2>
<p>The code AK presented here: <a href="https://github.com/pytorch/vision/blob/main/torchvision/models/resnet.py#L108" class="uri">https://github.com/pytorch/vision/blob/main/torchvision/models/resnet.py#L108</a></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/resnet50.png" class="img-fluid figure-img"></p>
<figcaption>The architecture of ResNet-50 model.</figcaption>
</figure>
</div>
</section>
<section id="summary-of-the-lecture" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-the-lecture">summary of the lecture</h2>
<p>Understand the activations (non-linearity) and gradients is crucial when training deep / large neural networks, in part 1 we have observed some issue and come up with many solutions:</p>
<ol type="1">
<li>Confidently wrong of network at init leads to hookey stick for loss in training loop: adding multipliers to <code>logits</code>‚Äôs weights and biases;</li>
<li>Flat-tails distribution or saturated <code>tanh</code>: Kaiming init;</li>
<li>Normalization of the hidden states: introduction to BN.</li>
</ol>
<p>Our final code in part 1 (un-fold to see), <code># üëà</code> indicates a change:</p>
<div id="ac7389b9" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb36-1">block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb36-2"></span>
<span id="cb36-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MLP revisited</span></span>
<span id="cb36-4">n_emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># no of dimensions of the embedding space.</span></span>
<span id="cb36-5">n_hidden <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># size of the hidden - tanh layer</span></span>
<span id="cb36-6"></span>
<span id="cb36-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Lookup table - 10 dimensional space</span></span>
<span id="cb36-8">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for reproductivity</span></span>
<span id="cb36-9">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((vocab_size, n_emb),                  generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb36-10"></span>
<span id="cb36-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 1 - tanh - 300 neurons</span></span>
<span id="cb36-12">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n_emb, n_hidden),      generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ((block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n_emb)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># * 0.2       # üëà</span></span>
<span id="cb36-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># b1 = torch.randn(n_hidden,                            generator=g) * 0.01       # üëà</span></span>
<span id="cb36-14"></span>
<span id="cb36-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 2 - softmax</span></span>
<span id="cb36-16">W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((n_hidden, vocab_size),              generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà</span></span>
<span id="cb36-17">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(vocab_size,                          generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà</span></span>
<span id="cb36-18"></span>
<span id="cb36-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Batch Normalization gain and bias</span></span>
<span id="cb36-20">bngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ones((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_hidden))                                              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà</span></span>
<span id="cb36-21">bnbias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_hidden))                                             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà</span></span>
<span id="cb36-22"></span>
<span id="cb36-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add running mean/std</span></span>
<span id="cb36-24">bnmean_running <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_hidden))                             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà</span></span>
<span id="cb36-25">bnstd_running <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ones((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_hidden))                               <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà</span></span>
<span id="cb36-26"></span>
<span id="cb36-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All params (deleted b1)</span></span>
<span id="cb36-28">parameters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [C, W1, W2, b2, bngain, bnbias]                                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà</span></span>
<span id="cb36-29"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No of params: "</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p.nelement() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters))</span>
<span id="cb36-30"></span>
<span id="cb36-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pre-training</span></span>
<span id="cb36-32"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb36-33">    p.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb36-34"></span>
<span id="cb36-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Optimization</span></span>
<span id="cb36-36">max_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50_000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#200_000</span></span>
<span id="cb36-37">batch_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb36-38"></span>
<span id="cb36-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stats holders</span></span>
<span id="cb36-40">lossi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb36-41"></span>
<span id="cb36-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training on Xtr, Ytr</span></span>
<span id="cb36-43"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(max_steps):</span>
<span id="cb36-44"></span>
<span id="cb36-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minibatch construct      </span></span>
<span id="cb36-46">    ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Xtr.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], (batch_size,)) </span>
<span id="cb36-47">    Xb, Yb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Xtr[ix], Ytr[ix] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch X, Y</span></span>
<span id="cb36-48"></span>
<span id="cb36-49">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass:</span></span>
<span id="cb36-50">    emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xb] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># embed the characters into vectors   </span></span>
<span id="cb36-51">    emb_cat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># concatenate the vectors</span></span>
<span id="cb36-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Linear layer</span></span>
<span id="cb36-53">    h_pre_act <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb_cat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># + b1 # hidden layer pre-activation                               # üëà</span></span>
<span id="cb36-54">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BatchNorm layer</span></span>
<span id="cb36-55">    bnmeani <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h_pre_act.mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)                                                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà</span></span>
<span id="cb36-56">    bnstdi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h_pre_act.std(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)                                                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà</span></span>
<span id="cb36-57">    h_pre_act <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ((h_pre_act <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> bnmeani) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> bnstdi) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bnbias                              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà</span></span>
<span id="cb36-58">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Updating running mean and std (this runs outside the training loop)</span></span>
<span id="cb36-59">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():                                                                       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà</span></span>
<span id="cb36-60">        bnmean_running <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.999</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bnmean_running <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bnmeani                               <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà</span></span>
<span id="cb36-61">        bnstd_running <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.999</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bnstd_running <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bnstdi                                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà</span></span>
<span id="cb36-62">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Non-linearity</span></span>
<span id="cb36-63">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(h_pre_act) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hidden layer</span></span>
<span id="cb36-64">    logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># output layer</span></span>
<span id="cb36-65">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Yb) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss function</span></span>
<span id="cb36-66"></span>
<span id="cb36-67">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass:</span></span>
<span id="cb36-68">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb36-69">        p.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb36-70">    loss.backward()</span>
<span id="cb36-71"></span>
<span id="cb36-72">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update</span></span>
<span id="cb36-73">    lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> max_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># step learning rate decay</span></span>
<span id="cb36-74">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb36-75">        p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p.grad</span>
<span id="cb36-76"></span>
<span id="cb36-77">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># track stats</span></span>
<span id="cb36-78">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print once every while</span></span>
<span id="cb36-79">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:7d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>max_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:7d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb36-80">    lossi.append(loss.log10().item())</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>No of params:  12097
      0/  50000: 3.3045
  10000/  50000: 2.2005
  20000/  50000: 2.1628
  30000/  50000: 2.0014
  40000/  50000: 2.1175</code></pre>
</div>
</div>
<div id="b5102b6f" class="cell" data-execution_count="25">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb38-1">plt.plot(lossi)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/index_files/figure-html/cell-26-output-1.png" width="579" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="22ad83d7" class="cell" data-execution_count="26">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@torch.no_grad</span>() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># disables gradient tracking</span></span>
<span id="cb39-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> split_loss(split: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb39-3">  x, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb39-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>: (Xtr, Ytr),</span>
<span id="cb39-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val'</span>: (Xdev, Ydev),</span>
<span id="cb39-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>: (Xte, Yte)</span>
<span id="cb39-7">  }[split]</span>
<span id="cb39-8">  emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[x]</span>
<span id="cb39-9">  emb_cat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) </span>
<span id="cb39-10">  h_pre_act <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb_cat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1                                                                                         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà </span></span>
<span id="cb39-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># h_pre_act = bngain * ((h_pre_act - h_pre_act.mean(0, keepdim=True)) / h_pre_act.std(0, keepdim=True)) + bnbias      # üëà</span></span>
<span id="cb39-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># h_pre_act = bngain * ((h_pre_act - bnmean) / bnstd) + bnbias                                                        # üëà</span></span>
<span id="cb39-13">  h_pre_act <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bngain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ((h_pre_act <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> bnmean_running) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> bnstd_running) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bnbias                                          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># üëà</span></span>
<span id="cb39-14">  h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(h_pre_act) </span>
<span id="cb39-15">  logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2</span>
<span id="cb39-16">  loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, y)</span>
<span id="cb39-17">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(split, loss.item())</span>
<span id="cb39-18"></span>
<span id="cb39-19">split_loss(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>)</span>
<span id="cb39-20">split_loss(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>train 2.4766831398010254
val 2.490326404571533</code></pre>
</div>
</div>
<section id="loss-logs" class="level3">
<h3 class="anchored" data-anchor-id="loss-logs">loss logs</h3>
<p>The numbers somehow are approximate, I don‚Äôt know why my Thinkpad-E14 gave different results when running codes multiple times üòÇ.</p>
<table class="table-striped table-hover table">
<caption>Loss logs</caption>
<colgroup>
<col style="width: 10%">
<col style="width: 40%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Step</th>
<th>What we did</th>
<th>Loss we got (accum)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>original</td>
<td><p>train 2.1169614791870117</p>
<p>val 2.1623435020446777</p></td>
</tr>
<tr class="even">
<td>2</td>
<td>fixed softmax confidently wrong</td>
<td><p>train 2.0666463375091553</p>
<p>val 2.1468191146850586</p></td>
</tr>
<tr class="odd">
<td>3</td>
<td>fixed <code>tanh</code> layer too saturated at init</td>
<td><p>train 2.033477544784546</p>
<p>val 2.115907907485962</p></td>
</tr>
<tr class="even">
<td>4</td>
<td>used semi principle ‚Äúkaiming init‚Äù instead of hacking init</td>
<td><p>train 2.038902997970581</p>
<p>val 2.1138899326324463</p></td>
</tr>
<tr class="odd">
<td>5</td>
<td>added batch norm layer</td>
<td><p>train 2.0662825107574463</p>
<p>val 2.1201331615448</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>
<section id="part-2-pytorch-ifying-the-code-and-train-a-deeper-network" class="level1">
<h1>Part 2: PyTorch-ifying the code, and train a deeper network</h1>
<p>Below is PyTorch-ified code by Andrej, some comments inputted by me:</p>
<div id="0d606bcb" class="cell" data-execution_count="27">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Let's train a deeper network</span></span>
<span id="cb41-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The classes we create here are the same API as nn.Module in PyTorch</span></span>
<span id="cb41-3"></span>
<span id="cb41-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Linear:</span>
<span id="cb41-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb41-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Simplifying Pytorch Linear Layer: https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear</span></span>
<span id="cb41-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb41-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, fan_in, fan_out, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb41-9">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((fan_in, fan_out), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> fan_in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb41-10">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(fan_out) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> bias <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb41-11"></span>
<span id="cb41-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb41-13">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.weight</span>
<span id="cb41-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb41-15">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias</span>
<span id="cb41-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out</span>
<span id="cb41-17"></span>
<span id="cb41-18">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> parameters(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb41-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.weight] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ([] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias])</span>
<span id="cb41-20"></span>
<span id="cb41-21"></span>
<span id="cb41-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> BatchNorm1d:</span>
<span id="cb41-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb41-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Simplifying Pytorch BatchNorm1D: https://pytorch.org/docs/stable/generated/torch.nn.BatchNorm1d.html</span></span>
<span id="cb41-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span> </span>
<span id="cb41-26">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, dim, eps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span>, momentum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>):</span>
<span id="cb41-27">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.eps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> eps</span>
<span id="cb41-28">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.momentum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> momentum</span>
<span id="cb41-29">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.training <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to differentiate usage of class in training or evaluation (using running mean/std)</span></span>
<span id="cb41-30">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># parameters (trained with backprop)</span></span>
<span id="cb41-31">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ones(dim) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gain</span></span>
<span id="cb41-32">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(dim) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bias</span></span>
<span id="cb41-33">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># buffers (trained with a running 'momentum update')</span></span>
<span id="cb41-34">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(dim)</span>
<span id="cb41-35">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ones(dim)</span>
<span id="cb41-36"></span>
<span id="cb41-37">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb41-38">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calculate the forward pass</span></span>
<span id="cb41-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.training:</span>
<span id="cb41-40">            xmean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch mean</span></span>
<span id="cb41-41">            xvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.var(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch variance, follow the paper exactly</span></span>
<span id="cb41-42">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb41-43">            xmean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_mean</span>
<span id="cb41-44">            xvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_var</span>
<span id="cb41-45">        xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xmean) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> torch.sqrt(xvar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.eps) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># normalize to unit variance</span></span>
<span id="cb41-46">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.beta <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to tracking and visualizing data later on, PyTorch does not have this</span></span>
<span id="cb41-47">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update the buffers</span></span>
<span id="cb41-48">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.training:</span>
<span id="cb41-49">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb41-50">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.momentum) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.momentum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> xmean</span>
<span id="cb41-51">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.momentum) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.running_var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.momentum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> xvar</span>
<span id="cb41-52">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out</span>
<span id="cb41-53"></span>
<span id="cb41-54">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> parameters(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb41-55">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gamma, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.beta]</span>
<span id="cb41-56"></span>
<span id="cb41-57"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Tanh:</span>
<span id="cb41-58">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb41-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Just calculate the Tanh, just PyTorch: https://pytorch.org/docs/stable/generated/torch.nn.Tanh.html</span></span>
<span id="cb41-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb41-61">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb41-62">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(x)</span>
<span id="cb41-63">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out</span>
<span id="cb41-64">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> parameters(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb41-65">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> []</span>
<span id="cb41-66"></span>
<span id="cb41-67">n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the dimensionality of the character embedding vectors</span></span>
<span id="cb41-68">n_hidden <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the number of neurons in the hidden layer of the MLP</span></span>
<span id="cb41-69">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for reproducibility</span></span>
<span id="cb41-70"></span>
<span id="cb41-71">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((vocab_size, n_embd),            generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb41-72"></span>
<span id="cb41-73">layers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb41-74">    Linear(n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size, n_hidden), Tanh(),</span>
<span id="cb41-75">    Linear(           n_hidden, n_hidden), Tanh(),</span>
<span id="cb41-76">    Linear(           n_hidden, n_hidden), Tanh(),</span>
<span id="cb41-77">    Linear(           n_hidden, n_hidden), Tanh(),</span>
<span id="cb41-78">    Linear(           n_hidden, n_hidden), Tanh(),</span>
<span id="cb41-79">    Linear(           n_hidden, vocab_size),</span>
<span id="cb41-80">]</span>
<span id="cb41-81"></span>
<span id="cb41-82"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb41-83">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># last layer: make less confident</span></span>
<span id="cb41-84">    layers[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb41-85">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># all other layers: apply gain</span></span>
<span id="cb41-86">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]:</span>
<span id="cb41-87">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(layer, Linear):</span>
<span id="cb41-88">            layer.weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb41-89"></span>
<span id="cb41-90">parameters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [C] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [p <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layer.parameters()]</span>
<span id="cb41-91"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p.nelement() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of parameters in total</span></span>
<span id="cb41-92"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb41-93">    p.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>46497</code></pre>
</div>
</div>
<div id="c0dda97c" class="cell" data-execution_count="28">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># same optimization as last time</span></span>
<span id="cb43-2">max_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200000</span></span>
<span id="cb43-3">batch_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb43-4">lossi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb43-5">ud <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb43-6"></span>
<span id="cb43-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(max_steps):</span>
<span id="cb43-8">  </span>
<span id="cb43-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minibatch construct</span></span>
<span id="cb43-10">    ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Xtr.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], (batch_size,), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb43-11">    Xb, Yb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Xtr[ix], Ytr[ix] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch X,Y</span></span>
<span id="cb43-12"></span>
<span id="cb43-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass</span></span>
<span id="cb43-14">    emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xb] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># embed the characters into vectors</span></span>
<span id="cb43-15">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># concatenate the vectors</span></span>
<span id="cb43-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers:</span>
<span id="cb43-17">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layer(x)</span>
<span id="cb43-18">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(x, Yb) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss function</span></span>
<span id="cb43-19"></span>
<span id="cb43-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass</span></span>
<span id="cb43-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers:</span>
<span id="cb43-22">        layer.out.retain_grad() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AFTER_DEBUG: would take out retain_graph</span></span>
<span id="cb43-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb43-24">        p.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb43-25">    loss.backward()</span>
<span id="cb43-26"></span>
<span id="cb43-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update</span></span>
<span id="cb43-28">    lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150000</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># step learning rate decay</span></span>
<span id="cb43-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb43-30">        p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p.grad</span>
<span id="cb43-31"></span>
<span id="cb43-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># track stats</span></span>
<span id="cb43-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print every once in a while</span></span>
<span id="cb43-34">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:7d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>max_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:7d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb43-35">    lossi.append(loss.log10().item())</span>
<span id="cb43-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb43-37">        ud.append([((lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p.grad).std() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p.data.std()).log10().item() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters])</span>
<span id="cb43-38"></span>
<span id="cb43-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb43-40">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if i &gt;= 1000:</span></span>
<span id="cb43-41">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     break # AFTER_DEBUG: would take out obviously to run full optimization</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      0/ 200000: 3.2962</code></pre>
</div>
</div>
<section id="viz-1-forward-pass-activations-statistics" class="level2">
<h2 class="anchored" data-anchor-id="viz-1-forward-pass-activations-statistics">viz #1: forward pass activations statistics</h2>
<div id="7d864881" class="cell" data-execution_count="29">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb45-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># visualize histograms</span></span>
<span id="cb45-2">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># width and height of the plot</span></span>
<span id="cb45-3">legends <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb45-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i, layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(layers[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]): <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note: exclude the output layer</span></span>
<span id="cb45-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(layer, Tanh):</span>
<span id="cb45-6">    t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layer.out</span>
<span id="cb45-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'layer </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%10s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">): mean </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%+.2f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, std </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, saturated: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f%%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (i, layer.__class__.<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span>, t.mean(), t.std(), (t.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.97</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>().mean()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))</span>
<span id="cb45-8">    hy, hx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.histogram(t, density<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb45-9">    plt.plot(hx[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].detach(), hy.detach())</span>
<span id="cb45-10">    legends.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'layer </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>layer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>__class__<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb45-11">plt.legend(legends)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb45-12">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'activation distribution'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>layer 1 (      Tanh): mean -0.02, std 0.75, saturated: 20.25%
layer 3 (      Tanh): mean -0.00, std 0.69, saturated: 8.38%
layer 5 (      Tanh): mean +0.00, std 0.67, saturated: 6.62%
layer 7 (      Tanh): mean -0.01, std 0.66, saturated: 5.47%
layer 9 (      Tanh): mean -0.02, std 0.66, saturated: 6.12%</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>Text(0.5, 1.0, 'activation distribution')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/index_files/figure-html/cell-30-output-3.png" width="855" height="283" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>If we set the gain to <code>1</code>, the std is shrinking, and the saturation is coming to zeros, due to the first layer is pretty decent, but the next ones are shrinking to zero because of the <code>tanh()</code> - a squashing function.</p>
<div class="sourceCode" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb48-1">layer 1 (      Tanh): mean -0.02, std 0.62, saturated: 3.50%</span>
<span id="cb48-2">layer 3 (      Tanh): mean -0.00, std 0.48, saturated: 0.03%</span>
<span id="cb48-3">layer 5 (      Tanh): mean +0.00, std 0.41, saturated: 0.06%</span>
<span id="cb48-4">layer 7 (      Tanh): mean +0.00, std 0.35, saturated: 0.00%</span>
<span id="cb48-5">layer 9 (      Tanh): mean -0.02, std 0.32, saturated: 0.00%</span>
<span id="cb48-6">Text(0.5, 1.0, 'activation distribution')</span></code></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/viz1_gain1.png" class="img-fluid figure-img"></p>
<figcaption>If the gain is 1</figcaption>
</figure>
</div>
<p>But if we set the gain is far too high, let‚Äôs say <code>3</code>, we can see the saturation is too high.</p>
<div class="sourceCode" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb49-1">layer 1 (      Tanh): mean -0.03, std 0.85, saturated: 47.66%</span>
<span id="cb49-2">layer 3 (      Tanh): mean +0.00, std 0.84, saturated: 40.47%</span>
<span id="cb49-3">layer 5 (      Tanh): mean -0.01, std 0.84, saturated: 42.38%</span>
<span id="cb49-4">layer 7 (      Tanh): mean -0.01, std 0.84, saturated: 42.00%</span>
<span id="cb49-5">layer 9 (      Tanh): mean -0.03, std 0.84, saturated: 42.41%</span>
<span id="cb49-6">Text(0.5, 1.0, 'activation distribution')</span></code></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/viz1_gain3.png" class="img-fluid figure-img"></p>
<figcaption>If the gain is 3</figcaption>
</figure>
</div>
<p>So <code>5/3</code> is a nice one, balancing the std and saturation.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Why 5/3?">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why 5/3?
</div>
</div>
<div class="callout-body-container callout-body">
<p>A comment in his video explains why <code>5/3</code> is recommended, it comes from the avg of <img src="https://latex.codecogs.com/png.latex?%5B%5Ctanh(x)%5D%5E2"> where <img src="https://latex.codecogs.com/png.latex?x"> is distributed as a Gaussian:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cinfty%7D%20%5Cfrac%7B%5B%5Ctanh(x)%5D%5E2%20%5Cexp(-%5Cfrac%7Bx%5E2%7D%7B2%7D)%7D%7B%5Csqrt%7B2%5Cpi%7D%7D%20%5C,%20dx%20%5Capprox%200.39"></p>
<blockquote class="blockquote">
<p>The square root of this value is how much the <code>tanh</code> squeezes the variance of the incoming variable: 0.39 ** .5 ~= 0.63 ~= 3/5 (hence 5/3 is just an approximation of the exact gain).</p>
</blockquote>
</div>
</div>
</section>
<section id="viz-2-backward-pass-gradient-statistics" class="level2">
<h2 class="anchored" data-anchor-id="viz-2-backward-pass-gradient-statistics">viz #2: backward pass gradient statistics</h2>
<p>Similarly, we can do the same thing with gradients. With the setting of gain as <code>5/3</code>, the distribution of gradients through layers quite the same. Layer by layer, the value of gradients will be shrank close to zero, the distributions would be more and more peak, so the gain here will help expanding those distributions.</p>
<div id="dfe866ce" class="cell" data-execution_count="30">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># visualize histograms</span></span>
<span id="cb50-2">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># width and height of the plot</span></span>
<span id="cb50-3">legends <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb50-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i, layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(layers[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]): <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note: exclude the output layer</span></span>
<span id="cb50-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(layer, Tanh):</span>
<span id="cb50-6">    t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layer.out.grad</span>
<span id="cb50-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'layer </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%10s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">): mean </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%+f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, std </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%e</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (i, layer.__class__.<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span>, t.mean(), t.std()))</span>
<span id="cb50-8">    hy, hx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.histogram(t, density<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb50-9">    plt.plot(hx[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].detach(), hy.detach())</span>
<span id="cb50-10">    legends.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'layer </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>layer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>__class__<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb50-11">plt.legend(legends)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb50-12">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gradient distribution'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>layer 1 (      Tanh): mean +0.000010, std 4.205588e-04
layer 3 (      Tanh): mean -0.000003, std 3.991179e-04
layer 5 (      Tanh): mean +0.000003, std 3.743020e-04
layer 7 (      Tanh): mean +0.000015, std 3.290473e-04
layer 9 (      Tanh): mean -0.000014, std 3.054035e-04</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>Text(0.5, 1.0, 'gradient distribution')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/index_files/figure-html/cell-31-output-3.png" width="888" height="283" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-fully-linear-case-of-no-non-linearity" class="level2">
<h2 class="anchored" data-anchor-id="the-fully-linear-case-of-no-non-linearity">the fully linear case of no non-linearity</h2>
<p>Now imagine if we remove the <code>tanh</code> from all layers, the recommend gain now for Linear is <code>1</code>.</p>
<div id="9a455b65" class="cell" data-execution_count="31">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb53-1">layers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb53-2">  Linear(n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size, n_hidden), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Tanh(),</span></span>
<span id="cb53-3">  Linear(           n_hidden, n_hidden), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Tanh(),</span></span>
<span id="cb53-4">  Linear(           n_hidden, n_hidden), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Tanh(),</span></span>
<span id="cb53-5">  Linear(           n_hidden, n_hidden), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Tanh(),</span></span>
<span id="cb53-6">  Linear(           n_hidden, n_hidden), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Tanh(),</span></span>
<span id="cb53-7">  Linear(           n_hidden, vocab_size),</span>
<span id="cb53-8">]</span></code></pre></div>
</details>
</div>
<p>But you‚Äôll end up getting a pure linear network. No matter of how many Linear Layers you stacked up, it just the combination of all layers to a massive linear function <img src="https://latex.codecogs.com/png.latex?y%20=%20xA%5ET%20+%20b">, which will greatly limit the capacity of the neural nets.</p>
</section>
<section id="viz-3-parameter-activation-and-gradient-statistics" class="level2">
<h2 class="anchored" data-anchor-id="viz-3-parameter-activation-and-gradient-statistics">viz #3: parameter activation and gradient statistics</h2>
<p>We can also visualize the distribution of paramaters, here below only weight for simplicity (ignoring gamma, beta, etc‚Ä¶). We observed mean, std, and the grad to data ratio (to see how much the data will be updated).</p>
<p>Problem for the last layer is shown in code output below, the weights on last layer are 10 times bigger than previous ones, and the grad to data ratio is too high.</p>
<p>We can try run 1st 1000 training loops and this can be slight reduced, but since we are using a simple optimizer SGD rather than modern one like Adam, it is still problematic.</p>
<div id="01311979" class="cell" data-execution_count="32">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb54-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># visualize histograms</span></span>
<span id="cb54-2">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># width and height of the plot</span></span>
<span id="cb54-3">legends <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb54-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i,p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(parameters):</span>
<span id="cb54-5">  t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p.grad</span>
<span id="cb54-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> p.ndim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:</span>
<span id="cb54-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'weight </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%10s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> | mean </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%+f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> | std </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%e</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> | grad:data ratio </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%e</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(p.shape), t.mean(), t.std(), t.std() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p.std()))</span>
<span id="cb54-8">    hy, hx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.histogram(t, density<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb54-9">    plt.plot(hx[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].detach(), hy.detach())</span>
<span id="cb54-10">    legends.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(p.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb54-11">plt.legend(legends)</span>
<span id="cb54-12">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'weights gradient distribution'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>weight   (27, 10) | mean -0.000031 | std 1.365078e-03 | grad:data ratio 1.364090e-03
weight  (30, 100) | mean -0.000049 | std 1.207430e-03 | grad:data ratio 3.871660e-03
weight (100, 100) | mean +0.000016 | std 1.096730e-03 | grad:data ratio 6.601988e-03
weight (100, 100) | mean -0.000010 | std 9.893572e-04 | grad:data ratio 5.893091e-03
weight (100, 100) | mean -0.000011 | std 8.623432e-04 | grad:data ratio 5.158123e-03
weight (100, 100) | mean -0.000004 | std 7.388576e-04 | grad:data ratio 4.415211e-03
weight  (100, 27) | mean -0.000000 | std 2.364824e-02 | grad:data ratio 2.328203e+00</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/index_files/figure-html/cell-33-output-2.png" width="881" height="283" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="viz-4-update-data-ratio-over-time" class="level2">
<h2 class="anchored" data-anchor-id="viz-4-update-data-ratio-over-time">viz #4: update data ratio over time</h2>
<p>The grad to data above ratio is at the end not really informative (only at one point in time), what matter is actual amount which we change the data in these tensors (over time). AK introduce a tracking list <code>ud</code> (update to data). This calculates the ratio between (std) of the grad to the data of parameters (and <code>log10()</code> for a nicer viz) <strong>without context of gradient</strong>.</p>
<div id="ef31baee" class="cell" data-execution_count="33">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb56-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb56-2">legends <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb56-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i,p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(parameters):</span>
<span id="cb56-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> p.ndim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:</span>
<span id="cb56-5">    plt.plot([ud[j][i] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(ud))])</span>
<span id="cb56-6">    legends.append(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'param </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> i)</span>
<span id="cb56-7">plt.plot([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(ud)], [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k'</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># these ratios should be ~1e-3, indicate on plot</span></span>
<span id="cb56-8">plt.legend(legends)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
</div>
<p>Below is the visualization from data collected after 1000 training loops:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/viz4_1000times.png" class="img-fluid figure-img"></p>
<figcaption>Viz 4 1000</figcaption>
</figure>
</div>
<p>Recall what we did to the last layer, avoiding over confidence, so the pink line looks different among others. In general, the learning process are good, if we change the learning rate to <code>0.0001</code>, the chart looks much worse.</p>
<p>Below are viz 1 after 1000 training loops:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/viz1_1000times.png" class="img-fluid figure-img"></p>
<figcaption>Viz 1 1000</figcaption>
</figure>
</div>
<p>and viz 2:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/viz2_1000times.png" class="img-fluid figure-img"></p>
<figcaption>Viz 2 1000</figcaption>
</figure>
</div>
<p>and viz 3:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/viz3_1000times.png" class="img-fluid figure-img"></p>
<figcaption>Viz 3 1000</figcaption>
</figure>
</div>
<p>Pretty decent till now. Let‚Äôs bring the BatchNorm back.</p>
</section>
<section id="bringing-back-batchnorm-looking-at-the-visualizations" class="level2">
<h2 class="anchored" data-anchor-id="bringing-back-batchnorm-looking-at-the-visualizations">bringing back batchnorm, looking at the visualizations</h2>
<p>We re-define the layers, and change <code>gamma</code> in last layer under no gradient instead of <code>weight</code>. We also dont want the ‚Äúmanual normalization‚Äù fan-in, and the gain <code>5/3</code> as well:</p>
<div id="4d9f0d00" class="cell" data-execution_count="34">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb57-1">layers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb57-2">  Linear(n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(n_hidden), Tanh(),</span>
<span id="cb57-3">  Linear(           n_hidden, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(n_hidden), Tanh(),</span>
<span id="cb57-4">  Linear(           n_hidden, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(n_hidden), Tanh(),</span>
<span id="cb57-5">  Linear(           n_hidden, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(n_hidden), Tanh(),</span>
<span id="cb57-6">  Linear(           n_hidden, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(n_hidden), Tanh(),</span>
<span id="cb57-7">  Linear(           n_hidden, vocab_size, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(vocab_size),</span>
<span id="cb57-8">]</span></code></pre></div>
</details>
</div>
</section>
<section id="summary-of-the-lecture-for-real-this-time" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-the-lecture-for-real-this-time">summary of the lecture for real this time</h2>
<ol type="1">
<li>Intruduction of Batch Normalization - the 1st one of modern innovation to stablize Deep NN training;</li>
<li>PyTorch-ifying code;</li>
<li>Introduction to some diagnostic tools that we can use to verify the network is in good state dynamically.</li>
</ol>
<p>What he did not try to improve here is the loss of the network. It‚Äôs now somehow bottleneck not by the Optimization, but by the Context Length he suspect.</p>
<blockquote class="blockquote">
<p>Training Neural Network is like balancing a pencil on a finger.</p>
</blockquote>
<p>Final network architecture and training:</p>
<div id="1c3ea2f8" class="cell" data-execution_count="35">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb58-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BatchNorm1D and Tanh are the same</span></span>
<span id="cb58-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Linear:</span>
<span id="cb58-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb58-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Simplifying Pytorch Linear Layer: https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#torch.nn.Linear</span></span>
<span id="cb58-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb58-6">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, fan_in, fan_out, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb58-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((fan_in, fan_out), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># / fan_in**0.5</span></span>
<span id="cb58-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(fan_out) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> bias <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb58-9"></span>
<span id="cb58-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb58-11">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.weight</span>
<span id="cb58-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb58-13">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias</span>
<span id="cb58-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.out</span>
<span id="cb58-15"></span>
<span id="cb58-16">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> parameters(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb58-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.weight] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ([] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> [<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bias])</span>
<span id="cb58-18"></span>
<span id="cb58-19">n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the dimensionality of the character embedding vectors</span></span>
<span id="cb58-20">n_hidden <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the number of neurons in the hidden layer of the MLP</span></span>
<span id="cb58-21">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for reproducibility</span></span>
<span id="cb58-22">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((vocab_size, n_embd),            generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb58-23">layers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb58-24">  Linear(n_embd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(n_hidden), Tanh(),</span>
<span id="cb58-25">  Linear(           n_hidden, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(n_hidden), Tanh(),</span>
<span id="cb58-26">  Linear(           n_hidden, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(n_hidden), Tanh(),</span>
<span id="cb58-27">  Linear(           n_hidden, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(n_hidden), Tanh(),</span>
<span id="cb58-28">  Linear(           n_hidden, n_hidden, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(n_hidden), Tanh(),</span>
<span id="cb58-29">  Linear(           n_hidden, vocab_size, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), BatchNorm1d(vocab_size),</span>
<span id="cb58-30">]</span>
<span id="cb58-31"></span>
<span id="cb58-32"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb58-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># last layer: make less confident</span></span>
<span id="cb58-34">    layers[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb58-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># all other layers: apply gain</span></span>
<span id="cb58-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]:</span>
<span id="cb58-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(layer, Linear):</span>
<span id="cb58-38">            layer.weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#5/3</span></span>
<span id="cb58-39"></span>
<span id="cb58-40">parameters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [C] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [p <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layer.parameters()]</span>
<span id="cb58-41"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p.nelement() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of parameters in total</span></span>
<span id="cb58-42"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb58-43">    p.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb58-44"></span>
<span id="cb58-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># same optimization as last time</span></span>
<span id="cb58-46">max_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200000</span></span>
<span id="cb58-47">batch_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb58-48">lossi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb58-49">ud <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb58-50"></span>
<span id="cb58-51"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(max_steps):</span>
<span id="cb58-52">  </span>
<span id="cb58-53">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minibatch construct</span></span>
<span id="cb58-54">    ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Xtr.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], (batch_size,), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb58-55">    Xb, Yb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Xtr[ix], Ytr[ix] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch X,Y</span></span>
<span id="cb58-56"></span>
<span id="cb58-57">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass</span></span>
<span id="cb58-58">    emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xb] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># embed the characters into vectors</span></span>
<span id="cb58-59">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># concatenate the vectors</span></span>
<span id="cb58-60">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers:</span>
<span id="cb58-61">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layer(x)</span>
<span id="cb58-62">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(x, Yb) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss function</span></span>
<span id="cb58-63"></span>
<span id="cb58-64">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass</span></span>
<span id="cb58-65">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers:</span>
<span id="cb58-66">        layer.out.retain_grad() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AFTER_DEBUG: would take out retain_graph</span></span>
<span id="cb58-67">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb58-68">        p.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb58-69">    loss.backward()</span>
<span id="cb58-70"></span>
<span id="cb58-71">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update</span></span>
<span id="cb58-72">    lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150000</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># step learning rate decay</span></span>
<span id="cb58-73">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb58-74">        p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p.grad</span>
<span id="cb58-75"></span>
<span id="cb58-76">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># track stats</span></span>
<span id="cb58-77">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print every once in a while</span></span>
<span id="cb58-78">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:7d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>max_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:7d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb58-79">    lossi.append(loss.log10().item())</span>
<span id="cb58-80">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb58-81">        ud.append([((lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p.grad).std() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p.data.std()).log10().item() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters])</span>
<span id="cb58-82"></span>
<span id="cb58-83">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># break</span></span>
<span id="cb58-84">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if i &gt;= 1000:</span></span>
<span id="cb58-85">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     break # AFTER_DEBUG: would take out obviously to run full optimization</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>47024
      0/ 200000: 3.2870
  10000/ 200000: 2.4521
  20000/ 200000: 2.0847
  30000/ 200000: 2.1838
  40000/ 200000: 2.1515
  50000/ 200000: 2.2246
  60000/ 200000: 1.9450
  70000/ 200000: 2.2514
  80000/ 200000: 2.4420
  90000/ 200000: 2.0624
 100000/ 200000: 2.5850
 110000/ 200000: 2.3225
 120000/ 200000: 2.2004
 130000/ 200000: 2.0352
 140000/ 200000: 1.8516
 150000/ 200000: 2.0424
 160000/ 200000: 2.2229
 170000/ 200000: 2.0384
 180000/ 200000: 2.2274
 190000/ 200000: 2.0901</code></pre>
</div>
</div>
<p>Final visualization:</p>
<p>Viz 1:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/viz1_final.png" class="img-fluid figure-img"></p>
<figcaption>Viz 1 final</figcaption>
</figure>
</div>
<p>Viz 2:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/viz2_final.png" class="img-fluid figure-img"></p>
<figcaption>Viz 2 final</figcaption>
</figure>
</div>
<p>Viz 3:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/viz3_final.png" class="img-fluid figure-img"></p>
<figcaption>Viz 3 final</figcaption>
</figure>
</div>
<p>Viz 4:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/viz4_final.png" class="img-fluid figure-img"></p>
<figcaption>Viz 4 final</figcaption>
</figure>
</div>
<p>The final loss on train/val:</p>
<div id="90609a85" class="cell" data-execution_count="36">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb60-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@torch.no_grad</span>() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this decorator disables gradient tracking</span></span>
<span id="cb60-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> split_loss(split):</span>
<span id="cb60-3">  x,y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb60-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>: (Xtr, Ytr),</span>
<span id="cb60-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val'</span>: (Xdev, Ydev),</span>
<span id="cb60-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>: (Xte, Yte),</span>
<span id="cb60-7">  }[split]</span>
<span id="cb60-8">  emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[x] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (N, block_size, n_embd)</span></span>
<span id="cb60-9">  x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># concat into (N, block_size * n_embd)</span></span>
<span id="cb60-10">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers:</span>
<span id="cb60-11">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layer(x)</span>
<span id="cb60-12">  loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(x, y)</span>
<span id="cb60-13">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(split, loss.item())</span>
<span id="cb60-14"></span>
<span id="cb60-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># put layers into eval mode</span></span>
<span id="cb60-16"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers:</span>
<span id="cb60-17">  layer.training <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb60-18">split_loss(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>)</span>
<span id="cb60-19">split_loss(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>train 2.103635549545288
val 2.1365904808044434</code></pre>
</div>
</div>
<p>Sample from the model:</p>
<div id="711ba3e9" class="cell" data-execution_count="37">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb62-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample from the model</span></span>
<span id="cb62-2">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb62-3"></span>
<span id="cb62-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>):</span>
<span id="cb62-5">    </span>
<span id="cb62-6">    out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb62-7">    context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize with all ...</span></span>
<span id="cb62-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>:</span>
<span id="cb62-9">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass the neural net</span></span>
<span id="cb62-10">      emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[torch.tensor([context])] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (1,block_size,n_embd)</span></span>
<span id="cb62-11">      x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(emb.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># concatenate the vectors</span></span>
<span id="cb62-12">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers:</span>
<span id="cb62-13">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> layer(x)</span>
<span id="cb62-14">      logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x</span>
<span id="cb62-15">      probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.softmax(logits, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb62-16">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample from the distribution</span></span>
<span id="cb62-17">      ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.multinomial(probs, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g).item()</span>
<span id="cb62-18">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shift the context window and track the samples</span></span>
<span id="cb62-19">      context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> context[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [ix]</span>
<span id="cb62-20">      out.append(ix)</span>
<span id="cb62-21">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if we sample the special '.' token, break</span></span>
<span id="cb62-22">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb62-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb62-24">    </span>
<span id="cb62-25">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(itos[i] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> out)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># decode and print the generated word</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>mona.
mayannielle.
dhryah.
rethan.
ejdraeg.
adelynnelin.
shi.
jen.
edelisson.
arleigh.
malaia.
nosadbergiaghiel.
kinde.
jennex.
terofius.
kaven.
jamyleyeh.
yuma.
myston.
azhil.</code></pre>
</div>
</div>
<p>Happy learning!</p>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises:</h2>
<ul>
<li>E01: I did not get around to seeing what happens when you initialize all weights and biases to zero. Try this and train the neural net. You might think either that 1) the network trains just fine or 2) the network doesn‚Äôt train at all, but actually it is 3) the network trains but only partially, and achieves a pretty bad final performance. Inspect the gradients and activations to figure out what is happening and why the network is only partially training, and what part is being trained exactly.</li>
<li>E02: BatchNorm, unlike other normalization layers like LayerNorm/GroupNorm etc. has the big advantage that after training, the batchnorm gamma/beta can be ‚Äúfolded into‚Äù the weights of the preceeding Linear layers, effectively erasing the need to forward it at test time. Set up a small 3-layer MLP with batchnorms, train the network, then ‚Äúfold‚Äù the batchnorm gamma/beta into the preceeding Linear layer‚Äôs W,b by creating a new W2, b2 and erasing the batch norm. Verify that this gives the same forward pass during inference. i.e.&nbsp;we see that the batchnorm is there just for stabilizing the training, and can be thrown out after training is done! pretty cool.</li>
</ul>
</section>
</section>
<section id="resources" class="level1">
<h1>resources:</h1>
<ol type="1">
<li>other people learn from AK like me: <a href="https://bedirtapkan.com/posts/blog_posts/karpathy_3_makemore_activations/" class="uri">https://bedirtapkan.com/posts/blog_posts/karpathy_3_makemore_activations/</a>; <a href="https://skeptric.com/index.html#category=makemore" class="uri">https://skeptric.com/index.html#category=makemore</a> - a replicate (?) with more OOPs on another dataset;</li>
<li>some good papers recommended by Andrej:
<ul>
<li>‚ÄúKaiming init‚Äù paper: <a href="https://arxiv.org/abs/1502.01852" class="uri">https://arxiv.org/abs/1502.01852</a>;</li>
<li>BatchNorm paper: <a href="https://arxiv.org/abs/1502.03167" class="uri">https://arxiv.org/abs/1502.03167</a>;</li>
<li>Bengio et al.&nbsp;2003 MLP language model paper (pdf): <a href="https://www.jmlr.org/papers/volume3/bengio03a/bengio03a.pdf" class="uri">https://www.jmlr.org/papers/volume3/bengio03a/bengio03a.pdf</a>;</li>
<li>Good paper illustrating some of the problems with batchnorm in practice: <a href="https://arxiv.org/abs/2105.07576" class="uri">https://arxiv.org/abs/2105.07576</a>.</li>
</ul></li>
<li>Notebook: <a href="https://github.com/karpathy/nn-zero-to-hero/blob/master/lectures/makemore/makemore_part3_bn.ipynb" class="uri">https://github.com/karpathy/nn-zero-to-hero/blob/master/lectures/makemore/makemore_part3_bn.ipynb</a></li>
</ol>


<!-- -->

</section>

 ]]></description>
  <category>til</category>
  <category>python</category>
  <category>andrej karpathy</category>
  <category>nn-z2h</category>
  <category>neural networks</category>
  <guid>https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/</guid>
  <pubDate>Mon, 25 Nov 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-11-26-nn-z2h-p4/resnet50.png" medium="image" type="image/png" height="83" width="144"/>
</item>
<item>
  <title>NN-Z2H Lesson 3: Building makemore part 2 - MLP</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-11-20-nn-z2h-p3/</link>
  <description><![CDATA[ 





<div class="callout callout-style-default callout-important callout-titled" title="This is not orginal content!">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This is not orginal content!
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is my study notes / codes along with Andrej Karpathy‚Äôs ‚Äú<a href="https://www.youtube.com/watch?v=VMj-3S1tku0&amp;list=PLAqhIrjkxbuWI23v9cThsA9GvCAUhRvKZ">Neural Networks: Zero to Hero</a>‚Äù series.</p>
</div>
</div>
<p>In the previous lecture, we built a simple <code>bigram</code> character-level language model, using 2 different approaches that are (1) count, and (2) 1 layer neural network. They produced the same (and both poor - since the context is 1 character only) result but the neural network option offers more flexibility so that we can complexify our model to get better performance.</p>
<p>In this lecture we are going to implement 20-years ago neural probabilistic language model by <em>Bengio et al.&nbsp;(2003)</em>.</p>
<section id="part-1-intro-to-mlp" class="level1">
<h1>PART 1: intro to MLP</h1>
<section id="bengio-et-al.-2003-mlp-language-model-paper-walkthrough" class="level2">
<h2 class="anchored" data-anchor-id="bengio-et-al.-2003-mlp-language-model-paper-walkthrough">Bengio et al.&nbsp;2003 (MLP language model) paper walkthrough</h2>
<section id="summary" class="level3">
<h3 class="anchored" data-anchor-id="summary">Summary</h3>
<p><strong>Problem Statement</strong>:</p>
<ul>
<li>Traditional n-gram language models suffer from the <em>curse of dimensionality</em>: they can‚Äôt effectively generalize to word sequences not seen in training data;</li>
<li>The core issue is treating words as atomic units with no <em>inherent similarity</em> to each other;</li>
<li>For example, if we‚Äôve seen ‚Äúdog is eating‚Äù in training but never ‚Äúcat is eating‚Äù, n-gram models can‚Äôt leverage the similarity between ‚Äúdog‚Äù and ‚Äúcat‚Äù;</li>
<li>This leads to poor probability estimates for rare or unseen word sequences.</li>
</ul>
<p><strong>Solution</strong>:</p>
<ul>
<li>Learn a <em>distributed representation</em> (embedding) for each word in a continuous vector space where similar words are close to each other;</li>
<li>Use a neural network architecture with:
<ul>
<li>Input layer: concatenated embeddings of n-1 previous words;</li>
<li>Hidden layer: dense neural network with <code>tanh</code> activation;</li>
<li>Output layer: softmax over entire vocabulary to predict next word probability.</li>
</ul></li>
</ul>
<p><strong>The model simultaneously learns</strong>:</p>
<ul>
<li>Word feature vectors (embeddings) that capture <em>semantic/syntactic word similarities</em>;</li>
<li>Neural network parameters that combine these features to estimate probability distributions.</li>
</ul>
<p><strong>Key advantages</strong>:</p>
<ul>
<li>Words with similar meanings get similar feature vectors, enabling better <em>generalization</em>;</li>
<li>The probability function is smooth with respect to word embeddings, so similar words yield <em>similar predictions</em>;</li>
<li>Can generalize to <em>unseen sequences</em> by leveraging learned word similarities.</li>
</ul>
</section>
<section id="methodology" class="level3">
<h3 class="anchored" data-anchor-id="methodology">Methodology:</h3>
<ul>
<li><p>Traditional Problem:</p>
<ul>
<li>In n-gram models, each word sequence of length n is a separate parameter;</li>
<li>For vocabulary size <img src="https://latex.codecogs.com/png.latex?%7CV%7C">, need <img src="https://latex.codecogs.com/png.latex?%7CV%7C%5En"> parameters;</li>
<li>Most sequences never appear in training, leading to poor generalization;</li>
</ul></li>
<li><p>Solution via <strong>Distributed Representation</strong>:</p>
<ul>
<li>Each word mapped to a dense vector in <img src="https://latex.codecogs.com/png.latex?R%5Em"> (typically m=50-100);</li>
<li>Similar words get similar vectors through training;</li>
<li>Probability function is smooth w.r.t these vectors;</li>
<li>Key benefit: If ‚Äúdog‚Äù and ‚Äúcat‚Äù have similar vectors, model can generalize from ‚Äúdog is eating‚Äù to ‚Äúcat is eating‚Äù;</li>
<li>Number of parameters reduces to <img src="https://latex.codecogs.com/png.latex?O(%7CV%7C%C3%97m%20+%20m%C3%97h%20+%20h%C3%97%7CV%7C)">, where <img src="https://latex.codecogs.com/png.latex?h"> is hidden layer size;</li>
<li>This is much smaller than <img src="https://latex.codecogs.com/png.latex?%7CV%7C%5En"> and allows better generalization;</li>
</ul></li>
</ul>
</section>
<section id="neural-architecture" class="level3">
<h3 class="anchored" data-anchor-id="neural-architecture">Neural architecture:</h3>
<p><strong>Input Layer</strong>:</p>
<ul>
<li>Takes <img src="https://latex.codecogs.com/png.latex?n-1"> previous words (context window);</li>
<li>Each word i mapped to vector <img src="https://latex.codecogs.com/png.latex?C(i)%20%E2%88%88%20R%5Em"> via lookup table;</li>
<li>Concatenates these vectors: <img src="https://latex.codecogs.com/png.latex?x%20=%20%5BC(w%E2%82%9C%E2%82%8B%E2%82%99%E2%82%8A%E2%82%81),%20...,%20C(w%E2%82%9C%E2%82%8B%E2%82%81)%5D">;</li>
<li><img src="https://latex.codecogs.com/png.latex?x"> dimension is <img src="https://latex.codecogs.com/png.latex?(n-1)%C3%97m">;</li>
</ul>
<p><strong>Hidden Layer</strong>:</p>
<ul>
<li>Dense layer with tanh activation;</li>
<li>Computation: <img src="https://latex.codecogs.com/png.latex?h%20=%20tanh(d%20+%20Hx)">;</li>
<li><img src="https://latex.codecogs.com/png.latex?H"> is weight matrix, <img src="https://latex.codecogs.com/png.latex?d"> is bias vector;</li>
<li>Maps concatenated context to hidden representation;</li>
</ul>
<p><strong>Output Layer</strong>:</p>
<ul>
<li>Computes probability distribution over all words;</li>
<li><img src="https://latex.codecogs.com/png.latex?y%20=%20b%20+%20Wx%20+%20Uh">;</li>
<li>Softmax activation: <img src="https://latex.codecogs.com/png.latex?P(w%E2%82%9C%7Ccontext)%20=%20exp(y%E1%B5%A2)/%CE%A3%E2%B1%BCexp(y%E2%B1%BC)">;</li>
<li><img src="https://latex.codecogs.com/png.latex?W"> provides ‚Äúshortcut‚Äù connections from input to output;</li>
<li>Direct connection helps learn simpler patterns;</li>
</ul>
<p><strong>Training</strong>:</p>
<ul>
<li>Maximizes log-likelihood of training data;</li>
<li>Uses stochastic gradient descent;</li>
<li>Learns both word vectors <img src="https://latex.codecogs.com/png.latex?C(i)"> and neural network parameters <img src="https://latex.codecogs.com/png.latex?(H,%20d,%20W,%20U,%20b)">;</li>
<li>Word vectors capture similarities as they help predict similar contexts;</li>
<li>Can initialize word vectors randomly or with pretrained vectors.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-20-nn-z2h-p3/NLM_Bengio_etal.png" class="img-fluid figure-img"></p>
<figcaption>Neural Language Model proposed by (Bengio et al., 2003). C(i) is the i th word embedding.</figcaption>
</figure>
</div>
</section>
</section>
<section id="re-building-our-training-dataset" class="level2">
<h2 class="anchored" data-anchor-id="re-building-our-training-dataset">(re-)building our training dataset</h2>
<p>Loading library, reading data, building dictionary:</p>
<div id="e492dcd6" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>matplotlib inline</span></code></pre></div>
</details>
</div>
<div id="01121608" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb2-2"></span>
<span id="cb2-3">url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/karpathy/makemore/refs/heads/master/names.txt"</span></span>
<span id="cb2-4">words <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(url, header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>).iloc[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].tolist()</span>
<span id="cb2-5">words[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>]</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>['emma', 'olivia', 'ava', 'isabella', 'sophia', 'charlotte', 'mia', 'amelia']</code></pre>
</div>
</div>
<div id="c2af0470" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(words)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>32033</code></pre>
</div>
</div>
<div id="510583ce" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># build the vocabulary of characters and mapping to/from integer</span></span>
<span id="cb6-2">chars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(words))))</span>
<span id="cb6-3">stoi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {s:i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i, s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(chars)}</span>
<span id="cb6-4">stoi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb6-5"></span>
<span id="cb6-6">itos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {i: s <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s, i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> stoi.items()}</span>
<span id="cb6-7">itos</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>{1: 'a',
 2: 'b',
 3: 'c',
 4: 'd',
 5: 'e',
 6: 'f',
 7: 'g',
 8: 'h',
 9: 'i',
 10: 'j',
 11: 'k',
 12: 'l',
 13: 'm',
 14: 'n',
 15: 'o',
 16: 'p',
 17: 'q',
 18: 'r',
 19: 's',
 20: 't',
 21: 'u',
 22: 'v',
 23: 'w',
 24: 'x',
 25: 'y',
 26: 'z',
 0: '.'}</code></pre>
</div>
</div>
<p>Building the dataset:</p>
<div id="af0815d1" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the context length: how many characters do we take to predict the next one?</span></span>
<span id="cb8-2">X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [], []</span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]:</span>
<span id="cb8-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(w)</span>
<span id="cb8-6">    context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0 so context will be padded by '.'</span></span>
<span id="cb8-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>:</span>
<span id="cb8-8">        ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch]</span>
<span id="cb8-9">        X.append(context)</span>
<span id="cb8-10">        Y.append(ix)</span>
<span id="cb8-11">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(itos[i] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> context), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-----&gt;'</span>, itos[ix] )</span>
<span id="cb8-12">        context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> context[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [ix] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rolling to the next one</span></span>
<span id="cb8-13"></span>
<span id="cb8-14">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(X)</span>
<span id="cb8-15">Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(Y)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>emma
... -----&gt; e
..e -----&gt; m
.em -----&gt; m
emm -----&gt; a
mma -----&gt; .
olivia
... -----&gt; o
..o -----&gt; l
.ol -----&gt; i
oli -----&gt; v
liv -----&gt; i
ivi -----&gt; a
via -----&gt; .
ava
... -----&gt; a
..a -----&gt; v
.av -----&gt; a
ava -----&gt; .
isabella
... -----&gt; i
..i -----&gt; s
.is -----&gt; a
isa -----&gt; b
sab -----&gt; e
abe -----&gt; l
bel -----&gt; l
ell -----&gt; a
lla -----&gt; .
sophia
... -----&gt; s
..s -----&gt; o
.so -----&gt; p
sop -----&gt; h
oph -----&gt; i
phi -----&gt; a
hia -----&gt; .</code></pre>
</div>
</div>
<div id="bd6807e0" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1">X.shape, X.dtype, Y.shape, Y.dtype</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>(torch.Size([32, 3]), torch.int64, torch.Size([32]), torch.int64)</code></pre>
</div>
</div>
</section>
<section id="implementing-the-embedding-lookup-table" class="level2">
<h2 class="anchored" data-anchor-id="implementing-the-embedding-lookup-table">implementing the embedding lookup table</h2>
<p>In the paper they cram 17k word into as-low-as-possible 30 dimensions space, for our data, we just cram words into 2D space.</p>
<div id="d8c16f21" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div>
</details>
</div>
<p>We can access the element of <code>torch.tensor</code> by:</p>
<div id="036a30dd" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1">C[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># can be integer, list [5, 6, 7], or torch.tensor([5,6,7])</span></span>
<span id="cb13-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &gt; tensor([1.0825, 0.2010])</span></span>
<span id="cb13-3"></span>
<span id="cb13-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># or</span></span>
<span id="cb13-5"></span>
<span id="cb13-6">F.one_hot(torch.tensor(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), num_classes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> C</span>
<span id="cb13-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># produce identical result, remember torch.tensor() infer long dtype int64, so we need to cast to float</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>tensor([ 0.3055, -0.4069])</code></pre>
</div>
</div>
<p>‚Ä¶but in this lecture accessing by <code>C[5]</code> would be sufficient. We can even access using a more than 1 dimension tensor:</p>
<div id="5afd1cbb" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(C[X].shape)</span>
<span id="cb15-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(X[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># integer 1 for 13rd index of 2nd dimension</span></span>
<span id="cb15-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(C[X][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># will be the embedding of that element</span></span>
<span id="cb15-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(C[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># so C[X][13,2] = C[1]</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([32, 3, 2])
tensor(1)
tensor([0.0748, 0.8711])
tensor([0.0748, 0.8711])</code></pre>
</div>
</div>
<p>PyTorch is great for embedding words:</p>
<div id="8fb9db32" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1">emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[X]</span>
<span id="cb17-2">emb.shape</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>torch.Size([32, 3, 2])</code></pre>
</div>
</div>
<p>We‚Äôve compeleted the first layer with <code>context</code> and lookup table!</p>
</section>
<section id="implementing-the-hidden-layer-internals-of-torch.tensor-storage-views" class="level2">
<h2 class="anchored" data-anchor-id="implementing-the-hidden-layer-internals-of-torch.tensor-storage-views">implementing the hidden layer + internals of <code>torch.Tensor</code>: <code>storage</code>, <code>views</code></h2>
<div id="8aa99d10" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># input of tanh layer will be 6 (3 words in context x 2 dimensions)</span></span>
<span id="cb19-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and the number or neurons is up to us - let's set it 100</span></span>
<span id="cb19-3">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))</span>
<span id="cb19-4">b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span></code></pre></div>
</details>
</div>
<p>Now we need to do something like <code>emb @ W1 + b1</code>, but <code>emb.shape</code> is <code>[32, 3, 2]</code> and <code>W1.shape</code> is <code>[6, 100]</code>. We need to somehow concatnate/transform:</p>
<div id="a07a406b" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># emb[:, 0, :] is tensor for each input in the 3-words context, shape is [32, 2]</span></span>
<span id="cb20-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># cat 3 of them using the 2nd dimension (index 1) -&gt; so we set dim = 1</span></span>
<span id="cb20-3">torch.cat([emb[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, :], emb[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, :], emb[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, :]], dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).shape</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>torch.Size([32, 6])</code></pre>
</div>
</div>
<p>However this code does not change dynamically when we change the block size. We will be using <code>torch.unbind()</code></p>
<div id="23521555" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this is good!</span></span>
<span id="cb22-2">torch.cat(torch.unbind(emb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).shape</span>
<span id="cb22-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># new memory for storage is created, so it is not efficient</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>torch.Size([32, 6])</code></pre>
</div>
</div>
<p>This works, but we have a better and more efficient way to do this. Since:</p>
<ul>
<li>every <code>torch.Tensor</code> have <code>.storage()</code> which is one-dimensional vector tensor;</li>
<li>when we call <code>.view()</code>, we instruct how this vector tensor is interpreted;</li>
<li>no memory is being changed/copied/moved/or created. the storage is identical.</li>
</ul>
<p>Readmore: <a href="http://blog.ezyang.com/2019/05/pytorch-internals/" class="uri">http://blog.ezyang.com/2019/05/pytorch-internals/</a></p>
<p>So this hidden layer can be declared:</p>
<div id="6f67b25b" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># instead or 32 we can write emb.shape[1], or -1 (whatever fitted)</span></span>
<span id="cb24-2">h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1</span>
<span id="cb24-3">h.shape</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>torch.Size([32, 100])</code></pre>
</div>
</div>
<p>Notice that in the final operation, <code>b1</code> will be broadcasted.</p>
</section>
<section id="implementing-the-output-layer" class="level2">
<h2 class="anchored" data-anchor-id="implementing-the-output-layer">implementing the output layer</h2>
<div id="e78eceef" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1">W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>))</span>
<span id="cb26-2">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>)</span></code></pre></div>
</details>
</div>
<p>In Deep Learning, people use <code>logits</code> for what raw output that range from negative inf to positive inf.</p>
<div id="f21d0db5" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2</span></code></pre></div>
</details>
</div>
<div id="ab4c6cac" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1">logits.shape</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>torch.Size([32, 27])</code></pre>
</div>
</div>
<p>Now we need to exponentiate it and get the probability.</p>
<div id="08609b0d" class="cell" data-execution_count="18">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1">counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logits.exp()</span></code></pre></div>
</details>
</div>
<div id="9e545490" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1">probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> counts.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
</details>
</div>
<div id="a0c442b2" class="cell" data-execution_count="20">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1">probs.shape</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>torch.Size([32, 27])</code></pre>
</div>
</div>
<p>Every row of <code>probs</code> has sum of 1.</p>
<div id="ca70c847" class="cell" data-execution_count="21">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1">probs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>tensor(1.)</code></pre>
</div>
</div>
<p>And this is the <code>probs</code> of each ground true <code>Y</code> in current output of the neural nets:</p>
<div id="e53f2b9d" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb36-1">probs[torch.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>), Y]</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>tensor([2.0660e-21, 3.6184e-15, 1.5675e-11, 1.2796e-08, 4.4312e-02, 2.4003e-12,
        3.5811e-13, 1.3876e-18, 3.3465e-14, 2.5158e-22, 8.3230e-35, 3.4999e-08,
        7.5305e-10, 6.8868e-24, 1.8081e-28, 8.6262e-08, 4.0514e-18, 4.2847e-19,
        4.9013e-15, 1.0952e-10, 8.4563e-11, 2.1141e-26, 4.4209e-22, 6.9570e-30,
        3.9779e-10, 3.2419e-13, 2.2802e-07, 6.5380e-23, 3.0035e-37, 0.0000e+00,
        0.0000e+00, 3.2723e-26])</code></pre>
</div>
</div>
<p>Result is not good as we‚Äôve not trained the network yet!</p>
</section>
<section id="implementing-the-negative-log-likelihood-loss" class="level2">
<h2 class="anchored" data-anchor-id="implementing-the-negative-log-likelihood-loss">implementing the negative log likelihood loss</h2>
<p>We define the negative log likelihood as:</p>
<div id="4127f2e6" class="cell" data-execution_count="23">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb38-1">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> probs[torch.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>), Y].log().mean()</span>
<span id="cb38-2">loss</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>tensor(inf)</code></pre>
</div>
</div>
</section>
<section id="summary-of-the-full-network" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-the-full-network">summary of the full network</h2>
<p>Dataset:</p>
<div id="3ddbeeb7" class="cell" data-execution_count="24">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1">X.shape, Y.shape</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>(torch.Size([32, 3]), torch.Size([32]))</code></pre>
</div>
</div>
<p>Neural network layers:</p>
<div id="29fb9ebc" class="cell" data-execution_count="25">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb42-1">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>)</span>
<span id="cb42-2">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb42-3">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb42-4">b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb42-5">W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb42-6">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb42-7"></span>
<span id="cb42-8">parameters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [C, W1, b1, W2, b2]</span></code></pre></div>
</details>
</div>
<p>Size of the network:</p>
<div id="ee60f1e7" class="cell" data-execution_count="26">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p.nelement() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>3481</code></pre>
</div>
</div>
<p>Constructing forward pass:</p>
<div id="7d9f3566" class="cell" data-execution_count="27">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb45-1">emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[X] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 3, 2)</span></span>
<span id="cb45-2">h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 100)</span></span>
<span id="cb45-3">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 27)</span></span>
<span id="cb45-4">counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logits.exp()</span>
<span id="cb45-5">probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> counts.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb45-6">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> probs[torch.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>), Y].log().mean()</span>
<span id="cb45-7">loss</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>tensor(17.7697)</code></pre>
</div>
</div>
</section>
</section>
<section id="part-2-intro-to-many-basics-of-machine-learning" class="level1">
<h1>PART 2: intro to many basics of machine learning</h1>
<section id="introducing-f.cross_entropy-and-why" class="level2">
<h2 class="anchored" data-anchor-id="introducing-f.cross_entropy-and-why">introducing <code>F.cross_entropy</code> and why</h2>
<p>We re-define loss:</p>
<div id="955bff3c" class="cell" data-execution_count="28">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb47-1">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Y)</span>
<span id="cb47-2">loss</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>tensor(17.7697)</code></pre>
</div>
</div>
<p>Why?</p>
<ul>
<li>Pytorch will create more intermediate tensor for every assignment: <code>counts</code>, <code>probs</code> -&gt; more memory;</li>
<li>Backward pass will be more optimized, because the expressions are much analytically and mathematically interpreted;</li>
<li>Cross entropy can be significantly &amp; numerically well behaved (for eg when we exponentiate a large positive number we got inf, PyTorch cross entropy will calculate the max of set and subtract it - which will not impact the exp result)</li>
</ul>
</section>
<section id="implementing-the-training-loop-overfitting-one-batch" class="level2">
<h2 class="anchored" data-anchor-id="implementing-the-training-loop-overfitting-one-batch">implementing the training loop, overfitting one batch</h2>
<p>So the forward pass, backward pass, and update loop will be implemented as below:</p>
<div id="64d4c38a" class="cell" data-execution_count="29">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb49-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb49-2">    p.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span></code></pre></div>
</details>
</div>
<div id="b08ab8cb" class="cell" data-execution_count="30">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb50-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass:</span></span>
<span id="cb50-3">    emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[X] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 3, 2)</span></span>
<span id="cb50-4">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 100)</span></span>
<span id="cb50-5">    logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 27)</span></span>
<span id="cb50-6">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Y)</span>
<span id="cb50-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(loss.item())</span>
<span id="cb50-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass:</span></span>
<span id="cb50-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb50-10">        p.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb50-11">    loss.backward()</span>
<span id="cb50-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update</span></span>
<span id="cb50-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb50-14">        p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p.grad</span>
<span id="cb50-15"></span>
<span id="cb50-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(loss.item())</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>17.76971435546875
13.656400680541992
11.298768997192383
9.452457427978516
7.984262466430664
6.891321182250977
6.100014686584473
5.452036380767822
4.898152828216553
4.4146647453308105
4.4146647453308105</code></pre>
</div>
</div>
<p>We are fitting 32 examples to a neural nets of 3481 params, so it‚Äôs super easy to be overfitting. We got a low final loss, but it would never be 0, because the output can varry for the same input, for eg, <code>...</code>.</p>
<div id="181635eb" class="cell" data-execution_count="31">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb52-1">logits.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>torch.return_types.max(
values=tensor([10.7865, 12.2558, 17.3982, 13.2739, 10.6965, 10.7865,  9.5145,  9.0495,
        14.0280, 11.8378,  9.9038, 15.4187, 10.7865, 10.1476,  9.8372, 11.7660,
        10.7865, 10.0029,  9.2940,  9.6824, 11.4241,  9.4885,  8.1164,  9.5176,
        12.6383, 10.7865, 10.6021, 11.0822,  6.3617, 17.3157, 12.4544,  8.1669],
       grad_fn=&lt;MaxBackward0&gt;),
indices=tensor([ 1,  8,  9,  0, 15,  1, 17,  2,  9,  9,  2,  0,  1, 15,  1,  0,  1, 19,
         1,  1, 16, 10, 26,  9,  0,  1, 15, 16,  3,  9, 19,  1]))</code></pre>
</div>
</div>
</section>
<section id="training-on-the-full-dataset-minibatches" class="level2">
<h2 class="anchored" data-anchor-id="training-on-the-full-dataset-minibatches">training on the full dataset, minibatches</h2>
<p>We can deploy our code to all the dataset, un-fold the below code block to see full code.</p>
<div id="82aa36e9" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb54-1">block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb54-2">X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [], []</span>
<span id="cb54-3"></span>
<span id="cb54-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Dataset</span></span>
<span id="cb54-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words:</span>
<span id="cb54-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print(w)</span></span>
<span id="cb54-7">    context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size</span>
<span id="cb54-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>:</span>
<span id="cb54-9">        ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch]</span>
<span id="cb54-10">        X.append(context)</span>
<span id="cb54-11">        Y.append(ix)</span>
<span id="cb54-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print(''.join(itos[i] for i in context), '-----&gt;', itos[ix] )</span></span>
<span id="cb54-13">        context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> context[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [ix] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rolling to the next one</span></span>
<span id="cb54-14"></span>
<span id="cb54-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Input and ground true</span></span>
<span id="cb54-16">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(X)</span>
<span id="cb54-17">Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(Y)</span>
<span id="cb54-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Data size"</span>, X.shape, Y.shape)</span>
<span id="cb54-19"></span>
<span id="cb54-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Lookup table</span></span>
<span id="cb54-21">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>)</span>
<span id="cb54-22">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb54-23">emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[X] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 3, 2)</span></span>
<span id="cb54-24"></span>
<span id="cb54-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 1 - tanh</span></span>
<span id="cb54-26">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb54-27">b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb54-28">h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 100)</span></span>
<span id="cb54-29"></span>
<span id="cb54-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 2 - softmax</span></span>
<span id="cb54-31">W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb54-32">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb54-33">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 27)</span></span>
<span id="cb54-34">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Y)</span>
<span id="cb54-35"></span>
<span id="cb54-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All params</span></span>
<span id="cb54-37">parameters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [C, W1, b1, W2, b2]</span>
<span id="cb54-38"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No of params: "</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p.nelement() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters))</span>
<span id="cb54-39"></span>
<span id="cb54-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pre-training</span></span>
<span id="cb54-41"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb54-42">    p.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Data size torch.Size([228146, 3]) torch.Size([228146])
No of params:  3481</code></pre>
</div>
</div>
<p>We notice that it takes a bit long time for each training in the loop. In practice, we will perform the forward/backward passes and update parameters for a small batch of the dataset. The minibatch construction is added/modified for lines of code with <code>#üëà</code>.</p>
<p>Read more: <a href="https://nttuan8.com/bai-10-cac-ky-thuat-co-ban-trong-deep-learning/" class="uri">https://nttuan8.com/bai-10-cac-ky-thuat-co-ban-trong-deep-learning/</a></p>
<div id="dabcf778" class="cell" data-execution_count="33">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb56-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training</span></span>
<span id="cb56-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>):</span>
<span id="cb56-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minibatch construct                                           #üëà</span></span>
<span id="cb56-4">    ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, X.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>,))                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#üëà</span></span>
<span id="cb56-5"></span>
<span id="cb56-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass:</span></span>
<span id="cb56-7">    emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[X[ix]] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 3, 2)                                     #üëà</span></span>
<span id="cb56-8">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 100)</span></span>
<span id="cb56-9">    logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 27)</span></span>
<span id="cb56-10">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Y[ix])                           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#üëà</span></span>
<span id="cb56-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9990</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"___after running </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>_<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> time: "</span>, loss.item())</span>
<span id="cb56-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass:</span></span>
<span id="cb56-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb56-14">        p.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb56-15">    loss.backward()</span>
<span id="cb56-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update</span></span>
<span id="cb56-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb56-18">        p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p.grad</span>
<span id="cb56-19"></span>
<span id="cb56-20"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"final minibatch loss: "</span>, loss.item())</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>___after running 9990 time:  2.4769816398620605
___after running 9991 time:  2.719482660293579
___after running 9992 time:  2.5886943340301514
___after running 9993 time:  2.2563774585723877
___after running 9994 time:  2.584904432296753
___after running 9995 time:  2.8459784984588623
___after running 9996 time:  2.4365286827087402
___after running 9997 time:  2.2122902870178223
___after running 9998 time:  2.440680742263794
___after running 9999 time:  2.183750867843628
final minibatch loss:  2.183750867843628</code></pre>
</div>
</div>
<p>The <code>loss</code> decrease much much better, although the direction of gradient might be not correct direction. But it is good enough for an approximation. Notice the loss for a minibatch is not the loss of whole dataset.</p>
<div id="abed3dd9" class="cell" data-execution_count="34">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb58-1">emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[X] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 3, 2)                                    </span></span>
<span id="cb58-2">h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 100)</span></span>
<span id="cb58-3">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 27)</span></span>
<span id="cb58-4">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Y)   </span>
<span id="cb58-5">loss.item()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>2.492901086807251</code></pre>
</div>
</div>
<p>We archived 2.39 loss for final minibatch and 2.5 on overall network.</p>
</section>
<section id="finding-a-good-initial-learning-rate" class="level2">
<h2 class="anchored" data-anchor-id="finding-a-good-initial-learning-rate">finding a good initial learning rate</h2>
<p>Now we‚Äôre continuing the optimization, let‚Äôs focus on how much we update the data from the gradient <code>p.data += -0.1 * p.grad</code>. We do not know if we step too little or too much.</p>
<p>We can create 1000 learning rates to use along with the training loop and see which one offers more stable convergence.</p>
<div id="fa9347fd" class="cell" data-execution_count="35">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb60-1">lre <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span>
<span id="cb60-2">lrs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>lre</span></code></pre></div>
</details>
</div>
<p>Reset the code:</p>
<div id="76628b82" class="cell" data-execution_count="36">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb61-1">block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb61-2">X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [], []</span>
<span id="cb61-3"></span>
<span id="cb61-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Dataset</span></span>
<span id="cb61-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words:</span>
<span id="cb61-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print(w)</span></span>
<span id="cb61-7">    context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size</span>
<span id="cb61-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>:</span>
<span id="cb61-9">        ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch]</span>
<span id="cb61-10">        X.append(context)</span>
<span id="cb61-11">        Y.append(ix)</span>
<span id="cb61-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print(''.join(itos[i] for i in context), '-----&gt;', itos[ix] )</span></span>
<span id="cb61-13">        context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> context[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [ix] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rolling to the next one</span></span>
<span id="cb61-14"></span>
<span id="cb61-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Input and ground true</span></span>
<span id="cb61-16">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(X)</span>
<span id="cb61-17">Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(Y)</span>
<span id="cb61-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Data size"</span>, X.shape, Y.shape)</span>
<span id="cb61-19"></span>
<span id="cb61-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Lookup table</span></span>
<span id="cb61-21">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>)</span>
<span id="cb61-22">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb61-23">emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[X] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 3, 2)</span></span>
<span id="cb61-24"></span>
<span id="cb61-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 1 - tanh</span></span>
<span id="cb61-26">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb61-27">b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb61-28">h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 100)</span></span>
<span id="cb61-29"></span>
<span id="cb61-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 2 - softmax</span></span>
<span id="cb61-31">W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb61-32">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb61-33">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 27)</span></span>
<span id="cb61-34">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Y)</span>
<span id="cb61-35"></span>
<span id="cb61-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All params</span></span>
<span id="cb61-37">parameters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [C, W1, b1, W2, b2]</span>
<span id="cb61-38"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No of params: "</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p.nelement() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters))</span>
<span id="cb61-39"></span>
<span id="cb61-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pre-training</span></span>
<span id="cb61-41"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb61-42">    p.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Data size torch.Size([228146, 3]) torch.Size([228146])
No of params:  3481</code></pre>
</div>
</div>
<p>Training and tracking stats:</p>
<div id="6ca24afc" class="cell" data-execution_count="37">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb63-1">lri <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb63-2">lossi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb63-3"></span>
<span id="cb63-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>):</span>
<span id="cb63-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minibatch construct                                           </span></span>
<span id="cb63-6">    ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, X.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>,))                        </span>
<span id="cb63-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass:</span></span>
<span id="cb63-8">    emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[X[ix]] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 3, 2)                                    </span></span>
<span id="cb63-9">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 100)</span></span>
<span id="cb63-10">    logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 27)</span></span>
<span id="cb63-11">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Y[ix])                           </span>
<span id="cb63-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass:</span></span>
<span id="cb63-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb63-14">        p.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb63-15">    loss.backward()</span>
<span id="cb63-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update</span></span>
<span id="cb63-17">    lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lrs[i]</span>
<span id="cb63-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb63-19">        p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p.grad</span>
<span id="cb63-20"></span>
<span id="cb63-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># track stats</span></span>
<span id="cb63-22">    lri.append(lre[i])</span>
<span id="cb63-23">    lossi.append(loss.item())</span>
<span id="cb63-24"></span>
<span id="cb63-25">loss.item()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>8.216608047485352</code></pre>
</div>
</div>
<p>Plotting, we see a good exponential element of learning rate turn out to be around <code>-1</code>.</p>
<p><img src="https://latex.codecogs.com/png.latex?10%5E%7B-1%7D"> is <code>0.1</code> so our initial guess seems good.</p>
<div id="640c4dae" class="cell" data-execution_count="38">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb65-1">plt.plot(lri, lossi)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-20-nn-z2h-p3/index_files/figure-html/cell-39-output-1.png" width="579" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="splitting-up-the-dataset-into-trainvaltest-splits-and-why" class="level2">
<h2 class="anchored" data-anchor-id="splitting-up-the-dataset-into-trainvaltest-splits-and-why">splitting up the dataset into train/val/test splits and why</h2>
<p>Now we can keep lengthening the training loop to continue decreasing loss. We can try some techniques like change the learning rate to <code>0.001</code> after 20k, 30k loops of training with <code>0.1</code>.</p>
<p>But it will come to be overfitting when we try to keep training or increase the size of network to achieve a lower loss. The model just memorizing our training set verbatim, so if we try to sample from the model it just gives us the same thing in the dataset. Or if we calculate the loss on another dataset, it might be very high.</p>
<p>So another industry standard is we will split the data set into 3 pieces: (1) training set; (2) dev/validation set; and (3) test set, they can be 80% - 10% - 10% roughly and respectively.</p>
<ol type="1">
<li>Training split: train the parameters;</li>
<li>Dev/validation split: train the hyperparamerters (size of hidden layer, size of embedding, streng of regularization, etc);</li>
<li>Test split: evaluate the performance of the model at the end, we only work on this a very very few times, otherwise we learn from it and repeat overfitting.</li>
</ol>
<p>We are going to implement this train/dev/test splits:</p>
<div id="ed4b4242" class="cell" data-execution_count="39">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb66-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># build the dataset</span></span>
<span id="cb66-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> buid_dataset(words):</span>
<span id="cb66-3">    block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb66-4">    X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [], []</span>
<span id="cb66-5"></span>
<span id="cb66-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words:</span>
<span id="cb66-7">        context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size</span>
<span id="cb66-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>:</span>
<span id="cb66-9">            ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch]</span>
<span id="cb66-10">            X.append(context)</span>
<span id="cb66-11">            Y.append(ix)</span>
<span id="cb66-12">            context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> context[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [ix]</span>
<span id="cb66-13"></span>
<span id="cb66-14">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(X)</span>
<span id="cb66-15">    Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(Y)</span>
<span id="cb66-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(X.shape, Y.shape)</span>
<span id="cb66-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> X, Y</span>
<span id="cb66-18"></span>
<span id="cb66-19"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb66-20">random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb66-21">random.shuffle(words)</span>
<span id="cb66-22">n1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(words))</span>
<span id="cb66-23">n2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(words))</span>
<span id="cb66-24"></span>
<span id="cb66-25">Xtr, Ytr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[:n1])</span>
<span id="cb66-26">Xdev, Ydev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[n1:n2])</span>
<span id="cb66-27">Xte, Yte <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[n2:])</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([182625, 3]) torch.Size([182625])
torch.Size([22655, 3]) torch.Size([22655])
torch.Size([22866, 3]) torch.Size([22866])</code></pre>
</div>
</div>
<p>Now we‚Äôre already to train on splits of the dataset, but let‚Äôs hold on as we are talking abount overfitting. As discussed, overfitting also come from using a complex (too many parameters) for a small data set.</p>
<p>Our dataset has roughly 228k records, while the size of network is only 3.4k. So we are still underfitting, let‚Äôs continue to complexify our neural networks.</p>
<p>2 things to consider here:</p>
<ul>
<li>the size of tanh - hidden layer; and</li>
<li>dimensions of embedding space.</li>
</ul>
</section>
<section id="visualizing-the-loss-character-embeddings" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-the-loss-character-embeddings">visualizing the loss, character embeddings</h2>
<p>First we want to see: - how the loss decrease with 200k training loop with current network setting, learning rate decay to 0.01 after first 100k; and - how the current character embeddings recognize the similarity between characters in (2D) space.</p>
<p>Training on the <code>Xtr</code>, <code>Ytr</code>:</p>
<div id="5ef3b3e4" class="cell" data-execution_count="40">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb68-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Lookup table</span></span>
<span id="cb68-2">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>)</span>
<span id="cb68-3">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb68-4"></span>
<span id="cb68-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 1 - tanh</span></span>
<span id="cb68-6">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb68-7">b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb68-8"></span>
<span id="cb68-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 2 - softmax</span></span>
<span id="cb68-10">W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb68-11">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb68-12"></span>
<span id="cb68-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All params</span></span>
<span id="cb68-14">parameters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [C, W1, b1, W2, b2]</span>
<span id="cb68-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No of params: "</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p.nelement() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters))</span>
<span id="cb68-16"></span>
<span id="cb68-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pre-training</span></span>
<span id="cb68-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb68-19">    p.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb68-20"></span>
<span id="cb68-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stats holders</span></span>
<span id="cb68-22">lossi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb68-23">stepi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb68-24"></span>
<span id="cb68-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training on Xtr, Ytr</span></span>
<span id="cb68-26"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200_000</span>):</span>
<span id="cb68-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minibatch construct                                           </span></span>
<span id="cb68-28">    ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Xtr.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>,))                       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#üëà</span></span>
<span id="cb68-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass:</span></span>
<span id="cb68-30">    emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xtr[ix]] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 3, 2)                                    #üëà</span></span>
<span id="cb68-31">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 100)</span></span>
<span id="cb68-32">    logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 27)</span></span>
<span id="cb68-33">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Ytr[ix])                          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#üëà</span></span>
<span id="cb68-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass:</span></span>
<span id="cb68-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb68-36">        p.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb68-37">    loss.backward()</span>
<span id="cb68-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update</span></span>
<span id="cb68-39">    lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100_000</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>                                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#üëà</span></span>
<span id="cb68-40">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb68-41">        p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p.grad</span>
<span id="cb68-42"></span>
<span id="cb68-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># track stats</span></span>
<span id="cb68-44">    lossi.append(loss.item())</span>
<span id="cb68-45">    stepi.append(i)</span>
<span id="cb68-46"></span>
<span id="cb68-47"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loss on minibatch: "</span>, loss.item())</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>No of params:  3481
Loss on minibatch:  2.1069579124450684</code></pre>
</div>
</div>
<p>Loss on whole training dataset:</p>
<div id="fe5e43a0" class="cell" data-execution_count="41">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb70-1">emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xtr] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 3, 2)                                    </span></span>
<span id="cb70-2">h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 100)</span></span>
<span id="cb70-3">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 27)</span></span>
<span id="cb70-4">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Ytr)   </span>
<span id="cb70-5">loss.item()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>2.259035110473633</code></pre>
</div>
</div>
<p>Loss on dev/validation dataset, it‚Äôs not much different from loss on training as the model is still underfitting, it still generalizes thing:</p>
<div id="422b9d22" class="cell" data-execution_count="42">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb72-1">emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xdev] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 3, 2)                                    </span></span>
<span id="cb72-2">h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 100)</span></span>
<span id="cb72-3">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (32, 27)</span></span>
<span id="cb72-4">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Ydev)   </span>
<span id="cb72-5">loss.item()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>2.257272958755493</code></pre>
</div>
</div>
<p>Visualizing loss, we can see the loss shaking significantly as the batch size still small - 32.</p>
<div id="d86667b8" class="cell" data-execution_count="43">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb74-1">plt.plot(stepi, lossi)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-20-nn-z2h-p3/index_files/figure-html/cell-44-output-1.png" width="581" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Visualizing the character embeddings, we can see the model can cluster for eg. vowels a, e, i, o, u.</p>
<div id="c788851a" class="cell" data-execution_count="44">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb75-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>))</span>
<span id="cb75-2">plt.scatter(C[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].data, C[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].data, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb75-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(C.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]):</span>
<span id="cb75-4">    plt.text(C[i,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].item(),C[i,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].item(), itos[i], ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>, va<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>)</span>
<span id="cb75-5">plt.grid(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'minor'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-20-nn-z2h-p3/index_files/figure-html/cell-45-output-1.png" width="656" height="633" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="experiment-larger-hidden-layer-larger-embedding-size" class="level2">
<h2 class="anchored" data-anchor-id="experiment-larger-hidden-layer-larger-embedding-size">experiment: larger hidden layer, larger embedding size</h2>
<p>Now we can experiment a larger hidden layer (300), and larger embedding_size (10). Below is the whole code:</p>
<div id="c62f8cec" class="cell" data-execution_count="45">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb76-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hyper-parameters</span></span>
<span id="cb76-2">block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of chracters / inputs to predict the nextone</span></span>
<span id="cb76-3">no_chars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of possible chracters, include '.'</span></span>
<span id="cb76-4">emb_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># no of dimensions of the embedding space.</span></span>
<span id="cb76-5">hidden_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># size of the hidden - tanh layer</span></span>
<span id="cb76-6">batch_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minibatch size for training, 2, 4, 8, 16, 32, 64, etc</span></span>
<span id="cb76-7"></span>
<span id="cb76-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># build the dataset</span></span>
<span id="cb76-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> buid_dataset(words):</span>
<span id="cb76-10"></span>
<span id="cb76-11">    X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [], []</span>
<span id="cb76-12"></span>
<span id="cb76-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words:</span>
<span id="cb76-14">        context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size</span>
<span id="cb76-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>:</span>
<span id="cb76-16">            ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch]</span>
<span id="cb76-17">            X.append(context)</span>
<span id="cb76-18">            Y.append(ix)</span>
<span id="cb76-19">            context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> context[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [ix]</span>
<span id="cb76-20"></span>
<span id="cb76-21">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(X)</span>
<span id="cb76-22">    Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(Y)</span>
<span id="cb76-23">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(X.shape, Y.shape)</span>
<span id="cb76-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> X, Y</span>
<span id="cb76-25"></span>
<span id="cb76-26"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb76-27">random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb76-28">random.shuffle(words)</span>
<span id="cb76-29">n1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(words))</span>
<span id="cb76-30">n2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(words))</span>
<span id="cb76-31"></span>
<span id="cb76-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 80 - 10 - 10 splits</span></span>
<span id="cb76-33">Xtr, Ytr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[:n1])</span>
<span id="cb76-34">Xdev, Ydev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[n1:n2])</span>
<span id="cb76-35">Xte, Yte <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> buid_dataset(words[n2:])</span>
<span id="cb76-36"></span>
<span id="cb76-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Lookup table - 10 dimensional space</span></span>
<span id="cb76-38">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for reproductivity</span></span>
<span id="cb76-39">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((no_chars, emb_size), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb76-40"></span>
<span id="cb76-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 1 - tanh - 300 neurons</span></span>
<span id="cb76-42">W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> emb_size, hidden_size), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb76-43">b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(hidden_size, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb76-44"></span>
<span id="cb76-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Layer 2 - softmax</span></span>
<span id="cb76-46">W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((hidden_size, no_chars), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb76-47">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(no_chars, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb76-48"></span>
<span id="cb76-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All params</span></span>
<span id="cb76-50">parameters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [C, W1, b1, W2, b2]</span>
<span id="cb76-51"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No of params: "</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(p.nelement() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters))</span>
<span id="cb76-52"></span>
<span id="cb76-53"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pre-training</span></span>
<span id="cb76-54"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb76-55">    p.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb76-56"></span>
<span id="cb76-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stats holders</span></span>
<span id="cb76-58">lossi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb76-59">stepi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb76-60"></span>
<span id="cb76-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training on Xtr, Ytr</span></span>
<span id="cb76-62"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200_000</span>):</span>
<span id="cb76-63">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minibatch construct                                           </span></span>
<span id="cb76-64">    ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Xtr.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], (batch_size,))                      </span>
<span id="cb76-65">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass:</span></span>
<span id="cb76-66">    emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xtr[ix]]                                                </span>
<span id="cb76-67">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> emb_size) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1)</span>
<span id="cb76-68">    logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2</span>
<span id="cb76-69">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Ytr[ix]) </span>
<span id="cb76-70">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass:</span></span>
<span id="cb76-71">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb76-72">        p.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb76-73">    loss.backward()</span>
<span id="cb76-74">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update</span></span>
<span id="cb76-75">    lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100_000</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> </span>
<span id="cb76-76">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> parameters:</span>
<span id="cb76-77">        p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p.grad</span>
<span id="cb76-78"></span>
<span id="cb76-79">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># track stats</span></span>
<span id="cb76-80">    lossi.append(loss.item())</span>
<span id="cb76-81">    stepi.append(i)</span>
<span id="cb76-82"></span>
<span id="cb76-83"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loss on minibatch: "</span>, loss.item())</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([182580, 3]) torch.Size([182580])
torch.Size([22767, 3]) torch.Size([22767])
torch.Size([22799, 3]) torch.Size([22799])
No of params:  17697
Loss on minibatch:  2.0859084129333496</code></pre>
</div>
</div>
<div id="9354902a" class="cell" data-execution_count="46">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb78" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb78-1">emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xtr]                                 </span>
<span id="cb78-2">h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> emb_size) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1)</span>
<span id="cb78-3">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2</span>
<span id="cb78-4">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Ytr)   </span>
<span id="cb78-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loss on whole training set: "</span>, loss.item())</span>
<span id="cb78-6"></span>
<span id="cb78-7">emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xdev]                                </span>
<span id="cb78-8">h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> emb_size) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1)</span>
<span id="cb78-9">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2</span>
<span id="cb78-10">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Ydev)   </span>
<span id="cb78-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loss on dev/validation set: "</span>, loss.item())</span>
<span id="cb78-12"></span>
<span id="cb78-13">emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[Xte]                                </span>
<span id="cb78-14">h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, block_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> emb_size) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1)</span>
<span id="cb78-15">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2</span>
<span id="cb78-16">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.cross_entropy(logits, Yte)   </span>
<span id="cb78-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loss on test set: "</span>, loss.item())</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loss on whole training set:  2.117095947265625
Loss on dev/validation set:  2.1767637729644775
Loss on test set:  2.1748299598693848</code></pre>
</div>
</div>
</section>
<section id="summary-of-our-final-code-conclusion" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-our-final-code-conclusion">summary of our final code, conclusion</h2>
<div id="582cd2a2" class="cell" data-execution_count="47">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb80" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb80-1">plt.plot(stepi, lossi)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-20-nn-z2h-p3/index_files/figure-html/cell-48-output-1.png" width="568" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="70b97c29" class="cell" data-execution_count="48">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb81-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>))</span>
<span id="cb81-2">plt.scatter(C[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].data, C[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].data, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb81-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(C.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]):</span>
<span id="cb81-4">    plt.text(C[i,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].item(),C[i,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].item(), itos[i], ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>, va<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>)</span>
<span id="cb81-5">plt.grid(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'minor'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-20-nn-z2h-p3/index_files/figure-html/cell-49-output-1.png" width="662" height="633" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can see the loss on validation set and test set are quite similar as we are not try different scenarios to calibrate/tune hyperparamters much. So they both have the same suprise to the model training by <code>Xtr</code>.</p>
<p>We still have rooms for improvement!</p>
</section>
<section id="sampling-from-the-model" class="level2">
<h2 class="anchored" data-anchor-id="sampling-from-the-model">sampling from the model</h2>
<p>But our networks now can generate more name-like name!</p>
<div id="b3778f33" class="cell" data-execution_count="49">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb82" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb82-1">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb82-2"></span>
<span id="cb82-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>):</span>
<span id="cb82-4">    </span>
<span id="cb82-5">    out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb82-6">    context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> block_size <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize with all ...</span></span>
<span id="cb82-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>:</span>
<span id="cb82-8">      emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C[torch.tensor([context])] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (1,block_size,d)</span></span>
<span id="cb82-9">      h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tanh(emb.view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b1)</span>
<span id="cb82-10">      logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b2</span>
<span id="cb82-11">      probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.softmax(logits, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb82-12">      ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.multinomial(probs, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g).item()</span>
<span id="cb82-13">      context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> context[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [ix]</span>
<span id="cb82-14">      out.append(ix)</span>
<span id="cb82-15">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb82-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb82-17">    </span>
<span id="cb82-18">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(itos[i] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> out))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>eria.
kayanniee.
mad.
rylle.
evers.
endra.
kalie.
kaillie.
shivonna.
keisenna.
araelyzion.
kalin.
shubergenghies.
kindrendy.
pan.
puon.
ubertedir.
yarleyel.
yule.
myshelda.</code></pre>
</div>
</div>
</section>
<section id="google-collab-new-notebook-advertisement" class="level2">
<h2 class="anchored" data-anchor-id="google-collab-new-notebook-advertisement">google collab (new!!) notebook advertisement</h2>
<p>Colab link: <a href="https://colab.research.google.com/drive/1YIfmkftLrz6MPTOO9Vwqrop2Q5llHIGK?usp=sharing" class="uri">https://colab.research.google.com/drive/1YIfmkftLrz6MPTOO9Vwqrop2Q5llHIGK?usp=sharing</a></p>
<p>Thanks Andrej!</p>
</section>
</section>
<section id="resources" class="level1">
<h1>resources</h1>
<ol type="1">
<li><a href="https://www.jmlr.org/papers/volume3/bengio03a/bengio03a.pdf"><strong>A Neural Probabilistic Language Model</strong>, Bengio et al.&nbsp;(2003)</a></li>
<li><a href="https://www.youtube.com/watch?v=TCH_1BHY58I">Video lecturer</a></li>
<li><a href="https://github.com/karpathy/nn-zero-to-hero/blob/master/lectures/makemore/makemore_part2_mlp.ipynb">Notebook</a></li>
<li><a href="https://github.com/karpathy/makemore"><code>makemore</code> on Github</a></li>
<li><a href="https://pytorch.org/docs/main/tensors.html"><code>torch.Tensor()</code> documentation</a></li>
</ol>


<!-- -->

</section>

 ]]></description>
  <category>til</category>
  <category>python</category>
  <category>andrej karpathy</category>
  <category>nn-z2h</category>
  <category>neural networks</category>
  <guid>https://lktuan.github.io/blog/2024-11-20-nn-z2h-p3/</guid>
  <pubDate>Tue, 19 Nov 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-11-20-nn-z2h-p3/NLM_Bengio_etal.png" medium="image" type="image/png" height="121" width="144"/>
</item>
<item>
  <title>NN-Z2H Lesson 2: The spelled-out intro to language modeling - building makemore</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-11-15-nn-z2h-p2/</link>
  <description><![CDATA[ 





<div class="callout callout-style-default callout-important callout-titled" title="This is not orginal content!">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This is not orginal content!
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is my study notes / codes along with Andrej Karpathy‚Äôs ‚Äú<a href="https://www.youtube.com/watch?v=VMj-3S1tku0&amp;list=PLAqhIrjkxbuWI23v9cThsA9GvCAUhRvKZ">Neural Networks: Zero to Hero</a>‚Äù series.</p>
</div>
</div>
<section id="part-1-intro" class="level1">
<h1>PART 1: intro</h1>
<blockquote class="blockquote">
<p><code>makemore</code> takes one text file as input, where each line is assumed to be one training thing, and generates more things like it. Under the hood, it is an autoregressive character-level language model, with a wide choice of models from bigrams all the way to a Transformer (exactly as seen in GPT).</p>
</blockquote>
<section id="reading-and-exploring-the-dataset" class="level2">
<h2 class="anchored" data-anchor-id="reading-and-exploring-the-dataset">reading and exploring the dataset</h2>
<div id="90420c5c" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-2"></span>
<span id="cb1-3">url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://raw.githubusercontent.com/karpathy/makemore/refs/heads/master/names.txt"</span></span>
<span id="cb1-4">words <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(url, header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>).iloc[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].tolist()</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(words[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>])</span>
<span id="cb1-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(words))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>['emma', 'olivia', 'ava', 'isabella', 'sophia', 'charlotte', 'mia', 'amelia', 'harper', 'evelyn']
32033</code></pre>
</div>
</div>
<div id="a87bd877" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No of chars for the shortest word: "</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(w) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words))</span>
<span id="cb3-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No of chars for the longest word: "</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(w) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>No of chars for the shortest word:  2
No of chars for the longest word:  15</code></pre>
</div>
</div>
<p>By looking into (1) the order of characters in individual word, and (2) that pattern for the whole dataset of 32k words, we will try to infer which character is likely to follow a character or chain of characters.</p>
<p>We will first building a <code>bigrams</code> languague model - which only works will 2 characters at a time - look at the current character and try to predict the next one. We are just following this local structure!</p>
<p>It‚Äôs just a simple (and weak) model but a good way to start.</p>
</section>
<section id="exploring-the-bigrams-in-the-dataset" class="level2">
<h2 class="anchored" data-anchor-id="exploring-the-bigrams-in-the-dataset">exploring the <code>bigrams</code> in the dataset</h2>
<div id="4d766908" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]:</span>
<span id="cb5-2">  chs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'&lt;S&gt;'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(w) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'&lt;E&gt;'</span>] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># special start and ending token, `list()` will turn all character in word to list</span></span>
<span id="cb5-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch1, ch2 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(chs, chs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]):</span>
<span id="cb5-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(ch1, ch2)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;S&gt; e
e m
m m
m a
a &lt;E&gt;
&lt;S&gt; o
o l
l i
i v
v i
i a
a &lt;E&gt;
&lt;S&gt; a
a v
v a
a &lt;E&gt;</code></pre>
</div>
</div>
</section>
<section id="counting-bigrams-in-a-python-dictionary" class="level2">
<h2 class="anchored" data-anchor-id="counting-bigrams-in-a-python-dictionary">counting <code>bigrams</code> in a python dictionary</h2>
<p>In order to learn statistics about what character is more likely to follow another character, the simplest way is <code>counting</code>.</p>
<div id="ce845d3e" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {} <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dict to store all pair of character</span></span>
<span id="cb7-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># do it for first five words</span></span>
<span id="cb7-3">  chs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'&lt;S&gt;'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(w) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'&lt;E&gt;'</span>]</span>
<span id="cb7-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch1, ch2 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(chs, chs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]):</span>
<span id="cb7-5">    bigram <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (ch1, ch2)</span>
<span id="cb7-6">    b[bigram] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b.get(bigram, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print(ch1, ch2)</span></span></code></pre></div>
</details>
</div>
<div id="a068ca62" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(b.items(), key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> kv: <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>kv[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>[(('a', '&lt;E&gt;'), 5),
 (('i', 'a'), 2),
 (('&lt;S&gt;', 'e'), 1),
 (('e', 'm'), 1),
 (('m', 'm'), 1),
 (('m', 'a'), 1),
 (('&lt;S&gt;', 'o'), 1),
 (('o', 'l'), 1),
 (('l', 'i'), 1),
 (('i', 'v'), 1),
 (('v', 'i'), 1),
 (('&lt;S&gt;', 'a'), 1),
 (('a', 'v'), 1),
 (('v', 'a'), 1),
 (('&lt;S&gt;', 'i'), 1),
 (('i', 's'), 1),
 (('s', 'a'), 1),
 (('a', 'b'), 1),
 (('b', 'e'), 1),
 (('e', 'l'), 1),
 (('l', 'l'), 1),
 (('l', 'a'), 1),
 (('&lt;S&gt;', 's'), 1),
 (('s', 'o'), 1),
 (('o', 'p'), 1),
 (('p', 'h'), 1),
 (('h', 'i'), 1)]</code></pre>
</div>
</div>
</section>
<section id="counting-bigrams-in-a-2d-torch-tensor-training-the-model" class="level2">
<h2 class="anchored" data-anchor-id="counting-bigrams-in-a-2d-torch-tensor-training-the-model">counting <code>bigrams</code> in a 2D <code>torch</code> tensor (‚Äútraining the model‚Äù)</h2>
<p>Instead of using Python dictionary, we will use <code>torch</code> 2D array to store this information.</p>
<div id="d1ef4f1e" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span></code></pre></div>
</details>
</div>
<div id="cf80b73b" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32)</span>
<span id="cb11-2">a</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>tensor([[0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0]], dtype=torch.int32)</code></pre>
</div>
</div>
<p>How can we access/assign a value in torch array:</p>
<div id="1b3ba5fd" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1">a[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb13-2">a</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>tensor([[ 0,  0,  0,  0,  0],
        [10, 10, 10, 10, 10],
        [10, 10, 10, 10, 10]], dtype=torch.int32)</code></pre>
</div>
</div>
<p>Now the english alphabet contain 26 characters, we will need to capture the <code>&lt;S&gt;</code> and <code>&lt;E&gt;</code> also. So it would be 28 x 28 array.</p>
<div id="a7a1c85b" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>), dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32)</span></code></pre></div>
</details>
</div>
<p>This will collect all the characters used in our dataset (join all words to a massive string and pass it to a <code>set()</code>, which will remove duplicate). With such a large dataset, all the english characters were used.</p>
<div id="98c84379" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1">chars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(words))))</span>
<span id="cb16-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(chars) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 26 </span></span>
<span id="cb16-3"></span>
<span id="cb16-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># with index</span></span>
<span id="cb16-5">stoi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {s:i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i,s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(chars)}</span>
<span id="cb16-6">stoi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'&lt;S&gt;'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">26</span></span>
<span id="cb16-7">stoi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'&lt;E&gt;'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span></span>
<span id="cb16-8">stoi</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>{'a': 0,
 'b': 1,
 'c': 2,
 'd': 3,
 'e': 4,
 'f': 5,
 'g': 6,
 'h': 7,
 'i': 8,
 'j': 9,
 'k': 10,
 'l': 11,
 'm': 12,
 'n': 13,
 'o': 14,
 'p': 15,
 'q': 16,
 'r': 17,
 's': 18,
 't': 19,
 'u': 20,
 'v': 21,
 'w': 22,
 'x': 23,
 'y': 24,
 'z': 25,
 '&lt;S&gt;': 26,
 '&lt;E&gt;': 27}</code></pre>
</div>
</div>
<div id="fa7cba89" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words:</span>
<span id="cb18-2">  chs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'&lt;S&gt;'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(w) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'&lt;E&gt;'</span>]</span>
<span id="cb18-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch1, ch2 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(chs, chs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]):</span>
<span id="cb18-4">    ix1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch1]</span>
<span id="cb18-5">    ix2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch2]</span>
<span id="cb18-6">    N[ix1, ix2] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span></code></pre></div>
</details>
</div>
</section>
<section id="visualizing-the-bigram-tensor" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-the-bigram-tensor">visualizing the <code>bigram</code> tensor</h2>
<div id="0443fcaf" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1">itos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {i:s <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s, i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> stoi.items()}</span></code></pre></div>
</details>
</div>
<div id="6770c9cb" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb20-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>matplotlib inline</span>
<span id="cb20-3"></span>
<span id="cb20-4">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>))</span>
<span id="cb20-5">plt.imshow(N, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Blues'</span>)</span>
<span id="cb20-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>):</span>
<span id="cb20-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>):</span>
<span id="cb20-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot character strings with number of time</span></span>
<span id="cb20-9">    chstr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> itos[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> itos[j]</span>
<span id="cb20-10">    plt.text(j, i, chstr, ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>, va<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray"</span>)</span>
<span id="cb20-11">    plt.text(j, i, N[i, j].item(), ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>, va<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray"</span>)</span>
<span id="cb20-12">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-15-nn-z2h-p2/index_files/figure-html/cell-14-output-1.png" width="1212" height="1202" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="deleting-spurious-s-and-e-tokens-in-favor-of-a-single-.-token" class="level2">
<h2 class="anchored" data-anchor-id="deleting-spurious-s-and-e-tokens-in-favor-of-a-single-.-token">deleting spurious (S) and (E) tokens in favor of a single <code>.</code> token</h2>
<p><code>&lt;S&gt;</code>, and <code>&lt;E&gt;</code> look a bit annoying. let‚Äôs replace them by simple <code>.</code>.</p>
<div id="a9aa94c3" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>), dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.int32)</span>
<span id="cb21-2">stoi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {s:i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i,s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(chars)}</span>
<span id="cb21-3">stoi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb21-4">itos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {i:s <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s, i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> stoi.items()}</span>
<span id="cb21-5"></span>
<span id="cb21-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words:</span>
<span id="cb21-7">  chs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(w) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>]</span>
<span id="cb21-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch1, ch2 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(chs, chs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]):</span>
<span id="cb21-9">    ix1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch1]</span>
<span id="cb21-10">    ix2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch2]</span>
<span id="cb21-11">    N[ix1, ix2] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span></code></pre></div>
</details>
</div>
<div id="91cf4cae" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb22-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>matplotlib inline</span>
<span id="cb22-3"></span>
<span id="cb22-4">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>))</span>
<span id="cb22-5">plt.imshow(N, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Blues'</span>)</span>
<span id="cb22-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>):</span>
<span id="cb22-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>):</span>
<span id="cb22-8">        chstr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> itos[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> itos[j]</span>
<span id="cb22-9">        plt.text(j, i, chstr, ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>, va<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gray'</span>)</span>
<span id="cb22-10">        plt.text(j, i, N[i, j].item(), ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>, va<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gray'</span>)</span>
<span id="cb22-11">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-15-nn-z2h-p2/index_files/figure-html/cell-16-output-1.png" width="1202" height="1202" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sampling-from-the-model" class="level2">
<h2 class="anchored" data-anchor-id="sampling-from-the-model">sampling from the model</h2>
<p>Taking the first column of the array.</p>
<div id="0c5017d8" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1">N[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>tensor([   0, 4410, 1306, 1542, 1690, 1531,  417,  669,  874,  591, 2422, 2963,
        1572, 2538, 1146,  394,  515,   92, 1639, 2055, 1308,   78,  376,  307,
         134,  535,  929], dtype=torch.int32)</code></pre>
</div>
</div>
<p>Column-wise probability.</p>
<div id="943a9aff" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> N[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span>
<span id="cb25-2">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb25-3">p</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>tensor([0.0000, 0.1377, 0.0408, 0.0481, 0.0528, 0.0478, 0.0130, 0.0209, 0.0273,
        0.0184, 0.0756, 0.0925, 0.0491, 0.0792, 0.0358, 0.0123, 0.0161, 0.0029,
        0.0512, 0.0642, 0.0408, 0.0024, 0.0117, 0.0096, 0.0042, 0.0167, 0.0290])</code></pre>
</div>
</div>
<p>Creating random number with Pytorch generator at a state.</p>
<div id="7bcac7cb" class="cell" data-execution_count="18">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>)</span>
<span id="cb27-2">p_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.rand(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb27-3">p_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p_test.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span></code></pre></div>
</details>
</div>
<div id="23e1dc99" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1">torch.multinomial(p_test, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, replacement<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>tensor([1, 1, 2, 0, 0, 2, 1, 1, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 0, 2, 0, 0,
        1, 0, 0, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1,
        0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0,
        0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 2, 0, 0, 0, 0, 0, 0, 1, 0, 0, 2, 0, 1, 0,
        0, 1, 1, 1])</code></pre>
</div>
</div>
<p>Now back to our data, generate a tensor with 1 value from the <code>p</code> vector.</p>
<div id="88eebf09" class="cell" data-execution_count="20">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>)</span>
<span id="cb30-2">ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.multinomial(p, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, replacement<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g).item()</span>
<span id="cb30-3">itos[ix]</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>'j'</code></pre>
</div>
</div>
<p>Let‚Äôs automate it:</p>
<div id="83d64434" class="cell" data-execution_count="21">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>)</span>
<span id="cb32-2"></span>
<span id="cb32-3">ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb32-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>:</span>
<span id="cb32-5">  p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> N[ix].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span>
<span id="cb32-6">  p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb32-7">  ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.multinomial(p, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, replacement<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g).item()</span>
<span id="cb32-8">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(itos[ix])</span>
<span id="cb32-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb32-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>j
u
n
i
d
e
.</code></pre>
</div>
</div>
<p>And more, joining the last result to single word, and make new 10 names:</p>
<div id="691ded3f" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>)</span>
<span id="cb34-2"></span>
<span id="cb34-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb34-4">  </span>
<span id="cb34-5">  out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb34-6">  ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb34-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>:</span>
<span id="cb34-8">    p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> N[ix].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span>
<span id="cb34-9">    p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb34-10"></span>
<span id="cb34-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># p = torch.ones(27) / 27.0</span></span>
<span id="cb34-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the result look terrible, but compare to an un-trained model for eg p - uncomment to code above, they are still like names.</span></span>
<span id="cb34-13">    ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.multinomial(p, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, replacement<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g).item()</span>
<span id="cb34-14">    out.append(itos[ix])</span>
<span id="cb34-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb34-16">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb34-17">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(out))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>junide.
janasah.
p.
cony.
a.
nn.
kohin.
tolian.
juee.
ksahnaauranilevias.</code></pre>
</div>
</div>
</section>
<section id="efficiency-vectorized-normalization-of-the-rows-tensor-broadcasting" class="level2">
<h2 class="anchored" data-anchor-id="efficiency-vectorized-normalization-of-the-rows-tensor-broadcasting">efficiency! vectorized normalization of the rows, tensor broadcasting</h2>
<p>We just fetching a row of <code>N</code> from the counts matrix, and then always do the same things: converting to float, dividing. That‚Äôs not efficient! We now will optimize this:</p>
<div id="a210b0c2" class="cell" data-execution_count="23">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb36-1">P <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> N.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span>
<span id="cb36-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># param 1 helps summing horizontally, by rows</span></span>
<span id="cb36-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># keepdim keeps the dimension the output is still 2D array with 1 column for each row, not a vertical vector entirely</span></span>
<span id="cb36-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tensor already support to broadcast the row sum allowing this dividing (keepdim helped not to mess the broadcast)</span></span>
<span id="cb36-5">P <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/=</span> P.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb36-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># inplace operator instead of P = P / P.sum(1, keepdim=True), take care of memory!</span></span></code></pre></div>
</details>
</div>
<div id="93edc4dc" class="cell" data-execution_count="24">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb37-1">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>)</span>
<span id="cb37-2"></span>
<span id="cb37-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb37-4">  </span>
<span id="cb37-5">  out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb37-6">  ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb37-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>:</span>
<span id="cb37-8">    p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> P[ix]</span>
<span id="cb37-9">    ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.multinomial(p, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, replacement<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g).item()</span>
<span id="cb37-10">    out.append(itos[ix])</span>
<span id="cb37-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb37-12">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb37-13">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(out))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>junide.
janasah.
p.
cony.
a.
nn.
kohin.
tolian.
juee.
ksahnaauranilevias.</code></pre>
</div>
</div>
</section>
<section id="loss-function-the-negative-log-likelihood-of-the-data-under-our-model" class="level2">
<h2 class="anchored" data-anchor-id="loss-function-the-negative-log-likelihood-of-the-data-under-our-model">loss function (the negative log likelihood of the data under our model)</h2>
<p>We‚Äôve just trained and sampled from the model, iteratively sampled the next character and fed it in each time and got the next one. Now we need to somehow measure the quality of the model.</p>
<p>How good is it in predicting? Gimme a number!</p>
<div id="53f5307c" class="cell" data-execution_count="25">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># showing bigram for the first 3 words, along with the probability inferred by our model (`P`)</span></span>
<span id="cb39-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the higher the prob, the better of prediction</span></span>
<span id="cb39-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># since a fair (under no data) probability of occuring a character is roughly 1/27 ~ 4%, any prob higher than 4% should be good</span></span>
<span id="cb39-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># we need to combine all the prob to a single 1 number, measuring how good is our model?</span></span>
<span id="cb39-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># since multiplying all the prob resulting a very very small number, we will approach by the log likelihood function</span></span>
<span id="cb39-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the log likelihood is just the sum of log of individual multiplier</span></span>
<span id="cb39-7"></span>
<span id="cb39-8">log_likelihood <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb39-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]:</span>
<span id="cb39-10">  chs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(w) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>]</span>
<span id="cb39-11">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch1, ch2 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(chs, chs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]):</span>
<span id="cb39-12">    ix1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch1]</span>
<span id="cb39-13">    ix2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch2]</span>
<span id="cb39-14">    prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> P[ix1, ix2]</span>
<span id="cb39-15">    log_prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.log(prob)</span>
<span id="cb39-16">    log_likelihood <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> log_prob</span>
<span id="cb39-17">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ch1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}{</span>ch2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>prob<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>log_prob<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb39-18"></span>
<span id="cb39-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>log_likelihood<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print both the variable name and its value, for the first 3 words</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>.e: 0.0478 -3.0408
em: 0.0377 -3.2793
mm: 0.0253 -3.6772
ma: 0.3899 -0.9418
a.: 0.1960 -1.6299
.o: 0.0123 -4.3982
ol: 0.0780 -2.5508
li: 0.1777 -1.7278
iv: 0.0152 -4.1867
vi: 0.3541 -1.0383
ia: 0.1381 -1.9796
a.: 0.1960 -1.6299
.a: 0.1377 -1.9829
av: 0.0246 -3.7045
va: 0.2495 -1.3882
a.: 0.1960 -1.6299
log_likelihood=tensor(-38.7856)</code></pre>
</div>
</div>
<p>If all the probs equal to 1, the logs will be 0. If they close to 0, the logs will be more negative. We want to use this as a loss function, meaning lower the better, so we will invert it:</p>
<div id="02d4b5e7" class="cell" data-execution_count="26">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb41-1">neg_log_likelihood <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb41-2">n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb41-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words:</span>
<span id="cb41-4">  chs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(w) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>]</span>
<span id="cb41-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch1, ch2 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(chs, chs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]):</span>
<span id="cb41-6">    ix1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch1]</span>
<span id="cb41-7">    ix2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch2]</span>
<span id="cb41-8">    prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> P[ix1, ix2]</span>
<span id="cb41-9">    log_prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.log(prob)</span>
<span id="cb41-10">    neg_log_likelihood <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>log_prob</span>
<span id="cb41-11">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb41-12"></span>
<span id="cb41-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>neg_log_likelihood<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb41-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>neg_log_likelihood<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>neg_log_likelihood=tensor(559891.7500)
2.454094171524048</code></pre>
</div>
</div>
<p>Finally we insert a count and calculate the ‚Äúnormalized‚Äù (or average) negative log likelihood. The lower of this number, the better model we have.</p>
<p>You can test with your name:</p>
<div id="251942d3" class="cell" data-execution_count="27">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1">neg_log_likelihood <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb43-2">n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb43-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tuan'</span>]:</span>
<span id="cb43-4">  chs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(w) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>]</span>
<span id="cb43-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch1, ch2 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(chs, chs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]):</span>
<span id="cb43-6">    ix1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch1]</span>
<span id="cb43-7">    ix2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch2]</span>
<span id="cb43-8">    prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> P[ix1, ix2]</span>
<span id="cb43-9">    log_prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.log(prob)</span>
<span id="cb43-10">    neg_log_likelihood <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>log_prob</span>
<span id="cb43-11">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb43-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ch1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}{</span>ch2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>prob<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>log_prob<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb43-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>neg_log_likelihood<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb43-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>neg_log_likelihood<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>.t: 0.0408 -3.1983
tu: 0.0140 -4.2684
ua: 0.0520 -2.9566
an: 0.1605 -1.8296
n.: 0.3690 -0.9969
neg_log_likelihood=tensor(13.2498)
2.649962902069092</code></pre>
</div>
</div>
<p><code>tu</code> is not common in our dataset.</p>
</section>
<section id="model-smoothing-with-fake-counts" class="level2">
<h2 class="anchored" data-anchor-id="model-smoothing-with-fake-counts">model smoothing with fake counts</h2>
<p>For a pair of bigram that does not exist in the dataset, for eg <code>jq</code>, the prob will be zero and log likelihood will be infinity. We can kind of smooth our model by adding constant ‚Äúfake counts‚Äù to the model:</p>
<div id="a6136c3c" class="cell" data-execution_count="28">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb45-1">P <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span></code></pre></div>
</details>
</div>
<p><code>1</code> is decent number, the more you added, you‚Äôll have a more uniformed distribution, the less, the more peaked distribution you have.</p>
</section>
</section>
<section id="part-2-the-neural-network-approach---intro" class="level1">
<h1>PART 2: the neural network approach - intro</h1>
<p>Now we will try to cast the problem of bigram character level of language modeling into the <strong>neural network framework</strong>. We first understand how to feed it in with 1 point dataset - only the first word <code>emma</code>:</p>
<section id="creating-the-bigram-dataset-for-the-neural-net" class="level2">
<h2 class="anchored" data-anchor-id="creating-the-bigram-dataset-for-the-neural-net">creating the <code>bigram</code> dataset for the neural net</h2>
<div id="c0374fa0" class="cell" data-execution_count="29">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># creating training set of bigram(x, y)</span></span>
<span id="cb46-2">xs, ys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [], []</span>
<span id="cb46-3"></span>
<span id="cb46-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]:</span>
<span id="cb46-5">  chs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(w) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>]</span>
<span id="cb46-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch1, ch2 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(chs, chs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]):</span>
<span id="cb46-7">    ix1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch1]</span>
<span id="cb46-8">    ix2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch2]</span>
<span id="cb46-9">    xs.append(ix1)</span>
<span id="cb46-10">    ys.append(ix2)</span>
<span id="cb46-11"></span>
<span id="cb46-12">xs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(xs) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># both .tensor() and .Tensor() work!</span></span>
<span id="cb46-13">ys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(ys)</span>
<span id="cb46-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># https://stackoverflow.com/questions/51911749/what-is-the-difference-between-torch-tensor-and-torch-tensor</span></span>
<span id="cb46-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># .tensor() infers dtype as int64 while .Tensor() infers dtype as float32, in this case</span></span></code></pre></div>
</details>
</div>
<p>The input and output tensor for the first word will be look like this:</p>
<div class="sourceCode" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode numberSource {md} number-lines code-with-copy"><code class="sourceCode"><span id="cb47-1">&gt; print(ch1,ch2)</span>
<span id="cb47-2">. e</span>
<span id="cb47-3">e m</span>
<span id="cb47-4">m m</span>
<span id="cb47-5">m a</span>
<span id="cb47-6">a .</span>
<span id="cb47-7">&gt; xs</span>
<span id="cb47-8">tensor([ 0,  5, 13, 13,  1])</span>
<span id="cb47-9">&gt; ys</span>
<span id="cb47-10">tensor([ 5, 13, 13,  1,  0])</span></code></pre></div>
</section>
<section id="feeding-integers-into-neural-nets-one-hot-encodings" class="level2">
<h2 class="anchored" data-anchor-id="feeding-integers-into-neural-nets-one-hot-encodings">feeding integers into neural nets? one-hot encodings</h2>
<div id="6519ea17" class="cell" data-execution_count="30">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb48-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb48-2"></span>
<span id="cb48-3">xenc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.one_hot(xs, num_classes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remember to cast integer to float, which can be fed to neural nets</span></span>
<span id="cb48-4">xenc</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>tensor([[1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
         0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
         0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0.,
         0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0.,
         0., 0., 0., 0., 0., 0., 0., 0., 0.],
        [0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
         0., 0., 0., 0., 0., 0., 0., 0., 0.]])</code></pre>
</div>
</div>
<div id="107f7c42" class="cell" data-execution_count="31">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb50-1">xenc.shape</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>torch.Size([5, 27])</code></pre>
</div>
</div>
<div id="8444a1f8" class="cell" data-execution_count="32">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb52-1">plt.imshow(xenc, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Blues"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-15-nn-z2h-p2/index_files/figure-html/cell-33-output-1.png" width="558" height="138" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-neural-net-one-linear-layer-of-neurons-implemented-with-matrix-multiplication" class="level2">
<h2 class="anchored" data-anchor-id="the-neural-net-one-linear-layer-of-neurons-implemented-with-matrix-multiplication">the ‚Äúneural net‚Äù: one linear layer of neurons implemented with matrix multiplication</h2>
<div id="cd8385ee" class="cell" data-execution_count="33">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb53-1">W <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fulfill a tensor with random number followed normal distribution, 1 is indicating 1 single neuron</span></span>
<span id="cb53-2">xenc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># @ is matrix mult operator in PyTorch</span></span>
<span id="cb53-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (5, 27) @ (27, 1) will result (5, 1) matrix</span></span>
<span id="cb53-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># no bias is added for now</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>tensor([[ 0.2084],
        [-0.1912],
        [-0.7102],
        [-0.7102],
        [ 0.5453]])</code></pre>
</div>
</div>
<p>This is 1 neuron only, now we want to evaluate all 27 characters using only 5 inputs from the first word, we‚Äôll make 27 neurons:</p>
<div id="9395ae9a" class="cell" data-execution_count="34">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb55-1">W <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>))</span>
<span id="cb55-2">xenc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W </span>
<span id="cb55-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (5, 27) @ (27, 27) will result (5, 27) matrix</span></span>
<span id="cb55-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># no bias is added for now</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>tensor([[ 1.1742, -0.1228,  0.3312, -1.7074, -0.5036,  0.5717,  0.5462,  1.2425,
          2.2197,  0.9381, -0.4647, -1.1784, -0.0046,  1.5661,  0.1240, -0.1818,
         -0.1129,  1.1559, -0.2303, -0.2885, -0.8589, -0.6829,  0.6188,  0.6673,
         -0.6109,  1.9768,  0.2832],
        [-1.3979, -1.4019, -3.2251, -0.6767,  0.3323,  0.2407,  0.5753, -0.2401,
          1.0848,  0.1452,  0.1295,  0.4613,  2.3659,  1.4620,  0.3717, -1.1485,
         -0.5063, -0.4455, -0.2564, -0.6005,  1.9493, -0.3160,  0.7859, -1.0101,
          0.3456,  0.9161,  0.5722],
        [-1.2995, -0.2011,  0.0972,  0.1959,  0.5090,  0.0080, -0.8293, -0.9525,
         -1.0965,  0.6003,  0.7801, -1.1612, -0.4070,  2.1902, -0.0264,  0.9155,
          1.4465, -0.3992,  0.0044,  0.0918,  2.1084,  0.7271, -0.5992, -0.1443,
          0.1657, -0.0258, -0.4744],
        [-1.2995, -0.2011,  0.0972,  0.1959,  0.5090,  0.0080, -0.8293, -0.9525,
         -1.0965,  0.6003,  0.7801, -1.1612, -0.4070,  2.1902, -0.0264,  0.9155,
          1.4465, -0.3992,  0.0044,  0.0918,  2.1084,  0.7271, -0.5992, -0.1443,
          0.1657, -0.0258, -0.4744],
        [ 0.4732,  0.0148, -0.4303, -0.3870, -2.1335, -1.9046, -0.8460,  1.0632,
         -0.7406,  1.9063, -0.7375,  0.8191, -1.1415,  0.1678, -0.1831,  0.5425,
         -1.5502, -0.3083,  0.4649, -0.8271,  0.8959,  0.6717,  1.1916,  2.1147,
          0.3208, -1.3000, -1.0078]])</code></pre>
</div>
</div>
</section>
<section id="transforming-neural-net-outputs-into-probabilities-the-softmax" class="level2">
<h2 class="anchored" data-anchor-id="transforming-neural-net-outputs-into-probabilities-the-softmax">transforming neural net outputs into probabilities: the softmax</h2>
<p>So far we have fed 5 inputs to 27 neurons for 27 characters in <strong>the first layer</strong> of the neural net. We notice that the output number ranges from negative to positive while we want ‚Äúhow likely of the next characters‚Äù. It would be counts, or probs, hence we exponentiate the logits, then dividing row-wise total to get the prob of each character.</p>
<p>This is call the softmax!</p>
<div id="f8cf4aab" class="cell" data-execution_count="35">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb57-1">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xenc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># log-counts</span></span>
<span id="cb57-2">counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logits.exp() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># equivalent N</span></span>
<span id="cb57-3">probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> counts.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb57-4">probs</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>tensor([[0.0609, 0.0166, 0.0262, 0.0034, 0.0114, 0.0333, 0.0325, 0.0652, 0.1732,
         0.0481, 0.0118, 0.0058, 0.0187, 0.0901, 0.0213, 0.0157, 0.0168, 0.0598,
         0.0149, 0.0141, 0.0080, 0.0095, 0.0349, 0.0367, 0.0102, 0.1359, 0.0250],
        [0.0051, 0.0051, 0.0008, 0.0105, 0.0288, 0.0263, 0.0367, 0.0162, 0.0611,
         0.0239, 0.0235, 0.0328, 0.2201, 0.0891, 0.0300, 0.0066, 0.0125, 0.0132,
         0.0160, 0.0113, 0.1451, 0.0151, 0.0453, 0.0075, 0.0292, 0.0516, 0.0366],
        [0.0059, 0.0177, 0.0239, 0.0264, 0.0361, 0.0218, 0.0095, 0.0084, 0.0072,
         0.0395, 0.0473, 0.0068, 0.0144, 0.1937, 0.0211, 0.0541, 0.0921, 0.0145,
         0.0218, 0.0238, 0.1785, 0.0448, 0.0119, 0.0188, 0.0256, 0.0211, 0.0135],
        [0.0059, 0.0177, 0.0239, 0.0264, 0.0361, 0.0218, 0.0095, 0.0084, 0.0072,
         0.0395, 0.0473, 0.0068, 0.0144, 0.1937, 0.0211, 0.0541, 0.0921, 0.0145,
         0.0218, 0.0238, 0.1785, 0.0448, 0.0119, 0.0188, 0.0256, 0.0211, 0.0135],
        [0.0377, 0.0239, 0.0153, 0.0160, 0.0028, 0.0035, 0.0101, 0.0681, 0.0112,
         0.1582, 0.0112, 0.0533, 0.0075, 0.0278, 0.0196, 0.0405, 0.0050, 0.0173,
         0.0374, 0.0103, 0.0576, 0.0460, 0.0774, 0.1949, 0.0324, 0.0064, 0.0086]])</code></pre>
</div>
</div>
</section>
<section id="summary-preview-to-next-steps-reference-to-micrograd" class="level2">
<h2 class="anchored" data-anchor-id="summary-preview-to-next-steps-reference-to-micrograd">summary, preview to next steps, reference to <code>micrograd</code></h2>
<div id="9126eee2" class="cell" data-execution_count="36">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb59-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># randomly initialize 27 neurons' weights. each neuron receives 27 inputs</span></span>
<span id="cb59-2">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to make sure we all have same random</span></span>
<span id="cb59-3">W <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g)</span>
<span id="cb59-4">xenc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.one_hot(xs, num_classes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># input to the network: one-hot encoding</span></span>
<span id="cb59-5">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xenc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># predict log-counts</span></span>
<span id="cb59-6">counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logits.exp() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># counts, equivalent to N</span></span>
<span id="cb59-7">probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> counts.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># probabilities for next character</span></span>
<span id="cb59-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># btw: the last 2 lines here are together called a 'softmax'</span></span></code></pre></div>
</details>
</div>
<div id="278bcbaa" class="cell" data-execution_count="37">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb60-1">probs.shape</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>torch.Size([5, 27])</code></pre>
</div>
</div>
<p>Below is detail explaination for each example from our 5-datapoint dataset.</p>
<div id="33c9ae6e" class="cell" data-execution_count="38">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb62-1">nlls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb62-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>):</span>
<span id="cb62-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># i-th bigram:</span></span>
<span id="cb62-4">  x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xs[i].item() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># input character index</span></span>
<span id="cb62-5">  y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ys[i].item() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># label character index</span></span>
<span id="cb62-6">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--------'</span>)</span>
<span id="cb62-7">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'bigram example </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>itos[x]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}{</span>itos[y]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (indexes </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">,</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)'</span>)</span>
<span id="cb62-8">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input to the neural net:'</span>, x)</span>
<span id="cb62-9">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'output probabilities from the neural net:'</span>, probs[i])</span>
<span id="cb62-10">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label (actual next character):'</span>, y)</span>
<span id="cb62-11">  p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> probs[i, y]</span>
<span id="cb62-12">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'probability assigned by the net to the the correct character:'</span>, p.item())</span>
<span id="cb62-13">  logp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.log(p)</span>
<span id="cb62-14">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'log likelihood:'</span>, logp.item())</span>
<span id="cb62-15">  nll <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>logp</span>
<span id="cb62-16">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'negative log likelihood:'</span>, nll.item())</span>
<span id="cb62-17">  nlls[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nll</span>
<span id="cb62-18"></span>
<span id="cb62-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'========='</span>)</span>
<span id="cb62-20"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'average negative log likelihood, i.e. loss ='</span>, nlls.mean().item())</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>--------
bigram example 1: .e (indexes 0,5)
input to the neural net: 0
output probabilities from the neural net: tensor([0.0609, 0.0166, 0.0262, 0.0034, 0.0114, 0.0333, 0.0325, 0.0652, 0.1732,
        0.0481, 0.0118, 0.0058, 0.0187, 0.0901, 0.0213, 0.0157, 0.0168, 0.0598,
        0.0149, 0.0141, 0.0080, 0.0095, 0.0349, 0.0367, 0.0102, 0.1359, 0.0250])
label (actual next character): 5
probability assigned by the net to the the correct character: 0.03332865983247757
log likelihood: -3.4013376235961914
negative log likelihood: 3.4013376235961914
--------
bigram example 2: em (indexes 5,13)
input to the neural net: 5
output probabilities from the neural net: tensor([0.0051, 0.0051, 0.0008, 0.0105, 0.0288, 0.0263, 0.0367, 0.0162, 0.0611,
        0.0239, 0.0235, 0.0328, 0.2201, 0.0891, 0.0300, 0.0066, 0.0125, 0.0132,
        0.0160, 0.0113, 0.1451, 0.0151, 0.0453, 0.0075, 0.0292, 0.0516, 0.0366])
label (actual next character): 13
probability assigned by the net to the the correct character: 0.08912799507379532
log likelihood: -2.4176816940307617
negative log likelihood: 2.4176816940307617
--------
bigram example 3: mm (indexes 13,13)
input to the neural net: 13
output probabilities from the neural net: tensor([0.0059, 0.0177, 0.0239, 0.0264, 0.0361, 0.0218, 0.0095, 0.0084, 0.0072,
        0.0395, 0.0473, 0.0068, 0.0144, 0.1937, 0.0211, 0.0541, 0.0921, 0.0145,
        0.0218, 0.0238, 0.1785, 0.0448, 0.0119, 0.0188, 0.0256, 0.0211, 0.0135])
label (actual next character): 13
probability assigned by the net to the the correct character: 0.19367089867591858
log likelihood: -1.6415950059890747
negative log likelihood: 1.6415950059890747
--------
bigram example 4: ma (indexes 13,1)
input to the neural net: 13
output probabilities from the neural net: tensor([0.0059, 0.0177, 0.0239, 0.0264, 0.0361, 0.0218, 0.0095, 0.0084, 0.0072,
        0.0395, 0.0473, 0.0068, 0.0144, 0.1937, 0.0211, 0.0541, 0.0921, 0.0145,
        0.0218, 0.0238, 0.1785, 0.0448, 0.0119, 0.0188, 0.0256, 0.0211, 0.0135])
label (actual next character): 1
probability assigned by the net to the the correct character: 0.01772291027009487
log likelihood: -4.032896995544434
negative log likelihood: 4.032896995544434
--------
bigram example 5: a. (indexes 1,0)
input to the neural net: 1
output probabilities from the neural net: tensor([0.0377, 0.0239, 0.0153, 0.0160, 0.0028, 0.0035, 0.0101, 0.0681, 0.0112,
        0.1582, 0.0112, 0.0533, 0.0075, 0.0278, 0.0196, 0.0405, 0.0050, 0.0173,
        0.0374, 0.0103, 0.0576, 0.0460, 0.0774, 0.1949, 0.0324, 0.0064, 0.0086])
label (actual next character): 0
probability assigned by the net to the the correct character: 0.0377422496676445
log likelihood: -3.276975154876709
negative log likelihood: 3.276975154876709
=========
average negative log likelihood, i.e. loss = 2.954097270965576</code></pre>
</div>
</div>
</section>
<section id="vectorized-loss" class="level2">
<h2 class="anchored" data-anchor-id="vectorized-loss">vectorized loss</h2>
<div id="190bb55f" class="cell" data-execution_count="39">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb64-1">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> probs[torch.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), ys].log().mean()</span>
<span id="cb64-2">loss</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>tensor(2.9541)</code></pre>
</div>
</div>
</section>
<section id="backward-and-update-in-pytorch" class="level2">
<h2 class="anchored" data-anchor-id="backward-and-update-in-pytorch">backward and update, in PyTorch</h2>
<div id="65caaa25" class="cell" data-execution_count="40">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb66-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass</span></span>
<span id="cb66-2">W.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set to zero the gradient</span></span>
<span id="cb66-3">loss.backward()</span>
<span id="cb66-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this can not yet run for now, PyTorch require the specification of require_grad</span></span></code></pre></div>
</details>
</div>
<div id="6b94a8b7" class="cell" data-execution_count="41">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb67-1">W.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> W.grad</span></code></pre></div>
</details>
</div>
</section>
<section id="putting-everything-together" class="level2">
<h2 class="anchored" data-anchor-id="putting-everything-together">putting everything together</h2>
<div id="ba5ef5b6" class="cell" data-execution_count="42">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb68-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create the dataset</span></span>
<span id="cb68-2">xs, ys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [], []</span>
<span id="cb68-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> words:</span>
<span id="cb68-4">  chs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(w) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>]</span>
<span id="cb68-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ch1, ch2 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(chs, chs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]):</span>
<span id="cb68-6">    ix1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch1]</span>
<span id="cb68-7">    ix2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stoi[ch2]</span>
<span id="cb68-8">    xs.append(ix1)</span>
<span id="cb68-9">    ys.append(ix2)</span>
<span id="cb68-10">xs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(xs)</span>
<span id="cb68-11">ys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(ys)</span>
<span id="cb68-12">num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xs.nelement()</span>
<span id="cb68-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'number of examples: '</span>, num)</span>
<span id="cb68-14"></span>
<span id="cb68-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize the 'network'</span></span>
<span id="cb68-16">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>)</span>
<span id="cb68-17">W <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>), generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g, requires_grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>number of examples:  228146</code></pre>
</div>
</div>
<div id="526c9aed" class="cell" data-execution_count="43">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb70-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gradient descent</span></span>
<span id="cb70-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>): <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># after run 100 times, shorten the notebook</span></span>
<span id="cb70-3">  </span>
<span id="cb70-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass</span></span>
<span id="cb70-5">  xenc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.one_hot(xs, num_classes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># input to the network: one-hot encoding</span></span>
<span id="cb70-6">  logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xenc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># predict log-counts</span></span>
<span id="cb70-7">  counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logits.exp() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># counts, equivalent to N</span></span>
<span id="cb70-8">  probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> counts.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># probabilities for next character</span></span>
<span id="cb70-9">  loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>probs[torch.arange(num), ys].log().mean() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(W<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).mean() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># regularization loss</span></span>
<span id="cb70-10">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(loss.item())</span>
<span id="cb70-11">  </span>
<span id="cb70-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># backward pass</span></span>
<span id="cb70-13">  W.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set to zero the gradient</span></span>
<span id="cb70-14">  loss.backward()</span>
<span id="cb70-15">  </span>
<span id="cb70-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update</span></span>
<span id="cb70-17">  W.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> W.grad</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>3.768618583679199</code></pre>
</div>
</div>
<p>Looking back to the backprogation in the <a href="https://lktuan.github.io/blog/2024-06-17-nn-z2h-p1/#doing-gradient-descent-optimization-manually-training-the-network">lesson 1</a>, everything look similar here:</p>
<table class="table">
<colgroup>
<col style="width: 25%">
<col style="width: 38%">
<col style="width: 36%">
</colgroup>
<thead>
<tr class="header">
<th>Part</th>
<th>This neural nets for bigram language modeling</th>
<th>Neural nets introduced in the lesson 1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Forward pass</td>
<td><code>probs</code> , use negative log likelihood as loss function, doing classification</td>
<td><code>ypred</code> , use MSE for loss function, doing regression</td>
</tr>
<tr class="even">
<td>Backward pass</td>
<td>Same, offered by Torch.</td>
<td>Set grad of params to be zeros and do backpropagation.</td>
</tr>
<tr class="odd">
<td>Update loss</td>
<td>Same</td>
<td>Update the parameters, change the parameters following opposite direction to reduce the loss.</td>
</tr>
</tbody>
</table>
</section>
<section id="note-1-one-hot-encoding-really-just-selects-a-row-of-the-next-linear-layers-weight-matrix" class="level2">
<h2 class="anchored" data-anchor-id="note-1-one-hot-encoding-really-just-selects-a-row-of-the-next-linear-layers-weight-matrix">note 1: one-hot encoding really just selects a row of the next Linear layer‚Äôs weight matrix</h2>
<p>Look at the below code, <code>xenc @ W</code> is (5, 27) @ (27, 27) that will result (5, 27) matrix. Each <code>ix</code> row of that 5-rows result matrix should be the selection of corresponding character rows in the <code>W</code>.</p>
<div id="8e557da2" class="cell" data-execution_count="44">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb72-1">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xenc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># predict log-counts</span></span>
<span id="cb72-2">counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logits.exp() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># counts, equivalent to N</span></span>
<span id="cb72-3">probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> counts.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># probabilities for next character</span></span></code></pre></div>
</details>
</div>
<p>So in this gradient-based framework, we start with a random array of parameters. By optimizing the loss function we will get the same result with the bigram approach (<code>W</code> and <code>N</code> are almost the same, it‚Äôs log count here why is count in bigram). That‚Äôs why we obtained the same loss!</p>
<p>The neural networks offer more flexibility!</p>
</section>
<section id="note-2-model-smoothing-as-regularization-loss" class="level2">
<h2 class="anchored" data-anchor-id="note-2-model-smoothing-as-regularization-loss">note 2: model smoothing as regularization loss</h2>
<p>Same with smoothing technique when we‚Äôve doing the bigram model, gradient-based framework have an equivalent way for smoothing. We will try to incentivize <code>W</code> to be near zero. We augment to loss function by adding this: <code>0.01*(W**2).mean()</code>.</p>
<div id="010ac901" class="cell" data-execution_count="45">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb73" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb73-1">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>probs[torch.arange(num), ys].log().mean() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(W<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).mean()</span></code></pre></div>
</details>
</div>
</section>
<section id="sampling-from-the-neural-net" class="level2">
<h2 class="anchored" data-anchor-id="sampling-from-the-neural-net">sampling from the neural net</h2>
<div id="87363de4" class="cell" data-execution_count="46">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb74-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># finally, sample from the 'neural net' model</span></span>
<span id="cb74-2">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.Generator().manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2147483647</span>)</span>
<span id="cb74-3"></span>
<span id="cb74-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>):</span>
<span id="cb74-5">  </span>
<span id="cb74-6">  out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb74-7">  ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb74-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>:</span>
<span id="cb74-9">    </span>
<span id="cb74-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ----------</span></span>
<span id="cb74-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BEFORE:</span></span>
<span id="cb74-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># p = P[ix]</span></span>
<span id="cb74-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ----------</span></span>
<span id="cb74-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># NOW:</span></span>
<span id="cb74-15">    xenc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.one_hot(torch.tensor([ix]), num_classes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span>
<span id="cb74-16">    logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xenc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># predict log-counts</span></span>
<span id="cb74-17">    counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> logits.exp() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># counts, equivalent to N</span></span>
<span id="cb74-18">    p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> counts.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># probabilities for next character</span></span>
<span id="cb74-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ----------</span></span>
<span id="cb74-20">    </span>
<span id="cb74-21">    ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.multinomial(p, num_samples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, replacement<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g).item()</span>
<span id="cb74-22">    out.append(itos[ix])</span>
<span id="cb74-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb74-24">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb74-25">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>.join(out))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>juwjdjdjancqydjufhqyywecnw.
.
oiin.
toziasz.
twt.</code></pre>
</div>
</div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">conclusion</h2>
<p>What we‚Äôve gone through:</p>
<ul>
<li>introduced bigrams language model? how we can train, sample, and evaluate the model;</li>
<li>we modeled by 2 different ways:
<ul>
<li>1st: counted out the freq of bigram and normalized it;</li>
<li>2nd: used a negative log likelihood loss as a guide to optimizing the counts matrix/array in a gradient-based framework;</li>
<li>we obtained the same result!</li>
</ul></li>
<li>gradient-based framework is more flexible. We‚Äôve just modeled the simplest/dumpiest language model. In next lessons, we will complexify it.</li>
</ul>
<p>We are on the way out to <strong>transformer</strong>!</p>
<p>Thank you, Andrej!</p>
</section>
</section>
<section id="resources" class="level1">
<h1>resources</h1>
<ol type="1">
<li>YouTube video lecture: <a href="https://www.youtube.com/watch?v=PaCmpygFfXo" class="uri">https://www.youtube.com/watch?v=PaCmpygFfXo</a></li>
<li>Jupyter notebook files: <a href="https://github.com/karpathy/nn-zero-to-hero/blob/master/lectures/makemore/makemore_part1_bigrams.ipynb" class="uri">https://github.com/karpathy/nn-zero-to-hero/blob/master/lectures/makemore/makemore_part1_bigrams.ipynb</a></li>
<li><code>makemore</code> Github repo: <a href="https://github.com/karpathy/makemore" class="uri">https://github.com/karpathy/makemore</a></li>
</ol>


<!-- -->

</section>

 ]]></description>
  <category>til</category>
  <category>python</category>
  <category>andrej karpathy</category>
  <category>nn-z2h</category>
  <category>bigram</category>
  <category>neural networks</category>
  <guid>https://lktuan.github.io/blog/2024-11-15-nn-z2h-p2/</guid>
  <pubDate>Thu, 14 Nov 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-11-15-nn-z2h-p2/andrej_new.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Data Science Project with Mamba, Python, and VS Code on Window</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-11-04-intro-to-mamba/</link>
  <description><![CDATA[ 





<section id="v√¨-sao-m√†-mamba" class="level1">
<h1>V√¨ sao m√† Mamba?</h1>
<p>L√† m·ªôt non-tech data coder, m√¨nh v·∫´n loay hoay vi·ªác setup m·ªôt d·ª± √°n c√≥ th·ªÉ ƒë∆∞·ª£c t√°i s·ª≠ d·ª•ng v√† d·ªÖ d√†ng deploy, ƒë·∫∑c bi·ªát l√† v·ªõi d·ª± √°n d·∫°ng data - khi m√† DS/DA s·∫Ω l√†m vi·ªác nhi·ªÅu v·ªõi notebook - r·∫•t anti production.</p>
<div class="columns">
<div class="column" style="width:60%;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-11-04-intro-to-mamba/meme_top.png" class="img-fluid figure-img"></p>
<figcaption>Arggg! C∆°n ƒëau ƒë·∫ßu c·ªßa non-tech l√†m data, ngu·ªìn ·∫£nh <a href="https://www.analyticsvidhya.com/blog/2023/03/choosing-the-right-python-environment-tool-for-your-next-project/">Analytics Vidhya</a></figcaption>
</figure>
</div>
</div><div class="column" style="width:40%;">
<p><img src="https://lktuan.github.io/blog/2024-11-04-intro-to-mamba/meme_bottom.png" class="img-fluid"></p>
</div>
</div>
<p>M√¨nh t√¨m hi·ªÉu m·ªôt s·ªë c√¥ng c·ª• v√† d∆∞·ªõi ƒë√¢y l√† so s√°nh:</p>
<ol type="1">
<li><code>Mamba</code> ‚úÖ</li>
</ol>
<ul>
<li><p>∆Øu ƒëi·ªÉm:</p>
<ul>
<li>Nhanh h∆°n Conda nhi·ªÅu l·∫ßn</li>
<li>T∆∞∆°ng th√≠ch ho√†n to√†n v·ªõi Conda</li>
<li>Qu·∫£n l√Ω ƒë∆∞·ª£c c·∫£ Python v√† non-Python dependencies</li>
<li>T√≠ch h·ª£p t·ªët v·ªõi notebooks</li>
</ul></li>
</ul>
<ol start="2" type="1">
<li><code>Poetry</code></li>
</ol>
<ul>
<li><p>∆Øu ƒëi·ªÉm:</p>
<ul>
<li>Dependency resolution t·ªët</li>
<li>Lock file ch√≠nh x√°c</li>
</ul></li>
<li><p>Nh∆∞·ª£c ƒëi·ªÉm:</p>
<ul>
<li>Kh√≥ x·ª≠ l√Ω non-Python dependencies</li>
<li>C·∫ßn th√™m setup cho notebook kernels</li>
<li>Kh√¥ng ph√π h·ª£p l·∫Øm v·ªõi data science</li>
</ul></li>
</ul>
<ol type="1">
<li><code>venv</code></li>
</ol>
<ul>
<li>Qu√° ƒë∆°n gi·∫£n cho data science</li>
<li>Kh√¥ng x·ª≠ l√Ω ƒë∆∞·ª£c dependencies ph·ª©c t·∫°p</li>
<li>C·∫ßn nhi·ªÅu c·∫•u h√¨nh th·ªß c√¥ng</li>
</ul>
<ol start="4" type="1">
<li><code>pipenv</code></li>
</ol>
<ul>
<li>T∆∞∆°ng t·ª± Poetry nh∆∞ng √≠t t√≠nh nƒÉng h∆°n</li>
<li>Kh√¥ng ph√π h·ª£p v·ªõi data science</li>
</ul>
<ol start="5" type="1">
<li><code>uv</code></li>
</ol>
<ul>
<li>M·ªõi v√† nhanh</li>
<li>Ch∆∞a ƒë·ªß ch√≠n mu·ªìi cho data science</li>
<li>Thi·∫øu nhi·ªÅu t√≠nh nƒÉng c·∫ßn thi·∫øt</li>
</ul>
<p>Xem ra <code>mamba</code> c√≥ v·∫ª ·ªïn nh·∫•t, h√£y ƒë√†o s√¢u h∆°n v·ªÅ ∆∞u ƒëi·ªÉm c·ªßa n√≥:</p>
<ol type="1">
<li>X·ª≠ l√Ω dependencies ph·ª©c t·∫°p</li>
</ol>
<ul>
<li>Data science th∆∞·ªùng c·∫ßn nhi·ªÅu th∆∞ vi·ªán v·ªõi dependencies ph·ª©c t·∫°p (numpy, pandas, scipy, pytorch‚Ä¶)</li>
<li>Mamba gi·∫£i quy·∫øt dependencies nhanh v√† hi·ªáu qu·∫£ h∆°n Conda</li>
<li>X·ª≠ l√Ω t·ªët c√°c th∆∞ vi·ªán c√≥ binary dependencies (nh∆∞ CUDA)</li>
</ul>
<ol start="2" type="1">
<li>Qu·∫£n l√Ω m√¥i tr∆∞·ªùng kernel cho notebooks</li>
</ol>
<ul>
<li>T·ª± ƒë·ªông t√≠ch h·ª£p v·ªõi Jupyter notebooks</li>
<li>D·ªÖ d√†ng switch gi·ªØa c√°c m√¥i tr∆∞·ªùng trong notebook</li>
<li>Kh√¥ng c·∫ßn c·∫•u h√¨nh th√™m cho notebook kernels</li>
</ul>
<p>Oke gi·ªù h√£y th·ª≠ xem l√†m th·∫ø n√†o ƒë·ªÉ t·ªï ch·ª©c ph√°t tri·ªÉn m·ªôt d·ª± √°n v·ªõi mamba - VS Code tr√™n Window.</p>
</section>
<section id="h∆∞·ªõng-d·∫´n-c√†i-ƒë·∫∑t-v√†-s·ª≠-d·ª•ng-mamba-v·ªõi-vs-code-tr√™n-windows" class="level1">
<h1>H∆∞·ªõng d·∫´n C√†i ƒë·∫∑t v√† S·ª≠ d·ª•ng Mamba v·ªõi VS Code tr√™n Windows</h1>
<section id="c√†i-ƒë·∫∑t-mamba-tr√™n-windows" class="level2">
<h2 class="anchored" data-anchor-id="c√†i-ƒë·∫∑t-mamba-tr√™n-windows">1. C√†i ƒë·∫∑t Mamba tr√™n Windows</h2>
<section id="c√°ch-1-t·∫£i-tr·ª±c-ti·∫øp" class="level3">
<h3 class="anchored" data-anchor-id="c√°ch-1-t·∫£i-tr·ª±c-ti·∫øp">C√°ch 1: T·∫£i tr·ª±c ti·∫øp</h3>
<ul>
<li>T·∫£i Mambaforge cho Windows t·ª´: <a href="https://github.com/conda-forge/miniforge#mambaforge" class="uri">https://github.com/conda-forge/miniforge#mambaforge</a></li>
<li>Ch·∫°y file installer v√† l√†m theo h∆∞·ªõng d·∫´n.</li>
</ul>
</section>
<section id="c√°ch-2-d√πng-windows-terminalpowershell" class="level3">
<h3 class="anchored" data-anchor-id="c√°ch-2-d√πng-windows-terminalpowershell">C√°ch 2: D√πng Windows Terminal/PowerShell</h3>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-Windows-x86_64.exe <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-OutFile</span> mambaforge.exe</span>
<span id="cb1-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">start</span> /wait <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span> mambaforge.exe /InstallationType=JustMe /RegisterPython=0 /S /D=%UserProfile%\Mambaforge</span></code></pre></div>
</section>
</section>
<section id="t√≠ch-h·ª£p-v·ªõi-vs-code" class="level2">
<h2 class="anchored" data-anchor-id="t√≠ch-h·ª£p-v·ªõi-vs-code">2. T√≠ch h·ª£p v·ªõi VS Code</h2>
<section id="c√†i-ƒë·∫∑t-extensions" class="level3">
<h3 class="anchored" data-anchor-id="c√†i-ƒë·∫∑t-extensions">C√†i ƒë·∫∑t Extensions</h3>
<ol type="1">
<li>Python (Microsoft)</li>
<li>Jupyter (Microsoft)</li>
</ol>
</section>
<section id="t·∫°o-v√†-c·∫•u-h√¨nh-m√¥i-tr∆∞·ªùng" class="level3">
<h3 class="anchored" data-anchor-id="t·∫°o-v√†-c·∫•u-h√¨nh-m√¥i-tr∆∞·ªùng">T·∫°o v√† C·∫•u h√¨nh M√¥i tr∆∞·ªùng</h3>
<p>T·∫°o file <code>environment.yml</code>:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ds-project</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">channels</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb2-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> conda-forge</span></span>
<span id="cb2-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> defaults</span></span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dependencies</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb2-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> python=3.10</span></span>
<span id="cb2-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ipykernel</span></span>
<span id="cb2-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> pandas</span></span>
<span id="cb2-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> numpy</span></span>
<span id="cb2-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> matplotlib</span></span>
<span id="cb2-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> scikit-learn</span></span>
<span id="cb2-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> jupyter</span></span></code></pre></div>
<p>T·∫°o m√¥i tr∆∞·ªùng t·ª´ file:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">mamba</span> env create <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-f</span> environment.yml</span></code></pre></div>
</section>
</section>
<section id="c·∫•u-h√¨nh-vs-code" class="level2">
<h2 class="anchored" data-anchor-id="c·∫•u-h√¨nh-vs-code">3. C·∫•u h√¨nh VS Code</h2>
<section id="ch·ªçn-python-interpreter" class="level3">
<h3 class="anchored" data-anchor-id="ch·ªçn-python-interpreter">Ch·ªçn Python Interpreter</h3>
<ol type="1">
<li>M·ªü Command Palette (<code>Ctrl + Shift + P</code>)</li>
<li>T√¨m ‚ÄúPython: Select Interpreter‚Äù</li>
<li>Ch·ªçn m√¥i tr∆∞·ªùng Mamba v·ª´a t·∫°o</li>
</ol>
</section>
<section id="c·∫•u-h√¨nh-notebooks" class="level3">
<h3 class="anchored" data-anchor-id="c·∫•u-h√¨nh-notebooks">C·∫•u h√¨nh Notebooks</h3>
<ul>
<li>VS Code t·ª± ƒë·ªông nh·∫≠n di·ªán kernel t·ª´ m√¥i tr∆∞·ªùng Mamba</li>
<li>Kernel c√≥ th·ªÉ ƒë∆∞·ª£c ch·ªçn ·ªü g√≥c ph·∫£i tr√™n c·ªßa notebook</li>
</ul>
</section>
</section>
<section id="c·∫•u-tr√∫c-project-ƒë·ªÅ-xu·∫•t" class="level2">
<h2 class="anchored" data-anchor-id="c·∫•u-tr√∫c-project-ƒë·ªÅ-xu·∫•t">4. C·∫•u tr√∫c Project ƒê·ªÅ Xu·∫•t</h2>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb4-1">project/</span>
<span id="cb4-2">‚îÇ</span>
<span id="cb4-3">‚îú‚îÄ‚îÄ .vscode/                      # VS Code settings</span>
<span id="cb4-4">‚îÇ   ‚îú‚îÄ‚îÄ settings.json</span>
<span id="cb4-5">‚îÇ   ‚îî‚îÄ‚îÄ launch.json</span>
<span id="cb4-6">‚îÇ</span>
<span id="cb4-7">‚îú‚îÄ‚îÄ data/</span>
<span id="cb4-8">‚îÇ   ‚îú‚îÄ‚îÄ raw/</span>
<span id="cb4-9">‚îÇ   ‚îî‚îÄ‚îÄ processed/</span>
<span id="cb4-10">‚îÇ</span>
<span id="cb4-11">‚îú‚îÄ‚îÄ notebooks/</span>
<span id="cb4-12">‚îÇ   ‚îú‚îÄ‚îÄ 01_exploration.ipynb</span>
<span id="cb4-13">‚îÇ   ‚îî‚îÄ‚îÄ 02_analysis.ipynb</span>
<span id="cb4-14">‚îÇ</span>
<span id="cb4-15">‚îú‚îÄ‚îÄ src/</span>
<span id="cb4-16">‚îÇ   ‚îî‚îÄ‚îÄ processing/</span>
<span id="cb4-17">‚îÇ       ‚îú‚îÄ‚îÄ __init__.py</span>
<span id="cb4-18">‚îÇ       ‚îî‚îÄ‚îÄ data_processing.py</span>
<span id="cb4-19">‚îÇ</span>
<span id="cb4-20">‚îú‚îÄ‚îÄ environment.yml</span>
<span id="cb4-21">‚îú‚îÄ‚îÄ .gitignore</span>
<span id="cb4-22">‚îî‚îÄ‚îÄ README.md</span></code></pre></div>
</section>
<section id="c·∫•u-h√¨nh-vs-code-settings" class="level2">
<h2 class="anchored" data-anchor-id="c·∫•u-h√¨nh-vs-code-settings">5. C·∫•u h√¨nh VS Code Settings</h2>
<p>T·∫°o file <code>.vscode/settings.json</code>:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"python.defaultInterpreterPath"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"${env:USERPROFILE}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Mambaforge</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">envs</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">ds-project</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">python.exe"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"jupyter.notebookFileRoot"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"${workspaceFolder}"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"python.analysis.extraPaths"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"${workspaceFolder}/src"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"python.formatting.provider"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editor.formatOnSave"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"ruff.enable"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"ruff.format.args"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--config=pyproject.toml"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"ruff.lint.args"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--config=pyproject.toml"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-10">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"mypy.enabled"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"mypy.configFile"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pyproject.toml"</span></span>
<span id="cb5-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="c·∫•u-h√¨nh-development-tools" class="level2">
<h2 class="anchored" data-anchor-id="c·∫•u-h√¨nh-development-tools">6. C·∫•u h√¨nh Development Tools</h2>
<section id="c√†i-ƒë·∫∑t-development-dependencies" class="level3">
<h3 class="anchored" data-anchor-id="c√†i-ƒë·∫∑t-development-dependencies">6.1 C√†i ƒë·∫∑t Development Dependencies</h3>
<p>C·∫≠p nh·∫≠t <code>environment.yml</code>:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ds-project</span></span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">channels</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb6-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> conda-forge</span></span>
<span id="cb6-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> defaults</span></span>
<span id="cb6-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dependencies</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb6-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> python=3.10</span></span>
<span id="cb6-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ipykernel</span></span>
<span id="cb6-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> pandas</span></span>
<span id="cb6-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> numpy</span></span>
<span id="cb6-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> matplotlib</span></span>
<span id="cb6-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> scikit-learn</span></span>
<span id="cb6-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> jupyter</span></span>
<span id="cb6-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  # Dev dependencies</span></span>
<span id="cb6-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> black</span></span>
<span id="cb6-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ruff</span></span>
<span id="cb6-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> mypy</span></span>
<span id="cb6-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> pre-commit</span></span>
<span id="cb6-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> nbqa</span></span>
<span id="cb6-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> jupytext</span></span></code></pre></div>
</section>
<section id="c·∫•u-h√¨nh-pyproject.toml" class="level3">
<h3 class="anchored" data-anchor-id="c·∫•u-h√¨nh-pyproject.toml">6.2 C·∫•u h√¨nh pyproject.toml</h3>
<p>T·∫°o file <code>pyproject.toml</code>:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">[tool.black]</span></span>
<span id="cb7-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">line-length</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">88</span></span>
<span id="cb7-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">target-version</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"py310"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb7-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">include</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">\.pyi?$</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span></span>
<span id="cb7-5"></span>
<span id="cb7-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">[tool.ruff]</span></span>
<span id="cb7-7"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">line-length</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">88</span></span>
<span id="cb7-8"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">target-version</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"py310"</span></span>
<span id="cb7-9"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">select</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb7-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pycodestyle</span></span>
<span id="cb7-11">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pyflakes</span></span>
<span id="cb7-12">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># isort</span></span>
<span id="cb7-13">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UP"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pyupgrade</span></span>
<span id="cb7-14"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb7-15"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ignore</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span></span>
<span id="cb7-16"></span>
<span id="cb7-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">[tool.ruff.isort]</span></span>
<span id="cb7-18"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">known-first-party</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"src"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb7-19"></span>
<span id="cb7-20"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">[tool.mypy]</span></span>
<span id="cb7-21"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">python_version</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3.10"</span></span>
<span id="cb7-22"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">warn_return_any</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb7-23"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">warn_unused_configs</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb7-24"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">disallow_untyped_defs</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb7-25"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">check_untyped_defs</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb7-26"></span>
<span id="cb7-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">[[tool.mypy.overrides]]</span></span>
<span id="cb7-28"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">module</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb7-29">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pandas.*"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-30">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"numpy.*"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-31">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"matplotlib.*"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-32">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"seaborn.*"</span></span>
<span id="cb7-33"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb7-34"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ignore_missing_imports</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span></span></code></pre></div>
</section>
<section id="c·∫•u-h√¨nh-pre-commit" class="level3">
<h3 class="anchored" data-anchor-id="c·∫•u-h√¨nh-pre-commit">6.3 C·∫•u h√¨nh Pre-commit</h3>
<p>T·∫°o file <code>.pre-commit-config.yaml</code>:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">repos</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb8-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">repo</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> https://github.com/pre-commit/pre-commit-hooks</span></span>
<span id="cb8-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> v4.5.0</span></span>
<span id="cb8-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hooks</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb8-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> trailing-whitespace</span></span>
<span id="cb8-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> end-of-file-fixer</span></span>
<span id="cb8-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> check-yaml</span></span>
<span id="cb8-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> check-json</span></span>
<span id="cb8-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> check-added-large-files</span></span>
<span id="cb8-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">args</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--maxkb=5000'</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb8-11"></span>
<span id="cb8-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">repo</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> https://github.com/psf/black</span></span>
<span id="cb8-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">24.1.1</span></span>
<span id="cb8-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hooks</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb8-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> black</span></span>
<span id="cb8-16"></span>
<span id="cb8-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">repo</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> https://github.com/astral-sh/ruff-pre-commit</span></span>
<span id="cb8-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> v0.2.1</span></span>
<span id="cb8-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hooks</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb8-20"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ruff</span></span>
<span id="cb8-21"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">args</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--fix</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb8-22"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ruff-format</span></span>
<span id="cb8-23"></span>
<span id="cb8-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">repo</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> https://github.com/pre-commit/mirrors-mypy</span></span>
<span id="cb8-25"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> v1.8.0</span></span>
<span id="cb8-26"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hooks</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb8-27"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> mypy</span></span>
<span id="cb8-28"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">additional_dependencies</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">types-all</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb8-29"></span>
<span id="cb8-30"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">repo</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> https://github.com/nbQA-dev/nbQA</span></span>
<span id="cb8-31"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.7.1</span></span>
<span id="cb8-32"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hooks</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb8-33"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> nbqa-black</span></span>
<span id="cb8-34"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">additional_dependencies</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">black==</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">24.1.1</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb8-35"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">   </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> nbqa-ruff</span></span>
<span id="cb8-36"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">additional_dependencies</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ruff==</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2.1</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
</section>
<section id="c·∫•u-h√¨nh-git-ignore" class="level3">
<h3 class="anchored" data-anchor-id="c·∫•u-h√¨nh-git-ignore">6.4 C·∫•u h√¨nh Git Ignore</h3>
<p>T·∫°o file <code>.gitignore</code>:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource gitignore number-lines code-with-copy"><code class="sourceCode"><span id="cb9-1"># Python</span>
<span id="cb9-2">__pycache__/</span>
<span id="cb9-3">*.py[cod]</span>
<span id="cb9-4">*$py.class</span>
<span id="cb9-5">*.so</span>
<span id="cb9-6">.Python</span>
<span id="cb9-7">build/</span>
<span id="cb9-8">develop-eggs/</span>
<span id="cb9-9">dist/</span>
<span id="cb9-10">downloads/</span>
<span id="cb9-11">eggs/</span>
<span id="cb9-12">.eggs/</span>
<span id="cb9-13">lib/</span>
<span id="cb9-14">lib64/</span>
<span id="cb9-15">parts/</span>
<span id="cb9-16">sdist/</span>
<span id="cb9-17">var/</span>
<span id="cb9-18">wheels/</span>
<span id="cb9-19">*.egg-info/</span>
<span id="cb9-20">.installed.cfg</span>
<span id="cb9-21">*.egg</span>
<span id="cb9-22"></span>
<span id="cb9-23"># Jupyter Notebook</span>
<span id="cb9-24">.ipynb_checkpoints</span>
<span id="cb9-25">*/.ipynb_checkpoints/*</span>
<span id="cb9-26">profile_default/</span>
<span id="cb9-27">ipython_config.py</span>
<span id="cb9-28"></span>
<span id="cb9-29"># VS Code</span>
<span id="cb9-30">.vscode/*</span>
<span id="cb9-31">!.vscode/settings.json</span>
<span id="cb9-32">!.vscode/tasks.json</span>
<span id="cb9-33">!.vscode/launch.json</span>
<span id="cb9-34">!.vscode/extensions.json</span>
<span id="cb9-35"></span>
<span id="cb9-36"># Environment</span>
<span id="cb9-37">.env</span>
<span id="cb9-38">.venv</span>
<span id="cb9-39">env/</span>
<span id="cb9-40">venv/</span>
<span id="cb9-41">ENV/</span>
<span id="cb9-42">env.bak/</span>
<span id="cb9-43">venv.bak/</span>
<span id="cb9-44">.conda/</span>
<span id="cb9-45">conda-env/</span>
<span id="cb9-46"></span>
<span id="cb9-47"># Data</span>
<span id="cb9-48">data/raw/*</span>
<span id="cb9-49">!data/raw/.gitkeep</span>
<span id="cb9-50">data/processed/*</span>
<span id="cb9-51">!data/processed/.gitkeep</span>
<span id="cb9-52">*.csv</span>
<span id="cb9-53">*.xlsx</span>
<span id="cb9-54">*.xls</span>
<span id="cb9-55">*.db</span>
<span id="cb9-56">*.sqlite</span>
<span id="cb9-57">*.h5</span>
<span id="cb9-58"></span>
<span id="cb9-59"># Logs</span>
<span id="cb9-60">logs/</span>
<span id="cb9-61">*.log</span>
<span id="cb9-62">.hypothesis/</span>
<span id="cb9-63">.pytest_cache/</span>
<span id="cb9-64">.coverage</span>
<span id="cb9-65">htmlcov/</span>
<span id="cb9-66"></span>
<span id="cb9-67"># OS specific</span>
<span id="cb9-68">.DS_Store</span>
<span id="cb9-69">.DS_Store?</span>
<span id="cb9-70">._*</span>
<span id="cb9-71">.Spotlight-V100</span>
<span id="cb9-72">.Trashes</span>
<span id="cb9-73">ehthumbs.db</span>
<span id="cb9-74">Thumbs.db</span></code></pre></div>
</section>
<section id="kh·ªüi-t·∫°o-pre-commit" class="level3">
<h3 class="anchored" data-anchor-id="kh·ªüi-t·∫°o-pre-commit">6.5 Kh·ªüi t·∫°o Pre-commit</h3>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Activate m√¥i tr∆∞·ªùng</span></span>
<span id="cb10-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">mamba</span> activate ds-project</span>
<span id="cb10-3"></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C√†i ƒë·∫∑t pre-commit hooks</span></span>
<span id="cb10-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pre-commit</span> install</span>
<span id="cb10-6"></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (T√πy ch·ªçn) Ch·∫°y pre-commit tr√™n t·∫•t c·∫£ files</span></span>
<span id="cb10-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pre-commit</span> run <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--all-files</span></span></code></pre></div>
</section>
<section id="extensions-vs-code-cho-notebooks" class="level3">
<h3 class="anchored" data-anchor-id="extensions-vs-code-cho-notebooks">6.6 Extensions VS Code cho Notebooks</h3>
<p>C√†i th√™m c√°c extensions sau:</p>
<ol type="1">
<li>‚ÄúJupyter Notebook Renderers‚Äù</li>
<li>‚ÄúJupytext for Notebooks‚Äù</li>
<li>‚ÄúBlack Formatter‚Äù</li>
<li>‚ÄúRuff‚Äù</li>
<li>‚ÄúMypy Type Checker‚Äù</li>
</ol>
</section>
<section id="c·∫•u-h√¨nh-jupytext" class="level3">
<h3 class="anchored" data-anchor-id="c·∫•u-h√¨nh-jupytext">6.7 C·∫•u h√¨nh Jupytext</h3>
<p>T·∫°o file <code>.jupytext.toml</code>:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource toml number-lines code-with-copy"><code class="sourceCode toml"><span id="cb11-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">formats</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ipynb,qmd"</span></span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">[formats]</span></span>
<span id="cb11-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ipynb</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span>
<span id="cb11-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">qmd</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span></span></code></pre></div>
</section>
</section>
<section id="pro-tips-cho-windows" class="level2">
<h2 class="anchored" data-anchor-id="pro-tips-cho-windows">7. Pro Tips cho Windows</h2>
<section id="path-management" class="level3">
<h3 class="anchored" data-anchor-id="path-management">Path Management</h3>
<p>S·ª≠ d·ª•ng <code>pathlib</code> ƒë·ªÉ x·ª≠ l√Ω ƒë∆∞·ªùng d·∫´n:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb12-2">data_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file.csv"</span></span></code></pre></div>
</section>
<section id="git-configuration" class="level3">
<h3 class="anchored" data-anchor-id="git-configuration">Git Configuration</h3>
<p>T·∫°o file <code>.gitignore</code>:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource gitignore number-lines code-with-copy"><code class="sourceCode"><span id="cb13-1"># .gitignore</span>
<span id="cb13-2">data/raw/*</span>
<span id="cb13-3">data/processed/*</span>
<span id="cb13-4">.ipynb_checkpoints/</span>
<span id="cb13-5">__pycache__/</span>
<span id="cb13-6">*.pyc</span></code></pre></div>
</section>
<section id="jupyter-trong-vs-code" class="level3">
<h3 class="anchored" data-anchor-id="jupyter-trong-vs-code">Jupyter trong VS Code</h3>
<ul>
<li>Ch·∫°y cell: <code>Shift + Enter</code></li>
<li>Variable explorer c√≥ s·∫µn</li>
<li>Plot viewer t√≠ch h·ª£p</li>
<li>Intellisense ho·∫°t ƒë·ªông t·ªët</li>
</ul>
</section>
<section id="debugging" class="level3">
<h3 class="anchored" data-anchor-id="debugging">Debugging</h3>
<ul>
<li>Debugger t√≠ch h·ª£p cho c·∫£ <code>.py</code> v√† <code>.ipynb</code></li>
<li>C√≥ th·ªÉ ƒë·∫∑t breakpoints trong notebooks</li>
</ul>
</section>
</section>
<section id="x·ª≠-l√Ω-l·ªói-th∆∞·ªùng-g·∫∑p" class="level2">
<h2 class="anchored" data-anchor-id="x·ª≠-l√Ω-l·ªói-th∆∞·ªùng-g·∫∑p">8. X·ª≠ l√Ω L·ªói Th∆∞·ªùng G·∫∑p</h2>
<ol type="1">
<li><p><strong>Path qu√° d√†i tr√™n Windows</strong></p>
<ul>
<li>S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n ng·∫Øn h∆°n</li>
<li>K√≠ch ho·∫°t h·ªó tr·ª£ ƒë∆∞·ªùng d·∫´n d√†i trong Windows</li>
</ul></li>
<li><p><strong>Conflict v·ªõi m√¥i tr∆∞·ªùng Python kh√°c</strong></p>
<ul>
<li>ƒê·∫£m b·∫£o PATH ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng</li>
<li>Ki·ªÉm tra <code>where python</code> trong terminal</li>
</ul></li>
<li><p><strong>Jupyter Kernel kh√¥ng hi·ªÉn th·ªã</strong></p>
<ul>
<li>C√†i l·∫°i <code>ipykernel</code></li>
<li>Ki·ªÉm tra jupyter kernelspec list</li>
</ul></li>
</ol>
</section>
<section id="resources-h·ªØu-√≠ch" class="level2">
<h2 class="anchored" data-anchor-id="resources-h·ªØu-√≠ch">9. Resources H·ªØu √≠ch</h2>
<ul>
<li><a href="https://mamba.readthedocs.io/">Mamba Documentation</a></li>
<li><a href="https://code.visualstudio.com/docs/python/python-tutorial">VS Code Python Documentation</a></li>
<li><a href="https://code.visualstudio.com/docs/datascience/jupyter-notebooks">Jupyter in VS Code</a></li>
</ul>
</section>
<section id="workflow-ƒë·ªÅ-xu·∫•t" class="level2">
<h2 class="anchored" data-anchor-id="workflow-ƒë·ªÅ-xu·∫•t">10. Workflow ƒê·ªÅ Xu·∫•t</h2>
<ol type="1">
<li><strong>Kh·ªüi t·∫°o project m·ªõi</strong>:</li>
</ol>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># T·∫°o v√† activate m√¥i tr∆∞·ªùng</span></span>
<span id="cb14-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">mamba</span> env create <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-f</span> environment.yml</span>
<span id="cb14-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">mamba</span> activate ds-project</span>
<span id="cb14-4"></span>
<span id="cb14-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C√†i ƒë·∫∑t pre-commit hooks</span></span>
<span id="cb14-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pre-commit</span> install</span></code></pre></div>
<ol start="2" type="1">
<li><strong>Ph√°t tri·ªÉn</strong>:</li>
</ol>
<ul>
<li>Code trong VS Code v·ªõi c√°c extensions ƒë√£ c√†i</li>
<li>Notebooks s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c format b·ªüi nbQA</li>
<li>Pre-commit s·∫Ω ki·ªÉm tra code tr∆∞·ªõc m·ªói commit</li>
</ul>
<ol start="3" type="1">
<li><strong>Commit Changes</strong>:</li>
</ol>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> add .</span>
<span id="cb15-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> commit <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"your message"</span></span>
<span id="cb15-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pre-commit s·∫Ω t·ª± ƒë·ªông ch·∫°y c√°c checks</span></span></code></pre></div>
<ol start="4" type="1">
<li><strong>Update Dependencies</strong>:</li>
</ol>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Th√™m package m·ªõi</span></span>
<span id="cb16-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">mamba</span> install package-name</span>
<span id="cb16-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Export environment</span></span>
<span id="cb16-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">mamba</span> env export <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> environment.yml</span></code></pre></div>
</section>
<section id="bonus-n·∫øu-mu·ªën-import-m·ªôt-module-t·ª´-src-trong-notebook.ipynb-th√¨-l√†m-th·∫ø-n√†o" class="level2">
<h2 class="anchored" data-anchor-id="bonus-n·∫øu-mu·ªën-import-m·ªôt-module-t·ª´-src-trong-notebook.ipynb-th√¨-l√†m-th·∫ø-n√†o">Bonus: n·∫øu mu·ªën import m·ªôt module t·ª´ <code>src</code> trong <code>notebook.ipynb</code> th√¨ l√†m th·∫ø n√†o?</h2>
<div id="c9cc4dfd" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Trong notebook c·ªßa b·∫°n (v√≠ d·ª• notebooks/analysis.ipynb)</span></span>
<span id="cb17-2"></span>
<span id="cb17-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. Setup path</span></span>
<span id="cb17-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb17-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb17-6">project_root <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(Path.cwd().parent)</span>
<span id="cb17-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> project_root <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> sys.path:</span>
<span id="cb17-8">    sys.path.append(project_root)</span>
<span id="cb17-9"></span>
<span id="cb17-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. Import function</span></span>
<span id="cb17-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> src.processing.data_preprocessing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> process_data, clean_data</span>
<span id="cb17-12"></span>
<span id="cb17-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. S·ª≠ d·ª•ng function</span></span>
<span id="cb17-14">df_processed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> process_data(df_raw)</span></code></pre></div>
</details>
</div>
<p>V·ªõi l∆∞u √Ω:</p>
<ul>
<li>ƒê·∫£m b·∫£o c√≥ file <code>__init__.py</code> trong m·ªói th∆∞ m·ª•c Python</li>
<li>Kh√¥ng n√™n d√πng relative imports (<code>from ...src.processing</code>) v√¨ d·ªÖ g√¢y l·ªói</li>
<li>N√™n ƒë·∫∑t t√™n module v√† function theo PEP 8</li>
<li>Trong <code>data_preprocessing.py</code> n√™n c√≥ docstring m√¥ t·∫£ function</li>
</ul>
<div id="05d43597" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># src/processing/data_preprocessing.py</span></span>
<span id="cb18-2"></span>
<span id="cb18-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> process_data(df):</span>
<span id="cb18-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Process the input dataframe.</span></span>
<span id="cb18-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb18-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb18-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        df (pd.DataFrame): Input dataframe</span></span>
<span id="cb18-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        </span></span>
<span id="cb18-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb18-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        pd.DataFrame: Processed dataframe</span></span>
<span id="cb18-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb18-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># your code here</span></span>
<span id="cb18-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> processed_df</span></code></pre></div>
</details>
</div>


<!-- -->

</section>
</section>

 ]]></description>
  <category>python</category>
  <guid>https://lktuan.github.io/blog/2024-11-04-intro-to-mamba/</guid>
  <pubDate>Sun, 03 Nov 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-11-04-intro-to-mamba/mamba.png" medium="image" type="image/png" height="92" width="144"/>
</item>
<item>
  <title>Keynote on: Causal Effect Estimation in Practice - lessons learned from E-commerce &amp; Banking</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/</link>
  <description><![CDATA[ 





<p>Link: <a href="https://www.youtube.com/watch?v=pz7QD2GPBlE" class="uri">https://www.youtube.com/watch?v=pz7QD2GPBlE</a></p>
<p><a href="https://github.com/Senejohnny">Danial</a> focuses on the practical challenges and solutions in implementing causal effect estimation in business settings, particularly in finance and banking. The speaker emphasizes the gap between <strong>theoretical frameworks</strong> and <strong>real-world applications</strong>, sharing lessons learned from actual implementations.</p>
<section id="intro" class="level1">
<h1>0. Intro</h1>
<p>The author aim to shed some light on the practical setting and challenges of <strong>causal inference</strong>. Causal analysis goes further than predicting an outcome, all the way to influence it.</p>
</section>
<section id="practical-use-cases" class="level1">
<h1>1. Practical Use Cases</h1>
<ul>
<li>Effect estimation:
<ul>
<li>Marketing campaign effectiveness evaluation (on client/product acquisition and retention);</li>
<li>Assessment of free financial consultation services‚Äô value (on revenue/NPS);</li>
</ul></li>
<li>Other applications [Out of scope]:
<ul>
<li>Root Cause Analysis: To what factor(s) the estimated effect can be attributed;</li>
<li>What if analysis: What is the result of a counterfactual scenario.</li>
</ul></li>
</ul>
<p>Eg.: the impact measurement of credit lines on customer retention. The primary challenge is moving from <strong>theoretical frameworks</strong> to <strong>practical business applications</strong>.</p>
</section>
<section id="the-gold-standard-vs.-reality" class="level1">
<h1>2. The Gold Standard vs.&nbsp;Reality</h1>
<ul>
<li>While A/B testing (randomized experiments) is considered the gold standard, it‚Äôs often impractical or impossible in real business settings;</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/1_ab_testing.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>golden standard</figcaption>
</figure>
</div>
</div>
</div>
</div>
<ul>
<li>Common obstacles include:
<ul>
<li>Marketers forgetting to implement proper randomization;</li>
<li>Cost and business constraints;</li>
<li>Ethical considerations;</li>
<li>Client non-compliance;</li>
<li>Limited data availability.</li>
</ul></li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/2_limitations.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>limitations</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="practical-challenges" class="level1">
<h1>3. Practical Challenges</h1>
<ul>
<li>Non-simultaneous contact: In reality, campaigns often target different groups at different times;</li>
<li>Lack of proper control groups: When targeting specific customer segments, finding comparable control groups is difficult;</li>
<li>No randomization: Business rules often determine who receives treatment, leading to selection bias.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/3_differences.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>differences</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="solutions-and-approaches" class="level1">
<h1>4. Solutions and Approaches</h1>
<section id="handling-non-randomization" class="level2">
<h2 class="anchored" data-anchor-id="handling-non-randomization">4.1. Handling Non-randomization</h2>
<ul>
<li>Use propensity score modeling to mimic randomization;</li>
<li>Account for confounding variables (like age, sex) that affect both treatment assignment and outcomes;</li>
<li>Apply inverse probability weighting to correct for selection bias.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/4_sol_1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>minic randomization</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="control-group-selection" class="level2">
<h2 class="anchored" data-anchor-id="control-group-selection">4.2. Control Group Selection</h2>
<ul>
<li>Use rule-based methods to create comparable control groups;</li>
<li>Apply the same filters used in campaign targeting;</li>
<li>Consider similar products within the same category;</li>
<li>Implement exclusion criteria to maintain non-interference and consistency;</li>
<li>Ensure basic criteria matching (e.g., valid email addresses, opt-in status).</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/10_good_control.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>good control</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="kpi-consideration" class="level2">
<h2 class="anchored" data-anchor-id="kpi-consideration">4.3. KPI Consideration</h2>
<ul>
<li>Understand the propagation of effects through time:
<ul>
<li>Short-term metrics (email opens, clicks);</li>
<li>Mid-term metrics (product adoption);</li>
<li>Long-term metrics (revenue generation);</li>
</ul></li>
<li>Consider data availability and measurement timing;</li>
<li>Account for different variables affecting each level of metrics.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/9_effect_propagation_kpi.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>KPIs consideration</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="theoretical-frameworks" class="level1">
<h1>5. Theoretical Frameworks</h1>
<p>The speaker discusses two main schools of thought:</p>
<section id="potential-outcomes-framework" class="level2">
<h2 class="anchored" data-anchor-id="potential-outcomes-framework">5.1. Potential Outcomes Framework</h2>
<ul>
<li>Focuses on treatment assignment mechanisms;</li>
<li>Uses propensity scoring and inverse probability weighting;</li>
<li>Simpler to implement in practice.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/5_potantial_outcome.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>potential outcome</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/6_potential_outcome_assumption.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>potential outcome assumptions</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/7_when_association_is_causation.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>when association is causation?</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="structural-causal-models" class="level2">
<h2 class="anchored" data-anchor-id="structural-causal-models">5.2. Structural Causal Models</h2>
<ul>
<li>Based on causal graphs;</li>
<li>Provides a more complete picture of relationships;</li>
<li>Requires careful consideration of mediators, confounders, and colliders.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/8_SCM.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>structural causal models</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="practical-implementation-tips" class="level1">
<h1>6. Practical Implementation Tips</h1>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/11_practice_example.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>pratical example</figcaption>
</figure>
</div>
</div>
</div>
</div>
<ul>
<li>Start with simple rule-based approaches before applying sophisticated models;</li>
<li>Validate assumptions with domain experts;</li>
<li>Consider multiple time horizons for effect measurement;</li>
<li>Use survival analysis for handling time-varying outcomes;</li>
<li>Apply multiple methods to validate results;</li>
<li>Focus on business relevance rather than theoretical perfection.</li>
</ul>
</section>
<section id="key-considerations-for-success" class="level1">
<h1>7. Key Considerations for Success</h1>
<ul>
<li>Ensure exchangeability between treatment and control groups;</li>
<li>Maintain positivity (overlap in covariate distributions);</li>
<li>Avoid interference between groups;</li>
<li>Maintain consistency in treatment application;</li>
<li>Consider both direct and indirect effects;</li>
<li>Account for time-varying effects.</li>
</ul>
</section>
<section id="evaluation-challenges" class="level1">
<h1>8. Evaluation Challenges</h1>
<ul>
<li>Unlike simulated data, real-world applications lack known true effects;</li>
<li>Recommend using multiple methods and comparing results;</li>
<li>Validate findings with domain experts;</li>
<li>Consider business context and practical significance.</li>
</ul>
</section>
<section id="outtro" class="level1">
<h1>9. Outtro</h1>
<p>The speaker emphasizes that successful causal inference in practice requires:</p>
<ul>
<li>Balance between theoretical rigor and practical constraints;</li>
<li>Understanding of business context and limitations;</li>
<li>Use of simple, interpretable methods where appropriate;</li>
<li>Careful consideration of data quality and availability;</li>
<li>Collaboration with domain experts;</li>
<li>Focus on business-relevant metrics and timeframes.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/12_take_aways.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>take aways</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>The speech concludes by highlighting that while causal inference in practice may not always match theoretical ideals, careful application of basic principles, combined with practical business understanding, can still provide valuable insights for decision-making.</p>
<p>Summary with the help of <a href="https://claude.ai/"><strong>Claude 3.5 Sonnet</strong></a>. Happy exploring!</p>


<!-- -->

</section>

 ]]></description>
  <category>causal inference</category>
  <guid>https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/</guid>
  <pubDate>Thu, 24 Oct 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-10-25-CEE-in-practice/causal_inf.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Note on Mathematics as the Universal Language of Nature</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-08-08-note-muln/</link>
  <description><![CDATA[ 





<p>m√¨nh nghe b√†i n√≥i chuy·ªán ‚ÄúMathematics as the Universal Language of Nature‚Äù c·ªßa R. Seiringer, t·ªï ch·ª©c t·∫°i Tr∆∞·ªùng ƒê·∫°i h·ªçc S∆∞ ph·∫°m Hu·∫ø, ng√†y 8 th√°ng 8 nƒÉm 2024. D∆∞·ªõi ƒë√¢y l√† note c·ªßa m√¨nh.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-08-08-note-muln/talk_cover.png" class="img-fluid figure-img"></p>
<figcaption>talk cover</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>Robert l√† 1 gi√°o s∆∞ chuy√™n, ƒë·∫ßu ng√†nh v·ªÅ To√°n v√† V·∫≠t l√Ω, t·ª´ng gi·∫£ng d·∫°y t·∫°i Princeton, hi·ªán nay c√¥ng t√°c t·∫°i Vi·ªán K·ªπ Thu·∫≠t v√† Khoa h·ªçc c·ªßa √Åo. B√†i gi·∫£ng n√†y c·ªßa gi√°o s∆∞ nh·∫±m n√™u b·∫≠t v·∫ª ƒë·∫πp c·ªßa To√°n v√† V·∫≠t l√Ω, d√πng To√°n ƒë·ªÉ gi·∫£i th√≠ch t·ª± nhi√™n.</p>
<section id="history" class="level1">
<h1>History</h1>
<ul>
<li>Newton: calculus, motion of earth around the sun, theory of gravity;</li>
<li>Fourier: Fourier series to understand hear transfer &amp; conduction (also green house effect!);</li>
<li>Rieman: thuy·∫øt t∆∞∆°ng ƒë·ªëi t·ªïng qu√°t, l√Ω thuy·∫øt tr∆∞·ªùng l∆∞·ª£ng t·ª≠, l√Ω thuy·∫øt d√¢y.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
green house effect
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Jean-Baptiste Joseph Fourier, nh√† to√°n h·ªçc v√† v·∫≠t l√Ω h·ªçc ng∆∞·ªùi Ph√°p, l√† ng∆∞·ªùi ƒë·∫ßu ti√™n m√¥ t·∫£ hi·ªáu ·ª©ng nh√† k√≠nh (greenhouse effect) v√†o nƒÉm 1824. H√£y gi·∫£i th√≠ch v·ªÅ kh√°i ni·ªám n√†y:</p>
<ol type="1">
<li><p><strong>ƒê·ªãnh nghƒ©a:</strong> Hi·ªáu ·ª©ng nh√† k√≠nh c·ªßa Fourier ƒë·ªÅ c·∫≠p ƒë·∫øn qu√° tr√¨nh m√† kh√≠ quy·ªÉn c·ªßa Tr√°i ƒê·∫•t gi·ªØ nhi·ªát, l√†m cho b·ªÅ m·∫∑t h√†nh tinh ·∫•m h∆°n so v·ªõi tr∆∞·ªùng h·ª£p kh√¥ng c√≥ kh√≠ quy·ªÉn.</p></li>
<li><p><strong>C∆° ch·∫ø c∆° b·∫£n:</strong></p></li>
</ol>
<ol type="a">
<li><p>B·ª©c x·∫° m·∫∑t tr·ªùi ƒëi qua kh√≠ quy·ªÉn v√† ƒë∆∞·ª£c h·∫•p th·ª• b·ªüi b·ªÅ m·∫∑t Tr√°i ƒê·∫•t.</p></li>
<li><p>Tr√°i ƒê·∫•t ph√°t ra b·ª©c x·∫° h·ªìng ngo·∫°i (nhi·ªát).</p></li>
<li><p>M·ªôt ph·∫ßn b·ª©c x·∫° n√†y b·ªã c√°c kh√≠ nh√† k√≠nh trong kh√≠ quy·ªÉn h·∫•p th·ª• v√† t√°i ph√°t ra theo m·ªçi h∆∞·ªõng.</p></li>
<li><p>Qu√° tr√¨nh n√†y gi·ªØ nhi·ªát trong kh√≠ quy·ªÉn, l√†m tƒÉng nhi·ªát ƒë·ªô trung b√¨nh c·ªßa Tr√°i ƒê·∫•t.</p></li>
</ol>
<ol start="3" type="1">
<li><strong>ƒê√≥ng g√≥p c·ªßa Fourier:</strong></li>
</ol>
<ul>
<li>Fourier nh·∫≠n ra r·∫±ng kh√≠ quy·ªÉn ƒë√≥ng vai tr√≤ nh∆∞ m·ªôt ‚Äút·∫•m chƒÉn‚Äù, gi·ªØ nhi·ªát cho Tr√°i ƒê·∫•t.</li>
<li>√îng so s√°nh qu√° tr√¨nh n√†y v·ªõi c√°ch ho·∫°t ƒë·ªông c·ªßa nh√† k√≠nh tr·ªìng c√¢y.</li>
</ul>
<ol start="4" type="1">
<li><strong>T·∫ßm quan tr·ªçng:</strong></li>
</ol>
<ul>
<li>Hi·ªáu ·ª©ng nh√† k√≠nh t·ª± nhi√™n l√†m cho Tr√°i ƒê·∫•t c√≥ th·ªÉ ·ªü ƒë∆∞·ª£c, duy tr√¨ nhi·ªát ƒë·ªô trung b√¨nh kho·∫£ng 15¬∞C thay v√¨ -18¬∞C n·∫øu kh√¥ng c√≥ n√≥.</li>
<li>Hi·ªÉu bi·∫øt n√†y ƒë·∫∑t n·ªÅn m√≥ng cho nghi√™n c·ª©u v·ªÅ bi·∫øn ƒë·ªïi kh√≠ h·∫≠u hi·ªán ƒë·∫°i.</li>
</ul>
<ol start="5" type="1">
<li><strong>Ph√°t tri·ªÉn sau n√†y:</strong></li>
</ol>
<ul>
<li>John Tyndall (1859) x√°c ƒë·ªãnh c√°c kh√≠ c·ª• th·ªÉ g√¢y ra hi·ªáu ·ª©ng nh√† k√≠nh.</li>
<li>Svante Arrhenius (1896) t√≠nh to√°n ƒë·ªãnh l∆∞·ª£ng ·∫£nh h∆∞·ªüng c·ªßa CO2 ƒë·ªëi v·ªõi nhi·ªát ƒë·ªô Tr√°i ƒê·∫•t.</li>
</ul>
<ol start="6" type="1">
<li><strong>Kh√°c bi·ªát v·ªõi hi·ªÉu bi·∫øt hi·ªán ƒë·∫°i:</strong></li>
</ol>
<ul>
<li>Fourier ch∆∞a bi·∫øt v·ªÅ c√°c kh√≠ nh√† k√≠nh c·ª• th·ªÉ ho·∫∑c c∆° ch·∫ø ph√¢n t·ª≠ c·ªßa qu√° tr√¨nh n√†y.</li>
<li>Hi·ªÉu bi·∫øt hi·ªán ƒë·∫°i v·ªÅ hi·ªáu ·ª©ng nh√† k√≠nh ph·ª©c t·∫°p h∆°n nhi·ªÅu, bao g·ªìm c√°c ph·∫£n h·ªìi v√† t∆∞∆°ng t√°c kh√≠ h·∫≠u.</li>
</ul>
<ol start="7" type="1">
<li><strong>√ù nghƒ©a l·ªãch s·ª≠:</strong></li>
</ol>
<ul>
<li>C√¥ng tr√¨nh c·ªßa Fourier ƒë·∫∑t n·ªÅn m√≥ng cho khoa h·ªçc kh√≠ h·∫≠u hi·ªán ƒë·∫°i v√† hi·ªÉu bi·∫øt c·ªßa ch√∫ng ta v·ªÅ c√°ch Tr√°i ƒê·∫•t duy tr√¨ nhi·ªát ƒë·ªô.</li>
</ul>
<p>Hi·ªáu ·ª©ng nh√† k√≠nh c·ªßa Fourier l√† m·ªôt v√≠ d·ª• tuy·ªát v·ªùi v·ªÅ c√°ch m·ªôt kh√°i ni·ªám khoa h·ªçc c∆° b·∫£n c√≥ th·ªÉ d·∫´n ƒë·∫øn nh·ªØng hi·ªÉu bi·∫øt s√¢u s·∫Øc v·ªÅ h·ªá th·ªëng Tr√°i ƒê·∫•t v√† cu·ªëi c√πng ·∫£nh h∆∞·ªüng ƒë·∫øn ch√≠nh s√°ch to√†n c·∫ßu v·ªÅ bi·∫øn ƒë·ªïi kh√≠ h·∫≠u.</p>
</div>
</div>
</div>
</section>
<section id="math-desc.-of-laws-of-nature" class="level1">
<h1>Math Desc. of Laws of Nature</h1>
<p>the unreasonable effectiveness of math in the natural sciences (Eugene P. Wigner), formulation of the basic laws of nature in mathematically precise terms.</p>
<p>v√≠ d·ª•: Ph∆∞∆°ng tr√¨nh Schrodinger -&gt; √°p d·ª•ng t·ª´ atomic nuclei to neutron stars.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Ph∆∞∆°ng Tr√¨nh Schr√∂dinger: C√°nh C·ª≠a V√†o Th·∫ø Gi·ªõi L∆∞·ª£ng T·ª≠
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Ph∆∞∆°ng tr√¨nh Schr√∂dinger l√† m·ªôt ph∆∞∆°ng tr√¨nh vi ph√¢n t·ª´ng ph·∫ßn c∆° b·∫£n trong c∆° h·ªçc l∆∞·ª£ng t·ª≠, ƒë∆∞·ª£c ƒë·∫∑t t√™n theo nh√† v·∫≠t l√Ω Erwin Schr√∂dinger. N√≥ m√¥ t·∫£ s·ª± bi·∫øn ƒë·ªïi theo th·ªùi gian c·ªßa h√†m s√≥ng c·ªßa m·ªôt h·ªá l∆∞·ª£ng t·ª≠. H√†m s√≥ng n√†y ch·ª©a ƒë·ª±ng t·∫•t c·∫£ th√¥ng tin v·ªÅ tr·∫°ng th√°i c·ªßa h·ªá th·ªëng, bao g·ªìm c·∫£ v·ªã tr√≠, ƒë·ªông l∆∞·ª£ng v√† c√°c t√≠nh ch·∫•t kh√°c.</p>
<p><strong>√ù nghƒ©a V·∫≠t l√Ω</strong></p>
<ul>
<li>M√¥ t·∫£ s·ª± chuy·ªÉn ƒë·ªông c·ªßa c√°c h·∫°t ·ªü c·∫•p ƒë·ªô l∆∞·ª£ng t·ª≠: N·∫øu trong c∆° h·ªçc c·ªï ƒëi·ªÉn, ch√∫ng ta s·ª≠ d·ª•ng c√°c ph∆∞∆°ng tr√¨nh Newton ƒë·ªÉ m√¥ t·∫£ chuy·ªÉn ƒë·ªông c·ªßa c√°c v·∫≠t th·ªÉ, th√¨ trong c∆° h·ªçc l∆∞·ª£ng t·ª≠, ph∆∞∆°ng tr√¨nh Schr√∂dinger ƒë√≥ng vai tr√≤ t∆∞∆°ng t·ª±. N√≥ cho ph√©p ch√∫ng ta t√≠nh to√°n x√°c su·∫•t t√¨m th·∫•y m·ªôt h·∫°t t·∫°i m·ªôt v·ªã tr√≠ n√†o ƒë√≥ t·∫°i m·ªôt th·ªùi ƒëi·ªÉm nh·∫•t ƒë·ªãnh.</li>
<li>H√†m s√≥ng: H√†m s√≥ng kh√¥ng ph·∫£i l√† m·ªôt ƒë·∫°i l∆∞·ª£ng v·∫≠t l√Ω c√≥ th·ªÉ ƒëo tr·ª±c ti·∫øp, m√† l√† m·ªôt h√†m to√°n h·ªçc ph·ª©c. B√¨nh ph∆∞∆°ng m√¥ ƒëun c·ªßa h√†m s√≥ng t·∫°i m·ªôt ƒëi·ªÉm trong kh√¥ng gian cho ta x√°c su·∫•t t√¨m th·∫•y h·∫°t t·∫°i ƒëi·ªÉm ƒë√≥.</li>
</ul>
<p><strong>·ª®ng d·ª•ng c·ªßa Ph∆∞∆°ng Tr√¨nh Schr√∂dinger</strong>. Ph∆∞∆°ng tr√¨nh Schr√∂dinger c√≥ ·ª©ng d·ª•ng r·ªông r√£i trong nhi·ªÅu lƒ©nh v·ª±c c·ªßa v·∫≠t l√Ω, bao g·ªìm:</p>
<ul>
<li>V·∫≠t l√Ω nguy√™n t·ª≠: D√πng ƒë·ªÉ m√¥ t·∫£ c·∫•u tr√∫c c·ªßa nguy√™n t·ª≠, ph√¢n t·ª≠ v√† t√≠nh to√°n c√°c m·ª©c nƒÉng l∆∞·ª£ng c·ªßa ch√∫ng.</li>
<li>V·∫≠t l√Ω h·∫°t nh√¢n: √Åp d·ª•ng ƒë·ªÉ nghi√™n c·ª©u c·∫•u tr√∫c c·ªßa h·∫°t nh√¢n nguy√™n t·ª≠ v√† c√°c qu√° tr√¨nh t∆∞∆°ng t√°c h·∫°t nh√¢n.</li>
<li>V·∫≠t l√Ω ch·∫•t r·∫Øn: ƒê∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ m√¥ t·∫£ c√°c t√≠nh ch·∫•t ƒëi·ªán, t·ª´, v√† quang h·ªçc c·ªßa v·∫≠t li·ªáu.</li>
<li>V·∫≠t l√Ω thi√™n vƒÉn: √Åp d·ª•ng ƒë·ªÉ nghi√™n c·ª©u c√°c v·∫≠t th·ªÉ thi√™n vƒÉn nh∆∞ sao, tinh v√¢n v√† l·ªó ƒëen.</li>
</ul>
<p><strong>T·∫°i Sao Ph∆∞∆°ng Tr√¨nh Schr√∂dinger √Åp D·ª•ng R·ªông R√£i?</strong></p>
<ul>
<li>T√≠nh ph·ªï qu√°t: Ph∆∞∆°ng tr√¨nh Schr√∂dinger l√† m·ªôt ph∆∞∆°ng tr√¨nh c∆° b·∫£n, √°p d·ª•ng cho m·ªçi h·ªá l∆∞·ª£ng t·ª≠, t·ª´ c√°c h·∫°t ƒë∆°n l·∫ª ƒë·∫øn c√°c h·ªá ph·ª©c t·∫°p nh∆∞ nguy√™n t·ª≠, ph√¢n t·ª≠ v√† v·∫≠t li·ªáu r·∫Øn.</li>
<li>ƒê·ªô ch√≠nh x√°c cao: C√°c k·∫øt qu·∫£ t√≠nh to√°n d·ª±a tr√™n ph∆∞∆°ng tr√¨nh Schr√∂dinger ƒë√£ ƒë∆∞·ª£c ki·ªÉm nghi·ªám th·ª±c nghi·ªám m·ªôt c√°ch ch√≠nh x√°c cao, kh·∫≥ng ƒë·ªãnh t√≠nh ƒë√∫ng ƒë·∫Øn c·ªßa l√Ω thuy·∫øt l∆∞·ª£ng t·ª≠.</li>
<li>Kh·∫£ nƒÉng d·ª± ƒëo√°n: Ph∆∞∆°ng tr√¨nh Schr√∂dinger cho ph√©p ch√∫ng ta d·ª± ƒëo√°n k·∫øt qu·∫£ c·ªßa c√°c th√≠ nghi·ªám l∆∞·ª£ng t·ª≠, t·ª´ ƒë√≥ m·ªü ra nhi·ªÅu ·ª©ng d·ª•ng trong c√¥ng ngh·ªá hi·ªán ƒë·∫°i.</li>
</ul>
<p><strong>T·ª´ Nguy√™n T·ª≠ ƒë·∫øn Sao Neutron</strong></p>
<ul>
<li>Nguy√™n t·ª≠: Ph∆∞∆°ng tr√¨nh Schr√∂dinger ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ m√¥ t·∫£ s·ª± chuy·ªÉn ƒë·ªông c·ªßa electron xung quanh h·∫°t nh√¢n, t·ª´ ƒë√≥ gi·∫£i th√≠ch quang ph·ªï nguy√™n t·ª≠ v√† c√°c t√≠nh ch·∫•t h√≥a h·ªçc c·ªßa c√°c nguy√™n t·ªë.</li>
<li>H·∫°t nh√¢n: Ph∆∞∆°ng tr√¨nh Schr√∂dinger (·ªü d·∫°ng t∆∞∆°ng ƒë·ªëi t√≠nh) ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ m√¥ t·∫£ c·∫•u tr√∫c c·ªßa h·∫°t nh√¢n nguy√™n t·ª≠, c√°c t∆∞∆°ng t√°c gi·ªØa c√°c nucleon (proton v√† neutron) b√™n trong h·∫°t nh√¢n.</li>
<li>Sao neutron: Sao neutron l√† nh·ªØng ng√¥i sao ƒë√£ ch·∫øt, c·ª±c k·ª≥ ƒë·∫∑c, ch·ªß y·∫øu g·ªìm c√°c neutron. M·∫∑c d√π c·∫•u tr√∫c b√™n trong c·ªßa sao neutron r·∫•t ph·ª©c t·∫°p, nh∆∞ng c√°c nh√† v·∫≠t l√Ω v·∫´n s·ª≠ d·ª•ng c√°c phi√™n b·∫£n m·ªü r·ªông c·ªßa ph∆∞∆°ng tr√¨nh Schr√∂dinger ƒë·ªÉ m√¥ t·∫£ h√†nh vi c·ªßa v·∫≠t ch·∫•t trong ƒëi·ªÅu ki·ªán c·ª±c ƒëoan b√™n trong sao neutron.</li>
</ul>
<p><strong>T√≥m l·∫°i</strong>, ph∆∞∆°ng tr√¨nh Schr√∂dinger l√† m·ªôt c√¥ng c·ª• to√°n h·ªçc m·∫°nh m·∫Ω, cho ph√©p ch√∫ng ta hi·ªÉu s√¢u s·∫Øc v·ªÅ th·∫ø gi·ªõi l∆∞·ª£ng t·ª≠. S·ª± th√†nh c√¥ng c·ªßa ph∆∞∆°ng tr√¨nh n√†y trong vi·ªác gi·∫£i th√≠ch c√°c hi·ªán t∆∞·ª£ng t·ª´ c·∫•p ƒë·ªô nguy√™n t·ª≠ ƒë·∫øn c·∫•p ƒë·ªô v≈© tr·ª• ƒë√£ kh·∫≥ng ƒë·ªãnh v·ªã tr√≠ trung t√¢m c·ªßa n√≥ trong n·ªÅn t·∫£ng c·ªßa v·∫≠t l√Ω hi·ªán ƒë·∫°i.</p>
</div>
</div>
</div>
</section>
<section id="technology-development" class="level1">
<h1>Technology Development</h1>
<p>How quantum mechanic works, it‚Äôs understanding from human lies at the heart of technological advances in the past century</p>
<ul>
<li>phone</li>
<li>computer</li>
<li>satellite</li>
<li>‚Ä¶</li>
</ul>
</section>
<section id="complexity" class="level1">
<h1>Complexity</h1>
<p>the more basic physical laws are stated, the more complex be allowed for calculating their solution.</p>
<p>eg: description of the air in this lecture room, there will me rought ly 10^30 parameters</p>
<p>eg: phase transitions -&gt; one small change in system‚Äôs params lead to a masive change of its behaviour.</p>
<p>read more: ‚ÄúMore is Different - broken symertry and the nature of hierarchical structure of science‚Äù ‚Äì P. W. Anderson ‚Äì (<a href="https://inters.org/files/more-is-different.pdf">link</a>).</p>
</section>
<section id="aims-of-mathematical-physics" class="level1">
<h1>Aims of Mathematical Physics</h1>
<ul>
<li>dev new math tools, allowing deduction of ‚Ä¶</li>
<li>improve understanding of physical systems, d∆∞·ªõi nhi·ªÅu g√≥c nh√¨n h∆°n.</li>
</ul>
<p>eg: <strong>fruitful interaction</strong>, To√°n l√† n·ªÅn t·∫£ng, L√Ω th·ªÉ hi·ªán c√°c c√¢u h·ªèi m·ªôt c√°ch t·ª± nhi√™n ƒë·ªÉ mang l·∫°i s·ª± ph√°t tri·ªÉn cho s·ª± kh√°m ph√° To√°n h·ªçc.</p>
</section>
<section id="stability-of-atoms" class="level1">
<h1>Stability of Atoms</h1>
<p>T·∫°i sao electron kh√¥ng spiral v√†o nguy√™n t·ª≠, gi·∫£i ph√≥ng m·ªôt nƒÉng l∆∞·ª£ng v√¥ h·∫°n.</p>
<ul>
<li>Heisenberg uncertainty principle</li>
<li>In math, non-commutativity implies‚Ä¶</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-08-08-note-muln/stability_of_atoms.png" class="img-fluid figure-img"></p>
<figcaption>stability of atoms</figcaption>
</figure>
</div>
<p>? electromagtic radiation</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
electromagtic radiation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>B·ª©c x·∫° ƒëi·ªán t·ª´ l√† m·ªôt d·∫°ng nƒÉng l∆∞·ª£ng truy·ªÅn ƒëi d∆∞·ªõi d·∫°ng s√≥ng ƒëi·ªán t·ª´. S√≥ng ƒëi·ªán t·ª´ n√†y bao g·ªìm c·∫£ tr∆∞·ªùng ƒëi·ªán t·ª´ v√† tr∆∞·ªùng t·ª´ tr∆∞·ªùng dao ƒë·ªông vu√¥ng g√≥c v·ªõi nhau v√† vu√¥ng g√≥c v·ªõi ph∆∞∆°ng truy·ªÅn s√≥ng.</p>
<p><strong>ƒê·∫∑c ƒëi·ªÉm ch√≠nh c·ªßa b·ª©c x·∫° ƒëi·ªán t·ª´:</strong></p>
<ul>
<li>T·ªëc ƒë·ªô: T·∫•t c·∫£ c√°c s√≥ng ƒëi·ªán t·ª´ ƒë·ªÅu truy·ªÅn ƒëi v·ªõi t·ªëc ƒë·ªô √°nh s√°ng trong ch√¢n kh√¥ng (kho·∫£ng 3 x 10^8 m/s).</li>
<li>T·∫ßn s·ªë v√† b∆∞·ªõc s√≥ng: C√°c s√≥ng ƒëi·ªán t·ª´ kh√°c nhau b·ªüi t·∫ßn s·ªë (s·ªë l·∫ßn dao ƒë·ªông trong m·ªôt gi√¢y) v√† b∆∞·ªõc s√≥ng (kho·∫£ng c√°ch gi·ªØa hai ƒë·ªânh s√≥ng li√™n ti·∫øp).</li>
<li>Ph·ªï ƒëi·ªán t·ª´: Ph·ªï ƒëi·ªán t·ª´ l√† m·ªôt d·∫£i li√™n t·ª•c c√°c lo·∫°i b·ª©c x·∫° ƒëi·ªán t·ª´, t·ª´ s√≥ng v√¥ tuy·∫øn c√≥ b∆∞·ªõc s√≥ng d√†i ƒë·∫øn tia gamma c√≥ b∆∞·ªõc s√≥ng ng·∫Øn.</li>
<li>T√≠nh ch·∫•t s√≥ng-h·∫°t l∆∞·ª°ng t√≠nh: B·ª©c x·∫° ƒëi·ªán t·ª´ th·ªÉ hi·ªán c·∫£ t√≠nh ch·∫•t s√≥ng (giao thoa, nhi·ªÖu x·∫°) v√† t√≠nh ch·∫•t h·∫°t (hi·ªáu ·ª©ng quang ƒëi·ªán).</li>
</ul>
<p><strong>C√°c lo·∫°i b·ª©c x·∫° ƒëi·ªán t·ª´ ph·ªï bi·∫øn:</strong></p>
<ul>
<li>S√≥ng v√¥ tuy·∫øn: S·ª≠ d·ª•ng trong truy·ªÅn th√¥ng, radio, truy·ªÅn h√¨nh.</li>
<li>Vi s√≥ng: S·ª≠ d·ª•ng trong l√≤ vi s√≥ng, radar.</li>
<li>Tia h·ªìng ngo·∫°i: T·∫°o ra nhi·ªát, ƒë∆∞·ª£c s·ª≠ d·ª•ng trong ƒëi·ªÅu khi·ªÉn t·ª´ xa, thi·∫øt b·ªã nh√¨n ƒë√™m.</li>
<li>√Ånh s√°ng kh·∫£ ki·∫øn: √Ånh s√°ng m√† m·∫Øt ng∆∞·ªùi c√≥ th·ªÉ nh√¨n th·∫•y.</li>
<li>Tia t·ª≠ ngo·∫°i: S·ª≠ d·ª•ng trong kh·ª≠ tr√πng, s·∫£n xu·∫•t vitamin D.</li>
<li>Tia X: S·ª≠ d·ª•ng trong y t·∫ø ƒë·ªÉ ch·ª•p X-quang.</li>
<li>Tia gamma: C√≥ nƒÉng l∆∞·ª£ng r·∫•t cao, ƒë∆∞·ª£c s·ª≠ d·ª•ng trong ƒëi·ªÅu tr·ªã ung th∆∞.</li>
</ul>
<p><strong>·ª®ng d·ª•ng c·ªßa b·ª©c x·∫° ƒëi·ªán t·ª´:</strong> B·ª©c x·∫° ƒëi·ªán t·ª´ c√≥ r·∫•t nhi·ªÅu ·ª©ng d·ª•ng trong cu·ªôc s·ªëng h√†ng ng√†y v√† trong c√°c lƒ©nh v·ª±c khoa h·ªçc, c√¥ng ngh·ªá. V√≠ d·ª•:</p>
<ul>
<li>Truy·ªÅn th√¥ng: ƒêi·ªán tho·∫°i, truy·ªÅn h√¨nh, internet.</li>
<li>Y t·∫ø: Ch·ª•p X-quang, ƒëi·ªÅu tr·ªã ung th∆∞.</li>
<li>C√¥ng nghi·ªáp: H√†n, c·∫Øt kim lo·∫°i.</li>
<li>Qu√¢n s·ª±: Radar, s√≥ng √¢m.</li>
</ul>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
T√≠nh Kh√¥ng Giao Ho√°n (Non-Commutativity) trong To√°n h·ªçc
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>T√≠nh kh√¥ng giao ho√°n l√† m·ªôt kh√°i ni·ªám quan tr·ªçng trong to√°n h·ªçc, ƒë·∫∑c bi·ªát trong ƒë·∫°i s·ªë tr·ª´u t∆∞·ª£ng. N√≥ m√¥ t·∫£ m·ªôt t√≠nh ch·∫•t c·ªßa c√°c ph√©p to√°n, khi m√† vi·ªác ƒë·ªïi ch·ªó c√°c ƒë·ªëi t∆∞·ª£ng trong ph√©p to√°n ƒë√≥ l·∫°i cho k·∫øt qu·∫£ kh√°c nhau.</p>
<p><strong>V√≠ d·ª• minh h·ªça:</strong></p>
<ul>
<li>Ph√©p nh√¢n s·ªë: Ph√©p nh√¢n s·ªë l√† m·ªôt ph√©p to√°n giao ho√°n. V√≠ d·ª•: <code>2 x 3 = 3 x 2</code>.</li>
<li>Ph√©p tr·ª´ s·ªë: Ph√©p tr·ª´ s·ªë kh√¥ng ph·∫£i l√† ph√©p to√°n giao ho√°n. V√≠ d·ª•: <code>5 - 3 ‚â† 3 - 5</code>.</li>
<li>Ph√©p nh√¢n ma tr·∫≠n: Ph√©p nh√¢n ma tr·∫≠n n√≥i chung kh√¥ng giao ho√°n. T·ª©c l√†, n·∫øu A v√† B l√† hai ma tr·∫≠n, th√¨ th∆∞·ªùng <code>AB ‚â† BA</code>.</li>
</ul>
<p><strong>·ª®ng d·ª•ng c·ªßa t√≠nh kh√¥ng giao ho√°n:</strong></p>
<ul>
<li>ƒê·∫°i s·ªë tr·ª´u t∆∞·ª£ng: T√≠nh kh√¥ng giao ho√°n xu·∫•t hi·ªán trong nhi·ªÅu c·∫•u tr√∫c ƒë·∫°i s·ªë nh∆∞ nh√≥m, v√†nh, tr∆∞·ªùng.</li>
<li>V·∫≠t l√Ω l∆∞·ª£ng t·ª≠: Trong c∆° h·ªçc l∆∞·ª£ng t·ª≠, c√°c to√°n t·ª≠ ƒë·∫°i di·ªán cho c√°c ƒë·∫°i l∆∞·ª£ng v·∫≠t l√Ω th∆∞·ªùng kh√¥ng giao ho√°n. ƒêi·ªÅu n√†y d·∫´n ƒë·∫øn nguy√™n l√Ω b·∫•t ƒë·ªãnh Heisenberg, m·ªôt trong nh·ªØng nguy√™n l√Ω c∆° b·∫£n c·ªßa v·∫≠t l√Ω l∆∞·ª£ng t·ª≠.</li>
<li>Khoa h·ªçc m√°y t√≠nh: T√≠nh kh√¥ng giao ho√°n xu·∫•t hi·ªán trong c√°c c·∫•u tr√∫c d·ªØ li·ªáu nh∆∞ h√†ng ƒë·ª£i, ngƒÉn x·∫øp, v√† trong c√°c ng√¥n ng·ªØ l·∫≠p tr√¨nh.</li>
</ul>
<p><strong>√ù nghƒ©a c·ªßa t√≠nh kh√¥ng giao ho√°n:</strong></p>
<ul>
<li>Th·ª© t·ª± quan tr·ªçng: Khi th·ª±c hi·ªán c√°c ph√©p to√°n kh√¥ng giao ho√°n, th·ª© t·ª± c√°c ƒë·ªëi t∆∞·ª£ng ƒë√≥ng vai tr√≤ quy·∫øt ƒë·ªãnh trong vi·ªác x√°c ƒë·ªãnh k·∫øt qu·∫£.</li>
<li>M√¥ h√¨nh h√≥a c√°c h·ªá th·ªëng ph·ª©c t·∫°p: T√≠nh kh√¥ng giao ho√°n cho ph√©p m√¥ h√¨nh h√≥a c√°c h·ªá th·ªëng ph·ª©c t·∫°p trong ƒë√≥ c√°c y·∫øu t·ªë t∆∞∆°ng t√°c v·ªõi nhau theo m·ªôt c√°ch kh√¥ng ƒë·ªëi x·ª©ng.</li>
</ul>
<p>V√≠ d·ª• c·ª• th·ªÉ trong v·∫≠t l√Ω l∆∞·ª£ng t·ª≠:</p>
<p>Trong c∆° h·ªçc l∆∞·ª£ng t·ª≠, v·ªã tr√≠ (x) v√† ƒë·ªông l∆∞·ª£ng (p) c·ªßa m·ªôt h·∫°t l√† hai ƒë·∫°i l∆∞·ª£ng v·∫≠t l√Ω kh√¥ng giao ho√°n. Quan h·ªá kh√¥ng giao ho√°n n√†y ƒë∆∞·ª£c bi·ªÉu di·ªÖn b·ªüi c√¥ng th·ª©c:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Bx,%20p%5D%20=%20xp%20-%20px%20=%20i%C4%A7"></p>
<p>Trong ƒë√≥:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?x"> l√† to√°n t·ª≠ v·ªã tr√≠</li>
<li><img src="https://latex.codecogs.com/png.latex?p"> l√† to√°n t·ª≠ ƒë·ªông l∆∞·ª£ng</li>
<li><img src="https://latex.codecogs.com/png.latex?%C4%A7"> l√† h·∫±ng s·ªë Planck r√∫t g·ªçn</li>
<li><img src="https://latex.codecogs.com/png.latex?i"> l√† ƒë∆°n v·ªã ·∫£o</li>
</ul>
<p>C√¥ng th·ª©c tr√™n cho th·∫•y, vi·ªác ƒëo v·ªã tr√≠ v√† ƒë·ªông l∆∞·ª£ng c·ªßa m·ªôt h·∫°t c√πng m·ªôt l√∫c s·∫Ω c√≥ ƒë·ªô ch√≠nh x√°c b·ªã gi·ªõi h·∫°n. ƒê√¢y ch√≠nh l√† n·ªôi dung c·ªßa nguy√™n l√Ω b·∫•t ƒë·ªãnh Heisenberg.</p>
<p><strong>T√≥m l·∫°i</strong>, t√≠nh kh√¥ng giao ho√°n l√† m·ªôt kh√°i ni·ªám quan tr·ªçng trong to√°n h·ªçc v√† v·∫≠t l√Ω, gi√∫p ch√∫ng ta hi·ªÉu r√µ h∆°n v·ªÅ s·ª± t∆∞∆°ng t√°c gi·ªØa c√°c ƒë·ªëi t∆∞·ª£ng v√† c√°c h·ªá th·ªëng ph·ª©c t·∫°p.</p>
</div>
</div>
</div>
</section>
<section id="stability-of-matter" class="level1">
<h1>Stability of Matter</h1>
<p>n·∫øu nguy√™n t·ª≠ l√† ·ªïn ƒë·ªãnh, ƒëi·ªÅu g√¨ x·∫£y ra n·∫øu ch√∫ng ta assemble ch√∫ng l·∫°i v·ªõi nhau, nh∆∞ 10^30 nguy√™n t·ª≠ trong 1 vi√™n g·∫°ch. vi·ªác 1 vi√™n g·∫°ch t·∫°i sao l·ªõn nh∆∞ v·∫≠y, ch·ª© kh√¥ng th·ªÉ ƒë·∫∑c h∆°n, kh√≥ c√≥ th·ªÉ coi l√† hi·ªÉn nhi√™n, v√† uncertainty principle ko th·ªÉ t·ª± m√¨nh gi·∫£i th√≠ch.</p>
<p>extensitivity: electrons l√† fermions, th·ªèa Pauli exclusion principle.</p>
<p>why a brick is a brick?</p>
<p>book recommendation: ‚ÄúStability of Matter in Quantum Mechanics‚Äù</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Fermions and Bosons
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>These are two fundamental types of particles in physics. They differ in their quantum properties.</p>
<ul>
<li><strong>Fermions</strong>: These particles obey the Pauli Exclusion Principle, which means that no two identical fermions can occupy the same quantum state simultaneously. Examples of fermions include electrons, protons, and neutrons. &nbsp;</li>
<li><strong>Bosons</strong>: Unlike fermions, multiple bosons can occupy the same quantum state. This property is essential for phenomena like superconductivity and laser light. Examples of bosons include photons (particles of light) and the Higgs boson.</li>
</ul>
</div>
</div>
</div>
</section>
<section id="gravitational-in-stability-of-stars" class="level1">
<h1>Gravitational (In) Stability of Stars</h1>
<p>scale up to Stars, where the gravitation becomes a major factor -&gt; can be taken in to account.</p>
<p>Chandrasekhar limit - for the maximun mass of stable white dwarf (amounts roughly 1.4 solar masses)</p>
<p>Schrodinger equation can be applied to a huge range of scalces, from atoms to stars!</p>
</section>
<section id="phase-transitions" class="level1">
<h1>Phase Transitions</h1>
<p>ph∆∞∆°ng tr√¨nh c∆° b·∫£n c√≥ d·∫°ng ƒë∆°n gi·∫£n, nh∆∞ng l·ªùi gi·∫£i c√≥ th·ªÉ ·ªü r·∫•t nhi·ªÅu d·∫°ng do c√≥ r·∫•t nhi·ªÅu bi·∫øn v√† tham s·ªë.</p>
<p>v√≠ d·ª• nh∆∞ n∆∞·ªõc, c√≥ th·ªÉ kh√≠, l·ªèng v√† r·∫Øn - phase transitions.</p>
</section>
<section id="more-phase-transitions" class="level1">
<h1>More Phase Transitions</h1>
<ul>
<li>magnetism;</li>
<li>traffic jams: hociminh city, tiny change can make huge effect?;</li>
<li>superfluidity (si√™u ch·∫£y, m·ªôt tr·∫°ng th√°i ‚Äúk·ª≥ l·∫°‚Äù - exotic c·ªßa v·∫≠t ch·∫•t);</li>
<li>superconductivity (si√™u d·∫´n).</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
superfluidity
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol type="1">
<li><p><strong>ƒê·ªãnh nghƒ©a si√™u ch·∫£y</strong>: Si√™u ch·∫£y l√† tr·∫°ng th√°i c·ªßa v·∫≠t ch·∫•t, trong ƒë√≥ ch·∫•t l·ªèng c√≥ ƒë·ªô nh·ªõt b·∫±ng kh√¥ng v√† ch·∫£y m√† kh√¥ng c√≥ ma s√°t. ƒêi·ªÅu n√†y x·∫£y ra ·ªü nhi·ªát ƒë·ªô c·ª±c th·∫•p, g·∫ßn b·∫±ng kh√¥ng tuy·ªát ƒë·ªëi.</p></li>
<li><p><strong>ƒê·∫∑c ƒëi·ªÉm ch√≠nh</strong>:</p></li>
</ol>
<ul>
<li>Kh√¥ng c√≥ ma s√°t n·ªôi: Ch·∫•t l·ªèng si√™u ch·∫£y c√≥ th·ªÉ ch·∫£y m√† kh√¥ng m·∫•t nƒÉng l∆∞·ª£ng.</li>
<li>Hi·ªáu ·ª©ng phun tia: C√≥ th·ªÉ leo l√™n th√†nh b√¨nh ch·ª©a.</li>
<li>D·∫´n nhi·ªát v√¥ h·∫°n: Truy·ªÅn nhi·ªát c·ª±c k·ª≥ hi·ªáu qu·∫£.</li>
<li>Xo√°y l∆∞·ª£ng t·ª≠: T·∫°o ra c√°c xo√°y v·ªõi ƒë·ªông l∆∞·ª£ng g√≥c l∆∞·ª£ng t·ª≠ h√≥a.</li>
</ul>
<ol start="3" type="1">
<li><strong>V√≠ d·ª• v·ªÅ ch·∫•t si√™u ch·∫£y</strong>:</li>
</ol>
<ul>
<li>Helium-4 l·ªèng d∆∞·ªõi 2.17 K (ƒëi·ªÉm lambda).</li>
<li>Helium-3 l·ªèng d∆∞·ªõi kho·∫£ng 0.0025 K.</li>
</ul>
<p><strong>T·∫°i sao g·ªçi l√† ‚Äúexotic‚Äù (k·ª≥ l·∫°):</strong></p>
<ol type="a">
<li><strong>Hi·∫øm g·∫∑p trong t·ª± nhi√™n</strong>:</li>
</ol>
<ul>
<li>Ch·ªâ xu·∫•t hi·ªán ·ªü nhi·ªát ƒë·ªô c·ª±c th·∫•p, hi·∫øm khi g·∫∑p trong ƒëi·ªÅu ki·ªán t·ª± nhi√™n.</li>
</ul>
<ol start="2" type="a">
<li><strong>Vi ph·∫°m tr·ª±c gi√°c th√¥ng th∆∞·ªùng</strong>:</li>
</ol>
<ul>
<li>Ch·∫£y m√† kh√¥ng c√≥ ma s√°t, tr√°i ng∆∞·ª£c v·ªõi h·∫ßu h·∫øt c√°c ch·∫•t l·ªèng th√¥ng th∆∞·ªùng.</li>
<li>C√≥ th·ªÉ ‚Äúleo‚Äù ra kh·ªèi b√¨nh ch·ª©a, d∆∞·ªùng nh∆∞ vi ph·∫°m tr·ªçng l·ª±c.</li>
</ul>
<ol start="3" type="a">
<li><strong>H√†nh vi l∆∞·ª£ng t·ª≠ vƒ© m√¥</strong>:</li>
</ol>
<ul>
<li>Hi·ªÉn th·ªã c√°c hi·ªáu ·ª©ng l∆∞·ª£ng t·ª≠ ·ªü quy m√¥ c√≥ th·ªÉ quan s√°t ƒë∆∞·ª£c.</li>
<li>Th·ªÉ hi·ªán t√≠nh ch·∫•t s√≥ng-h·∫°t c·ªßa v·∫≠t ch·∫•t ·ªü m·ª©c ƒë·ªô l·ªõn.</li>
</ul>
<ol start="4" type="a">
<li><strong>Li√™n quan ƒë·∫øn v·∫≠t l√Ω c∆° b·∫£n</strong>:</li>
</ol>
<ul>
<li>Nghi√™n c·ª©u si√™u ch·∫£y gi√∫p hi·ªÉu s√¢u h∆°n v·ªÅ c∆° h·ªçc l∆∞·ª£ng t·ª≠ v√† v·∫≠t l√Ω tr·∫°ng th√°i ng∆∞ng t·ª•.</li>
</ul>
<ol start="5" type="a">
<li><strong>·ª®ng d·ª•ng ti·ªÅm nƒÉng ƒë·ªôc ƒë√°o</strong>:</li>
</ol>
<ul>
<li>C√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng trong c√°c thi·∫øt b·ªã l√†m l·∫°nh si√™u d·∫´n v√† c√°c ·ª©ng d·ª•ng c√¥ng ngh·ªá cao kh√°c.</li>
</ul>
<p>T√≥m l·∫°i, si√™u ch·∫£y ƒë∆∞·ª£c coi l√† ‚Äúexotic‚Äù v√¨ n√≥ th·ªÉ hi·ªán c√°c t√≠nh ch·∫•t k·ª≥ l·∫°, hi·∫øm g·∫∑p v√† vi ph·∫°m tr·ª±c gi√°c th√¥ng th∆∞·ªùng v·ªÅ c√°ch ch·∫•t l·ªèng ho·∫°t ƒë·ªông. N√≥ l√† m·ªôt v√≠ d·ª• v·ªÅ c√°ch c√°c hi·ªáu ·ª©ng l∆∞·ª£ng t·ª≠ c√≥ th·ªÉ bi·ªÉu hi·ªán ·ªü quy m√¥ vƒ© m√¥, l√†m cho n√≥ tr·ªü th√†nh m·ªôt ch·ªß ƒë·ªÅ th√∫ v·ªã v√† quan tr·ªçng trong v·∫≠t l√Ω hi·ªán ƒë·∫°i.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
superconductivity
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol type="1">
<li><p><strong>ƒê·ªãnh nghƒ©a</strong>: Si√™u d·∫´n l√† tr·∫°ng th√°i c·ªßa v·∫≠t ch·∫•t trong ƒë√≥ ƒëi·ªán tr·ªü su·∫•t c·ªßa v·∫≠t li·ªáu gi·∫£m xu·ªëng b·∫±ng kh√¥ng v√† t·ª´ tr∆∞·ªùng b·ªã ƒë·∫©y ra kh·ªèi v·∫≠t li·ªáu (hi·ªáu ·ª©ng Meissner) khi nhi·ªát ƒë·ªô gi·∫£m xu·ªëng d∆∞·ªõi m·ªôt nhi·ªát ƒë·ªô t·ªõi h·∫°n nh·∫•t ƒë·ªãnh.</p></li>
<li><p>ƒê·∫∑c ƒëi·ªÉm ch√≠nh:</p></li>
</ol>
<ol type="a">
<li><p><strong>ƒêi·ªán tr·ªü b·∫±ng kh√¥ng</strong>: D√≤ng ƒëi·ªán c√≥ th·ªÉ ch·∫£y m√† kh√¥ng m·∫•t nƒÉng l∆∞·ª£ng.</p></li>
<li><p><strong>Hi·ªáu ·ª©ng Meissner</strong>: T·ª´ tr∆∞·ªùng b·ªã ƒë·∫©y ra kh·ªèi v·∫≠t li·ªáu si√™u d·∫´n.</p></li>
<li><p><strong>Nhi·ªát ƒë·ªô t·ªõi h·∫°n (Tc)</strong>: Nhi·ªát ƒë·ªô m√† d∆∞·ªõi ƒë√≥ v·∫≠t li·ªáu tr·ªü th√†nh si√™u d·∫´n.</p></li>
</ol>
<ol start="3" type="1">
<li><strong>Lo·∫°i si√™u d·∫´n</strong>:</li>
</ol>
<ol type="a">
<li><p>Si√™u d·∫´n lo·∫°i I: Th∆∞·ªùng l√† kim lo·∫°i nguy√™n ch·∫•t, chuy·ªÉn ƒë·ªôt ng·ªôt sang tr·∫°ng th√°i si√™u d·∫´n.</p></li>
<li><p>Si√™u d·∫´n lo·∫°i II: Th∆∞·ªùng l√† h·ª£p kim ho·∫∑c h·ª£p ch·∫•t ph·ª©c t·∫°p, c√≥ hai nhi·ªát ƒë·ªô t·ªõi h·∫°n v√† c√≥ th·ªÉ duy tr√¨ tr·∫°ng th√°i si√™u d·∫´n trong t·ª´ tr∆∞·ªùng m·∫°nh h∆°n.</p></li>
</ol>
<ol start="4" type="1">
<li><strong>C∆° ch·∫ø</strong>:</li>
</ol>
<ul>
<li>L√Ω thuy·∫øt BCS (Bardeen-Cooper-Schrieffer): Gi·∫£i th√≠ch si√™u d·∫´n th√¥ng qua s·ª± h√¨nh th√†nh c√°c c·∫∑p Cooper (electron gh√©p ƒë√¥i).</li>
<li>Si√™u d·∫´n nhi·ªát ƒë·ªô cao: C∆° ch·∫ø ch∆∞a ƒë∆∞·ª£c hi·ªÉu ƒë·∫ßy ƒë·ªß, l√† m·ªôt lƒ©nh v·ª±c nghi√™n c·ª©u ƒëang ph√°t tri·ªÉn.</li>
</ul>
<ol start="5" type="1">
<li><strong>·ª®ng d·ª•ng</strong>:</li>
</ol>
<ul>
<li>Nam ch√¢m si√™u d·∫´n m·∫°nh cho MRI v√† m√°y gia t·ªëc h·∫°t.</li>
<li>M√°y d√≤ SQUID (Superconducting Quantum Interference Device) ƒë·ªÉ ƒëo t·ª´ tr∆∞·ªùng c·ª±c nh·ªè.</li>
<li>Ti·ªÅm nƒÉng trong m√°y t√≠nh l∆∞·ª£ng t·ª≠ v√† truy·ªÅn t·∫£i ƒëi·ªán kh√¥ng t·ªïn th·∫•t.</li>
</ul>
<ol start="6" type="1">
<li><strong>Th√°ch th·ª©c</strong>:</li>
</ol>
<ul>
<li>T√¨m ki·∫øm v·∫≠t li·ªáu si√™u d·∫´n ·ªü nhi·ªát ƒë·ªô cao h∆°n, l√Ω t∆∞·ªüng l√† ·ªü nhi·ªát ƒë·ªô ph√≤ng.</li>
<li>Hi·ªÉu r√µ h∆°n v·ªÅ c∆° ch·∫ø c·ªßa si√™u d·∫´n nhi·ªát ƒë·ªô cao.</li>
</ul>
<ol start="7" type="1">
<li><strong>L·ªãch s·ª≠ v√† ph√°t tri·ªÉn</strong>:</li>
</ol>
<ul>
<li>Ph√°t hi·ªán nƒÉm 1911 b·ªüi Heike Kamerlingh Onnes trong th·ªßy ng√¢n ·ªü 4.2K.</li>
<li>L√Ω thuy·∫øt BCS ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t nƒÉm 1957.</li>
<li>Si√™u d·∫´n nhi·ªát ƒë·ªô cao ƒë∆∞·ª£c ph√°t hi·ªán nƒÉm 1986 b·ªüi Bednorz v√† M√ºller.</li>
</ul>
<p>Si√™u d·∫´n l√† m·ªôt lƒ©nh v·ª±c nghi√™n c·ª©u ƒëang ph√°t tri·ªÉn m·∫°nh m·∫Ω trong v·∫≠t l√Ω hi·ªán ƒë·∫°i, v·ªõi ti·ªÅm nƒÉng ·ª©ng d·ª•ng r·ªông r√£i trong c√¥ng ngh·ªá v√† k·ªπ thu·∫≠t.</p>
</div>
</div>
</div>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<ul>
<li>to√°n kh√¥ng ph·∫£i l√† ng√¥n ng·ªØ v≈© tr·ª•, nh∆∞ng r·∫•t m·∫°nh m·∫Ω ƒë·ªÉ gi·∫£i th√≠ch t·ª± nhi√™n;</li>
<li>c√°c lu·∫≠t v·∫≠t l√Ω c∆° b·∫£n ƒë∆∞·ª£c di·ªÖn gi·∫£i b·∫±ng ng√¥n ng·ªØ to√°n, r·∫•t th√∫ v√≠ l√† nhi·ªÅu ƒë·ªãnh lu·∫≠t v·∫≠t l√Ω c∆° b·∫£n l·∫°i gi·∫£i th√≠ch ƒë∆∞·ª£c r·∫•t nhi·ªÅu hi·ªán t∆∞·ª£ng kh√°c nhau, nh∆∞ chuy·ªÉn th·ªÉ;</li>
<li>vi·ªác hi·ªÉu c√°c ƒë·ªãnh lu·∫≠t v·∫≠t l√Ω t·∫°o ra c√°c ti·∫øn b·ªô c√¥ng ngh·ªá;</li>
<li>m·ª•c ti√™u c·ªßa to√°n v·∫≠t l√Ω l√† ph√°t tri·ªÉn c√°c c√¥ng c·ª• to√°n ƒë·ªÉ hi·ªÉu c√°c h·ªá qu·∫£ c·ªßa c√°c ƒë·ªãnh lu·∫≠t v·∫≠t l√Ω c∆° b·∫£n v√† khai ph√° c√°c c∆° ch·∫ø c≈©ng nh∆∞ nguy√™n l√Ω ƒë·∫±ng sau c√°c hi·ªán t∆∞·ª£ng quan s√°t ƒë∆∞·ª£c;</li>
<li>m·ªôt trong c√°c th√†nh t·ª±u c·ªßa to√°n v·∫≠t l√Ω ch√≠nh l√† nghi√™n c·ª©u v·ªÅ t√≠nh ·ªïn ƒë·ªãnh c·ªßa v·∫≠t ch·∫•t.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-08-08-note-muln/summary.png" class="img-fluid figure-img"></p>
<figcaption>summary</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="qa-and-outro" class="level1">
<h1>q&amp;a and outro</h1>
<ol type="1">
<li>hamiltonian mechanics;</li>
<li>non-commutativity;</li>
<li>fermions, fundamental particle, bosons, 4-dimensions space;</li>
<li>schrodinger equation, lagrangian;</li>
<li>phase transitions, is this similar to the butterfly effect (notion of chaos)? eg double pendulum;</li>
<li>when was quantum mechanics been cared;</li>
<li>in classical physics, can predict trajectory; but why in quantum mechanics, we can not. (electron does not have definite position, read more on bell inequalities);</li>
<li>given the particles moving very fast, will they exchange the energy (read more on kinetic energy);</li>
<li>standing wave.</li>
</ol>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-08-08-note-muln/my_brain_is_full.png" class="img-fluid figure-img"></p>
<figcaption>bye bye</figcaption>
</figure>
</div>
</div>
</div>
</div>


<!-- -->

</section>

 ]]></description>
  <category>math</category>
  <guid>https://lktuan.github.io/blog/2024-08-08-note-muln/</guid>
  <pubDate>Wed, 07 Aug 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-08-08-note-muln/rs_portrait.png" medium="image" type="image/png" height="101" width="144"/>
</item>
<item>
  <title>M·ªôt s·ªë khu√¥n m·∫´u t∆∞ duy trong Brazilian Jiu-jitsu</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-08-06-bjj-mental-models/</link>
  <description><![CDATA[ 





<p><strong>l∆∞·ª£c d·ªãch</strong> v√†/ho·∫∑c <strong>t√≥m t·∫Øt</strong> cho kh√≥a h·ªçc c≈©ng ‚ÄúMechanic Models of BJJ: A Crash Course‚Äù c·ªßa Steve Kwan.</p>
<section id="theory-of-alignment" class="level1">
<h1>1. <a href="https://www.bjjmentalmodels.com/theory-of-alignment/">theory of alignment</a></h1>
<p>l√† l√Ω thuy·∫øt t·ªëi cao c·ªßa Jiu-jitsu, bao g·ªìm ba y·∫øu t·ªë:</p>
<ol type="1">
<li><strong>posture</strong> - t∆∞ th·∫ø: position m·ªôt c√°ch hi·ªáu qu·∫£ c·ªï (neck) v√† c·ªôt s·ªëng (spine);</li>
<li><strong>structure</strong> - c·∫•u tr√∫c: position m·ªôt c√°ch hi·ªáu qu·∫£ tay (arms) v√† ch√¢n (legs);</li>
<li><strong>base</strong> - c·ªü s·ªü: kh·∫£ nƒÉng h·∫•p th·ª• (absorb) ho·∫∑c t·∫°o ra l·ª±c li√™n quan ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c m·ª•c ti√™u.</li>
</ol>
<p>ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c alignment hi·ªáu qu·∫£, lu√¥n ghi nh·ªõ hai m·ª•c ti√™u sau:</p>
<ol type="1">
<li>maintain your alignment;</li>
<li>break your opponent‚Äôs alignment;</li>
<li>do not proceed 2. if you are failing at 1.</li>
</ol>
<p>trong ƒë√†o t·∫°o, v·ªõi tr·ªçng s·ªë c·ªßa ba y·∫øu t·ªë nh∆∞ nhau, c√≥ th·ªÉ ‚Äúch·∫•m ƒëi·ªÉm‚Äù (alignment scorecard) v·ªõi thang t·ª´ 0-3 cho m·ªói ng∆∞·ªùi ch∆°i. ƒëi·ªÉm c√†ng cao h∆°n s·∫Ω l√† d·∫•u hi·ªáu cho vi·ªác b·∫°n c√≥ m·ªôt c∆° h·ªôi t·ªët ƒë·ªÉ ph√° v·ª° alignment c·ªßa ƒë·ªëi th·ªß. v√≠ d·ª•, trong closed guard, b·∫°n ·ªü d∆∞·ªõi, v√† kh√¥ng ai ƒëang kh·ªëng ch·∫ø ƒë·ªëi ph∆∞∆°ng b·∫±ng m·ªôt hand grip:</p>
<p>b·∫°n s·∫Ω c√≥ 3 ƒëi·ªÉm n·∫øu:</p>
<ul>
<li><strong>posture</strong>: c·ªï (neck) v√† c·ªôt s·ªëng (spine) ·ªü v·ªã tr√≠ t·ª± nhi√™n, th·∫≥ng, kh√¥ng b·ªã ki·ªÉm so√°t. h√¥ng (hip) ƒë∆∞·ª£c t·ª± do di chuy·ªÉn;</li>
<li><strong>structure</strong>: tay (hands) v√† ch√¢n (legs) t·ª± do t·∫°o ra c√°c grips v√† khung - frames;</li>
<li><strong>base</strong>: b·∫°n c√≥ th·ªÉ t·∫°o (gen) ho·∫∑c h·∫•p th·ª• l·ª±c (absorb) nh·ªù vai v√† v·ªã tr√≠ ƒë·∫∑t ch√¢n.</li>
</ul>
<p>ƒë·ªëi th·ªß s·∫Ω c√≥ 3 ƒëi·ªÉm n·∫øu, t∆∞∆°ng ·ª©ng:</p>
<ul>
<li>c·ªï v√† c·ªôt s·ªëng th·∫≥ng, n·∫±m ch√≠nh di·ªán (vertical, centre) gi·ªØa c∆° th·ªÉ b·∫°n;</li>
<li>tay c·ªßa h·ªç kh√¥ng b·ªã ki·ªÉm so√°t m·ªôt c√°ch ch·ªß ƒë·ªông;</li>
<li>h·ªç c√≥ th·ªÉ ch·ªëng l·∫°i l·ª±c t·ª´ b·∫°n v·ªõi c·ªôt s·ªëng th·∫≥ng, vai m·ªü. h·ªç c√≥ kh·∫£ nƒÉng break guard khi ng·ªìi - d√πng tay, ho·∫∑c ƒë·ª©ng l√™n.</li>
</ul>
<p>c·∫£ hai ƒë·ªÅu kh√¥ng c√≥ l·ª£i th·∫ø ƒë√°ng k·ªÉ v√† n·ªó l·ª±c submission s·∫Ω d·∫´n ƒë·∫øn escape ho·∫∑c reversal.</p>
</section>
<section id="core-mechanics" class="level1 page-columns page-full">
<h1>2. <a href="https://www.bjjmentalmodels.com/core-mechanics/">core mechanics</a></h1>
<p>n·∫øu ti·∫øp c·∫≠n BJJ theo technique approach, s·∫Ω c√≥ r·∫•t nhi·ªÅu k·ªπ thu·∫≠t c≈©ng c√°c bi·∫øn th·ªÉ (variations) m√† b·∫°n kh√¥ng th·ªÉ khi nh·ªõ h·∫øt. <em>may m·∫Øn l√†</em>, c√°c k·ªπ thu·∫≠t c·ªßa BJJ ƒë·ªÅu l√† s·ª± k·∫øt h·ª£p c·ªßa 6 c∆° ch·∫ø c·ªët l√µi (core mechanics) sau ƒë√¢y:</p>
<ol type="1">
<li><strong>frame (khung)</strong>:</li>
</ol>
<ul>
<li>l√† concept ph√≤ng th·ªß quan tr·ªçng nh·∫•t trong BJJ, n√≥ t·∫°o ra m·ªôt khung b·∫£o v·ªá (shield) s·ª≠ d·ª•ng nh·ªØng ph·∫ßn c∆° th·ªÉ c·ª©ng (hard) ho·∫∑c nhi·ªÅu x∆∞∆°ng (bony), th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng cho ng∆∞·ªùi ·ªü v·ªã tr√≠ d∆∞·ªõi (bottom);</li>
<li>frame kh√¥ng ph·ª• thu·ªôc v√†o c∆° b·∫Øp, m√† l√† s·ª± cƒÉn ch·ªânh h·ªá x∆∞∆°ng. b·∫°n kh√¥ng mu·ªën d√πng √°p l·ª±c ƒë·∫©y ƒë·ªëi th·ªß ra xa, m√† l√† d√πng c·∫•u tr√∫c x∆∞∆°ng ƒë·ªÉ gi·ªØ ƒë·ªëi th·ªß t·∫°i m·ªôt kho·∫£ng c√°ch nh·∫•t ƒë·ªãnh, t·∫°o kh√¥ng gian ƒë·ªÉ b·∫£n th√¢n di chuy·ªÉn. frame t·ªët th√¨ ph·∫£i ch·∫Øc ch·∫Øn v√† kh√¥ng s·ª≠ d·ª•ng qu√° nhi·ªÅu s·ª©c l·ª±c ;</li>
<li>kh√¥ng n√™n frame v·ªõi c√°c kh·ªõp (joints) d·ªÖ b·ªã ƒë·ªëi ph∆∞∆°ng khai th√°c: v√≠ d·ª• d√πng hai tay ƒë·ªÉ ƒë·∫©y ƒë·ªëi th·ªß, ph·∫ßn c·ªï (wrist) v√† khu·ª∑u tay y·∫øu v√† r·∫•t d·ªÖ b·ªã counter. t∆∞∆°ng t·ª±, khi frame b·∫±ng ch√¢n, b·∫°n n√™n s·ª≠ d·ª•ng g·ªëi (knees) v√† ·ªëng ch√¢n (shins) nh·ªù di·ªán t√≠ch l·ªõn, d√πng b√†n ch√¢n (feet) c√≥ l·ª£i th·∫ø v·ªÅ kho·∫£ng c√°ch t·∫°o ƒë∆∞·ª£c tuy nhi√™n r·∫•t d·ªÖ b·ªã khai th√°c.</li>
</ul>
<div class="no-row-height column-margin column-container"><span class="margin-aside">ƒë·ªçc th√™m v·ªÅ <a href="https://bjjmentalmodels.com/solid-frames/">solid frame</a></span></div><ol start="2" type="1">
<li><strong>levers (ƒë√≤n b·∫©y)</strong>:</li>
</ol>
<ul>
<li>ƒë√≤n b·∫©y l√† ph√©p b·ªôi l·ª±c r·∫•t hi·ªáu qu·∫£ ƒë·ªÉ t·∫°o s∆° h·ªü (openings) v√† t·∫•n c√¥ng v√† ki·ªÉm so√°t ƒë·ªëi th·ªß;</li>
<li>theo th·ª© t·ª± t·ª´ kh·ªèe ƒë·∫øn y·∫øu nh·∫•t, 3 c√¥ng c·ª• ƒë√≤n b·∫©y tr√™n c∆° th·ªÉ b·∫°n ch√≠nh l√† <em>ch√¢n, tay, v√† ƒë·∫ßu</em>; </li>
<li>ƒë·∫ßu (head) th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ break t∆∞ th·∫ø (posture) c·ªßa ƒë·ªëi th·ªß, trong khi tay (arms) v√† ch√¢n (legs) th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ t·∫•n c√¥ng c·∫•u tr√∫c (structure);</li>
<li>m·ªói chi b·∫°n ƒë·ªÅu c√≥ 3 kh·ªõp (joints) ch√≠nh: v·ªõi tay l√† vai (shoulders), khu·ª∑u tay (elbows), c·ªï tay (wrists), v·ªõi ch√¢n l√† h√¥ng (hips), ƒë·∫ßu g·ªëi (knees), v√† c·ªï ch√¢n (ankles);</li>
<li>ƒë·ªÉ ki·ªÉm so√°t t·ªët tay ho·∫∑c ch√¢n ƒë·ªëi ph∆∞∆°ng b·∫°n c·∫ßn ki·ªÉm so√°t ƒë∆∞·ª£c √≠t nh·∫•t 2/3 kh·ªõp; tr√™n tr·ª•c tay, ch√¢n, kh·ªõp t·∫°o ra hi·ªáu ·ª©ng ƒë√≤n b·∫©y t·ªët nh·∫•t l√† kh·ªõp ngo√†i c√πng; </li>
<li>l√∫c b·∫°n t·∫•n c√¥ng, ƒë√≤n b·∫©y cho ph√©p b·∫°n ti·∫øn t·ªõi c√°c v·ªã tr√≠ ki·ªÉm so√°t v√† submission, suy cho c√πng th√¨ trong m·ªçi submission h·ª£p l·ªá, b·∫°n lu√¥n ph·∫£i t·∫≠n d·ª•ng, ki·ªÉm so√°t ƒë∆∞·ª£c √≠t nh·∫•t m·ªôt ƒë√≤n b·∫©y c·ªßa ƒë·ªëi ph∆∞∆°ng; </li>
<li>khi kh√¥ng ai c√≥ ∆∞u th·∫ø, ng∆∞·ªùi ƒë·∫ßu ti√™n ki·ªÉm so√°t ƒë∆∞·ª£c lever c·ªßa ƒë·ªëi ph∆∞∆°ng s·∫Ω ki·ªÉm so√°t tr·∫≠n ƒë·∫•u; </li>
</ul>
<div class="no-row-height column-margin column-container"><span class="margin-aside">ƒë√¢y ch√≠nh l√† <a href="https://www.bjjmentalmodels.com/anatomic-hierarchy/">anatomic hierarchy</a></span><span class="margin-aside">ƒë·ªçc th√™m v·ªÅ <a href="https://bjjmentalmodels.com/3-joint-rule/">3-joint rule</a></span><span class="margin-aside">ƒë·ªçc th√™m v·ªÅ <a href="https://bjjmentalmodels.com/isolate-a-single-target/">isolate a single target</a></span><span class="margin-aside">ƒë·ªçc th√™m v·ªÅ <a href="https://bjjmentalmodels.com/grips-dictate-position/">grips dictate position</a></span></div><ol start="3" type="1">
<li><strong>wedges (n√™m/ch√™m)</strong>:</li>
</ol>
<p>c√≥ hai ki·ªÉu n√™m:</p>
<ul>
<li>n√™m ch·∫∑n (blocking wedges): c·ªë ƒë·ªãnh m·ªôt ph·∫ßn c∆° th·ªÉ ƒë·ªëi th·ªß;</li>
<li>n√™m c·∫°y (prying wedge): gi√∫p m·ªü khung (frame) c·ªßa ƒë·ªëi th·ªß.</li>
</ul>
<p>m·ªôt s·ªë v√≠ d·ª•:</p>
<ul>
<li>cho tay v√†o h√¥ng (hip) c·ªßa ƒë·ªëi ph∆∞∆°ng ƒë·ªÉ pass guard, kh√¥ng cho ƒë·ªëi th·ªß re-guard ch√≠nh l√† v√≠ d·ª• c·ªßa n√™m ch·∫∑n;</li>
<li>ƒë√≤n c·∫Øt g·ªëi ƒë·ªÉ pass guard (knee cut pass), khi b·∫°n c·ªë ƒë∆∞a g·ªëi v√†o m·ªü hai ch√¢n ƒë·ªëi th·ªß, ch√≠nh l√† v√≠ d·ª• c·ªßa n√™m c·∫°y.</li>
</ul>
<p>n√™m v√† ƒë√≤n b·∫©y th∆∞·ªùng ƒëi v·ªõi nhau, b·∫°n c·∫ßn d√πng n√™m ƒë·ªÉ s·ª≠ d·ª•ng ƒë√≤n b·∫©y hi·ªáu qu·∫£ h∆°n: <strong>n√™m m·ªôt ƒë·∫ßu, ƒë√≤n b·∫©y m·ªôt ƒë·∫ßu</strong> gi√∫p c·ªë ƒë·ªãnh t·ªët h∆°n. g·ªìm hai schemes:</p>
<ul>
<li>hai ƒë√°nh m·ªôt: two-on-one (two limbs controlling one lever);</li>
<li>b·ªën ƒë√°nh m·ªôt: four-on-one (four limbs controlling one lever).</li>
</ul>
<ol start="4" type="1">
<li><strong>clamps (k·∫πp)</strong>:</li>
</ol>
<div class="page-columns page-full"><p>k·∫πp th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng khi b·∫°n ƒë√£ kh√≥a (lock) ƒë∆∞·ª£c m·ªôt ph·∫ßn c∆° th·ªÉ c·ªßa ƒë·ªëi th·ªß trong m·ªôt v√≤ng kh√©p k√≠n (<strong>closed circuit</strong>), si·∫øt ch·∫∑t hai tay v√† hai ch√¢n ƒë·ªÉ t·∫°o ra m·ªôt chu·ªói ƒë·ªông l·ª±c h·ªçc. </p><div class="no-row-height column-margin column-container"><span class="margin-aside">xem th√™m <a href="https://bjjmentalmodels.com/kinetic-chains/">kinetic chains</a></span></div></div>
<p>c∆° ch·∫ø ki·ªÉm so√°t n√†y nh∆∞ m·ªôt chi·∫øc neo l√†m ch·∫≠m ƒë·ªëi th·ªß, k·∫øt d√≠nh c∆° th·ªÉ b·∫°n v·ªõi h·ªç.</p>
<ol start="5" type="1">
<li><strong>hooks (m√≥c)</strong>:</li>
</ol>
<div class="page-columns page-full"><p>c√°c m√≥c ƒë∆∞·ª£c t·∫°o ra t·ª´ ph·∫ßn cu·ªëi m·ªói chi (ND: b√†n ch√¢n, b√†n tay). tuy nhi√™n ng∆∞·ªùi ta th∆∞·ªùng ch·ªâ hook v·ªõi ph·∫ßn mu b√†n ch√¢n (instep ~ shoelace area), n√≥ ƒë∆∞·ª£c g·ªçi l√† butterfly hook. m√≥c t·∫°o ra c√°c chuy·ªÉn ƒë·ªông, l·ª±c k√©o t·ª´ v·ªã tr√≠ d∆∞·ªõi, y√™u c·∫ßu b·∫°n ph·∫£i ki·ªÉm so√°t ƒë∆∞·ª£c kh√¥ng gian ph√≠a trong gi·ªØa b·∫°n v√† ƒë·ªëi th·ªß. </p><div class="no-row-height column-margin column-container"><span class="margin-aside">xem th√™m <a href="https://bjjmentalmodels.com/inside-channel-control/">inside channel</a></span></div></div>
<p>hook nh√¨n chung c≈©ng y·∫øu, b·ªüi v√¨ b·∫°n ki·ªÉm so√°t t·ª´ b√™n trong (kh√¥ng ph·∫£i b√™n ngo√†i v√† t·∫°o m·ªôt v√≤ng <strong>kh√©p k√≠n</strong>). n√≥ s·∫Ω b·ªã v√¥ hi·ªáu h√≥a n·∫øu ƒë·ªëi ph∆∞∆°ng lu·ªìn tay tho√°t v·ªã tr√≠ (pummels) ho·∫∑c tho√°t ly, g·ª° kh√≥a (disengages) ~ th∆∞·ªùng th√¨ h·ªç c≈©ng kh√¥ng m·∫•t nhi·ªÅu s·ª©c v√† th·ªùi gian cho chuy·ªán n√†y.</p>
<ol start="6" type="1">
<li><strong>posts (tr·ª•)</strong>:</li>
</ol>
<p>post (tr·ª•) ƒë∆∞·ª£c d√πng ƒë·ªÉ duy tr√¨ base (c∆° s·ªü). mindset v·ªÅ gi·ªØ v·ªØng tr·ª• cho ph√©p s·ª± linh ho·∫°t v√† chuy·ªÉn ƒë·ªông h√¥ng (hip) khi ·ªü v·ªã tr√≠ d∆∞·ªõi, hay ch·ªëng b·ªã qu√©t, l·∫≠t (sweep) khi ·ªü v·ªã tr√≠ tr√™n/ƒë·ª©ng.</p>
<div class="page-columns page-full"><p>kh√≠ s·ª≠ d·ª•ng post ·ªü v·ªã tr√≠ d∆∞·ªõi, ƒëi·ªÅu quan tr·ªçng l√† tr·ª• ph·∫£i c√πng ph∆∞∆°ng v·ªõi vector l·ª±c t·ªõi, n·∫øu kh√¥ng post c·ªßa b·∫°n s·∫Ω support cho tr·ªçng l∆∞·ª£ng c·ªßa ƒë·ªëi th·ªß. </p><div class="no-row-height column-margin column-container"><span class="margin-aside">xem th√™n <a href="https://www.bjjmentalmodels.com/force-vectors/">force vectors</a></span></div></div>
</section>
<section id="anatomic-hierarchy" class="level1 page-columns page-full">
<h1>3. <a href="https://bjjmentalmodels.com/anatomic-hierarchy/">anatomic hierarchy</a></h1>
<p>c∆° th·ªÉ con ng∆∞·ªùi c√≥ 6 c∆° quan v≈© kh√≠, trong ƒë√≥ core (g√≤m <em>ng·ª±c - chest, b·ª•ng - midsection, h√¥ng - hips</em>) l√† ph·∫ßn m·∫°nh nh·∫•t.</p>
<ol type="1">
<li>core;</li>
<li>2 legs;</li>
<li>2 arms;</li>
<li>head.</li>
</ol>
<p>v·ªõi b·∫°n, 6 b·ªô ph·∫≠n n√†y l√† v≈© kh√≠ ch·ªëng l·∫°i ƒë·ªëi th·ªß. ·ªü chi·ªÅu ng∆∞·ª£c l·∫°i - v·ªõi h·ªç, 6 b·ªô ph·∫≠n n√†y l√† m·ª•c ti√™u ƒë·ªÉ h·ªç t·∫•n c√¥ng, kh·ªëng ch·∫ø, v√† submits.</p>
<div class="page-columns page-full"><p>h√£y lu√¥n nh·ªõ r·∫±ng, b·∫°n ph·∫£i t·∫≠n d·ª•ng t·ªëi ƒëa ph·∫ßn c∆° th·ªÉ kh·ªèe nh·∫•t c·ªßa b·∫°n. v√¨ core l√† ph·∫ßn m·∫°nh nh·∫•t, n·∫øu khai th√°c ƒë∆∞·ª£c ƒë√≥, x√°c xu·∫•t l√† r·∫•t cao b·∫°n s·ª≠ d·ª•ng ƒë∆∞·ª£c c√°c k·ªπ thu·∫≠t m·ªôt c√°ch hi·ªáu qu·∫£. m·ªôt sai l·∫ßm ph·ªï bi·∫øn c·ªßa ng∆∞·ªùi m·ªõi l√† s·ª≠ d·ª•ng qu√° m·ª©c nƒÉng l∆∞·ª£ng v√†o tay v√† ch√¢n. ngo√†i vi·ªác ∆∞u ti√™n core, b·∫°n c≈©ng c·∫ßn c√≥ t∆∞ duy s·ª≠ d·ª•ng m·ªçi b·ªô ph·∫≠n c∆° th·ªÉ nhi·ªÅu nh·∫•t c√≥ th·ªÉ. </p><div class="no-row-height column-margin column-container"><span class="margin-aside">xem th√™m <a href="https://www.bjjmentalmodels.com/overwhelming-force/">overwhelming force</a></span></div></div>
<p>ng∆∞·ª£c l·∫°i, n√™n h·∫°n ch·∫ø t·∫•n c√¥ng v√†o core c·ªßa ƒë·ªëi th·ªß. s·∫Ω d·ªÖ d√†ng h∆°n khi t·∫•n c√¥ng v√†o 4 g√≥c ph·∫ßn t∆∞ c·ªßa c∆° th·ªÉ (torso) h·ªç - l√† 4 chi (limbs) v√† t·∫•t nhi√™n bao g·ªìm hai b√™n h√¥ng v√† hai vai. ki·ªÉm so√°t levers t·∫°o ra leverages, s·∫Ω d·ªÖ ph√° v·ª° ƒë∆∞·ª£c alignment c·ªßa ƒë·ªëi th·ªß h∆°n.</p>
</section>
<section id="type-of-guards" class="level1">
<h1>4. <a href="https://bjjmentalmodels.com/types-of-guard/">type of guards</a></h1>
<p>c√≥ h√†ng ch·ª•c, th·∫≠m ch√≠ l√† h√†ng trƒÉm c√°c lo·∫°i guards, ch√∫ng c≈©ng ƒëang ƒë∆∞·ª£c th√™m m·ªõi m·ªói ng√†y. do ƒë√≥ r·∫•t c·∫ßn thi·∫øt ƒë·ªÉ hi·ªÉu, ph√¢n lo·∫°i c√°c guards d·ª±a tr√™n ƒë·∫∑c ƒëi·ªÉm c∆° ch·∫ø (mechanical characteristics) c·ªßa ch√∫ng. ch√∫ng ta s·∫Ω hi·ªÉu s√¢u h∆°n v√† d·ªÖ d√†ng √°p d·ª•ng ƒë∆∞·ª£c h∆°n.</p>
<ol type="1">
<li><strong>hook-based</strong>;</li>
</ol>
<p>b·∫°n theo v√† b√°m (track and check) chuy·ªÉn ƒë·ªông c·ªßa ƒë·ªëi th·ªß b·∫±ng c√°ch ‚Äúm√≥c‚Äù (hooking) s·ª≠ d·ª•ng tay (b√†n tay) v√† ch√¢n (mu b√†n ch√¢n). tuy ch√∫ng l·ªèng l·∫ªo (shallow), v√† th∆∞·ªùng kh√¥ng c√≥ t√°c d·ª•ng c·ªë ƒë·ªãnh ƒë·ªëi th·ªß (immobilizing), nh∆∞ng l√† c√°ch r·∫•t t·ªët ƒë·ªÉ c·∫£m nh·∫≠n v·ªã tr√≠ c∆° th·ªÉ v√† ph·∫£n ·ª©ng l·∫°i. hooks th∆∞·ªùng ƒë∆∞·ª£c d√πng ƒë·ªÉ n√¢ng ƒë·ªëi th·ªß l√™n m·ªôt c√°ch linh ho·∫°t.</p>
<p>v√≠ d·ª•:</p>
<ul>
<li>butterfly guard;</li>
<li>instep/shin-to-shin guard.</li>
</ul>
<ol start="2" type="1">
<li><strong>clamp-based</strong>;</li>
</ol>
<p>b·∫°n s·∫Ω tr√≥i (tethering) c∆° th·ªÉ c·ªßa m√¨nh v√†o c∆° th·ªÉ ƒë·ªëi th·ªß, ngƒÉn c·∫£n (hindering) h·ªç chuy·ªÉn ƒë·ªông. nhi·ªÅu traditional guard l√† d·ª±a v√†o vi·ªác k·∫πp, ch√∫ng b·∫´y, l√†m ch·∫≠m ƒë·ªëi th·ªß v√† ƒë∆∞a h·ªç v√†o t√¨nh th·∫ø kh√¥ng thi ƒë·∫•u, tri·ªÉn khai ƒë∆∞·ª£c ph∆∞∆°ng √°n. ƒë·ªëi v·ªõi ng∆∞·ªùi th·ª±c hi·ªán, ch√∫ng c≈©ng nguy hi·ªÉm khi cho ph√©p ƒë·ªëi th·ªß n√¢ng b·∫°n l√™n ho·∫∑c t·∫°o √°p l·ª±c b·∫±ng tr·ªçng l∆∞·ª£ng.</p>
<p>v√≠ d·ª•:</p>
<ul>
<li>closed guard;</li>
<li>half guard.</li>
</ul>
<ol start="3" type="1">
<li><strong>frame-based</strong>;</li>
</ol>
<p>s·ª≠ d·ª•ng frame t·∫°o th√†nh t·ª´ c√°c chi (limbs) ƒë·ªÉ gi·ªØ cho ƒë·ªëi th·ªß ·ªü m·ªôt kho·∫£ng c√°ch an to√†n. r·∫•t hi·ªáu qu·∫£ ƒë·ªëi v·ªõi c√°c ƒë·ªëi th·ªß aggressive ho·∫∑c kh·ªèe h∆°n, c≈©ng r·∫•t hi·ªáu qu·∫£ trong MMA v√† chi·∫øn ƒë·∫•u th·ª±c t·∫ø khi gi·∫£m hi·ªÉu qu·∫£ c√°c ƒë√≤n ƒë√°nh/ƒë·∫•m c·ªßa ƒë·ªëi ph∆∞∆°ng.</p>
<p>v√≠ d·ª•:</p>
<ul>
<li>spider guard;</li>
<li>knee shield guard.</li>
</ul>
<ol start="4" type="1">
<li><strong>hybrid</strong>.</li>
</ol>
<p>c√°c guard hi·ªán ƒë·∫°i th∆∞·ªùng l√† s·ª± k·∫øt h·ª£p gi·ªØa c√°c th·ªÉ lo·∫°i ƒë·ªÅ c·∫≠p ·ªü tr√™n.</p>
<p>v√≠ d·ª•:</p>
<ul>
<li>de la Riva guard v√† c√°c bi·∫øn th·ªÉ;</li>
<li>X guard v√† c√°c bi·∫øn th·ªÉ.</li>
</ul>
</section>
<section id="breaking-mechanics" class="level1 page-columns page-full">
<h1>5. <a href="https://bjjmentalmodels.com/breaking-mechanics/">breaking mechanics</a></h1>
<p>c√≥ 4 ki·ªÉu kh√≥a g√£y (breaks):</p>
<ol type="1">
<li><strong>linear</strong> locks: nh∆∞ kneebars ho·∫∑c armbars;</li>
<li><strong>rotational</strong> locks: nh∆∞ heel hooks ho·∫∑c Kimuras;</li>
<li><strong>compression</strong> locks: nh∆∞ calf slicer;</li>
<li><strong>hybrid</strong> locks: k·∫øt h·ª£p c√°c ki·ªÉu h√¨nh tr√™n.</li>
</ol>
<div class="page-columns page-full"><p>t∆∞∆°ng t·ª± nh∆∞ choke, n√™n k·∫øt h·ª£p c√°c c∆° ch·∫ø kh√≥a g√£y b·∫±ng c√°ch s·ª≠ d·ª•ng hybrid locks. v√≠ d·ª•: khi th·ª±c hi·ªán kneebar ~ linear, n√™n s·ª≠ d·ª•ng th√™m rotation ƒë·ªÉ n√≥ th√™m hi·ªáu qu·∫£. </p><div class="no-row-height column-margin column-container"><span class="margin-aside">xem th√™m <a href="https://www.bjjmentalmodels.com/choking-mechanics/">chokes</a></span></div></div>
<p>c√°c b∆∞·ªõc ƒë·ªÉ kh√≥a g√£y ƒë·ªëi ph∆∞∆°ng:</p>
<ol type="1">
<li><strong>isolate a lever</strong>: c√¥ l·∫≠p m·ªôt chi, nh∆∞ ch√¢n ho·∫∑c tay;</li>
<li><strong>prevent predictable defenses</strong>: d·ª± ƒëo√°n c√°c c√°ch ph√≤ng th·ªß c·ªßa ƒë·ªëi th·ªß v√† ƒë∆∞a ra bi·ªán ph√°p ph√≤ng ng·ª´a, c≈©ng n√™n t·∫≠p c·∫£i thi·ªán alignment c·ªßa b·∫£n th√¢n tr∆∞·ªõc khi ph√° v·ª° alignment c·ªßa h·ªç;</li>
<li><strong>maximize leverage</strong>:</li>
</ol>
<ul>
<li>tri·ªát ƒë·ªÉ c·ªë ƒë·ªãnh kh·ªõp m√† b·∫°n c√≥ √Ω ƒë·ªãnh t·∫•n c√¥ng, s·ª≠ d·ª•ng 1 c√°i n√™m cho kh·ªõp ƒë√≥ v√† kh·ªëng ch·∫ø c√°c kh·ªõp l√¢n c·∫≠n.</li>
<li>c√°c kh·ªõp l√¢n c·∫≠n n·∫øu c√≤n c√≥ th·ªÉ di chuy·ªÉn s·∫Ω gi·∫£m b·ªõt √°p l·ª±c v√† l√†m suy y·∫øu ƒë√≤n t·∫•n c√¥ng c·ªßa b·∫°n.<br>
</li>
<li>ƒë·∫£m b·∫£o l√† grip l√† ch·∫Øc ch·∫Øn v√† k√©o d√†i ‚Äúc√°nh tay ƒë√≤n‚Äù nh·∫•t c√≥ th·ªÉ (maximizing leverage), b·∫°n ph·∫£i t·ª´ t·ª´ ƒë√†o b·ªõi ‚Äúdigging‚Äù ƒë·ªÉ ra ƒë∆∞·ª£c v·ªã tr√≠ ƒë√≥.</li>
<li>tr∆∞·ªõc khi si·∫øt l·ª±c, h√£y ƒë·∫£m b·∫£o m√¨nh ƒëang c√≥ v·ªã tr√≠ t·ªët nh·∫•t. sau khi si·∫øt c·∫ßn h·∫°n ch·∫ø chuy·ªÉn ƒë·ªông.</li>
<li>c√°c chuy·ªÉn ƒë·ªông c·ªßa h√¥ng n√™n ƒë∆∞·ª£c s·ª≠ d·ª•ng sau c√πng;</li>
</ul>
<ol start="4" type="1">
<li><strong>apply overwhelming force</strong>.</li>
</ol>
<p>ch·ªâ khi b·∫°n c√¥ l·∫≠p ƒë∆∞·ª£c levers, ngƒÉn ch·∫∑n c√°c r·ªßi ro b·ªã ph√≤ng ng·ª±, t·ªëi ∆∞u c√°nh tay ƒë√≤n b·∫°n m·ªõi n√™n bung s·ª©c.</p>
<div class="page-columns page-full"><p>khi bung s·ª©c, c·∫ßn s·ª≠ d·ª•ng c·∫£ core v√† s·ª©c m·∫°nh t·ª´ nhi·ªÅu chi nh·∫•t c√≥ th·ªÉ, h√£y nh·ªõ ch·ªâ <strong>sau khi</strong> t·∫≠n d·ª•ng t·ªëi ƒëa c√°c ∆∞u th·∫ø kƒ© thu·∫≠t (technical leverages), b·∫°n m·ªõi bung s·ª©c. </p><div class="no-row-height column-margin column-container"><span class="margin-aside">xem th√™m <a href="https://www.bjjmentalmodels.com/overwhelming-force/">overwhelming force</a></span></div></div>
</section>
<section id="choking-mechanics" class="level1 page-columns page-full">
<h1>6. <a href="https://bjjmentalmodels.com/choking-mechanics/">choking mechanics</a></h1>
<p>c√≥ nƒÉm lo·∫°i si·∫øt ngh·∫πt:</p>
<ol type="1">
<li><strong>air chokes</strong>: t·∫°o √°p l·ª±c l√™n kh√≠ qu·∫£n (trachea/windpipe) ƒë·ªÉ ngƒÉn c·∫£n ƒë·ªëi ph∆∞∆°ng h√¥ h·∫•p, th·ªü. n√≥ c≈©ng c√≥ th·ªÉ ƒë∆∞·ª£c hi·ªáu ch·ªânh ƒë·ªÉ t·∫°o ra ph·∫£n x·∫° h·∫ßu / ph·∫£n x·∫° h·ªçng (gax reflex),  t·∫°o ra hi·ªáu ·ª©ng nh∆∞ blood choke;</li>
<li><strong>blood chokes</strong>:</li>
</ol>
<div class="no-row-height column-margin column-container"><span class="margin-aside">xem th√™m <a href="https://en.wikipedia.org/wiki/Pharyngeal_reflex">pharyngeal reflex</a></span></div><ul>
<li>t·∫°o √°p l·ª±c l√™n ƒë·ªông m·∫°nh c·∫£nh (carotid arteries) ·ªü hai b√™n c·ªï, ng·∫∑n ch·∫∑n m√°u l∆∞u th√¥ng l√™n n√£o v√† l√†m m·∫•t √Ω th·ª©c ƒë·ªëi th·ªß. v√¨ ·∫£nh h∆∞·ªüng r·∫•t nhanh, blood chokes th∆∞·ªùng ƒë∆∞·ª£c coi l√† hi·ªáu qu·∫£ h∆°n air chokes, ƒëa s·ªë c√°c ƒë√≤n chokes trong Jiu-jitsu thu·ªôc lo·∫°i n√†y.</li>
<li>m·ª•c ti√™u c·ªßa m·ªçi blood choke ƒë·ªÅu l√† t√¨m c√°ch si·∫øt ch·∫∑n ƒë·ªông m·∫°nh c·∫£nh, d√πng m·ªôt c√°i n√™m (wedge) ƒë·ªÉ ƒë·∫©y t·ª´ sau ƒë·∫ßu (ND: trong tr∆∞·ªùng h·ª£p c·ªßa RNC l√† c·∫≥ng tay) v√†o choke.</li>
<li>h√£y h√¨nh dung RNC nh∆∞ m·ªôt tam gi√°c bao quanh ƒë·∫ßu ƒë·ªëi th·ªß (hai khu·ª∑u tay v√† 1 vai), trong ƒë√≥ m·ªôt g√≥c tam gi√°c - khu·ª∑u tay ·ªü v·ªã tr√≠ d∆∞·ªõi c·∫±m (chin). c√¥ng vi·ªác c·ªßa b·∫°n l√† tƒÉng √°p l·ª±c l√™n m·ªói ‚Äúc·∫°nh‚Äù c·ªßa tam gi√°c ƒë√≥ ƒë·ªìng th·ªùi gh√¨m c√°i g√≥c tam gi√°c ƒë√≥ xu·ªëng;</li>
</ul>
<ol start="3" type="1">
<li><strong>cranks</strong>: gi·ªØ v√† t·∫°o m·ªôt l·ª±c xo·∫Øn/ ng·∫´u l·ª±c (torque) t·ªõi c·ªï (neck) v√† c·ªôt s·ªëng (spine), v√≠ d·ª• ƒë·∫©y h√†m (jaw) v√†o ph√≠a trong s·ªç, ho·∫∑c v·∫∑n c·ªï b·∫±ng c√°ch s·ª≠ d·ª•ng h√†m nh∆∞ m·ªôt ƒëi·ªÉm m√≥c. b·∫°n kh√¥ng nh·∫•t thi·∫øt ph·∫£i lu·ªìn ƒë∆∞·ª£c tay v√†o d∆∞·ªõi c·∫±m (chin) ƒë·ªÉ th·ª±c hi·ªán neck crank. crank th∆∞·ªùng t·∫°o ra c√°c ch·∫•n th∆∞∆°ng nghi√™m tr·ªçng v√† th∆∞·ªùng h·∫°n ch·∫ø trong luy·ªán t·∫≠p, n√≥ c≈©ng b·ªã c·∫•m trong m·ªôt s·ªë gi·∫£i ƒë·∫•u;</li>
<li><strong>compression chokes</strong>: √©p ph·ªïi l√†m ƒë·ªëi ph∆∞∆°ng kh√≥ ch·ªãu v√¨ kh√¥ng ƒë∆∞a kh√¥ng kh√≠ v√†o ph·ªïi ƒë∆∞·ª£c, v√≠ d·ª• nh∆∞ body triangle hay <a href="https://www.youtube.com/watch?v=baiTE16e5xE">Bas Rutten body crush</a>. n√≥ c≈©ng c√≥ th·ªÉ l√†m g√£y x∆∞∆°ng s∆∞·ªùn v√† c√≥ th·ªÉ kh√¥ng h·ª£p l·ªá trong m·ªôt s·ªë gi·∫£i ƒë·∫•u;</li>
<li><strong>hybrid chokes</strong>: n√™n k·∫øt h·ª£p nhi·ªÅu kƒ© thu·∫≠t choke kh√°c nhau, v√≠ d·ª• blook choke k·∫øt h·ª£p v·ªõi m·ªôt y·∫øu t·ªë crank.</li>
</ol>
</section>
<section id="ratchet-control" class="level1">
<h1>7. <a href="https://bjjmentalmodels.com/ratchet-control/">ratchet control</a></h1>
<p>ki·ªÉm so√°t ƒë·∫ßu ho·∫∑c m·ªôt chi s·∫Ω ƒë∆°n gi·∫£n h∆°n r·∫•t nhi·ªÅu n·∫øu ch√∫ng ta xoay tr·ª•c (rotation) m·ªôt ch√∫t, v√† t·ªët nh·∫•t ch√≠nh l√† ƒë·ªÉ ph∆∞∆°ng t·∫°o l·ª±c c·ªßa ch√∫ng ta vu√¥ng g√≥c v·ªõi ph∆∞∆°ng ch·ªãu l·ª±c c·ªßa ƒë·ªëi th·ªß (ND: ng∆∞·ªùi d·ªãch confused v·ªÅ b·∫£n d·ªãch n√†y). ph∆∞∆°ng ph√°p n√†y g·ªçi l√† ki·ªÉm so√°t b√°nh c√≥c (ratchet control). c√≥ 2 lo·∫°i:</p>
<ol type="1">
<li><strong>internal ratchet control</strong>: khi b·∫°n xoay m·ªôt chi <em>ng∆∞·ª£c l·∫°i v·ªõi chuy·ªÉn ƒë·ªông t·ª± nhi√™n</em> c·ªßa n√≥. v√≠ d·ª• Kimuras (ngo·∫∑t tay ƒë·ªëi th·ªß ra sau l∆∞ng) hay heel hooks (tr·ª•c ch√¢n b·ªã xoay v·ªõi h∆∞·ªõng g√≥t ra ngo√†i);</li>
<li><strong>external ratchet control</strong>: khi b·∫°n xoay m·ªôt chi <em>theo h∆∞·ªõng chuy·ªÉn ƒë·ªông t·ª± nhi√™n</em> c·ªßa n√≥, cho t·ªõi khi ƒë·ªëi th·ªß kh√¥ng ch·ªãu ƒë·ª±ng ƒë∆∞·ª£c. v√≠ d·ª• Americana hay knee flares.</li>
</ol>
<p>d√π external ratchet control r·∫•t h·ªØu √≠ch nh∆∞ng n√≥ th∆∞·ªùng mang l·∫°i s·ª± tho·∫£i m√°i cho ƒë·ªëi th·ªß trong l√∫c b·∫°n t·∫•n c√¥ng (khi ch∆∞a t·ªõi ng∆∞·ª°ng ch·ªãu ƒë·ª±ng). n√™n internal ratchet control th∆∞·ªùng ƒë∆∞·ª£c l·ª±a ch·ªçn h∆°n khi b·∫Øt ƒë·ªëi th·ªß ph·∫£i quay ƒëi v√† ƒë·ªÉ h·ªü l∆∞ng, v√≠ d·ª• Kimuras hay backside 50-50.</p>
<p>m·ªôt s·ªë v√≠ d·ª•:</p>
<ul>
<li>khi d√πng ƒë√≤n armbar, h√£y xo·∫Øn (twist) tay ƒë·ªëi ph∆∞∆°ng song song v·ªõi vi·ªác du·ªói ra (hyper-extending);</li>
<li>khi d√πng ƒë√≤n kneebar, h√£y k√©o g√≥t ch√¢n g·∫ßn v·ªÅ ph√≠a b·∫°n ƒë·ªÉ tƒÉng l·ª±c xoay;</li>
<li>khi k√©o ƒë·∫ßu ƒë·ªëi ph∆∞∆°ng xu·ªëng, h√£y k√©o v√† v·∫∑n/xo·∫Øn c·ªï.</li>
</ul>
<p>ch√∫ng r·∫•t h·ªØu d·ª•ng v√¨ ph√° ƒëi posture v√† structure c·ªßa ƒë·ªëi th·ªß. khi h·ªá x∆∞∆°ng c·ªßa ƒë·ªëi ph∆∞∆°ng kh√¥ng c√≤n ngay h√†ng th·∫≥ng l·ªëi, s·ª©c m·∫°nh c∆° b·∫Øp (musculature) c≈©ng s·∫Ω b·ªã h·∫°n ch·∫ø ƒëi nhi·ªÅu.</p>
</section>
<section id="controlled-breathing" class="level1 page-columns page-full">
<h1>8. <a href="https://bjjmentalmodels.com/controlled-breathing/">controlled breathing</a></h1>
<p>h√£y ch√∫ √Ω ƒë·∫ø nh·ªãp th·ªü c·ªßa b·∫°n, h√£y duy tr√≠ m·ªôt nh·ªãp th·ªü tho·∫£i m√°i (relaxed cadence) c√≥ ch·ªß √Ω (deliberate).</p>
<div class="page-columns page-full"><p>ch√∫ng ta th∆∞·ªùng nghƒ© t√¢m tr√≠ (mind) s·∫Ω d·∫´n d·∫Øt c∆° th·ªÉ (body), tuy nhi√™n tr√™n th·ª±c t·∫ø ch√∫ng c√≥ m·ªëi quan h·ªá ch·∫∑t ch·∫Ω v√† ƒë√¥i khi c∆° ch·∫ø l√† ng∆∞·ª£c l·∫°i.  v√≠ d·ª• khi b·∫°n c∆∞∆°i, t√¢m l√Ω c·ªßa b·∫°n s·∫Ω vui v·∫ª h∆°n. t∆∞∆°ng t·ª±, ki·ªÉm so√°t h∆°i th·ªü s·∫Ω gi√∫p b·∫°n tho·∫£i m√°i v√† ti·∫øt ki·ªám (conserve) nƒÉng l∆∞·ª£ng.</p><div class="no-row-height column-margin column-container"><span class="margin-aside">ref <a href="https://www.scientificamerican.com/article/smile-it-could-make-you-happier/">Smile! It Could Make You Happier</a></span></div></div>
<p>ki·ªÉm so√°t h∆°i th·ªü l√† r·∫•t quan tr·ªçng khi b·∫°n ƒë·ªëi ƒë·∫ßu v·ªõi nh·ªØng ng∆∞·ªùi to ho·∫∑c nhi·ªÅu kinh nghi·ªám h∆°n. b√™n c·∫°nh vi·ªác b·∫£o to√†n ƒë∆∞·ª£c s·ª©c l·ª±c, n√≥ c√≤n gi√∫p b·∫°n b√¨nh tƒ©nh l·∫°i. s·ª± b√¨nh tƒ©nh l√† t·ªëi quan tr·ªçng ƒë·ªÉ ngƒÉn s·ª± ho√†ng lo·∫°n (panicking) khi b·∫°n ch·ªãu th·ª≠ th√°ch th·ª±c s·ª±.</p>
<p>ƒë·ªëi th·ªß c√≥ kinh nghi·ªám c≈©ng s·∫Ω c·∫£m nh·∫≠n (sensing) ƒë∆∞·ª£c s·ª± ho·∫£ng lo·∫°n n·∫øu c√≥ trong nh·ªãp th·ªü c·ªßa b·∫°n. th·ªü kh√¥ng ki·ªÉm so√°t c√≥ th·ªÉ b√°o hi·ªáu s·ª± ho·∫£ng lo·∫°n ƒë√≥ cho ƒë·ªëi th·ªß, khi·∫øn anh ta b·∫Øt ƒë·∫ßu t·∫•n c√¥ng ch·ªõp nho√°ng (blitz attacking) ho·∫∑c tƒÉng nh·ªãp ƒë·ªô (tempo).</p>
<p>n√≥ c≈©ng gi√∫p tim ph√¢n ph·ªëi l∆∞·ª£ng oxy t·ªõi c∆° b·∫Øp ƒë·ªìng ƒë·ªÅu h∆°n, r·∫•t quan tr·ªçng trong vi·ªác gi·ªØ nh·ªãp tim v√† tr√°nh m·ªát m·ªèi qu√° m·ª©c.</p>
</section>
<section id="staying-loose" class="level1 page-columns page-full">
<h1>9. <a href="https://bjjmentalmodels.com/staying-loose/">staying loose</a></h1>
<p>h√£y lu√¥n ch√∫ √Ω m·ªôt c√°ch c√≥ √Ω th·ª©c (conscious attention) t·ªõi vi·ªác th·∫£ l·ªèng c∆° b·∫Øp (relaxed &amp; fluid), ch·ªâ g·ªìng/cƒÉng (tense) ch√∫ng khi m·ªçi th·ª© ƒë√£ s·∫µn s√†ng. nh∆∞ng khi n√†o th√¨ ƒë∆∞·ª£c g·ªçi l√† ‚Äús·∫µn s√†ng‚Äù?:</p>
<ul>
<li>chi·∫øm ƒë∆∞·ª£c m·ªôt g√≥c ƒë√°nh ∆∞u th·∫ø; </li>
<li>ph√° v·ª°, gi√°n ƒëo·∫°n m·ªôt c√°ch c√≥ hi·ªáu qu·∫£ v·ªã tr√≠ cƒÉn ch√≠nh c·ªßa ƒë·ªëi ph∆∞∆°ng; </li>
<li>ho·∫∑c b·∫°n ƒë∆∞a ƒë·ªëi th·ªß v√†o m·ªôt t√¨nh hu·ªëng ti·∫øn tho√°i l∆∞·ª°ng nan. </li>
</ul>
<div class="no-row-height column-margin column-container"><span class="margin-aside">xem th√™m <a href="https://www.bjjmentalmodels.com/dominant-angles/">dominant angles</a></span><span class="margin-aside">xem th√™m v·ªÅ <a href="https://bjjmentalmodels.com/theory-of-alignment/">alignment</a></span><span class="margin-aside">xem th√™m v·ªÅ <a href="https://www.bjjmentalmodels.com/dilemma/">dilema</a></span></div><p>g·ªìng c·ª©ng c∆° b·∫Øp khi kh√¥ng c·∫ßn thi·∫øt s·∫Ω:</p>
<ul>
<li>l√†m ch√∫ng m·ªát m·ªèi (fatigues);</li>
<li>l√†m l·ªô √Ω ƒë·ªãnh c·ªßa b·∫°n;</li>
<li>tay ho·∫∑c ch√¢n g·ªìng qu√° c·ª©ng s·∫Ω d·ªÖ d√†ng cho ƒë·ªëi ph∆∞∆°ng ki·ªÉm so√°t v√† kh·ªëng ch·∫ø.</li>
</ul>
<p>n√≥ c≈©ng l√† hi·ªán t∆∞·ª£ng d·ªÖ hi·ªÉu khi c∆° ch·∫ø ph·∫£n ·ª©ng c·ªßa con ng∆∞·ªùi th∆∞·ªùng l√† s·∫Ω g·ªìng l·∫°i khi c·∫£m th·∫•y b·ªã ƒëe d·ªça, ƒë√≥ l√† l√Ω do m√† ng∆∞·ªùi m·ªõi t·∫≠p th∆∞·ªùng g·ªìng c·ª©ng khi roll. c·∫ßn t·∫≠p luy·ªán v√† k·ª∑ lu·∫≠t ƒë·ªÉ c√≥ th·ªÉ th·∫£ l·ªèng ƒë∆∞·ª£c tr∆∞·ªõc √°p l·ª±c - calm under fire!</p>
<p>n·∫øu ƒëa s·ªë c√°c k·ªπ nƒÉng / k·ªπ thu·∫≠t m√† b·∫°n t·∫≠p trung v√†o ƒë·ªÅu ph·ª• thu·ªôc v√†o s·ª©c m·∫°nh c∆° b·∫Øp, v√† b·∫°n th∆∞·ªùng xuy√™n c·∫£m th·∫•y ƒëu·ªëi, m·ªát m·ªèi, ƒë√≥ ch√≠nh l√† d·∫•u hi·ªáu c·ªßa vi·ªác b·∫°n kh√¥ng th·ª±c hi·ªán ƒë√∫ng k·ªπ nƒÉng / k·ªπ th·∫≠t ƒë√≥. c·∫ßn ƒë√°nh gi√° v√† luy·ªán t·∫≠p l·∫°i.</p>
<p>ch·ªâ c√≥ m·ªôt t√≠nh hu·ªëng duy nh·∫•t m√† b·∫°n n√™n bung s·ª©c m·∫°nh c∆° b·∫Øp, ƒë√≥ l√† l√∫c b·∫°n ƒë·∫£m b·∫£o ƒë∆∞·ª£c vi·ªác th·ª±c hi·ªán th√†nh c√¥ng m·ªôt kƒ© thu·∫≠t, ƒë·ªëi ph∆∞∆°ng kh√¥ng th·ªÉ ph√≤ng th·ªß v√† b·∫°n ƒë√£ ·ªü t∆∞ th·∫ø hi·ªáu qu·∫£ nh·∫•t c√≥ th·ªÉ. l√∫c ƒë√≥ s·ª©c m·∫°nh c∆° b·∫Øp s·∫Ω khu·∫øch ƒë·∫°i cao nh·∫•t l·ª£i th·∫ø b·∫°n ƒëang c√≥.</p>
<p>t√≥m l·∫°i: ch·ªâ bung c∆° b·∫Øp khi ƒë√£ ·ªü trong t√≠nh hu·ªëng hi·ªáu qu·∫£ nh·∫•t trong m·ªôt ƒë√≤n th·∫ø, c√≤n l·∫°i, <strong>ƒë·ª´ng</strong>.</p>
<blockquote class="blockquote">
<p>‚ÄúNotice that the stiffest tree is most easily cracked, while the bamboo or willow survives by bending with the wind.‚Äù <strong>‚Äî- Bruce Lee</strong></p>
</blockquote>
</section>
<section id="limb-coiling" class="level1">
<h1>10. <a href="https://bjjmentalmodels.com/limb-coiling/">limb coiling</a></h1>
<p>gi·ªØ t·ª© chi c·ªßa b·∫°n cu·ªôn s√°t v√†o c∆° th·ªÉ, s·∫µn s√°ng t·∫•n c√¥ng. c·ª• th·ªÉ:</p>
<ul>
<li>gi·ªØ c·∫±m c·ªßa b·∫°n khom xu·ªëng, hai vai c≈©ng g√π, khom v√†o ƒë·ªÉ h·∫°n ch·∫ø vi·ªác ƒë·ªëi th·ªß t·∫•n c√¥ng v√†o c·ªï;</li>
<li>khu·ª∑u tay lu√¥n kh√©p ch·∫∑t v√†o h√¥ng, s∆∞·ªùn (core, hips);</li>
<li>gi·ªØ ƒë·∫ßu g·ªëi g·∫≠p l·∫°i.</li>
</ul>
</section>
<section id="elbow-knee-connection" class="level1">
<h1>11. <a href="https://bjjmentalmodels.com/elbow-knee-connection/">elbow-knee connection</a></h1>
</section>
<section id="solid-frames" class="level1">
<h1>12. <a href="https://bjjmentalmodels.com/solid-frames/">solid frames</a></h1>
</section>
<section id="kinetic-chains" class="level1">
<h1>13. <a href="https://bjjmentalmodels.com/kinetic-chains/">kinetic chains</a></h1>
</section>
<section id="body-tethering" class="level1">
<h1>14. <a href="https://bjjmentalmodels.com/body-tethering/">body tethering</a></h1>
</section>
<section id="inside-channel-control" class="level1">
<h1>15. <a href="https://bjjmentalmodels.com/inside-channel-control/">inside channel control</a></h1>
</section>
<section id="single-vs.-double-level-control" class="level1">
<h1>16. <a href="https://bjjmentalmodels.com/single-vs-double-lever-control/">single vs.&nbsp;double level control</a></h1>
</section>
<section id="overwhelming-force" class="level1">
<h1>17. <a href="https://bjjmentalmodels.com/overwhelming-force/">overwhelming force</a></h1>
</section>
<section id="surface-area" class="level1">
<h1>18. <a href="https://bjjmentalmodels.com/surface-area/">surface area</a></h1>
</section>
<section id="joint-rule" class="level1">
<h1>19. 3-joint rule</h1>
</section>
<section id="center-of-gravity" class="level1">
<h1>20. center of gravity</h1>
</section>
<section id="critical-control-points" class="level1">
<h1>21. critical control points</h1>
</section>
<section id="direct-vs.-proxy-control" class="level1">
<h1>22. direct vs.&nbsp;proxy control</h1>
</section>
<section id="force-compression" class="level1">
<h1>23. force compression</h1>
</section>
<section id="force-vectors" class="level1">
<h1>24. force vectors</h1>
</section>
<section id="head-position" class="level1">
<h1>25. head position</h1>
</section>
<section id="inertia" class="level1">
<h1>26. inertia</h1>
</section>
<section id="leading-edges" class="level1">
<h1>27. leading edges</h1>
</section>
<section id="mirrored-stances" class="level1">
<h1>28. mirrored stances</h1>
</section>
<section id="momentum" class="level1">
<h1>29. momentum</h1>
</section>
<section id="priits-45-rule" class="level1">
<h1>30. priit‚Äôs 45¬∞ rule</h1>
</section>
<section id="redundancies" class="level1">
<h1>31. redundancies</h1>
</section>
<section id="seated-vs.-supine-guards" class="level1">
<h1>32. seated vs.&nbsp;supine guards</h1>
</section>
<section id="stress-and-recovery" class="level1">
<h1>33. stress and recovery</h1>
<p><a href="https://www.youtube.com/watch?v=XGZ-0ZoFqKk" class="uri">https://www.youtube.com/watch?v=XGZ-0ZoFqKk</a></p>


<!-- -->

</section>

 ]]></description>
  <category>bjj</category>
  <guid>https://lktuan.github.io/blog/2024-08-06-bjj-mental-models/</guid>
  <pubDate>Mon, 05 Aug 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-08-06-bjj-mental-models/bjj_mental_models.jpeg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Now I know docker init is a thing</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-07-30-docker-init/</link>
  <description><![CDATA[ 





<p>TIL that Docker has an <a href="https://docs.docker.com/language/python/containerize/">example</a> for containerizing Python apps. It uses a simple <a href="https://fastapi.tiangolo.com/">FastAPI</a> example for demonstration. We can download the project as below:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone https://github.com/estebanx64/python-docker-example</span></code></pre></div>
<p>After navigating to our project, we can easily set up our project for containerization with <code>docker init</code>. This will create:</p>
<ul>
<li><code>.dockerignore</code></li>
<li><code>Dockerfile</code></li>
<li><code>compose.yaml</code></li>
<li><code>README.Docker.md</code></li>
</ul>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">docker</span> init</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Welcome</span> to the Docker Init CLI!</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">This</span> utility will walk you through creating the following files with sensible defaults for your project:</span>
<span id="cb2-6">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">-</span> .dockerignore</span>
<span id="cb2-7">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">-</span> Dockerfile</span>
<span id="cb2-8">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">-</span> compose.yaml</span>
<span id="cb2-9">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">-</span> README.Docker.md</span>
<span id="cb2-10"></span>
<span id="cb2-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Let</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'s get started!</span></span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">? What application platform does your project use? Python</span></span>
<span id="cb2-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">? What version of Python do you want to use? (3.11.4)</span></span>
<span id="cb2-15"></span>
<span id="cb2-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">? What version of Python do you want to use? 3.11.4</span></span>
<span id="cb2-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">? What port do you want your app to listen on? (8000)</span></span>
<span id="cb2-18"></span>
<span id="cb2-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">? What port do you want your app to listen on? 8000</span></span>
<span id="cb2-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">? What is the command you use to run your app? (uvicorn '</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">app:app</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' --host=0.0.0.0 --port=8000)</span></span>
<span id="cb2-21"></span>
<span id="cb2-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">? What is the command you use to run your app? uvicorn '</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">app:app</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' --host=0.0.0.0 --port=8000</span></span>
<span id="cb2-23"></span>
<span id="cb2-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">‚úî Created ‚Üí .dockerignore</span></span>
<span id="cb2-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">‚úî Created ‚Üí Dockerfile</span></span>
<span id="cb2-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">‚úî Created ‚Üí compose.yaml</span></span>
<span id="cb2-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">‚úî Created ‚Üí README.Docker.md</span></span>
<span id="cb2-28"></span>
<span id="cb2-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">‚Üí Your Docker files are ready!</span></span>
<span id="cb2-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  Review your Docker files and tailor them to your application.</span></span>
<span id="cb2-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  Consult README.Docker.md for information about using the generated files.</span></span>
<span id="cb2-32"></span>
<span id="cb2-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">! Warning ‚Üí Make sure your requirements.txt contains an entry for the uvicorn package, which is required to run your application.</span></span>
<span id="cb2-34"></span>
<span id="cb2-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">What'</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">s</span> next<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">?</span></span>
<span id="cb2-36">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Start</span> your application by running ‚Üí docker compose up <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--build</span></span>
<span id="cb2-37">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Your</span> application will be available at http://localhost:8000</span></code></pre></div>
<p>I can access the application right after running <code>docker compose up --build</code>. The image buidling process was fast, and image size was only <code>203.21MB</code>.</p>
<p>Let‚Äôs take a look at the <code>Dockerfile</code>. IMHO, this is not yet a optimal Dockerized Python project:</p>
<ul>
<li>Lack off a dependency management tool (for e.g, <code>pipenv</code>, <code>poetry</code> both are good, production-ready);</li>
<li>This is single-step builder. Should we split it to <code>dependencies</code> and <code>runtime</code> steps, which will limit the objects in the <code>runtime</code> image to only those needed to run the application? </li>
</ul>
<div class="no-row-height column-margin column-container"><span class="margin-aside">further reading, <a href="https://sourcery.ai/blog/python-docker/">‚ÄúA perfect way to Dockerize your Pipenv Python application‚Äù</a></span></div><p>I do see some good practices here that we should run our apps in a non-privileged user rather than root as well as <em>mount cache and bind</em>, using Docker‚Äôs BuildKit feature, which allows more advanced mounting capabilities during build time:</p>
<ol type="1">
<li>first <code>--mount=type=cache,target=/root/.cache/pip</code> option:</li>
</ol>
<ul>
<li>This creates a cache mount for pip‚Äôs cache directory;</li>
<li>It speeds up subsequent builds by reusing cached pip packages;</li>
<li>The cache persists between builds, saving time and bandwidth.</li>
</ul>
<ol start="2" type="1">
<li>second <code>--mount=type=bind,source=requirements.txt,target=requirements.txt</code> option:</li>
</ol>
<ul>
<li>This creates a bind mount for the <code>requirements.txt</code> file;</li>
<li>It allows access to the <code>requirements.txt</code> file without copying it into the image layer;</li>
<li>This is useful for keeping the image size smaller and allowing changes to <code>requirements.txt</code> without rebuilding all layers.</li>
</ul>
<p>In conclusion, benefits are:</p>
<ol type="1">
<li><strong>Faster builds</strong>: By using a cache mount for pip, subsequent builds can reuse cached packages, significantly speeding up the process.</li>
<li><strong>Smaller image size</strong>: The bind mount for <code>requirements.txt</code> means the file doesn‚Äôt need to be copied into the image, keeping the image size smaller.</li>
<li><strong>Better caching</strong>: Changes to <code>requirements.txt</code> don‚Äôt invalidate the entire layer cache, only the parts that have changed.</li>
<li><strong>Separation of concerns</strong>: Downloading dependencies is done as a separate step, which can be beneficial for Docker‚Äôs layer caching mechanism.</li>
</ol>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># syntax=docker/dockerfile:1</span></span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Comments are provided throughout this file to help you get started.</span></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If you need more help, visit the Dockerfile reference guide at</span></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># https://docs.docker.com/go/dockerfile-reference/</span></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Want to help us make this template better? Share your feedback here: https://forms.gle/ybq9Krt8jtBL3iCk7</span></span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ARG</span> PYTHON_VERSION=3.11.4</span>
<span id="cb3-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">FROM</span> python:<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${PYTHON_VERSION}</span>-slim as base</span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prevents Python from writing pyc files.</span></span>
<span id="cb3-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENV</span> PYTHONDONTWRITEBYTECODE=1</span>
<span id="cb3-14"></span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Keeps Python from buffering stdout and stderr to avoid situations where</span></span>
<span id="cb3-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the application crashes without emitting any logs due to buffering.</span></span>
<span id="cb3-17"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ENV</span> PYTHONUNBUFFERED=1</span>
<span id="cb3-18"></span>
<span id="cb3-19"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">WORKDIR</span> /app</span>
<span id="cb3-20"></span>
<span id="cb3-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a non-privileged user that the app will run under.</span></span>
<span id="cb3-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># See https://docs.docker.com/go/dockerfile-user-best-practices/</span></span>
<span id="cb3-23"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ARG</span> UID=10001</span>
<span id="cb3-24"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">RUN</span> adduser <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--disabled-password</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--gecos</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--home</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/nonexistent"</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--shell</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/sbin/nologin"</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-create-home</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--uid</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${UID}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-31">    appuser</span>
<span id="cb3-32"></span>
<span id="cb3-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download dependencies as a separate step to take advantage of Docker's caching.</span></span>
<span id="cb3-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Leverage a cache mount to /root/.cache/pip to speed up subsequent builds.</span></span>
<span id="cb3-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Leverage a bind mount to requirements.txt to avoid having to copy them into</span></span>
<span id="cb3-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># into this layer.</span></span>
<span id="cb3-37"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">RUN</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--mount</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>type=cache,target=/root/.cache/pip <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--mount</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>type=bind,source=requirements.txt,target=requirements.txt <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-39">    python <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> pip install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-r</span> requirements.txt</span>
<span id="cb3-40"></span>
<span id="cb3-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Switch to the non-privileged user to run the application.</span></span>
<span id="cb3-42"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">USER</span> appuser</span>
<span id="cb3-43"></span>
<span id="cb3-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Copy the source code into the container.</span></span>
<span id="cb3-45"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">COPY</span> . .</span>
<span id="cb3-46"></span>
<span id="cb3-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Expose the port that the application listens on.</span></span>
<span id="cb3-48"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">EXPOSE</span> 8000</span>
<span id="cb3-49"></span>
<span id="cb3-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the application.</span></span>
<span id="cb3-51"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">CMD</span> uvicorn <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'app:app'</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--host</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>0.0.0.0 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--port</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>8000</span></code></pre></div>
<p>Happy coding!</p>


<!-- -->


 ]]></description>
  <category>docker</category>
  <category>python</category>
  <guid>https://lktuan.github.io/blog/2024-07-30-docker-init/</guid>
  <pubDate>Mon, 29 Jul 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-07-30-docker-init/python_docker.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>BJJ Beginners Guide</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-07-29-bjj-beginners-guide/</link>
  <description><![CDATA[ 





<p>ƒê√¢y l√† b√†i (l∆∞·ª£c) d·ªãch t·ª´ beginners guide c·ªßa Reddit community <code>r/bjj</code>. Link g·ªëc b√†i vi·∫øt: <a href="https://www.reddit.com/r/bjj/wiki/beginners-guide/" class="uri">https://www.reddit.com/r/bjj/wiki/beginners-guide/</a>. M·ªôt s·ªë thu·∫≠t ng·ªØ m√¨nh c√≥ th·ªÉ s·∫Ω ƒë·ªÉ nguy√™n b·∫£n Ti·∫øng Anh, ho·∫∑c ƒë·ªÉ k√®m trong ngo·∫∑c tr√≤n <code>()</code>, ch√∫ th√≠ch (n·∫øu c√≥) s·∫Ω ƒë∆∞·ª£c ƒë·∫∑t trong d·∫•u ngo·∫∑c tr√≤n sau ‚ÄúND‚Äù.</p>
<p>M·ª•c ƒë√≠ch ƒë√°nh gi√° l·∫°i nh·ªØng g√¨ m√¨nh ƒë·∫°t ƒë∆∞·ª£c sau 6 th√°ng theo ƒëu·ªïi BJJ.</p>
<section id="h∆∞·ªõng-d·∫´n-jiu-jitsu-cho-ng∆∞·ªùi-m·ªõi-b·∫Øt-ƒë·∫ßu" class="level1">
<h1>H∆∞·ªõng d·∫´n Jiu-jitsu cho ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu</h1>
<p>Ch√†o m·ª´ng ƒë·∫øn v·ªõi Brazil Jiujitsu v√† ch√†o m·ª´ng ƒë·∫øn v·ªõi <code>r/bjj</code>! ƒê√¢y l√† h∆∞·ªõng d·∫´n t·ªïng h·ª£p d√†nh cho ng∆∞·ªùi m·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu h√†nh tr√¨nh Jiu-jitsu c·ªßa b·∫°n.</p>
<p>Ch√∫c may m·∫Øn, v√† h√£y t·ª≠ t·∫ø!</p>
<p>B·∫°n c√≥ ƒë·ªÅ xu·∫•t, c·∫£i ti·∫øn ho·∫∑c nh·∫≠n x√©t cho b√†i vi·∫øt n√†y? ƒê·ªÉ n√≥ ·ªü <a href="https://docs.google.com/forms/d/e/1FAIpQLSclF8d-uXVmPVQ3EoV3K-SexnoWbefI5y6lofkSUNI68RpDCQ/viewform">ƒë√¢y</a>.</p>
</section>
<section id="bjj-l√†-g√¨" class="level1">
<h1>BJJ l√† g√¨?</h1>
<p>Brazilian Jiu-jitsu, ƒë√¥i l√∫c g·ªçi l√† Jiu-jitsu (ND: ÂÖ´ÂõõÊüîÊúØ Nhu thu·∫≠t Brazin) l√† m·ªôt m√¥n v√µ k·∫ø th·ª´a t·ª´ Judo (ND: ÊüîÈÅì Nhu ƒë·∫°o Nh·∫≠t b·∫£n). N√≥:</p>
<ul>
<li>ƒê·ªëi kh√°ng (contact), nghƒ©a l√† b·∫°n c·∫ßn tranh gi√†nh ∆∞u th·∫ø, chi·∫øn th·∫Øng v·ªõi ng∆∞·ªùi kh√°c;</li>
<li>Tay kh√¥ng (bare-handed), nghƒ©a l√† kh√¥ng v≈© kh√≠ n√†o ƒë∆∞·ª£c ch·∫•p nh·∫≠n;</li>
<li>D·ª±a v√†o v·∫≠t l·ªôn (grappling-based), ph∆∞∆°ng th·ª©c chi·∫øn ƒë·∫•u l√† v·∫≠t (grappling, wrestling), ƒë·∫•m (punching) v√† ƒë√° (kicking) l√† kh√¥ng ƒë∆∞·ª£c ph√©p;</li>
<li>Submission-based (ND: ch∆∞a th·ªÉ d·ªãch t·ª´ n√†y), nghƒ©a l√† m·ª•c ti√™u c·∫ßn ƒë·∫°t ƒë∆∞·ª£c l√† b·∫Øt ƒë·ªëi th·ªß ƒë·∫ßu h√†ng (submission) th√¥ng qua m·ªôt ƒë√≤n si·∫øt ngh·∫πt (choke) ho·∫∑c ƒëe d·ªça t·ªïn th∆∞∆°ng t·ªõi c√°c kh·ªõp c·ªßa h·ªç, h∆°n l√† ch·ªâ ƒë∆°n thu·∫ßn l√† chi·∫øm v·ªã tr√≠ ∆∞u th·∫ø (positioning) ho·∫∑c ghim ch·∫∑t ƒë·ªëi th·ªß (pinning).</li>
</ul>
<p>BJJ kh√°c v·ªõi Judo ·ªü ch·ªó n√≥ thi√™n v·ªÅ v·∫≠t l·ªôn / ƒë·ªãa chi·∫øn (ground grappling), trong khi Judo nh·∫•n m·∫°nh v·ªÅ quƒÉng (throws) v√† qu·∫≠t ng√£ (takedowns) t·ª´ v·ªã tr√≠ ƒë·ª©ng.</p>
</section>
<section id="t√¥i-c√≥-th·ª±c-s·ª±-th√≠ch-jiu-jitsu-kh√¥ng" class="level1">
<h1>T√¥i c√≥ (th·ª±c s·ª±) th√≠ch Jiu-jitsu kh√¥ng?</h1>
<p>B·∫°n s·∫Ω th√≠ch Jiu-jitsu n·∫øu:</p>
<ul>
<li>ƒêang t√¨m ki·∫øm m·ªôt b√†i th·ªÉ thao r√®n luy·ªán (workout), nh∆∞ng gh√©t t·∫≠p c√°c m√¥n th·ªÉ d·ª•c nh∆∞ ch·∫°y b·ªô, n√¢ng t·∫°;</li>
<li>T√¨m ki·∫øm m·ªôt c·ªông ƒë·ªìng s√¥i ƒë·ªông;</li>
<li>C·∫ßn t√¨m c·∫£m gi√°c c√≥ m·ª•c ƒë√≠ch v√† ti·∫øn b·ªô;</li>
<li>Th√≠ch c√°c ho·∫°t ƒë·ªông th·ªÉ thao k·∫øt h·ª£p th·ªÉ ch·∫•t v√† tr√≠ n√£o (cerebral), nh∆∞ leo n√∫i;</li>
<li>ƒê√£ t·ª´ng ƒë√†o t·∫°o c√°c m√¥n th·ªÉ thao ƒë·ªëi kh√°ng (combat) kh√°c;</li>
<li>Mu·ªën th·ª≠ g√¨ ƒë√≥ m·ªõi m·∫ª?.</li>
</ul>
</section>
<section id="jiu-jitsu-c√≥-ph√π-h·ª£p-v·ªõi-t√¥i-kh√¥ng" class="level1">
<h1>Jiu-jitsu c√≥ ph√π h·ª£p v·ªõi t√¥i kh√¥ng?</h1>
<p>N√≥ ph√π h·ª£p v·ªõi t·∫•t c·∫£ b·∫•t k·ªÉ tu·ªïi, th·ªÉ tr·∫°ng, gi·ªõi t√≠nh, ho√†n c·∫£nh, kinh nghi·ªám. Tuy nhi√™n, c√≥ th·ªÉ t·∫≠p v√† kh√¥ng c·∫ßn coi n√≥ l√† s·ªü th√≠ch c·ªßa b·∫°n, v√† b·∫°n c≈©ng kh√¥ng c·∫ßn xu·∫•t s·∫Øc trong m√¥n n√†y. M·ª•c ti√™u kh√¥ng ph·∫£i l√† h∆°n thua v·ªõi ng∆∞·ªùi kh√°c, m√† l√† tr·ªü n√™n <em>t·ªët nh·∫•t c√≥ th·ªÉ</em>.</p>
</section>
<section id="l√†m-sao-ƒë·ªÉ-th·ª≠-v√†-b·∫Øt-ƒë·∫ßu" class="level1">
<h1>L√†m sao ƒë·ªÉ th·ª≠ v√† b·∫Øt ƒë·∫ßu</h1>
<ol type="1">
<li>T√¨m m·ªôt ph√≤ng t·∫≠p, n√™n l√† c√°c ph√≤ng c√≥ ƒë√°nh gi√° t·ªët;</li>
<li>T√¨m hi·ªÉu l·ªãch t·∫≠p, ch√≠nh s√°ch, gi√° c·∫£;</li>
<li>M·∫∑c qu·∫ßn √°o tho·∫£i m√°i, kh√¥ng ƒëeo trang s·ª©c, mang n∆∞·ªõc, th·ªùi ƒëi·ªÉm n√†y b·∫°n ch∆∞a c·∫ßn trang b·ªã n√†o kh√°c;</li>
<li>T·∫≠p th·ª≠;</li>
<li>L·ªõp th√¥ng th∆∞·ªùng s·∫Ω bao g·ªìm: kh·ªüi ƒë·ªông (warmups), d·∫°y kƒ© thu·∫≠t v√† t·∫≠p luy·ªán (teaching &amp; drilling), sau ƒë√≥ l√† ƒë·ªëi kh√°ng (sparring, rolling, open mat). T·∫≠p nh·∫π nh√†ng v√† kh√¥ng n√™n k√¨ v·ªçng qu√° nhi·ªÅu;</li>
<li>(&amp; 7) Xin t·∫≠p th·ª≠ th√™m, ho·∫∑c t√¨m m·ªôt CLB kh√°c, h√£y m·∫°nh d·∫°n, cho t·ªõi khi ∆∞ng √Ω.</li>
</ol>
</section>
<section id="l·ª±a-ch·ªçn-clbph√≤ng-t·∫≠p" class="level1">
<h1>L·ª±a ch·ªçn CLB/Ph√≤ng t·∫≠p</h1>
<p>N·∫øu th·∫•y th√≠ch BJJ th√¨ b·∫°n n√™n commit t·ªõi m·ªôt ph√≤ng t·∫≠p. D∆∞·ªõi ƒë√¢y l√† c√°c ti√™u ch√≠:</p>
<ul>
<li>Kh√¥ng kh√≠ (Vibe): Th·∫•y h·ª£p kh√¥ng (jibe with the vibe), c√°c th√†nh vi√™n c√≥ th√¢n thi·ªán kh√¥ng. Trang thi·∫øt b·ªã c√≥ s∆° s√†i, c√≥ m√πi hay kh√¥ng?;</li>
<li>Ch·∫•t l∆∞·ª£ng (Quality): C√≥ nƒÉng l·ª±c t·ªï ch·ª©c t·ªët hay kh√¥ng? H·ªç focus v√†o Jiu-jitsu hay c√°c m√¥n kh√°c n·ªØa? Ng∆∞·ªùi ch·ªß c√≥ ƒëai ƒëen hay kh√¥ng? H·ªç ƒë√†o t·∫°o BJJ bao l√¢u r·ªìi?;</li>
<li>ƒê·ªãa ƒëi·ªÉm (Location): Thu·∫≠n ti·ªán cho b·∫°n hay kh√¥ng?;</li>
<li>Chi ph√≠ (Cost): C√≥ ph√π h·ª£p v·ªõi b·∫°n hay kh√¥ng?.</li>
</ul>
</section>
<section id="c√°c-quy-t·∫Øc-l·ªãch-s·ª±" class="level1">
<h1>C√°c quy t·∫Øc l·ªãch s·ª±</h1>
<section id="t·ªïng-quan" class="level2">
<h2 class="anchored" data-anchor-id="t·ªïng-quan">T·ªïng quan</h2>
<p>H√£y l·ªãch s·ª≠ v√† tu√¢n th·ªß c√°c quy t·∫Øc. B·∫°n ƒëang tham gia m·ªôt c·ªông ƒë·ªìng ƒëang c·ªë g·∫Øng c·∫£i thi·ªán k·ªπ nƒÉng c·ªßa h·ªç, ch·ª© kh√¥ng ph·∫£i chi·∫øn ƒë·∫•u ƒë·ªÉ ƒë·ª©ng ƒë·∫ßu theo ki·ªÉu c·ªßa b·∫°n.</p>
</section>
<section id="v·ªá-sinh-v√†-s·ª©c-kh·ªèe" class="level2">
<h2 class="anchored" data-anchor-id="v·ªá-sinh-v√†-s·ª©c-kh·ªèe">V·ªá sinh v√† s·ª©c kh·ªèe</h2>
<ul>
<li>ƒê·ª´ng ƒë·∫øn ph√≤ng t·∫≠p n·∫øu b·∫°n ·ªëm ho·∫∑c c√≥ virus ho·∫∑c b·ªánh truy·ªÅn nhi·ªÖm kh√°c;</li>
<li>Mang d√©p ho·∫∑c gi√†y ngo√†i th·∫£m, ƒëi ch√¢n ƒë·∫•t tr√™n th·∫£m;</li>
<li>Gi·∫∑t, v·ªá sinh ƒë·ªì t·∫≠p sau m·ªói bu·ªïi h·ªçc;</li>
<li>C·∫Øt g·ªçn ng√≥n ch√¢n / tay ƒë·ªÉ tr√°nh l√†m b·ªã th∆∞∆°ng b·∫°n t·∫≠p;</li>
<li>S·ª≠ d·ª•ng x·ªãt kh·ª≠ m√πi, n∆∞·ªõc s√∫c mi·ªáng n·∫øu c·∫ßn;</li>
<li>Tr∆∞·ªõc bu·ªïi t·∫≠p n·∫øu c√≥ m·ªì h√¥i ho·∫∑c m√πi, h√£y t·∫Øm tr∆∞·ªõc;</li>
<li>T·∫Øm c√†ng s·ªõm c√†ng t·ªët sau bu·ªïi t·∫≠p ƒë·ªÉ tr√°nh nhi·ªÖm tr√πng da;</li>
<li>Ch√∫ √Ω ƒë·∫øn da, n·∫øu c√≥ v·∫•n ƒë·ªÅ h√£y ng·ª´ng t·∫≠p v√† g·∫∑p b√°c sƒ©.</li>
</ul>
</section>
<section id="t·∫≠p-luy·ªán-kƒ©-thu·∫≠t-drilling" class="level2">
<h2 class="anchored" data-anchor-id="t·∫≠p-luy·ªán-kƒ©-thu·∫≠t-drilling">T·∫≠p luy·ªán kƒ© thu·∫≠t (Drilling)</h2>
<ul>
<li>Chia ƒë·ªÅu th·ªùi gian c·ªßa b·∫°n v√† b·∫°n t·∫≠p;</li>
<li>Ch·ªâ n√™n ƒë∆∞a ra l·ªùi khuy√™n khi b·∫°n th·ª±c s·ª± t·ª± tin, n·∫øu kh√¥ng th√¨ nghe coach (ND: Bi·∫øt th√¨ th∆∞a th·ªët, kh√¥ng bi·∫øt d·ª±a c·ªôt m√† nghe);</li>
<li>M·ª•c ti√™u l√† t·∫≠p luy·ªán c√°c ƒë·ªông t√°c trong ƒëi·ªÅu ki·ªán kh√¥ng c√≥ √°p l·ª±c t·ª´ ƒë·ªëi th·ªß. N√™n ƒë·ª´ng t·∫°o √°p l·ª±c qu√° nhi·ªÅu cho b·∫°n t·∫≠p, c≈©ng kh√¥ng n√™n qu√° tho·∫£i m√°i nh∆∞ m·ªôt ng∆∞·ªùi n·ªôm;</li>
<li>T·∫≠p trung v√†o c√°c chuy·ªán ƒë·ªông (movement) h∆°n l√† ƒë·∫°t ƒë∆∞·ª£c k·∫øt qu·∫£ c·ªßa ƒë·ªông t√°c.</li>
</ul>
</section>
<section id="t·∫≠p-luy·ªán-ƒë·ªëi-kh√°ng-rolling" class="level2">
<h2 class="anchored" data-anchor-id="t·∫≠p-luy·ªán-ƒë·ªëi-kh√°ng-rolling">T·∫≠p luy·ªán ƒë·ªëi kh√°ng (Rolling)</h2>
<ul>
<li>B·∫°n c√≥ quy·ªÅn t·ª´ ch·ªëi vi·ªác roll v·ªõi b·∫•t c·ª© ai, trong b·∫•t c·ª© th·ªùi ƒëi·ªÉm n√†o, ho·∫∑c b·∫•t k√¨ l√≠ do n√†o. H·ªç c√≥ th·ªÉ kh√¥ng th√≠ch ho·∫∑c cho r·∫±ng n√≥ thi·∫øu l·ªãch s·ª±, nh∆∞ng, b·∫°n c√≥ quy·ªÅn;</li>
<li>Ng∆∞·ªùi ta th∆∞·ªùng ƒë·∫≠p v√† c·ª•ng ta (hand slap and dump) ƒë·ªÉ ƒë√°nh d·∫•u cho m·ªôt ca roll b·∫Øt ƒë·∫ßu;</li>
<li>C·∫£m ∆°n b·∫°n t·∫≠p sau m·ªói l·∫ßn roll, b·∫•t k·ªÉ n√≥ k·∫øt th√∫c nh∆∞ th·∫ø n√†o;</li>
<li>M·ª•c ti√™u c·ªßa roll l√† h·ªçc h·ªèi ch·ª© kh√¥ng ph·∫£i chi·∫øn th·∫Øng, ƒë·ªÉ d√†nh c√°i ham mu·ªën ƒë√≥ cho c√°c tr·∫≠n ƒë√°nh th·ª±c s·ª±;</li>
<li>ƒêi·ªÅu t·ªá nh·∫•t b·∫°n c√≥ th·ªÉ l√†m l√† g√¢y ra ch·∫•n th∆∞∆°ng cho b·∫°n t·∫≠p;</li>
<li>M·ªôt s·ªë th·∫ø submission c√≥ th·ªÉ chuy·ªÉn t·ª´ kh√¥ng ƒëau cho t·ªõi t·∫°o ra ch·∫•n th∆∞∆°ng nghi√™m tr·ªçng nh·∫•t nhanh. Trong c√°c tr∆∞·ªùng h·ª£p ƒë√≥, h√£y si·∫øt l·ª±c ch·∫≠m l·∫°i ƒë·ªÉ t·∫°o th·ªùi gian cho b·∫°n t·∫≠p tap-out;</li>
<li>Khi roll v·ªõi m·ªôt b·∫°n t·∫≠p nh·ªè h∆°n m√¨nh nhi·ªÅu, ƒë·ª´ng c·ªë g·∫Øng d√πng tr·ªçng l∆∞·ª£ng ƒë·ªÉ ƒë√® h·ªç xu·ªëng. M·ª•c ti√™u l√† h·ªçc h·ªèi, v√† 5 ph√∫t ƒë√® nh∆∞ v·∫≠y v√† ch·∫£ ai h·ªçc ƒë∆∞·ª£c g√¨ c·∫£. H√£y c·ªë linh ho·∫°t nhi·ªÅu t∆∞ th·∫ø;</li>
<li>C√°c va ch·∫°m t√¨nh c·ªù v√†o c√°c v√πng nh·∫°y c·∫£m l√† ƒëi·ªÅu b√¨nh th∆∞·ªùng trong c√°c m√¥n v·∫≠t. C·ª© ti·∫øp t·ª•c roll ho·∫∑c n√≥i ‚ÄúSorry‚Äù n·∫øu b·∫°n mu·ªën, kh√¥ng n√™n gi·∫£i th√≠ch d√†i d√≤ng v√† n√™n t·∫≠p trung v√†o t·∫≠p luy·ªán.</li>
</ul>
</section>
</section>
<section id="t·ªïng-quan-c√°c-v·ªã-tr√≠-trong-bjj" class="level1">
<h1>T·ªïng quan c√°c v·ªã tr√≠ trong BJJ</h1>
<p>Jiu-jitsu c√≥ phong ph√∫ c√°c th·∫ø, t∆∞ th·∫ø chi·∫øn ƒë·∫•u (configurations and positions). M·ªói t∆∞ th·∫ø, ƒë·ªëi v·ªõi c·∫£ b·∫°n v√† b·∫°n t·∫≠p ƒë·ªÅu s·∫Ω c√≥ c√°c chi·∫øn l∆∞·ª£c, k·ªπ thu·∫≠t kh√°c nhau.</p>
<p>M·ªói th·∫ø s·∫Ω t∆∞∆°ng ∆∞ng l√† s·ª± chi·∫øm ∆∞u th·∫ø cho m·ªôt c√° nh√¢n, v√† s·ª± th·∫•t th·∫ø cho m·ªôt b√™n c√≤n l·∫°i. ƒê·ªëi v·ªõi ng∆∞·ªùi chi·∫øm ∆∞u th·∫ø, b·∫°n ƒëang t·∫•n c√¥ng, ng∆∞·ª£c l·∫°i, b·∫°n ƒëang trong vai tr√≤ ph√≤ng th·ªß. (ND) S·ª± ch√™nh l·ªách gi·ªØa ∆∞u / th·∫•t th·∫ø c≈©ng s·∫Ω kh√°c nhau cho c√°c th·∫ø ƒë√°nh kh√°c nhau. M·ªói ng∆∞·ªùi ƒë·ªÅu s·∫Ω c·ªë g·∫Øng d√πng c√°c chi·∫øn l∆∞·ª£c v√† kƒ© thu·∫≠t ƒë·ªÉ t·∫°o l·ª£i th·∫ø cho b·∫£n th√¢n.</p>
<p>D∆∞·ªõi ƒë√¢y l√† m·ªôt s·ªë th·∫ø nh∆∞ v·∫≠y, b·∫°n kh√¥ng c·∫ßn ghi nh·ªõ, b·∫°n s·∫Ω ƒë∆∞·ª£c d·∫°y theo th·ªùi gian:</p>
<p><em>All photos below credit to orginal post.</em></p>
<section id="closed-guard" class="level2">
<h2 class="anchored" data-anchor-id="closed-guard">Closed Guard</h2>
<p>Closed Guard l√† t∆∞ th·∫ø ph·ªë bi·∫øn nh·∫•t cho ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu, hai ch√¢n b·∫°n s·∫Ω v√≤ng qua h√¥ng (waist) ƒë·ªëi th·ªß v√† d√πng m·∫Øt c√° ch√¢n kh√≥a (ankles) l·∫°i. L·ª£i th·∫ø thu·ªôc v·ªÅ ng∆∞·ªùi ·ªü tr√™n (b·∫°n t·∫≠p c·ªßa b·∫°n).</p>
<p>Trong Jiu-jitsu, ‚Äúguard‚Äù mang nghƒ©a t∆∞∆°ng t·ª± nh∆∞ ‚Äúch√¢n‚Äù, t∆∞ th·∫ø n√†y ƒë∆∞·ª£c g·ªçi nh∆∞ v·∫≠y v√¨ b·∫°n d√πng ch√¢n kh√≥a k√≠n ƒë·ªëi th·ªß.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-29-bjj-beginners-guide/closed_guard.png" class="img-fluid figure-img"></p>
<figcaption>Closed Guard</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="open-guard" class="level2">
<h2 class="anchored" data-anchor-id="open-guard">Open Guard</h2>
<p>Khi ng∆∞·ªùi ·ªü tr√™n c√≥ th·ªÉ tho√°t, g·ª° ƒë∆∞·ª£c m√≥c n·ªëi gi·ªØa hai m·∫Øt c√° ch√¢n, s·∫Ω h√¨nh th√†nh n√™n t∆∞ th·∫ø Open Guard. L√∫c n√†y ‚Äúguard‚Äù ƒë√£ ƒë∆∞·ª£c ‚Äúopen‚Äù, t∆∞ th·∫ø n√†y r·∫•t linh ƒë·ªông v√† c√≥ nhi·ªÅu bi·∫øn th·ªÉ / t√™n g·ªçi cho t·ª´ng v·ªã tr√≠ c·ª• th·ªÉ, nh∆∞ <em>Spider Guard</em> hay <em>Lasso Guard</em>. Nh√¨n chung t∆∞ th·∫ø n√†y kh√¥ng c√≥ l·ª£i cho c·∫£ hai ng∆∞·ªùi.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-29-bjj-beginners-guide/open_guard.png" class="img-fluid figure-img"></p>
<figcaption>Open Guard</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="side-control" class="level2">
<h2 class="anchored" data-anchor-id="side-control">Side Control</h2>
<p>Khi m·ªôt ng∆∞·ªùi c√≥ th·ªÉ v√≤ng qua ch√¢n c·ªßa ng∆∞·ªùi ph√≠a d∆∞·ªõi v√† ki·ªÉm so√°t th√¢n m√¨nh (torso) th√¨ ng∆∞·ªùi ƒë√≥ ƒë∆∞·ª£c xem l√† ƒë√£ ‚Äúpassed the guard‚Äù, ƒë·ªông t√°c n√†y k·∫øt th√∫c b·∫±ng t·ª´ th·∫ø Side Control. L·ª£i th·∫ø thu·ªôc v·ªÅ ng∆∞·ªùi ƒë√≥ - ng∆∞·ªùi ·ªü tr√™n.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-29-bjj-beginners-guide/side_control.png" class="img-fluid figure-img"></p>
<figcaption>Side Control</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="mount" class="level2">
<h2 class="anchored" data-anchor-id="mount">Mount</h2>
<p>N·∫øu ng∆∞·ªùi ·ªü tr√™n c√≥ th·ªÉ gi√†nh ƒë∆∞·ª£c nhi·ªÅu quy·ªÅn ki·ªÉm so√°t h∆°n, h·ªç c√≥ th·ªÉ ng·ªìi l√™n ph·∫ßn b·ª•ng (hips) ho·∫∑c ng·ª±c (chest), t∆∞ th·∫ø n√†y ƒë∆∞·ª£c g·ªçi l√† Mount v√† n√≥ <em>c·ª±c k√¨</em> c√≥ l·ª£i cho ng∆∞·ªùi ·ªü tr√™n.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-29-bjj-beginners-guide/mount.png" class="img-fluid figure-img"></p>
<figcaption>Mount</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="back" class="level2">
<h2 class="anchored" data-anchor-id="back">Back</h2>
<p>Con ng∆∞·ªùi gi·ªèi chi·∫øn ƒë·∫•u v·ªõi c√°c m·ªëi ƒëe d·ªça ƒë·∫øn tr∆∞·ªõc m·∫∑t m√¨nh h∆°n l√† t·ª´ ƒë·∫±ng sau. V√¨ th·∫ø l·∫•y l∆∞ng l√† m·ªôt t∆∞ th·∫ø t·ªët cho vi·ªác t·∫•n c√¥ng, v√† b·ªã l·∫•y l∆∞ng s·∫Ω t·∫°o ra s·ª± th·∫•t th·∫ø c·ª±c l·ªõn cho vi·ªác ph√≤ng ng·ª±.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-29-bjj-beginners-guide/back.png" class="img-fluid figure-img"></p>
<figcaption>Back</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="turtle" class="level2">
<h2 class="anchored" data-anchor-id="turtle">Turtle</h2>
<p>T∆∞ th·∫ø con r√πa mang l·∫°i m·ªôt ch√∫t l·ª£i th·∫ø cho ng∆∞·ªùi ·ªü tr√™n. G·ªçi l√† con r√πa b·ªüi v√¨ t∆∞ th·∫ø c·ªßa ng∆∞·ªùi ·ªü d∆∞·ªõi.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-29-bjj-beginners-guide/turtle.png" class="img-fluid figure-img"></p>
<figcaption>Turtle</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="half-guard" class="level2">
<h2 class="anchored" data-anchor-id="half-guard">Half Guard</h2>
<p>Khi m·ªôt ng∆∞·ªùi c√≥ th·ªÉ d√πng ch√¢n kh·ªëng ch·∫ø ƒë∆∞·ª£c m·ªôt ch√¢n (thay v√¨ t·ª´ ph·∫ßn h√¥ng v√† hai ch√¢n) c·ªßa ƒë·ªëi th·ªß, t·ª´ ph√≠a d∆∞·ªõi, ta g·ªçi ƒë√≥ l√† Half Guard. Ai c√≥ l·ª£i th·∫ø c√≤n t√πy thu·ªôc v√†o t·ª´ng tr∆∞·ªùng h·ª£p c·ª• th·ªÉ</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-29-bjj-beginners-guide/half_guard.png" class="img-fluid figure-img"></p>
<figcaption>Half Guard</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="l√†m-sao-ƒë·ªÉ-ti·∫øn-b·ªô" class="level1">
<h1>L√†m sao ƒë·ªÉ ti·∫øn b·ªô</h1>
<section id="ch·∫•p-nh·∫≠n-th·∫•t-b·∫°i-nh·∫•t-l√†-khi-ch·ªâ-m·ªõi-b·∫Øt-ƒë·∫ßu" class="level2">
<h2 class="anchored" data-anchor-id="ch·∫•p-nh·∫≠n-th·∫•t-b·∫°i-nh·∫•t-l√†-khi-ch·ªâ-m·ªõi-b·∫Øt-ƒë·∫ßu">Ch·∫•p nh·∫≠n th·∫•t b·∫°i, nh·∫•t l√† khi ch·ªâ m·ªõi b·∫Øt ƒë·∫ßu</h2>
<ul>
<li>R·∫•t l√† b√¨nh th∆∞·ªùng n·∫øu b·∫°n c·∫£m th·∫•y m√¨nh t·ªá. B·∫°n ƒëang ƒë√†o s√¢u v√†o m·ªôt lƒ©nh v·ª±c s√¢u v√† ph·ª©c t·∫°p, ngay c·∫£ ƒëai ƒëen c≈©ng c√≥ l√∫c nh·∫≠n th·∫•y nhi·ªÅu th·ª© h·ªç ch∆∞a th·ªÉ hi·ªÉu ƒë∆∞·ª£c;</li>
<li>N·∫øu b·∫°n kh√¥ng c√≥ kinh nghi·ªáp v·∫≠t (grappling) tr∆∞·ªõc ƒë√≥, 12 th√°ng ƒë·∫ßu ti√™n b·∫°n s·∫Ω h·ªçc 108 c√°c phong c√°ch tap-out kh√°c nhau. V·∫≠y n√™n ƒë·ª´ng ƒëo l∆∞·ªùng m·ª©c ƒë·ªô ti·∫øn b·ªô c·ªßa b·∫°n b·∫±ng c√°c chi·∫øn th·∫Øng, m√† n√™n l√† c√°ch b·∫°n c·∫£i thi·ªán vi·ªác ph√≤ng th·ªß;</li>
<li>H√£y khi√™m t·ªën v√† h·ªçc c√°ch tr√¢n tr·ªçng t·ª´ng s·ª± ti·∫øn b·ªô, t·∫≠p trung v√†o h·ªçc h·ªèi thay v√¨ k·∫øt qu·∫£ cu·ªëi c√πng. T·∫•t c·∫£ nh·ªØng g√¨ b·∫°n c√≥ th·ªÉ ƒë·∫°t ƒë∆∞·ª£c l√† m·ªôt ch√∫t ti·∫øn b·ªô m·ªói ng√†y, ai c≈©ng th·∫ø, ngay c·∫£ khi b·∫°n kh√¥ng ch·ª©ng ki·∫øn.</li>
</ul>
</section>
<section id="vi·ªác-khai-tri·ªÉn-kƒ©-thu·∫≠t-kh√≥-h∆°n-r·∫•t-nhi·ªÅu-khi-roll" class="level2">
<h2 class="anchored" data-anchor-id="vi·ªác-khai-tri·ªÉn-kƒ©-thu·∫≠t-kh√≥-h∆°n-r·∫•t-nhi·ªÅu-khi-roll">Vi·ªác khai tri·ªÉn kƒ© thu·∫≠t kh√≥ h∆°n r·∫•t nhi·ªÅu khi Roll</h2>
<ul>
<li>B·∫°n c√≥ th·ªÉ h·ªçc ƒë∆∞·ª£c m·ªôt kƒ© thu·∫≠t v√† th·ª±c h√†nh n√≥ m·ªôt c√°ch m∆∞·ª£t m√† khi ƒë·ªëi th·ªß g·∫ßn nh∆∞ kh√¥ng kh√°ng c·ª± khi t·∫≠p luy·ªán;</li>
<li>Nh∆∞ng khi v√†o live roll th√¨ kh√°c, khi ƒë·ªëi th·ªß bi·∫øt b·∫°n mu·ªën l√†m g√¨, b·∫°n s·∫Ω th·∫≠m ch√≠ kh√¥ng th·∫ø th·ª±c hi·ªán ƒë∆∞·ª£c b∆∞·ªõc ƒë·∫ßu ti√™n v√† m·ªçi th·ª© ƒë·ªÅu ƒëi ch·ªách kh·ªèi h∆∞·ªõng. Ho·∫∑c, b·∫°n c≈©ng c·∫£m th·∫•y ƒë·∫ßu √≥c b·∫°n ho√†n to√†n tr·ªëng r·ªóng (ND: h√†nh ƒë·ªông theo b·∫£n nƒÉng);</li>
<li>ƒêi·ªÅu n√†y l√† ho√†n to√†n b√¨nh th∆∞·ªùng, h·ªçc c√°c b∆∞·ªõc c∆° b·∫£n l√† kh·ªüi ƒë·∫ßu cho h√†nh tr√¨nh d√†i ƒë·ªÉ tr·ªü n√™n th√†nh th·∫°o. H√£y ki√™n nh·∫´n nghi√™n c·ª©u xem m√¨nh ƒë√£ l√†m ch∆∞a ƒë√∫ng ·ªü b∆∞·ªõc n√†o, v√† ti·∫øp t·ª•c th·ª±c h√†nh.</li>
</ul>
</section>
<section id="l√†m-sao-ti·∫øn-b·ªô-m·ªôt-c√°ch-c√≥-hi·ªáu-qu·∫£" class="level2">
<h2 class="anchored" data-anchor-id="l√†m-sao-ti·∫øn-b·ªô-m·ªôt-c√°ch-c√≥-hi·ªáu-qu·∫£">L√†m sao ti·∫øn b·ªô m·ªôt c√°ch c√≥ hi·ªáu qu·∫£</h2>
<ul>
<li>H√£y ƒë·∫∑t c√¢u h·ªèi cho coach;</li>
<li>H√£y h·ªèi c√°c ti·ªÅn b·ªëi ƒëi tr∆∞·ªõc, nh·ªõ r·∫±ng c·∫ßn ph·∫£i t√¥n tr·ªçng th·ªùi gian c·ªßa h·ªç;</li>
<li>H√£y xem c√°c video h∆∞·ªõng d·∫´n, t√†i nguy√™n r·∫•t phong ph√∫ tr√™n Youtube. C·∫©n th·∫≠n v·ªõi click-bait v√† video-brain - h√£y xem c√≥ ch·ªçn l·ªçc:</li>
<li>Click-bait: nh·ªù thu·∫≠t to√°n c·ªßa Youtube m√† c√°c video v·ªõi ti√™u ƒë·ªÅ ‚Äòlearn this unstoppable sweep‚Äô ho·∫∑c ‚Äònever get submitted again ever‚Äô s·∫Ω xu·∫•t hi·ªán r·∫•t nhi·ªÅu. Nh·ªØng th·ª© n√†y kh√¥ng ch√≠nh x√°c, h√£y h·ªçc nh·ªØng th·ª© basic. Nh·ªØng th·ª© tr√¥ng fancy s·∫Ω kh√¥ng ph√π h·ª£p v·ªõi m·ª©c ƒë·ªô kƒ© nƒÉng c·ªßa b·∫°n ƒë√¢u;</li>
<li>Video-brain: r·∫•t d·ªÖ ƒë·ªÉ xem h·∫øt hai ba ch·ª•c video youtube v·ªÅ c√°c k·ªπ thu·∫≠t submissions, escapes. Nh∆∞ng n√£o b·ªô b·∫°n s·∫Ω kh√¥ng th·ªÉ h·∫•p thu h·∫øt ƒë∆∞·ª£c ch·ª´ng ƒë·∫•y c√°c k·ªπ thu·∫≠t m·ªôt c√°ch chi ti·∫øt. N·∫øu b·∫°n mu·ªën √°p d·ª•ng trong rolling, b·∫°n s·∫Ω th·∫•y ƒë·∫ßu ong ong v√† nh·ª©c nh·ª©c khi c·ªë nh·ªõ v·ªÅ k·ªπ thu·∫≠t n√†o ƒë√≥ ƒë√£ xem trong video n√†o ƒë√≥ trong h√†ng ch·ª•c c√°i video kh√°c. H√£y ƒëi s√¢u thay v√¨ ƒëi r·ªông (recommended to go deep rather than broad). Xem nhi·ªÅu video cho c√πng m·ªôt kƒ© thu·∫≠t, ho·∫∑c xem m·ªôt video l·∫∑p l·∫°i nhi·ªÅu l·∫ßn v√† c·ªë g·∫Øng ti·∫øp thu tr∆∞·ªõc khi move on.</li>
<li>Y√™u c·∫ßu c√°c b·∫°n t·∫≠p open mat h·ªçc m·ªôt kƒ© thu·∫≠t c·ª• th·ªÉ h∆°n l√† rolling. Rolling mang l·∫°i cho b·∫°n kinh nghi·ªám, nh∆∞ng n√≥ s·∫Ω r·∫•t lo√£ng. N·∫øu b·∫°n t·∫≠p m·ªôt t∆∞ th·∫ø guard ho·∫∑c m·ªôt k·ªπ thu·∫≠t v·ªõi nhi·ªÅu b·∫°n t·∫≠p kh√°c nhau trong m·ªôt th·ªùi gian ng·∫Øn, b·∫°n s·∫Ω th·∫•y s·ª± c·∫£i thi·ªán r√µ r·ªát. H√£y b·∫Øt ƒë·∫ßu v·ªõi t∆∞ th·∫ø m√† b·∫°n ch∆∞a th√†nh th·∫°o v√† reset n·∫øu m·ªôt trong hai tho√°t ƒë∆∞·ª£c kh·ªèi ƒë√≥. T·∫•t nhi√™n c≈©ng n√™n h·ªèi b·∫°n t·∫≠p xem h·ªç mu·ªën t·∫≠p kƒ© thu·∫≠t n√†o;</li>
<li>Sau m·ªói bu·ªïi t·∫≠p, h√£y nghƒ© v·ªÅ nh·ªØng th·ª© m√¨nh ch∆∞a l√†m ƒë∆∞·ª£c khi roll. H√£y ch·ªçn 1, 2 ch·ªß ƒë·ªÅ trong ƒë√≥ ƒë·ªÉ t·ª± h·ªçc qua video, bu·ªïi sau b·∫°n c√≥ th·ªÉ th·ª±c h√†nh cho t·ªõi khi th·∫•y c√≥ c·∫£i thi·ªán. C·ª© th·∫ø ti·∫øp t·ª•c m·ªôt chu tr√¨nh nh∆∞ v·∫≠y.</li>
</ul>
</section>
</section>
<section id="trang-b·ªã-ph·ª•-ki·ªán" class="level1">
<h1>Trang b·ªã, ph·ª• ki·ªán</h1>
<section id="gi" class="level2">
<h2 class="anchored" data-anchor-id="gi">Gi</h2>
<p>B·∫°n c√≥ th·ªÉ mua Gi online ho·∫∑c ·ªü ngay ph√≤ng t·∫≠p. Tuy nhi√™n mua online s·∫Ω r·∫ª h∆°n. C√≥ m·ªôt s·ªë ph√≤ng t·∫≠p s·∫Ω y√™u c·∫ßu mua Gi ho·∫∑c patch.</p>
<p>H√£y ki·ªÉm tra kƒ© size chart, nh·∫•t l√† n√™n h·ªèi nh·ªØng <em>b·∫°n t·∫≠p c√≥ c√πng k√≠ch th∆∞·ªõc v·ªõi m√¨nh</em>. C≈©ng n√™n nh·ªõ r·∫±ng size chart c√≥ th·ªÉ kh√°c nhau cho c√°c brand kh√°c nhau.</p>
</section>
<section id="rashguard-for-no-gi" class="level2">
<h2 class="anchored" data-anchor-id="rashguard-for-no-gi">Rashguard (for No Gi)</h2>
<p>TODO</p>
</section>
<section id="qu·∫ßn-√°o-l√≥t-underclothes" class="level2">
<h2 class="anchored" data-anchor-id="qu·∫ßn-√°o-l√≥t-underclothes">Qu·∫ßn √°o l√≥t (Underclothes)</h2>
<p>ƒê·ªëi v·ªõi Gi, b·∫°n c√≥ th·ªÉ m·∫∑c ƒë·ªì l√≥t d∆∞·ªõi Gi (ND: v√¨ √°o Gi c√≥ th·ªÉ b·ªã k√©o bung trong l√∫c t·∫≠p luy·ªán v√† b·∫°n kh√¥ng mu·ªën ƒë·ªÉ ng·ª±c tr·∫ßn). B·∫°n c√≥ th·ªÉ d·ªÖ d√†ng t√¨m c√°c elastic/compression shirts v√† pants (spat) online. H√£y nh·ªõ r·∫±ng ch√∫ng c√≥ th·ªÉ b·ªã n·∫Øm/k√©o (ND: nh∆∞ l√† m·ªôt ph·∫ßn c·ªßa c√°c kƒ© thu·∫≠t luy·ªán t·∫≠p v·ªõi Gi), v√† c√≥ th·ªÉ l√†m b·∫°n n√≥ng n·ª±c.</p>
<p>Trong thi ƒë·∫•u, nam <em>kh√¥ng ƒë∆∞·ª£c</em> m·∫∑c g√¨ d∆∞·ªõi √°o Gi (Gi top). C√≤n n·ªØ th√¨ <em>ph·∫£i m·∫∑c</em> compression shirt, gymnast top, ho·∫∑c one-piece swimsuit.</p>
</section>
<section id="b·∫£o-v·ªá-h√†m-mounthguard" class="level2">
<h2 class="anchored" data-anchor-id="b·∫£o-v·ªá-h√†m-mounthguard">B·∫£o v·ªá h√†m (Mounthguard)</h2>
<p>M·∫∑c d√π kh√¥ng ph·∫£i l√† m√¥n v·ªÅ ƒë·∫•m / ƒë√° (striking), s·∫Ω v·∫´n c√≥ kh·∫£ nƒÉng ƒë·ªëi th·ªß, b·∫°n t·∫≠p c·ªßa b·∫°n ƒë√°nh tr√∫ng m·∫∑t ho·∫∑c si·∫øt v√†o h√†m c·ªßa b·∫°n. Do ƒë√≥, vi·ªác ƒëeo b·∫£o v·ªá h√†m s·∫Ω gi√∫p h·∫°n ch·∫ø c√°c t·ªïn th∆∞∆°ng t·ªõi h√†m, rƒÉng, m√¥i, l∆∞·ª°i - nh·ªØng t·ªïn th∆∞∆°ng r·∫•t ƒëau v√† kh√≥ h·ªìi ph·ª•c.</p>
</section>
<section id="cup" class="level2">
<h2 class="anchored" data-anchor-id="cup">‚Ä¶ Cup</h2>
<p>M·ªôt s·ªë ng∆∞·ªùi d√πng cup ƒë·ªÉ v√†o v·ªá h√°ng / b·∫πn (crotch), nh∆∞ng n√≥ th·ª±c s·ª± kh√¥ng c·∫ßn thi·∫øt. Cup c√≥ th·ªÉ l√†m t·ªïn th∆∞∆°ng b·∫°n t·∫≠p, v√† b·ªã c·∫•m trong h·∫ßu h·∫øt c√°c tour ƒë·∫•u.</p>
</section>
<section id="b·∫£o-v·ªá-ƒë·∫ßu-headgear" class="level2">
<h2 class="anchored" data-anchor-id="b·∫£o-v·ªá-ƒë·∫ßu-headgear">B·∫£o v·ªá ƒë·∫ßu (Headgear)</h2>
<p>B·∫£o v·ªÅ ƒë·∫ßu s·∫Ω gi√∫p b·∫°n h·∫°n ch·∫ø c√°c t·ªïn th∆∞∆°ng tai - th∆∞·ªùng d·∫´n ƒë·∫øn ‚Äútai s√∫p l∆°‚Äù (cauliflower ear). Tuy nhi√™n n√≥ kh√¥ng ph·ªï bi·∫øn v√† vi·ªác d√πng headgear b·ªã c·∫•m trong c√°c tour ƒë·∫•u. B·∫°n ch·ªâ n√™n d√πng khi ƒë√£ c√≥ c√°c ch·∫•n th∆∞∆°ng v√† mu·ªën ch√∫ng kh√¥ng n·∫∑ng th√™m cho t·ªõi khi l√†nh l·∫°i.</p>
</section>
</section>
<section id="c√°c-t√†i-li·ªáu-kh√°c" class="level1">
<h1>C√°c t√†i li·ªáu kh√°c</h1>
<p><a href="http://www.artemisbjj.com/FAQ/" class="uri">http://www.artemisbjj.com/FAQ/</a></p>


<!-- -->

</section>

 ]]></description>
  <category>bjj</category>
  <guid>https://lktuan.github.io/blog/2024-07-29-bjj-beginners-guide/</guid>
  <pubDate>Sun, 28 Jul 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-07-29-bjj-beginners-guide/sloth_bjj.png" medium="image" type="image/png" height="141" width="144"/>
</item>
<item>
  <title>Another James Powell‚Äôs impromptu talk, summary by Clauder 3.5 Sonnet</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-07-18-claude-summary/</link>
  <description><![CDATA[ 





<p>source: <a href="https://www.youtube.com/watch?v=-z2eqLwVmzw">James Powell - Whatever I Can do to Entertain You in 30 Minutes | PyData London 2022</a></p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-18-claude-summary/James Powell - Whatever I Can do to Entertain You in 30 Minutes _ PyData London 2022 0-35 screenshot.png" class="img-fluid figure-img"></p>
<figcaption>Whatever I Can do to Entertain You in 30 Minutes</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>i was using this extension <a href="https://chromewebstore.google.com/detail/language-reactor/hoombieeljmmljlkjmnheibnpciblicm">Language Reactor</a> to export transcript into Excel and convert it to json. here is data in short:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span>   </span>
<span id="cb1-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"5s"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"okay let me get started i'll give you the"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"7s"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"premise the premise is the issues are not av related the issues are that my"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"12s"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"laptop where i was up until 4am last night writing this talk"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"16s"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"did not boot at all and as a consequence of that my notes that i spent quite a"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"21s"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bit of time putting together are not available to you but i am still on the"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"24s"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hook to keep you entertained for 30 minutes so we're going to see what i can"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"..."</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"..."</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"25:55"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"that makes it possible for us to write code that"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-10">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"25:58"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"put some structuring around the core computation now with that said i hope i"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"26:03"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"was able to entertain you i think we're just at the time that we have"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"26:07"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"thank you everybody i'm james powell hopefully i'll give the real talk"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>and this is summary by Clauder AI:</p>
<p>James Powell‚Äôs impromptu talk at PyData London 2022 covers several key points about Python programming, particularly aimed at data scientists. Here are the main points he‚Äôs trying to convey:</p>
<ol type="1">
<li><strong>Python is more than just APIs and function calls</strong>: Many data scientists focus solely on memorizing APIs (like Pandas or NumPy) without truly understanding the language‚Äôs depth and richness.</li>
<li><strong>Generators are underutilized</strong>: Generators can be powerful tools, especially for simulations or non-closed form operations where each incremental step is computationally expensive.</li>
<li><strong>Lazy vs.&nbsp;Eager computation</strong>: Understanding when to use lazy or eager computation can significantly impact performance, especially in data science tasks.</li>
<li><strong>Functions should not be overused</strong>: There‚Äôs a tendency to create functions for any repeated code, but this isn‚Äôt always the best approach. Powell distinguishes between intentional and coincidental repetition.</li>
<li><strong>Avoid premature abstraction</strong>: Creating functions deep in libraries, especially for data loading, can lead to issues with testing and maintenance. Sometimes, ad-hoc behavior is preferable.</li>
<li><strong>Iteration helpers and intentionality</strong>: Tools like <code>enumerate</code>, <code>zip</code>, and custom iteration helpers can make code more expressive and reveal the programmer‚Äôs intentions more clearly.</li>
<li><strong>Understanding Python conventions</strong>: Looking beyond the surface-level functionality of Python‚Äôs standard library (e.g., <code>itertools</code>) can reveal patterns and conventions that lead to better code.</li>
<li><strong>Code should express human intention</strong>: Loops in data science code often represent human-level processes rather than low-level computations. The code structure should reflect this.</li>
<li><strong>Flexibility in code structure</strong>: Allowing code to diverge when necessary, rather than forcing premature unification, can lead to more maintainable and adaptable codebases.</li>
<li><strong>Critical thinking about basic tools</strong>: Even when using basic Python constructs, data scientists should think deeply about why they‚Äôre using them and what alternatives might exist.</li>
</ol>
<p>Overall, Powell encourages data scientists to look beyond superficial knowledge of Python and its libraries, urging them to understand the language more deeply and use its features more thoughtfully to write more intentional, maintainable, and expressive code.</p>


<!-- -->


 ]]></description>
  <category>python</category>
  <category>pydata</category>
  <guid>https://lktuan.github.io/blog/2024-07-18-claude-summary/</guid>
  <pubDate>Wed, 17 Jul 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-07-18-claude-summary/claude.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>A Prefect Workshop</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-07-17-prefect-workshop/</link>
  <description><![CDATA[ 





<p>üéû Video source: <a href="https://www.youtube.com/watch?v=yIDBsHwTaa8&amp;list=PLGVZCDnMOq0rrhYTNedKKuJ9716fEaAdK&amp;index=4">Dr.&nbsp;Adam Hill - Empower Your Projects with Prefect‚Äôs Pipeline Magic | PyData London 2024</a></p>
<p>‚õè Github repo: <a href="https://github.com/Cadarn/PyData-Prefect-Workshop" class="uri">https://github.com/Cadarn/PyData-Prefect-Workshop</a></p>
<section id="goals" class="level1">
<h1>goals</h1>
<p>by end of this session you will:</p>
<ul>
<li>understand what Prefect is;</li>
<li>build and execute tasks and flows;</li>
<li>have schedules flow using deployment;</li>
<li>have a grasp what else can be done;</li>
<li>have some fun.</li>
</ul>
</section>
<section id="prefect-overview" class="level1">
<h1>prefect overview</h1>
<p>just simple as using jupyter notebook, you only need to use decorators (<code>@task</code> and <code>@flow</code>) to designate functions as <strong>task</strong> for <strong>flow</strong>. you need to breakdown your ‚Äúnotebook‚Äù into ‚Äúcode chunks‚Äù and organize to get them done.</p>
<div id="3aa32d45" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> prefect <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> task, flow</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@task</span></span>
<span id="cb1-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> my_task():</span>
<span id="cb1-5">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello, i am a task!"</span>)</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@flow</span></span>
<span id="cb1-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> my_flow():</span>
<span id="cb1-9">  my_task()</span></code></pre></div>
</details>
</div>
</section>
<section id="jump-to-the-workshop" class="level1">
<h1>jump to the workshop</h1>
<p>clone the repo, have docker compose up and running. then explore <code>http://localhost:8000/get_tweet</code>, this is shown which i have yet no idea:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"tweet_id"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">570306133677760500</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"airline_sentiment"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"neutral"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-4">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"airline_sentiment_confidence"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-5">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"airline"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Virgin America"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-6">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cairdin"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-7">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"text"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"@VirginAmerica What @dhepburn said."</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-8">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"retweet_count"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-9">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"tweet_timestamp"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2015-02-24T11:35:52-08:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-10">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"tweet_coord"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb2-11">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"loop"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>the first thing you need to do is telling where the Prefect API is gonna live. currently it runs on free tier of the their cloud server (?) and now we config it to run in the localhost (?):</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">prefect</span> config set PREFECT_API_URL=<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://127.0.0.1:4200/api"</span></span></code></pre></div>
<p>then we gonna reset the database, do some config then can start the server. please note that if you are using window, you need to add <code>Scripts</code> variable to environment variables also, the value of the path can be found when you install Prefect by <code>pip</code>:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">prefect</span> server database reset <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span></span>
<span id="cb4-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">prefect</span> config set PREFECT_API_DATABASE_CONNECTION_URL=<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"postgresql+asyncpg://postgres:password@localhost:5432/prefect_server"</span></span>
<span id="cb4-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">prefect</span> config view <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--show-sources</span></span>
<span id="cb4-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">prefect</span> server start</span></code></pre></div>
<p>below is my initial dashboard, there is nothing!</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-17-prefect-workshop/initial_prefect_server.png" class="img-fluid figure-img"></p>
<figcaption>Prefect Dashboard</figcaption>
</figure>
</div>
</div>
</div>
</div>
<section id="e01-my-first-flow" class="level2">
<h2 class="anchored" data-anchor-id="e01-my-first-flow">e01 my first flow</h2>
<p>the basic component of prefect is <code>task</code> and <code>flow</code>. these are decorators to funtions we want to run. we can name and log easily:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>e01.py</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-filename="e01.py" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Example of processing some data</span></span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> prefect <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> task, flow</span>
<span id="cb5-3"></span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@task</span>(name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Addition operator"</span>)</span>
<span id="cb5-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> add(a, b):</span>
<span id="cb5-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span>
<span id="cb5-8"></span>
<span id="cb5-9"></span>
<span id="cb5-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@task</span>(name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Squaring operator"</span>)</span>
<span id="cb5-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> square_num(num):</span>
<span id="cb5-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>:</span>
<span id="cb5-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span></span>
<span id="cb5-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb5-15"></span>
<span id="cb5-16"></span>
<span id="cb5-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@flow</span>(log_prints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"My first simple flow"</span>)</span>
<span id="cb5-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> add_and_square(a: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, b: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>):</span>
<span id="cb5-19">    add_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> add(a, b)</span>
<span id="cb5-20">    square_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> square_num(add_result)</span>
<span id="cb5-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"(</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>a<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> + </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">) squared = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>square_result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-22"></span>
<span id="cb5-23"></span>
<span id="cb5-24"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb5-25">    add_and_square(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span></code></pre></div>
</div>
</section>
<section id="e02a-sentiment-pipeline-v1" class="level2">
<h2 class="anchored" data-anchor-id="e02a-sentiment-pipeline-v1">e02a sentiment pipeline v1</h2>
</section>
<section id="e02b-sentiment-pipeline-v2" class="level2">
<h2 class="anchored" data-anchor-id="e02b-sentiment-pipeline-v2">e02b sentiment pipeline v2</h2>
</section>
<section id="e03a-kafka-tweet-publisher" class="level2">
<h2 class="anchored" data-anchor-id="e03a-kafka-tweet-publisher">e03a kafka tweet publisher</h2>
</section>
<section id="e03b-kafka-tweet-deployment" class="level2">
<h2 class="anchored" data-anchor-id="e03b-kafka-tweet-deployment">e03b kafka tweet deployment</h2>
</section>
<section id="e04-sentiment-pipeline-v3" class="level2">
<h2 class="anchored" data-anchor-id="e04-sentiment-pipeline-v3">e04 sentiment pipeline v3</h2>
</section>
</section>
<section id="further-reading" class="level1">
<h1>further reading</h1>
<ol type="1">
<li><a href="https://www.reddit.com/r/dataengineering/comments/oqbiiu/airflow_vs_prefect/">Prefect vs Airflow on Reddit</a></li>
</ol>
<p>B√¨nh lu·∫≠n b·ªüi <strong>u/alexisprince</strong>:</p>
<blockquote class="blockquote">
<p>T√¥i ƒëang s·ª≠ d·ª•ng song song Airflow v√† Prefect (A cho scheduling, P cho execution), P ƒë∆∞·ª£c s·ª≠ d·ª•ng khi y√™u c·∫ßu v·ªÅ hi·ªáu nƒÉng t√≠nh to√°n v√† ph·∫ßn scheduler c·ªßa A v·∫´n ch∆∞a th·ªÉ b·ªã thay th·∫ø.</p>
<p>L·ª£i th·∫ø c·ªßa A l√† ƒë√£ qu√° ph·ªï bi·∫øn, d·ªÖ t√¨m h∆∞·ªõng d·∫´n, d·ªÖ tuy·ªÉn ng∆∞·ªùi cho chuy√™n m√¥n. Y·∫øu ƒëi·ªÉm l√† A ƒë√£ qu√° c≈©, kh√¥ng c√≤n ph√π h·ª£p cho dynamic workflow v√† modern data env. H∆°n n·ªØa A lu√¥n best fit khi s·ª≠ d·ª•ng chung v·ªõi Astronomer, ngo√†i ra kh√° kh√≥ d√πng.</p>
<p>P hi·ªán ƒë·∫°i h∆°n, cung c·∫•p nhi·ªÅu modern execution models, DAG ƒë∆∞·ª£c x√°c ƒë·ªãnh t·∫°i runtime do ƒë√≥ dynamic h∆°n.</p>
<p>Prefer P h∆°n, better modularization of code.</p>
</blockquote>
<p>B√¨nh lu·∫≠n b·ªüi <strong>u/ChrisHC05</strong>:</p>
<blockquote class="blockquote">
<p>Tao ƒë√£ ƒë√°nh gi√° Airflow, Dagster, Argo v√† Prefect m·∫•y th√°ng nay.</p>
<p>Airflow th√¨ ƒë√£ gi√†, tuy nhi√™n t√†i li·ªáu, h∆∞·ªõng d·∫´n r·∫•t phong ph√∫.</p>
<p>Dagster c√≥ v·∫ª g·∫∑p nhi·ªÅu v·∫•n ƒë·ªÅ v·ªõi Production.</p>
<p>Prefect c√≥ c·ªông ƒë·ªìng ph√°t tri·ªÉn, support, s·ª≠a l·ªói active.</p>
<p>V·∫≠y n√™n t√¥i ch·ªâ ƒë√°nh gi√° cao hai th·∫±ng Argo v√† Prefect. Argo kh√°c bi·ªát m·ªôt c√°ch m·∫°nh m·∫Ω, config ƒë∆∞·ª£c vi·∫øt d∆∞·ªõi d·∫°ng YAML, ch·∫°y tr√™n c·ª•m Kubernetes, v√† vi·ªác vi·∫øt DAG kh√¥ng ph·ª• thu·ªôc v√†o m·ªôt ng√¥n ng·ªØ l·∫≠p tr√¨nh n√†o. Argo (t·∫°i th·ªùi ƒëi·ªÉm ƒë√≥) c≈©ng ƒëang ph√°t tri·ªÉn m·ªôt module ki·ªÉu event listening, from outside, nh∆∞ Sensor c·ªßa Airflow, th·ª© m√† Prefect thi·∫øu (workaround l√† call Prefect GraphQL-API).</p>
<p>N·∫øu ƒë√£ c√≥ s·∫µn infra l√† K8S, khuy·∫øn ngh·ªã Argo, kh√¥ng ch·ªâ l√† orchestration m√† c√≤n l√† m·ªôt h·ªá sinh th√°i support t·ª´ event responding t·ªõi CI/CD. Nh∆∞ng learning curve th√¨ steep nh√©. N√≥ c√≥ nhi·ªÅu ti·ªÅm nƒÉng v√¨ gi·ªù th√¨ ph·∫ßn m·ªÅm n√†o c≈©ng c·∫ßn dockerized c·∫£, t√≠nh tr·ª´u t∆∞·ª£ng cao h∆°n. ‚ÄúAnd IT in general is all about abstraction to make complicated things easier.‚Äù</p>
<p>V·∫≠y n√™n:</p>
<ul>
<li>N·∫øu c√≥ s·∫µn c·ª•m K8S: d√πng Argo</li>
<li>N·∫øu kh√¥ng: d√πng Prefect</li>
</ul>
</blockquote>
<ol start="2" type="1">
<li><a href="https://www.youtube.com/watch?v=XrZegcm1ftw">Airflow Vs. Prefect: Full Breakdown! by The Data Guy</a></li>
<li><a href="https://www.horsewithapointyhat.com/posts/being-a-data-scientist-in-a-post-truth-world/">Adam Hill‚Äôs blog</a></li>
</ol>


<!-- -->

</section>

 ]]></description>
  <category>python</category>
  <category>pydata</category>
  <category>prefect</category>
  <guid>https://lktuan.github.io/blog/2024-07-17-prefect-workshop/</guid>
  <pubDate>Tue, 16 Jul 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-07-17-prefect-workshop/adam_hill.png" medium="image" type="image/png" height="179" width="144"/>
</item>
<item>
  <title>Vim 101</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-07-12-vim/</link>
  <description><![CDATA[ 





<p>source: <a href="https://www.youtube.com/watch?v=RZ4p-saaQkc">Vim tutorial for Beginners</a> by freeCodeCamp.</p>
<p>in an effort not to give Vim up from the very first day. inspired by James Powell‚Äôs Vim skill in his every Python lecture.</p>
<p>after a few days of rolling with neovim i already have a somewhat calls sense of how to install, make the <code>nvim</code> config folder, do some <code>git clone</code> stuffs to download a bunch of i have no idea what they are to use vim in my damn window machine. can do <code>nvim file1</code>, <code>:qw</code>, <code>:below terminal</code>, <code>:vsplit</code>, but in general lots of actions i am not yet familiar with so actually could not stick with this editor.</p>
<p>now back to basics, i am spending Friyay night starting from scratch. Florian Dedov uses vim while i use nvim expecting both to be the same.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-12-vim/programmerhumor-io-linux_meme.jpg" class="img-fluid figure-img"></p>
<figcaption>source <a href="https://programmerhumor.io/memes/vim/">programmerhumor</a></figcaption>
</figure>
</div>
</div>
</div>
</div>
<section id="intro-why-vim" class="level1">
<h1>intro &amp; why vim?</h1>
<ul>
<li>less stick with your mouse, speed up your coding speed;</li>
<li>all settings are customizable;</li>
<li>dont need to stick with your terminal, you can use Vim keybindings in any IDE or text editor: Jupyter Notebook, VS Code, etc</li>
</ul>
</section>
<section id="installation" class="level1 page-columns page-full">
<h1>installation</h1>
<ul>
<li>i use window, i dont want to install more package manager like <code>scoop</code>, i dont like to use WSL, so just simply run <code>winget install Neovim.Neovim</code>; </li>
<li>this neovim version will not include <em>Neovim QT</em>, alright, i will use my terminal <code>pwsh</code>;</li>
</ul>
<div class="no-row-height column-margin column-container"><span class="margin-aside">neovim installation <a href="https://github.com/neovim/neovim/blob/master/INSTALL.md">page</a></span></div></section>
<section id="basics" class="level1">
<h1>basics</h1>
<ul>
<li><code>nvim file_name</code> will open a file or create a file if it did not exist (but the file will not be actually created if we dont write <code>:w</code> ~ this is just <strong>buffer</strong>);</li>
</ul>
</section>
<section id="exit" class="level1">
<h1>exit</h1>
<ul>
<li>now if we create a file (e.g.&nbsp;<code>client.py</code>), when we press <code>:q</code> in will return this message:</li>
</ul>
<pre><code>E37: No write since last change
E162: No write since last change for buffer "client.py"   </code></pre>
<ul>
<li>what you need to do is <code>:q!</code> (exclamation mark ~ saying you quite and dismiss any change you‚Äôve made);</li>
<li>notice that <code>q</code> first and <code>!</code> after. <code>:!</code> will open the terminal, so <code>:!q</code> will pass the command <code>q</code> to the terminal (window CMD), which returns ‚Äú<em>‚Äòq‚Äô is not recognized as an internal or external command, operable program or batch file.</em>‚Äù</li>
</ul>
</section>
<section id="insert-and-normal-modes" class="level1">
<h1>insert and normal modes</h1>
<ul>
<li>when we enter vim, we are in <strong>NORMAL</strong> mode. press the <code>i</code> or <code>I</code> will get you into the <strong>INSERT</strong> mode, press <code>esc</code> to enter the <strong>NORMAL</strong> mode;</li>
<li><strong>INSERT</strong> mode: any thing we press does not have functionality, just text;</li>
<li><strong>NORMAL</strong> mode: execute a command;</li>
<li>in normal mode, press <code>:w</code> to save/write file;</li>
<li><code>:wq</code> write and quit;</li>
<li>in <strong>INSERT</strong> mode, cursor points between 2 characters; in <strong>NORMAL</strong> mode cursor points a character;</li>
<li>from <strong>INSERT</strong> mode, press <code>esc</code> and cursor will point to the <strong>up-front</strong> character, press <code>i</code> in the cursor will point to <strong>before</strong> that character, press <code>a</code> and for cursor <strong>after</strong> character;</li>
<li><code>I = shift + i</code> will let you get into insert mode with cursor at the <strong>begin</strong> of the line;</li>
<li><code>A = shift + a</code> for the <strong>end</strong> of the line;</li>
<li>from normal mode, <code>o</code> let you create a new line below and cursor at that line;</li>
<li><code>O = shift + o</code> for creating line above.</li>
</ul>
</section>
<section id="line-numbers" class="level1">
<h1>line numbers</h1>
<ul>
<li>in normal mode, <code>:set number</code> will activate line number;</li>
<li><code>:set nonumber</code> to turn off the line number;</li>
<li>now this is important pattern: ‚Äúan action can be repeated x times‚Äù ~ in normal mode we can move cursor up and down using up and down arrow -&gt; if we press <code>5 + down arrow</code> we will move to the 5th line below;</li>
<li><code>10 + right arrow</code> will move the cursor to 10th character to the right, in the same line (?, or in the end of the line);</li>
<li>you can also use <code>h</code>, <code>j</code>, <code>k</code>, <code>l</code> instead of the arrow keys, they stand for <code>‚¨Ö</code>, <code>‚¨á</code>, <code>‚¨Ü</code>, <code>‚û°</code>, respectively (extremely usefull if you can type with 10 fingers);</li>
</ul>
</section>
<section id="relative-line-numbers" class="level1">
<h1>relative line numbers</h1>
<ul>
<li>certainly you can use <em>number</em> with <code>h</code>, <code>j</code>, <code>k</code>, <code>l</code>. now if you <code>:set relativenumber</code>, you can have your current line indexed as <code>0</code> and easily know the number to move up &amp; down-ward;</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-12-vim/relative_line_number.png" class="img-fluid figure-img"></p>
<figcaption>now if i type <code>14 + k</code> i will move to the 3rd line</figcaption>
</figure>
</div>
</div>
</div>
</div>
<ul>
<li>easy to know that <code>:set norelativenumber</code> will turn this option off.</li>
</ul>
</section>
<section id="various-options" class="level1 page-columns page-full">
<h1>various options</h1>
<ul>
<li><code>:set mouse=a</code> activate the mouse, you can scroll or select text;</li>
<li><code>:set mouse-=a</code> to inactivate, the pattern <code>-=</code> is to inactivate any option;</li>
<li><code>:set tabstop=4</code> set tab as 4 spaces</li>
<li><code>:set shiftwidth=4</code> set shift width as 4 spaces </li>
<li><code>:colorscheme slate</code> to set the color scheme, before type ‚Äústate‚Äù you can tab to select the scheme too (remember the space);</li>
</ul>
<div class="no-row-height column-margin column-container"><span class="margin-aside">this is <a href="https://stackoverflow.com/questions/1878974/redefine-tab-as-4-spaces">recommended</a></span></div><div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-12-vim/choosing_colorscheme.png" class="img-fluid figure-img"></p>
<figcaption><code>:colorscheme</code> and <code>tab</code> to select color scheme</figcaption>
</figure>
</div>
</div>
</div>
</div>
<ul>
<li>every single time you close and re-open vim, these settings is by far - all gone.</li>
</ul>
</section>
<section id="vimrc" class="level1 page-columns page-full">
<h1><code>.vimrc</code></h1>
<ul>
<li>so you need a configuration file and every time vim or nvim is opened your config will be loaded;</li>
<li>neovim will lookfor <code>init.vim</code> or <code>init.lua</code> when start; </li>
<li>in terminal (pwsn in user folder window), input:</li>
</ul>
<div class="no-row-height column-margin column-container"><span class="margin-aside">refer <a href="https://vi.stackexchange.com/questions/13505/where-do-i-put-my-vimrc-file-for-neovim-on-windows">here</a></span></div><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource bass number-lines code-with-copy"><code class="sourceCode"><span id="cb2-1">cd %AppData%</span>
<span id="cb2-2">cd .. # to get out of Roaming folder</span>
<span id="cb2-3">cd .\Local\</span>
<span id="cb2-4">mkdir nvim</span>
<span id="cb2-5">cd nvim</span>
<span id="cb2-6">nvim init.vim</span></code></pre></div>
<ul>
<li>then i set these config in my <code>init.vim</code> file:</li>
</ul>
<div class="sourceCode" id="cb3" data-filname="init.vim" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> number</span>
<span id="cb3-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> relativenumber</span>
<span id="cb3-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> tabstop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb3-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> shiftwidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb3-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> autoindent</span>
<span id="cb3-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> mouse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>a</span>
<span id="cb3-7">colorscheme slate</span></code></pre></div>
<ul>
<li>then <code>:wq</code>. now we‚Äôve already have some handy settings when go into nvim.</li>
</ul>
</section>
<section id="keybindings" class="level1">
<h1>keybindings</h1>
<table class="table-striped table-hover table">
<caption>helpful keybindings</caption>
<colgroup>
<col style="width: 24%">
<col style="width: 75%">
</colgroup>
<thead>
<tr class="header">
<th>Keybindings</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>u</code></td>
<td>undid the actions, vim show ‚Äú‚Ä¶ change; before #x xx seconds ago‚Äù</td>
</tr>
<tr class="even">
<td><code>Ctrl + R</code></td>
<td>redo</td>
</tr>
<tr class="odd">
<td><p><code>ntimes u</code></p>
<p><code>ntimes Ctrl + R</code></p></td>
<td>repeat to press <code>u</code> for multiple undo, or you can <code>3 + u</code> for 3 times undo. same for redo</td>
</tr>
<tr class="even">
<td><code>i</code>, <code>I</code>, <code>a</code>, <code>A</code>, <code>o</code>, <code>O</code></td>
<td>back to insert mode in different ways</td>
</tr>
<tr class="odd">
<td><code>v</code></td>
<td>enter VISUAL mode</td>
</tr>
<tr class="even">
<td><code>V</code></td>
<td>enter VISUAL model and select the whole line</td>
</tr>
<tr class="odd">
<td><code>d</code></td>
<td>deleting</td>
</tr>
<tr class="even">
<td><code>y</code></td>
<td>yanking ~ equivalent to copying</td>
</tr>
<tr class="odd">
<td><code>p</code></td>
<td>pasting what we yank before (<strong>after or below</strong> the cursor)</td>
</tr>
<tr class="even">
<td><code>dd</code></td>
<td>delete the whole line</td>
</tr>
<tr class="odd">
<td><code>5dd</code></td>
<td>delete the next whole 5 lines</td>
</tr>
<tr class="even">
<td><code>D</code></td>
<td>delete from the cursor to the end of line</td>
</tr>
<tr class="odd">
<td><code>yy</code></td>
<td>yank the full line in NORMAL mode, same with <code>V</code> then <code>y</code> ~ select the whole line and yank</td>
</tr>
<tr class="even">
<td><code>Y</code></td>
<td>same at <code>yy</code></td>
</tr>
<tr class="odd">
<td><code>P</code></td>
<td><p>pasting what we yank before (<strong>before or above</strong> the cursor)</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>again remember the pattern of <strong>lowercase</strong> and <strong>uppercase</strong></p>
</div>
</div></td>
</tr>
<tr class="even">
<td><code>c</code></td>
<td>delete the selection (from VISUAL mode) and enter to INSERT mode</td>
</tr>
<tr class="odd">
<td><code>cc</code></td>
<td>delete the whole text in the line (the line was kept) enter to INSERT mode</td>
</tr>
<tr class="even">
<td><code>C</code></td>
<td>delete from cursor to end of line (what <code>c</code> does is change, what <code>d</code> does is delete)</td>
</tr>
<tr class="odd">
<td><code>r</code></td>
<td><p>replacing the current cursor in NORMAL mode with 1 character press after <code>r</code></p>
<p>replacing all selection (include cursor) in VISUAL mode</p></td>
</tr>
<tr class="even">
<td><code>w</code></td>
<td>Jump to the next word (split by space or ‚Äú-‚Äù)</td>
</tr>
<tr class="odd">
<td><code>W</code></td>
<td>Jump to the next word (accept only space at delimiter)</td>
</tr>
<tr class="even">
<td><code>b</code>, <code>B</code></td>
<td>The same thing for <em>backward</em></td>
</tr>
<tr class="odd">
<td><code>dw</code></td>
<td>delete a word</td>
</tr>
<tr class="even">
<td><code>2dw</code> , <code>d2w</code></td>
<td>delete 2 words (forward, current cursor and the next one)</td>
</tr>
<tr class="odd">
<td><code>2db</code>, <code>d2b</code></td>
<td>delete 2 words (backward, <strong>before</strong> the cursor)</td>
</tr>
<tr class="even">
<td><code>diw</code></td>
<td>delete in a words</td>
</tr>
<tr class="odd">
<td><code>ciw</code> , <code>cw</code>, <code>cb</code></td>
<td>change in a words, next word, previous word and go into INSERT mode</td>
</tr>
<tr class="even">
<td><code>e</code></td>
<td>Jump to the end of the word (<code>E</code> will be more strictly, only accept space as delimiter)</td>
</tr>
<tr class="odd">
<td><code>0</code>, <code>$</code></td>
<td>Jump to the begin / and the end of the line respectively</td>
</tr>
<tr class="even">
<td><code>d0</code>, <code>d$</code></td>
<td><p>delete everything from cursor to the begin / end of the line, respectively</p>
<p>-&gt; think of <code>c0</code>, and <code>c$</code> for aha</p></td>
</tr>
<tr class="odd">
<td><code>:h ...</code></td>
<td>seek help, <code>:q</code> to quite the help window</td>
</tr>
</tbody>
</table>
</section>
<section id="intermediate-stuff" class="level1">
<h1>intermediate stuff</h1>
<p><strong>go and cook your meal:</strong></p>
<ul>
<li><p><code>i</code> - <strong>before</strong> and <code>I</code> - <strong>beginning</strong>, <code>a</code> - <strong>after</strong> and <code>A</code> - <strong>ending</strong> for navigating to INSERT mode;</p></li>
<li><p><code>o</code> - <strong>below</strong>, <code>O</code> - <strong>above</strong> to insert line;</p></li>
<li><p><code>u</code> - <strong>undo</strong>, <code>Ctrl + R</code> - <strong>redo</strong>;</p></li>
<li><p><code>v</code> - <strong>individual</strong> visual, <code>V</code> - visual the <strong>whole</strong> line;</p></li>
<li><p><code>y</code> - yanking <strong>current</strong>, <code>Y</code>, <code>yy</code> - yanking <strong>whole</strong> line;</p></li>
<li><p><code>p</code> - pasting <strong>after</strong> or <strong>below</strong>, <code>P</code> - pasting <strong>before</strong> or <strong>above</strong>;</p></li>
<li><p><code>d</code> - deleting <strong>current</strong>, <code>dd</code> - deleting <strong>whole</strong> line, <code>D</code> - deleting to the <strong>end</strong> of line;</p></li>
<li><p><code>c</code> - same with <code>d</code> but for <strong>changing</strong>;</p></li>
<li><p><code>r</code> - replacing <strong>current</strong> with 1 character, <code>R</code> - enter the REPLACE mode and replace with <strong>multiple</strong> characters;</p></li>
<li><p><code>w</code>, <code>W</code> - jump word <strong>forward</strong>, <code>b</code>, <code>B</code> - jump word <strong>backward</strong>;</p></li>
<li><p><code>i</code> - <strong>inside</strong> the word, <code>e</code> - <strong>end</strong> of the word;</p></li>
<li><p><code>0</code> - <strong>begin</strong>, <code>$</code> - <strong>end</strong> of the line;</p></li>
<li><p>repeat by press key <strong>multiple</strong> times or <code>n</code> - number before command;</p></li>
<li><p><code>%</code> - jump to the <strong>closing</strong> bracket if you are on the opening one;</p></li>
<li><p><code>t</code> follow by a character will let you jump cursor to <strong>before</strong> the next nearest one;</p></li>
<li><p><code>f</code> same with <code>t</code>, but to the <strong>character‚Äôs position</strong>;</p></li>
<li><p><code>T</code> and <code>F</code> for the <strong>backward</strong>;</p></li>
<li><p><code>gg</code> - go to the <strong>begin</strong> of the line, <code>G</code> for the <strong>end</strong> of the file;</p></li>
<li><p><code>123G</code> or <code>:123</code> will bring you to the line 123; ‚Ä¶.</p></li>
</ul>
<p><strong>now:</strong></p>
<ul>
<li><p><code>ciw</code> - changing the whole word; but</p></li>
<li><p><code>cib</code> , <code>ciB</code> - changing the text inside the current set of parenthesis () or braces {}, respectively, you can also <code>ci(</code> , <code>ci{</code> , <code>ci&lt;</code> for the specific.</p></li>
<li><p><code>ci"</code> - changing the text inside double quote;</p></li>
<li><p>if you want delete <code>d</code>, or yank <code>y</code> - replace the <code>c</code>;</p></li>
<li><p><code>5dw</code> will delete 5 words, <code>5d5w</code> will delete 5 words 5 times!;</p></li>
<li><p><code>5yy</code> copying 5 lines;</p></li>
<li><p><code>dt(</code> deleting everything up till the opening bracket, <code>df(</code> will delete the bracket also; ‚Ä¶</p></li>
</ul>
<p><strong>even more advanced stuff:</strong></p>
<ul>
<li>indentation: <code>&gt;&gt;</code> to the right, <code>&lt;&lt;</code> to the left;</li>
<li><code>V</code> for Visual Line mode, which will automatically select entire lines;</li>
<li><code>Ctrl + v</code> for Block Visual mode, which will select rectangular regions of the text;</li>
<li><code>=</code> for auto indentation;</li>
<li><code>gg=G</code> will start at the begin of the file, auto indentation till the end of file (and end of at the end of file);</li>
<li><code>/</code> and word follow to search the word, then <code>n</code> to jump to the next found, <code>N</code> to jump to the previous one;</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Re-note about the search:</p>
<ul>
<li><code>/pattern</code> - search for pattern;</li>
<li><code>?pattern</code> - search backward for pattern;</li>
<li><code>\vpattern</code> - ‚Äòvery magic‚Äô pattern: non-alphanumeric characters are interpreted as special regex symbols (no escaping needed);</li>
<li><code>n</code> - repeat search in same direction;</li>
<li><code>N</code> - repeat search in opposite direction;</li>
<li><code>#</code> go up, <code>*</code> go down.</li>
</ul>
</div>
</div>
<ul>
<li><code>ma</code>: mark A -&gt; to explore later;</li>
<li><code>zz</code>: centre the screen;</li>
<li><code>:%s/old/new/g</code> - replace all old with new throughout file;</li>
<li><code>:%s/old/new/gc</code> - replace all old with new throughout file with confirmations (without <code>c</code> is without confirmation);</li>
<li><code>.</code> repeat the last command;</li>
<li><code>"+</code> and <code>"*</code> are the special registers, which you copied in the system</li>
</ul>
</section>
<section id="registers-and-macros" class="level1">
<h1>registers and macros</h1>
<ul>
<li><code>d</code> deleting is also copying ~ cutting, so if you <code>y</code> then <code>d</code> you will lost the current clipboard</li>
<li><code>:reg</code> to see the history of the clipboard;</li>
<li><code>"7p</code> will paste the 7th register;</li>
<li><code>"7yy</code> yanks the whole line into 7th register;</li>
<li><code>"0p</code> the last thing that i actually yanked, not <code>d</code>;</li>
<li><code>qa</code> recording macro <span class="citation" data-cites="a">@a</span>, <code>q</code> quits recording;</li>
<li>you can see the macro in <code>:reg</code>, <code>@a</code> to use the macro; ‚Ä¶</li>
</ul>
</section>
<section id="neovim-plugins" class="level1">
<h1>neovim &amp; plugins</h1>
<ul>
<li>better, have more pluggins supported;</li>
<li>config in <code>./nvim</code> using <code>init.vim</code> or <code>init.lua</code>;</li>
</ul>
</section>
<section id="vim-support" class="level1">
<h1>vim support</h1>
<ul>
<li>can use vim bindings in VS Code, Pycharm</li>
</ul>
</section>
<section id="outro" class="level1">
<h1>outro</h1>
<ul>
<li>it is recommended to use vim bindings while coding, even if you dont like the command line.</li>
</ul>
</section>
<section id="other-resources" class="level1">
<h1>other resources</h1>
<ol type="1">
<li><a href="https://vim.rtorr.com/">Vim cheat sheet</a></li>
<li><a href="https://github.com/junegunn/vim-plug">Vim plug</a></li>
</ol>


<!-- -->

</section>

 ]]></description>
  <category>python</category>
  <category>vim</category>
  <guid>https://lktuan.github.io/blog/2024-07-12-vim/</guid>
  <pubDate>Thu, 11 Jul 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-07-12-vim/vim.png" medium="image" type="image/png" height="127" width="144"/>
</item>
<item>
  <title>Recap: So you want to be a Python expert?</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-07-10-expert-in-python/</link>
  <description><![CDATA[ 





<p>üî• source: <a href="https://www.youtube.com/watch?v=cKPlPJyQrt4"><strong>James Powell: So you want to be a Python expert? | PyData Seattle 2017</strong></a></p>
<section id="what-is-he-gonna-present" class="level1">
<h1>what is he gonna present?</h1>
<ul>
<li>something deeply behind the Zen of Python;</li>
<li>metaphors and programming in Python;</li>
<li>python is not only scripting language, he will be introducing 4 features of Python and the way experts would think about these features;</li>
<li>a lot of fundamental details of how these feature work but very little talk about we can conceptualize these features in the broader sense of what they mean for modeling core problem. so 4 features you might have heared before and couple of the core mental models how you can think about, an how you can think about python as a whole, wrapping everything together;</li>
<li>you will see me stumble to understand that in case you dont utd or dont have docs memorized, it‚Äôs alright, the target is to know what they are and what they mean;</li>
<li>the talk presumes you to have a baseline of Python, but in case you a new to Python he believes there are cores you can take away.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-10-expert-in-python/James Powell_ So you want to be a Python expert_ _ PyData Seattle 2017 5-37 screenshot.png" class="img-fluid figure-img"></p>
<figcaption>James Powell on PyData Seattle 2017</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="data-model-protocol-or-dunder-method" class="level1">
<h1>data model protocol (or dunder method)</h1>
<p>assume we have a data model with Polynomial object intitially do nothing, why I need 4 lines (instead of 2 lines) to create 2 Polynominals. How can I create and assign coefficients together.</p>
<div id="935bce05" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Polynomial:</span>
<span id="cb1-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">pass</span></span>
<span id="cb1-3">p1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Polynomial()</span>
<span id="cb1-4">p2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Polynomial()</span>
<span id="cb1-5">p1.coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  x^2 + 2x + 3</span></span>
<span id="cb1-6">p2.coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3x^2 + 4x + 3</span></span></code></pre></div>
</details>
</div>
<p>the answer is using a constructor <code>__init__</code>, then we can compact our code like this:</p>
<div id="c80a8e25" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Polynomial:</span>
<span id="cb2-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>coeffs):</span>
<span id="cb2-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> coeffs</span>
<span id="cb2-4"></span>
<span id="cb2-5">p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Polynomial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> ) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  x^2 + 2x + 3</span></span>
<span id="cb2-6">p2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Polynomial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> ) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3x^2 + 4x + 3</span></span></code></pre></div>
</details>
</div>
<p>but if we print our objects in the terminal, they look so ugly. We miss the method that actually call <code>repr(obj)</code> when we run <code>obj</code>:</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-10-expert-in-python/1_repr.png" class="img-fluid figure-img"></p>
<figcaption>The need of <code>__repr__</code></figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>that‚Äôs what <code>__repr__</code> for, a printable representation of the class:</p>
<div id="2f115390" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Polynomial:</span>
<span id="cb3-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>coeffs):</span>
<span id="cb3-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> coeffs</span>
<span id="cb3-4"></span>
<span id="cb3-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__repr__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb3-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Polynomial(*</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{!r}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)'</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.coeffs)</span>
<span id="cb3-7"></span>
<span id="cb3-8"></span>
<span id="cb3-9">p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Polynomial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  x^2 + 2x + 3</span></span>
<span id="cb3-10">p2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Polynomial(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3x^2 + 4x + 3</span></span></code></pre></div>
</details>
</div>
<p>the next thing we wanna do is to add Polinimials together <code>p1 + p2</code>.</p>
<div id="ee94fb92" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__add__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, other):</span>
<span id="cb4-2">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> Polynomial(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> x, y <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.coeffs, other.coeffs)))</span></code></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>What is pattern here? I have some behaviours that I want to implement, and I write some <strong>underscore</strong> (<code>__x__</code>) funtions. We call them dunder or underscore methods.</p>
<p>Try google ‚Äúdata model‚Äù and we‚Äôll a bunch of documents that list all method to implement the principle behaviours of our objects. There are top-level functions of top-level syntaxes that corresponding to <code>__</code>.</p>
<p>But there are smthg more fundamental here, when I want to:</p>
<ul>
<li>x + y -&gt; <code>__add__</code>;</li>
<li>initialize x -&gt; <code>__init__</code>;</li>
<li>repr(x) -&gt; <code>__repr__</code>.</li>
</ul>
<p>Then what if we want to implement the <code>len()</code> (return the length, which is popular know Python function) -&gt; naturally we‚Äôll be thinking of <code>__len__</code>.</p>
<div id="705b098f" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__len__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb5-2">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.coeffs)</span></code></pre></div>
</details>
</div>
</div>
</div>
<p>The Python data model is a means by which you can protocols. Thos protocols have abstract meaning depending on the object itself. We tight the behaviours to top-level <strong>syntaxes</strong> and <strong>functions</strong>.</p>
<p>Similarly, if we do see the object Polynomial a executable, callable thing, we can implement a <code>__call__</code> which will turn our class to function, in this case we cant imagine such thing, so pass.</p>
<p>‚úç There are 3 core patterns we want to understand and remember in Python to really understand object orientation in Python:</p>
<ol type="1">
<li>The protocol view of Python;</li>
<li>The buil-in inheritance protocol;</li>
<li>Some caveats around how OOP in Python works.</li>
</ol>
<p>Which will be continue to present in this video is jumping into a very tricky metaphor a feature we may have heard of.</p>
</section>
<section id="meta-class" class="level1 page-columns page-full">
<h1>meta class</h1>
<p>imagine there are 2 groups working on some piece of software. one is core infrastructure of the group and they write <code>library</code> code, the other group is devloper group, they write <code>user</code> code. the developer use <code>library</code> code to accomplish actual business objectives. the core team less cares about business problem, they focus on technical stuffs.</p>
<p>you are in the dev team and there is no way to change to code of <code>library.py</code>. in what circumstance the code of <code>user</code> can break -&gt; there is no <code>foo</code> method! To avoid that, we could simply write a test that call <code>bar()</code>, then we could know if it fails before production environment‚Äôs runtime.</p>
<p>is there anything simpler to know the ability to fail before hit run time in production env? -&gt; use <code>assert</code> to check existence of the attribute. we will have an early warning right before the class was initiated.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-10-expert-in-python/2_assert.png" class="img-fluid figure-img"></p>
<figcaption>we can know if the core team change the function name to ‚Äúfood‚Äù</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>by this way we are enforcing constraints on the base class from the derived class.</p>
<p>now we move to a reverse situation, you are the core structure writer and have to deal with the meathead in the business unit that actually using/abusing/missusing your code ~ you have no idea what are they doing. you write the <code>Base</code> class with the assumption and some responsible developer in the BU will go and implement the <code>bar</code> method.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-10-expert-in-python/3_reverse_sit.png" class="img-fluid figure-img"></p>
<figcaption>what if you stand on the left side pane</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>you have no ability to change and even have no idea where the code on the right pane sit. we can not use <code>hasattr()</code> for this particular situation. the first method is to use <code>try ... catch ...</code>, but it only catches in runtime and we will miss catching it before it goes to production env.</p>
<div class="{callout-note}">
<p>The reason that we could call Python a <strong>protocol orientated language</strong> is not just because the Python data model the object model is protocol orientated but that the entire Python language itself has a notion of hooks and protocols and safety valves within it.</p>
<p>Python is much much simpler language, the code run linearly from top to bottom. And the class statement in Python is actually an executable code. We can write this:</p>
<div id="459c7412" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb6-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Base: <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">pass</span></span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># or the same thing in other way</span></span>
<span id="cb6-5"></span>
<span id="cb6-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Base:</span>
<span id="cb6-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb6-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> bar(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb6-9">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bar'</span></span></code></pre></div>
</details>
</div>
<p>Only the last one will survive. Python accepts this syntax because it‚Äôs class is <strong>fundamentally executable</strong>.</p>
</div>
<p>Let‚Äôs get into something more interesting! create a class inside a function and use a function in a module in standard libbrary in Python called <code>dis</code>.</p>
<div id="e9bb28e0" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create a class inside a function</span></span>
<span id="cb7-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> _():</span>
<span id="cb7-3">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Base:</span>
<span id="cb7-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">pass</span></span>
<span id="cb7-5"></span>
<span id="cb7-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dis stands for disassemble</span></span>
<span id="cb7-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dis <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dis</span></code></pre></div>
</details>
</div>
<p>let‚Äôs ‚Äòdis‚Äô - stands for disassemble - to see what happen in the bytecode. there are actually things in Python bytecode call <code>LOAD_BUILD_CLASS</code>, it‚Äôs actual executable runtime instruction in the Python interpreter for create a class.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-10-expert-in-python/4_dis.png" class="img-fluid figure-img"></p>
<figcaption>disassemble</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>at the first section of this lecture, we saw some <strong>correspondence</strong> between top-level syntac or function AND some underscore method that implements that syntax or function. there should be also top-level mechanism, not explicitly syntax or function, with the process of building a class. there is a build-ins function called <code>__build_class__</code>.</p>
<div id="0f955f2e" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">old_bc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> __build_class__</span>
<span id="cb8-2"></span>
<span id="cb8-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> my_bc(func, name, base<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kw):</span>
<span id="cb8-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> base <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> Base:</span>
<span id="cb8-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'check if the bar method is defined'</span>)</span>
<span id="cb8-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> base <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb8-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> old_bc(func, name, base, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kw)</span>
<span id="cb8-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> old_bc(func, name, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kw)</span>
<span id="cb8-9"></span>
<span id="cb8-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> builtins</span>
<span id="cb8-11">builtins.__build_class__ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> my_bc</span></code></pre></div>
</details>
</div>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-10-expert-in-python/5_build_class.png" class="img-fluid figure-img"></p>
<figcaption><code>__build_class__</code>, we can check if the <code>bar</code> method is implemented, Python is <strong>protocal oriented language</strong>!</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>It‚Äôs actually quite a common pattern and quite a fundamental piece of Python almost everything that a Python language does in an execution context like building classes, creating functions, importing modules you can find a way to <strong>hook</strong> into that. once you can find a way to hook into that you can start doing things that you want to do like check is my user code going to break from the perspective the library author.</p>
<p>The most important thing here is <strong>understanding existence of this pattern</strong>, knowing that there are options solving such problem, and there are even better approachs.</p>
<section id="there-are-2-fundamental-ways-that-people-ussually-use-to-solve-this" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="there-are-2-fundamental-ways-that-people-ussually-use-to-solve-this">There are 2 fundamental ways that people ussually use to solve this</h2>
<section id="meta-class-1" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="meta-class-1">1. meta class</h3>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside"><a href="https://stackoverflow.com/questions/395982/metaclass-new-cls-and-super-what-is-the-mechanism-exactly">futher discussion</a></span></div></div>
<div id="38e91bf5" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># meta classes are merely derived from `type`</span></span>
<span id="cb9-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> BaseMeta(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>):</span>
<span id="cb9-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__new__</span>(cls, name, bases, namespace):</span>
<span id="cb9-4">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'BaseMeta.__new__'</span>, cls, name, bases, namespace)</span>
<span id="cb9-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Base'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bar'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> namespace:</span>
<span id="cb9-6">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">TypeError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bad User class, 'bar' is not defined"</span>)</span>
<span id="cb9-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__new__</span>(cls, name, bases, namespace)</span>
<span id="cb9-8"></span>
<span id="cb9-9"></span>
<span id="cb9-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># then our Base should be derived from BaseMeta</span></span>
<span id="cb9-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Base(metaclass<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>BaseMeta):</span>
<span id="cb9-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> foo(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb9-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bar()</span></code></pre></div>
</details>
</div>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-10-expert-in-python/6_meta_class.png" class="img-fluid figure-img"></p>
<figcaption>metaclass</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>That‚Äôs it! you can control, constraint the derived class from the base class in class hierachy.</p>
</section>
<section id="init_subclass__" class="level3">
<h3 class="anchored" data-anchor-id="init_subclass__">2. <code>__init_subclass__</code></h3>
<p>We can implement <code>Base</code> like this:</p>
<div id="090bfa24" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Base():</span>
<span id="cb10-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> foo(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb10-3">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bar()</span>
<span id="cb10-4"></span>
<span id="cb10-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init_subclass__</span>(cls, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb10-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"init subclass"</span>, cls.__dict__, kwargs)</span>
<span id="cb10-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bar'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cls.__dict__:</span>
<span id="cb10-8">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">TypeError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bad sub class"</span>)</span>
<span id="cb10-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init_subclass__</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span></code></pre></div>
</details>
</div>
</section>
</section>
</section>
<section id="decorator" class="level1">
<h1>decorator</h1>
<p>We would have met pattern like this, that‚Äôs is decorator:</p>
<div id="1b733668" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@dec</span> </span>
<span id="cb11-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> f():</span>
<span id="cb11-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">pass</span></span></code></pre></div>
</details>
</div>
<p>Python is a live language, there is no separate step that turns function definitions into bags of a set bits tagged and some elf binary or some <a href="https://en.wikipedia.org/wiki/Portable_Executable">PE</a> binary somewhere. That a function definition is actually a live thing, it actually runs at runtime, there‚Äôs actually executable code associated with this def <code>f()</code>.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-10-expert-in-python/7_interact_with_object.png" class="img-fluid figure-img"></p>
<figcaption>we can interact with our object as Python is a live language, the function itself is a runtime object</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>That every Python structure that you interact with whether it‚Äôs an object or a function or a generator has some <strong>runtime life</strong>, has some <strong>runtime existence</strong> you can see it in memory, you can ask it questions like what module UI were you defined in. you can even ask it very useful questions like if you use the inspect module you can say what‚Äôs your source code.</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ÓÇ∂</span> decorators ÓÇ∞ python <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-i</span> .<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\d</span>eco.py</span>
<span id="cb12-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> from <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">inspect</span> import getsource</span>
<span id="cb12-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> getsource<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">add</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb12-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'def add(a, b=10):\n    return a + b\n'</span></span>
<span id="cb12-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> print<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">getsource</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">add</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb12-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">def</span> add<span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">a,</span> b=10<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb12-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">a</span> + b </span>
<span id="cb12-8"></span>
<span id="cb12-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> </span></code></pre></div>
<p>now let‚Äôs say I want to calculate how much time does it take to perform the <code>add</code>. simply we would thinking about <code>time</code>, like this:</p>
<div id="17be65b1" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> time <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb13-2"></span>
<span id="cb13-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> add(a, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb13-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span>
<span id="cb13-5"> </span>
<span id="cb13-6">before <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time()</span>
<span id="cb13-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'add(10)'</span>, add(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span>
<span id="cb13-8">after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time()</span>
<span id="cb13-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'time_taken'</span>, after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> before)</span>
<span id="cb13-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'add(20, 30)'</span>, add(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>))</span>
<span id="cb13-11">after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time()</span>
<span id="cb13-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'time_taken'</span>, after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> before)</span>
<span id="cb13-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'add("a", "b")'</span>, add(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b"</span>))</span>
<span id="cb13-14">after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time()</span>
<span id="cb13-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'time_taken'</span>, after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> before)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>add(10) 20
time_taken 0.0
add(20, 30) 50
time_taken 0.0
add("a", "b") ab
time_taken 0.0</code></pre>
</div>
</div>
<p>there is something wrong here because we need to add code to everywhere we want to calculate. we see another important pattern in Python, decorator, the Python developers want you to write the simplest, stupidest, quickest thing to get the job done and get the rest of your day with your family.</p>
<p>we will see alot of scenarios where of cases where you can write the simple and stupidest thing to get the job done and when the task at hand becomes harder or more complex or the requirements change you can change your code in a very simple fashion to linearly extend its functionality without have to re-write it from scratch.</p>
<p>in Python we‚Äôll see a number of different features are orientated around how do we write the simplest thing today and then when the problem gets a little bit harder we have an avenue for making our code a little bit more complex.</p>
<p>we can modified a <code>add</code> alittle bit</p>
<div id="9ee3649c" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> time <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb15-2"></span>
<span id="cb15-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> add(a, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb15-4">    before <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time()</span>
<span id="cb15-5">    rv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span>
<span id="cb15-6">    after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time()</span>
<span id="cb15-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'elapsed:'</span>, after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> before)</span>
<span id="cb15-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> rv</span></code></pre></div>
</details>
</div>
<p>But if we have more functions, let say <code>sub</code>? We need to modify and make our code complicated. <strong>Python is live language</strong> that everything has some runtime representaion. We can create <code>timer()</code> which take <code>func</code>, <code>x</code>, and <code>y</code> as arguments (<code>x</code> and <code>y</code> will be forwarded to calculation function)</p>
<div id="3aca1fe5" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> time <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb16-2"></span>
<span id="cb16-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> timer(func, x, y):</span>
<span id="cb16-4">    before <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time()</span>
<span id="cb16-5">    rv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> func(x,y)</span>
<span id="cb16-6">    after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time()</span>
<span id="cb16-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'elapsed:'</span>, after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> before)</span>
<span id="cb16-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> rv</span>
<span id="cb16-9"></span>
<span id="cb16-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and </span></span>
<span id="cb16-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'add(20, 30)'</span>, timer(add, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>))</span></code></pre></div>
</details>
</div>
<p>we can also wrapping like this, <code>timer()</code> will return a function <code>f</code>:</p>
<div id="19af8894" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> time <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb17-2"></span>
<span id="cb17-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> timer(func):</span>
<span id="cb17-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> f(x, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb17-5">      before <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time()</span>
<span id="cb17-6">      rv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> func(x,y)</span>
<span id="cb17-7">      after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time()</span>
<span id="cb17-8">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'elapsed:'</span>, after <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> before)</span>
<span id="cb17-9">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> rv</span>
<span id="cb17-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> f</span>
<span id="cb17-11"></span>
<span id="cb17-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and </span></span>
<span id="cb17-13">add <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> timer(add)</span>
<span id="cb17-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'add(20, 30)'</span>, add(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>))</span></code></pre></div>
</details>
</div>
<p>Python provides a syntax for easily implement every behaviours of <code>timer()</code> to every function:</p>
<div id="7447cf77" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@timer</span></span>
<span id="cb18-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> add(a, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb18-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span>
<span id="cb18-4"></span>
<span id="cb18-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'add(20, 30)'</span>, add(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>))</span></code></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Fundamentally it‚Äôs about allowing you to take this wrapping behavior for functions and to wrap wide swathes of functions in one fashion without having to rewrite a lot of user code or having to even perform a lot of turn on your library code.</p>
</div>
</div>
<p>another example when we want a function to run n-times:</p>
<div id="827cb88c" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1">n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># let's say 2 times</span></span>
<span id="cb19-2"></span>
<span id="cb19-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> ntimes(f):</span>
<span id="cb19-4">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> wrapper(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb19-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n):</span>
<span id="cb19-6">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'running {.__name__}'</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(f))</span>
<span id="cb19-7">      rv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb19-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> rv</span>
<span id="cb19-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> wrapper</span>
<span id="cb19-10">    </span>
<span id="cb19-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@ntimes</span></span>
<span id="cb19-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> add(a, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb19-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span>
<span id="cb19-14"></span>
<span id="cb19-15">add(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>running add
running add</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>30</code></pre>
</div>
</div>
<p>wrapp <code>n</code> in to the function so <code>ntimes()</code> takes <code>n</code> instead of <code>f</code> as arg:</p>
<div id="5f7c8852" class="cell" data-execution_count="18">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># high order decorators</span></span>
<span id="cb22-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> ntimes(n):</span>
<span id="cb22-3">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> inner(f):</span>
<span id="cb22-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> wrapper(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb22-5">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n):</span>
<span id="cb22-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'running {.__name__}'</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(f))</span>
<span id="cb22-7">        rv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb22-8">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> rv</span>
<span id="cb22-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> wrapper</span>
<span id="cb22-10">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> inner</span>
<span id="cb22-11">    </span>
<span id="cb22-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@ntimes</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb22-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> add(a, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb22-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span>
<span id="cb22-15"></span>
<span id="cb22-16">add(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>running add
running add
running add</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>30</code></pre>
</div>
</div>
<p>There is a very important core concept that is hidden in here which is what you might call the <strong>closure object duality</strong>. it‚Äôs not something that we have time to look at in this session.</p>
</section>
<section id="generator" class="level1 page-columns page-full">
<h1>generator</h1>
<p>recall what we‚Äôve learned in previous section:</p>
<ul>
<li>there are top-level syntax or function &lt;‚Äì&gt; and some underscore methods that implemented it.</li>
<li>if you have parentheses after something x() &lt;‚Äì&gt; implies <code>__call__</code> protocol implemented.</li>
</ul>
<p>what is different between these 2:</p>
<div id="0698ed3a" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> add1(x, y):</span>
<span id="cb25-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y</span>
<span id="cb25-3"></span>
<span id="cb25-4"></span>
<span id="cb25-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Adder:</span>
<span id="cb25-6">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x, y):</span>
<span id="cb25-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y </span>
<span id="cb25-8">add2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Adder()</span>
<span id="cb25-9"></span>
<span id="cb25-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(add1(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 30</span></span>
<span id="cb25-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(add2(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 20</span></span>
<span id="cb25-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(add1) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &lt;class 'function'&gt;</span></span>
<span id="cb25-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(add2) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># &lt;class '__main__.Adder'&gt;</span></span></code></pre></div>
</details>
</div>
<p>functionally there is not distinguish between <code>add1</code> and <code>add2</code>. <code>add1</code> is syntaxtically whole hell more easy to write. another diffence is if you want to add some <em>statefull behaviors</em>, we can easily modified the class:</p>
<div id="a5a98768" class="cell" data-execution_count="20">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Adder:</span>
<span id="cb26-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb26-3">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb26-4"></span>
<span id="cb26-5">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x, y):</span>
<span id="cb26-6">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb26-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.z</span></code></pre></div>
</details>
</div>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">ƒê·ªçc th√™m v·ªÅ <a href="https://magz.techover.io/2021/12/04/python-deep-dive-hieu-closures-decorators-va-cac-ung-dung-cua-chung-phan-1/">chu·ªói b√†i n√†y</a> n·∫øu th·∫•y confuse</span></div></div>
<p>there is one what to do with the Adder, another way to do with the function, what he hinted at this object <strong>closure duality</strong>.</p>
<p>let‚Äôs think about a function that take a lot of time to do something, like loading the data from the database. we demo by a simple function <code>compute()</code>, which sleep 0.5 sec for each loop. the function only gives us the result once it completelt complete the loop, it will give us the entire result all at once. what if we care about the first? the first 3 values?</p>
<p>this is undesirable. this is wasteful both from the perspective of time &amp; memory. let‚Äôs think about it with the object model and rewrite under <code>Compute</code> class:</p>
<div id="583238e2" class="cell" data-execution_count="21">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> time <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sleep</span>
<span id="cb27-2"></span>
<span id="cb27-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> compute()</span>
<span id="cb27-4">  rv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb27-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):</span>
<span id="cb27-6">    sleep(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span>)</span>
<span id="cb27-7">    rv.append(i)</span>
<span id="cb27-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> rv</span>
<span id="cb27-9"></span>
<span id="cb27-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Compute:</span>
<span id="cb27-11">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb27-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">pass</span></span>
<span id="cb27-13"></span>
<span id="cb27-14">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb27-15">    rv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb27-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):</span>
<span id="cb27-17">      sleep(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span>)</span>
<span id="cb27-18">      rv.append(i)</span>
<span id="cb27-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> rv</span>
<span id="cb27-20">compute2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Compute()</span></code></pre></div>
</details>
</div>
<div class="page-columns page-full"><p>the 2nd method: </p><div class="no-row-height column-margin column-container"><span class="margin-aside"><a href="https://realpython.com/python-callable-instances">read more</a></span></div></div>
<ul>
<li>Retain state between calls (<strong>stateful callables</strong>)</li>
<li>Cache values that result from previous computations</li>
<li>Implement straightforward and convenient APIs</li>
</ul>
<p>if you want to access data during computaion, think of:</p>
<pre><code>for x in xs:
  pass

x1 = iter(xs)   ---&gt; __iter__
while True:
  x = next(x1)  ---&gt; __next__</code></pre>
<p>and re-write the <code>Compute</code> like this:</p>
<div id="630e83a0" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Compute:</span>
<span id="cb29-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__iter__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb29-3">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb29-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span> </span>
<span id="cb29-5">  </span>
<span id="cb29-6">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__next__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb29-7">    rv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.last</span>
<span id="cb29-8">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb29-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.last <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:</span>
<span id="cb29-10">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">StopIteration</span>()</span>
<span id="cb29-11">    sleep(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span>)</span>
<span id="cb29-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> rv</span>
<span id="cb29-13"></span>
<span id="cb29-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> val <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> Compute():</span>
<span id="cb29-15">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(val)</span></code></pre></div>
</details>
</div>
<p>now, it:</p>
<ul>
<li>takes 1 iteration to let you start using it;</li>
<li>takes no storage;</li>
<li>but looks ugly.</li>
</ul>
<p>and there is much simpler way to write a function that operate in such fashion, the <strong>generator</strong> syntax, it merely:</p>
<div id="8ff097c6" class="cell" data-execution_count="23">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> compute()</span>
<span id="cb30-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb30-3">    sleep(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span>)</span>
<span id="cb30-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> i</span></code></pre></div>
</details>
</div>
<p>its state is maintained internally. instead of eagerly computing the values, you give them to the user as the ask. let‚Äôs look in the last example:</p>
<div id="cf92bb02" class="cell" data-execution_count="24">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Api:</span>
<span id="cb31-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> run_this_first():</span>
<span id="cb31-3">    first()</span>
<span id="cb31-4">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> run_this_second():</span>
<span id="cb31-5">    second()</span>
<span id="cb31-6">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> run_this_last():</span>
<span id="cb31-7">    lass()</span>
<span id="cb31-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in documentation you ask user to use those functions in order but no physically constraint you to not run like this:</span></span>
<span id="cb31-9">Api.run_this_last()</span>
<span id="cb31-10">Api.run_this_second()</span>
<span id="cb31-11">Api.run_this_first()</span></code></pre></div>
</details>
</div>
<p>the generator not only yield the result back, but also the control back to the caller. we can interleave our code with library code, controling them to run in order, that is conceptualization of how generators are built upon - co-routines.</p>
<p>we can either define execution function inside the class or use generator to control the sequence:</p>
<div id="2a98e5f2" class="cell" data-execution_count="25">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1">...</span>
<span id="cb32-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> doit():</span>
<span id="cb32-3">    first()</span>
<span id="cb32-4">    second()</span>
<span id="cb32-5">    last()</span>
<span id="cb32-6">... </span>
<span id="cb32-7"></span>
<span id="cb32-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># or</span></span>
<span id="cb32-9"></span>
<span id="cb32-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> api()</span>
<span id="cb32-11">  first()</span>
<span id="cb32-12">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span></span>
<span id="cb32-13">  second()</span>
<span id="cb32-14">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span></span>
<span id="cb32-15">  last()</span></code></pre></div>
</details>
</div>
</section>
<section id="context-manager" class="level1">
<h1>context manager</h1>
<p>setup &amp; teardown ~ initial action and final action. we would often see pattern like:</p>
<div id="38b78af3" class="cell" data-execution_count="26">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ctx.py'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb33-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">pass</span></span></code></pre></div>
</details>
</div>
<p>beyond the file, it can be also sqllite</p>
<div id="3576f9c0" class="cell" data-execution_count="27">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sqlite3 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span></span>
<span id="cb34-2"></span>
<span id="cb34-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># control the execution is executed when connection is open</span></span>
<span id="cb34-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test.db'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> conn:</span>
<span id="cb34-5">  cur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> conn.cursor()</span>
<span id="cb34-6">  cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'create table points(x int, y int)'</span>)</span>
<span id="cb34-7">  cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (1, 1)'</span>)</span>
<span id="cb34-8">  cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (2, 1)'</span>)</span>
<span id="cb34-9">  cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (1, 2)'</span>)</span>
<span id="cb34-10">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'select sum(x * y) from points'</span>):</span>
<span id="cb34-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(row)</span>
<span id="cb34-12">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'select x, y from points'</span>):</span>
<span id="cb34-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(row)</span>
<span id="cb34-14">  cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drop table points'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(5,)
(1, 1)
(2, 1)
(1, 2)</code></pre>
</div>
</div>
<p>now we already control if connection is live to do something, we‚Äôve not yet controlled inside the connection, the entry point and the exit point. now behind the scence</p>
<pre><code>with ctx() as x:
  pass</code></pre>
<p>will look like the following:</p>
<pre><code>x = ctx().__enter__
try
  pass
finally:
  x.__exit__</code></pre>
<p>we‚Äôll try to emplement this to our connection, we‚Äôll wrap it to a <strong>temporary table behaviour</strong>:</p>
<div id="2b7f6312" class="cell" data-execution_count="28">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sqlite3 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span></span>
<span id="cb38-2"></span>
<span id="cb38-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Temporarytable:</span>
<span id="cb38-4">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, cur):</span>
<span id="cb38-5">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.cur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cur</span>
<span id="cb38-6">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__enter__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb38-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'__enter__'</span>)</span>
<span id="cb38-8">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'create table points(x int, y int)'</span>)</span>
<span id="cb38-9">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__exit__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>arg): <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># why need *arg</span></span>
<span id="cb38-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'__exit__'</span>)</span>
<span id="cb38-11">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drop table points'</span>)</span>
<span id="cb38-12"></span>
<span id="cb38-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test.db'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> conn:</span>
<span id="cb38-14">  cur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> conn.cursor()</span>
<span id="cb38-15">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> Temporarytable(cur<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cur):</span>
<span id="cb38-16">    cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (1, 1)'</span>)</span>
<span id="cb38-17">    cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (2, 1)'</span>)</span>
<span id="cb38-18">    cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (1, 2)'</span>)</span>
<span id="cb38-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'select sum(x * y) from points'</span>):</span>
<span id="cb38-20">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(row)</span>
<span id="cb38-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'select x, y from points'</span>):</span>
<span id="cb38-22">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(row)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>__enter__
(5,)
(1, 1)
(2, 1)
(1, 2)
__exit__</code></pre>
</div>
</div>
<p>now can the exit run before the enter, no! they need to be run sequencely. it remind us about the <strong>generator</strong> to improve this:</p>
<div id="749b00d4" class="cell" data-execution_count="29">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sqlite3 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span></span>
<span id="cb40-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> temporarytable(cur):</span>
<span id="cb40-3">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'created table'</span>)</span>
<span id="cb40-4">  cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'create table points(x int, y int)'</span>)</span>
<span id="cb40-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span></span>
<span id="cb40-6">  cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drop table points'</span>)</span>
<span id="cb40-7">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dropped table'</span>)</span>
<span id="cb40-8"></span>
<span id="cb40-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Temporarytable:</span>
<span id="cb40-10">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, cur):</span>
<span id="cb40-11">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.cur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cur</span>
<span id="cb40-12">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__enter__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb40-13">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gen <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> temporarytable(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.cur)</span>
<span id="cb40-14">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gen)</span>
<span id="cb40-15">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__exit__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>arg):</span>
<span id="cb40-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gen, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb40-17"></span>
<span id="cb40-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test.db'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> conn:</span>
<span id="cb40-19">  cur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> conn.cursor()</span>
<span id="cb40-20">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> Temporarytable(cur<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cur):</span>
<span id="cb40-21">    cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (1, 1)'</span>)</span>
<span id="cb40-22">    cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (2, 1)'</span>)</span>
<span id="cb40-23">    cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (1, 2)'</span>)</span>
<span id="cb40-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'select sum(x * y) from points'</span>):</span>
<span id="cb40-25">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(row)</span>
<span id="cb40-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'select x, y from points'</span>):</span>
<span id="cb40-27">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(row)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>created table
(5,)
(1, 1)
(2, 1)
(1, 2)
dropped table</code></pre>
</div>
</div>
<p>enter and exit are already implemented in function <code>temporarytable</code> and cursor is implemented in the <code>connect()</code> call. now i would rewrite like this</p>
<div id="3007e670" class="cell" data-execution_count="30">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sqlite3 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span></span>
<span id="cb42-2"></span>
<span id="cb42-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Temporarytable:</span>
<span id="cb42-4">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, gen):</span>
<span id="cb42-5">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gen <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gen</span>
<span id="cb42-6">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb42-7">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.args, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.kwargs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> args, kwargs</span>
<span id="cb42-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span></span>
<span id="cb42-9">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__enter__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb42-10">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gen_instance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gen(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.kwargs)</span>
<span id="cb42-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gen_instance)</span>
<span id="cb42-12">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__exit__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>arg):</span>
<span id="cb42-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gen_instance, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb42-14"></span>
<span id="cb42-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@Temporarytable</span></span>
<span id="cb42-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> temporarytable(cur):</span>
<span id="cb42-17">  cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'create table points(x int, y int)'</span>)</span>
<span id="cb42-18">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span></span>
<span id="cb42-19">  cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drop table points'</span>)</span>
<span id="cb42-20"></span>
<span id="cb42-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># temporarytable = Temporarytable(temporarytable)</span></span>
<span id="cb42-22"></span>
<span id="cb42-23"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test.db'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> conn:</span>
<span id="cb42-24">  cur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> conn.cursor()</span>
<span id="cb42-25">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> temporarytable(cur):</span>
<span id="cb42-26">    cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (1, 1)'</span>)</span>
<span id="cb42-27">    cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (2, 1)'</span>)</span>
<span id="cb42-28">    cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (1, 2)'</span>)</span>
<span id="cb42-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'select sum(x * y) from points'</span>):</span>
<span id="cb42-30">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(row)</span>
<span id="cb42-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'select x, y from points'</span>):</span>
<span id="cb42-32">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(row)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(5,)
(1, 1)
(2, 1)
(1, 2)</code></pre>
</div>
</div>
<p>all the stuff context manager above we do not need to write:</p>
<div id="f0ded331" class="cell" data-execution_count="31">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb44-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sqlite3 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span></span>
<span id="cb44-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> contextlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> contextmanager</span>
<span id="cb44-3"></span>
<span id="cb44-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@contextmanager</span></span>
<span id="cb44-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> temporarytable(cur):</span>
<span id="cb44-6">  cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'create table points(x int, y int)'</span>)</span>
<span id="cb44-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span>:</span>
<span id="cb44-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span></span>
<span id="cb44-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">finally</span>:</span>
<span id="cb44-10">    cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drop table points'</span>)</span>
<span id="cb44-11"></span>
<span id="cb44-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># temporarytable = Temporarytable(temporarytable)</span></span>
<span id="cb44-13"></span>
<span id="cb44-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test.db'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> conn:</span>
<span id="cb44-15">  cur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> conn.cursor()</span>
<span id="cb44-16">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> temporarytable(cur):</span>
<span id="cb44-17">    cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (1, 1)'</span>)</span>
<span id="cb44-18">    cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (2, 1)'</span>)</span>
<span id="cb44-19">    cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'insert into points(x, y) values (1, 2)'</span>)</span>
<span id="cb44-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'select sum(x * y) from points'</span>):</span>
<span id="cb44-21">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(row)</span>
<span id="cb44-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cur.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'select x, y from points'</span>):</span>
<span id="cb44-23">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(row)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(5,)
(1, 1)
(2, 1)
(1, 2)</code></pre>
</div>
</div>
</section>
<section id="summary" class="level1">
<h1>summary</h1>
<p>all combination of what we‚Äôve learned in the last example:</p>
<ul>
<li>a <strong>context manager</strong> is merely some piece of code that pairs set up actions and teardown actions. teardown occurs only if set up occurs</li>
<li>a <strong>generator</strong> is merely some form of syntax that allows us to do things like enforce sequencing and interleaving notice the</li>
</ul>
<p>finally we need something to adapt the generator to this data model that we looked at at the very beginning. we have these underscore methods and we have to find some way to take how the generator works and fit it into those underscore methods. one of the things we need to do in order to do that is we need to take this generator object to wrap it in some fashion that wrapping is part of the core of how Python works it‚Äôs easy to dynamics and construct functions</p>
<ul>
<li>there does happen to be a feature called <strong>decorators</strong> that allows us a nice convenient syntax for doing that exactly.</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>criteria of Python expert code:</p>
<ul>
<li>expert level code is not code that uses every single feature;</li>
<li>it‚Äôs in fact not code that even uses that many features of Python;</li>
<li>it‚Äôs code that has a certain clarity to where and when a feature should be used;</li>
<li>it‚Äôs code that doesn‚Äôt waste the time of the person who‚Äôs writing it because they say to themselves I have this pattern Python has this mechanism I fit them together and everything just seamlessly and and very smoothly works;</li>
<li>it‚Äôs code that doesn‚Äôt have a lot of additional mechanisms associated with it it doesn‚Äôt have people creating their own protocols it doesn‚Äôt have people creating their own frameworks where the language itself provides the core pieces that you need and you merely have to understand what those core pieces are what they need and how to assemble them.</li>
</ul>
</div>
</div>
</section>
<section id="futher-reading" class="level1">
<h1>futher reading</h1>
<ol type="1">
<li><a href="https://docs.python.org/3/reference/datamodel.html">Python data model</a></li>
<li><a href="https://www.geeksforgeeks.org/python-metaclass-__new__-method/">Python metaclass <code>__new__</code></a></li>
</ol>


<!-- -->

</section>

 ]]></description>
  <category>python</category>
  <category>pydata</category>
  <guid>https://lktuan.github.io/blog/2024-07-10-expert-in-python/</guid>
  <pubDate>Tue, 09 Jul 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-07-10-expert-in-python/pydata-logo-final.png" medium="image" type="image/png" height="60" width="144"/>
</item>
<item>
  <title>A lesson of advanced python from Juan Rodr√≠guez</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-07-08-advanced-python/</link>
  <description><![CDATA[ 





<p>This <a href="https://github.com/astrojuanlu/ie-mbd-advanced-python/tree/main">lesson</a> was found on <a href="https://github.com/astrojuanlu">Juan Luis Cano Rodr√≠guez‚Äôs</a> github profile when I came across his talk <a href="https://www.youtube.com/watch?v=ffDHdtz_vKc">‚ÄúBuilding the composable Python data stack with Kedro &amp; Ibis‚Äù</a> (bookmarked for learning later) in <a href="https://www.youtube.com/playlist?list=PLGVZCDnMOq0rrhYTNedKKuJ9716fEaAdK">Pydata London 2024</a>.</p>
<p>This is my notes:</p>
<section id="intro" class="level1">
<h1>00 <a href="https://github.com/astrojuanlu/ie-mbd-advanced-python/blob/main/sessions/00_intro.ipynb">intro</a></h1>
<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">learning objectives</h2>
<ul>
<li>Learn modern software engineering practices using Python</li>
<li>Understand the value of automation in the software engineering process</li>
<li>Gain insight into how Data Science projects are put in production</li>
<li>Learn better techniques to collaborate in software projects</li>
</ul>
<p>The instructor used Linux / Conda, err I just have Window here so there is no other way but right I will try to make stuffs work in Window. Let‚Äôs get started!</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://raw.githubusercontent.com/astrojuanlu/ie-mbd-advanced-python/e2224276f91529280ebfcd42ddc7dc22cf0d2010/img/quote-talk-is-cheap-show-me-the-code-linus-torvalds-273528.jpg" class="img-fluid figure-img"></p>
<figcaption>stolen from the lecture</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="git" class="level1">
<h1>01 <a href="https://github.com/astrojuanlu/ie-mbd-advanced-python/blob/main/sessions/01_git.ipynb">git</a></h1>
<section id="glossary" class="level2">
<h2 class="anchored" data-anchor-id="glossary">glossary</h2>
<ul>
<li><strong>Repository</strong>: Directory tracked by git, contains a <code>.git</code> folder and it‚Äôs created by <code>$ git init</code>;</li>
<li><strong>Commit</strong>: State or snapshot of the repository, they are created by <code>$ git commit</code>;</li>
<li><strong>Branch</strong>: A parallel or separate line of development, the default one is master and they are created by <code>$ git branch</code> or <code>$ git checkout -b</code>.</li>
</ul>
</section>
<section id="git-uses-a-linux-like-cli-so-now-linux-cli-101-and-how-to-do-the-same-on-window-pwsh" class="level2">
<h2 class="anchored" data-anchor-id="git-uses-a-linux-like-cli-so-now-linux-cli-101-and-how-to-do-the-same-on-window-pwsh">git uses a Linux-like cli so now Linux cli 101 (and how to do the same on Window pwsh)</h2>
<ul>
<li><code>whoami</code>: who am i</li>
<li><code>pwd</code>: print working directory</li>
<li><code>ls</code>: list all file in the dir, <code>.</code> for current folder, <code>..</code> for parent one (seems there is no <code>--color</code> or <code>-a</code> in pwsh)</li>
<li><code>cd</code>: change dir</li>
<li><code>touch</code>: create empty file (in pwsh we use <code>echo "" &gt;&gt; file_name</code>)</li>
<li><code>cat</code>: concatenate, print file contents</li>
<li><code>nano</code>: edit a file from the command line (there is a <a href="https://www.hanselman.com/blog/developers-can-run-bash-shell-and-usermode-ubuntu-linux-binaries-on-windows-10">way</a> that allows us to do the same in win10, but ya, nope)</li>
</ul>
</section>
<section id="workflow" class="level2">
<h2 class="anchored" data-anchor-id="workflow">workflow</h2>
<p>I did these in pwsh:</p>
<ol type="1">
<li>Create a directory <code>mkdir test_project</code> and navigate there <code>cd test_project</code>;</li>
<li>Init a git repository <code>git init</code>;</li>
<li>Check status <code>git status</code> (‚Äúon branch master, no commits yet, nothing to commit‚Äù);</li>
<li>Create some files <code>echo "#Hello, world!" &gt;&gt; readme.md</code>;</li>
<li>Stage the files <code>git add readme.md</code>;</li>
<li>Commit the changes <code>git commit -m "initial commit"</code>;</li>
</ol>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Do not run <code>git init</code> on your home directory, as it can lead to confusion and potential data loss. If <code>git status</code> gives a lot of untracked files unrelated to your project, you might want to <code>rm -rf .git</code> and start in another directory. Notice that this command removes all git history.</p>
</div>
</div>
</section>
<section id="branching" class="level2">
<h2 class="anchored" data-anchor-id="branching">branching</h2>
<ol type="1">
<li>Create and checkout to new branch <code>git switch -c branch1</code> (<code>-c</code> stands for create);</li>
<li>Commit there (see above);</li>
<li>Go back to main branch <code>git switch master</code>;</li>
<li>Merge changes <code>git merge branch1</code>;</li>
<li>Delete branch <code>git branch -d branch1</code> (<code>-d</code> stands for delete, don‚Äôt forget this step!).</li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Normally, the <code>git merge</code> step happens online using <em>pull requests</em> or <em>merge requests</em>, which are <strong>not</strong> git concepts, but GitHub/GitLab concepts.</li>
<li>If <code>git switch</code> does not work for you, you might have an older version of Git. Consider upgrading, or alternatively replace all <code>git switch -c</code> with <code>git checkout -b</code>.</li>
</ul>
</div>
</div>
<blockquote class="blockquote">
<p>Pull requests (PR) let you tell others about changes you‚Äôve pushed to a branch in a repository on GitHub. Once a pull request is opened, you can discuss and review the potential changes with collaborators and add follow-up commits before your changes are merged into the base branch. ‚Äì GitHub</p>
</blockquote>
<blockquote class="blockquote">
<p>A merge request (MR) is a proposal to incorporate changes from a source branch to a target branch. ‚Äì GitLab</p>
</blockquote>
<blockquote class="blockquote">
<p>Remember to <strong>never commit to master</strong>. ‚Äì Git Workflow</p>
</blockquote>
</section>
<section id="merging" class="level2">
<h2 class="anchored" data-anchor-id="merging">merging</h2>
<p>2 types of merging:</p>
<ul>
<li><strong>Fast-forward merge</strong>: There is no diverging history, and git just ‚Äúadvances the pointer‚Äù of the current branch. <code>git merge new-branch --ff-only</code> will fail if a fast-forward merge is not possible;</li>
<li><strong>Non fast-forward merge</strong>: The history diverged, and git will create a merge commit (hence ask for a commit message) with two parents that combines the two branches. <code>git merge new-branch --no-ff</code> always creates a merge commit even if a fast-forward merge is possible.</li>
</ul>
<p>GitHub use <code>--no--ff</code> option for pull requests, see <a href="https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/merging-a-pull-request">here</a>, and this old-but-gold <a href="https://stackoverflow.com/questions/9069061/what-effect-does-the-no-ff-flag-have-for-git-merge">discussion</a>.</p>
<ul>
<li>Non fast-forward merges can end up in conflicts. In that case, git will halt the merge operation and leave traces in the affected files;</li>
<li>To abort a merge <code>git merge --abort</code> (useful if we are scared and don‚Äôt know what to do);</li>
<li>To merge overriding everything with the upcoming branch <code>git merge new-branch --strategy-option theirs</code>;</li>
<li>To merge overriding everything with the current branch <code>git merge new-branch --strategy-option ours</code>.</li>
</ul>
<p><strong>Be careful</strong> while editing files that are in conflict.</p>
</section>
<section id="other" class="level2">
<h2 class="anchored" data-anchor-id="other">other</h2>
<ul>
<li>Ignoring files <code>.gitignore</code>;</li>
<li>Amend the last commit: <code>git commit --amend</code>;</li>
<li>Show pretty history: <code>git log --graph --oneline --decorate --all</code>;</li>
<li>Configuring git aliases: <code>git config --global alias.lg "log --graph --oneline --decorate"</code> (and now you have <code>git lg</code>!).</li>
</ul>
<p>This excellent chart will help you in git workflow decision making.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-08-advanced-python/git_pretty.png" class="img-fluid figure-img"></p>
<figcaption>git flowchart, photo credit to this SO <a href="https://stackoverflow.com/questions/14096721/how-to-add-file-to-a-previous-commit">thread</a></figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="triangular-workflows-in-git" class="level2">
<h2 class="anchored" data-anchor-id="triangular-workflows-in-git">triangular workflows in git</h2>
<p>When collaborating with a project hosted online on GitHub or GitLab, the most common setup is having a central repository, one remote fork per user, and local clones/checkouts:</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://github.blog/wp-content/uploads/2015/07/5dcdcae4-354a-11e5-9f82-915914fad4f7.png?resize=2000%2C951" class="img-fluid figure-img"></p>
<figcaption>triangular workflows in git, <a href="https://github.blog/2015-07-29-git-2-5-including-multiple-worktrees-and-triangular-workflows/">source</a></figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>Notice the different naming conventions between this website and the first image:</p>
<ul>
<li>Convention 1: upstream/origin/local</li>
<li>Convention 2: origin/<username>/local</username></li>
</ul>
<p>We will be consistent with the Aaron Meurer guide and therefore use Convention 2 all the time.</p>
</section>
<section id="after-creating-a-pr" class="level2">
<h2 class="anchored" data-anchor-id="after-creating-a-pr">after creating a PR</h2>
<p>After your pull request has been merged to <code>master</code>, your local <code>master</code> and <code>&lt;username&gt;/master</code> will be outdated with respect to <code>origin/master</code>. On the other hand, you should <strong>avoid working on this branch anymore in the future</strong>: remember branches should be ephemeral and short-lived.</p>
<p>To put yourself in a clean state again, you have to:</p>
<ol type="1">
<li>Click ‚Äúremove branch‚Äù in the pull request (don‚Äôt click ‚Äúremove fork‚Äù!);</li>
<li><code>git checkout master</code> (go back to master);</li>
<li><code>git fetch origin</code> (<strong>never, ever</strong> use <code>git pull</code> unless you know exactly what you‚Äôre doing)</li>
<li><code>git merge --ff-only origin master</code> (update your local master with origin/master, and fail if you accidentally made any commit in master)</li>
<li><code>git fetch -p &lt;username&gt;</code> (‚ú® acknowledge the removal of the remote branch ‚ú®)</li>
<li><code>git branch -d old-branch</code> (remove the old branch)</li>
<li><code>git push &lt;username&gt; master</code> (update your fork with respect to origin)</li>
<li><code>git checkout -b new-branch</code> (start working in the new feature!)</li>
</ol>
<p>This process has to be repeated <strong>after every pull request</strong>.</p>
<p>Some organizations where all the members are trusted do not use forks, and everybody pushes their branches to the same repository instead. While this simplifies some parts of the workflow, it also requires proper checks in place to prevent bad code to be merged - for example, by <a href="https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/managing-a-branch-protection-rule">requiring a minimum number of reviews</a> or some <a href="https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/about-protected-branches">automated status checks</a>.</p>
</section>
</section>
<section id="pythonpath" class="level1">
<h1>02 <a href="https://github.com/astrojuanlu/ie-mbd-advanced-python/blob/main/sessions/02_pythonpath.ipynb">pythonpath</a></h1>
<section id="how-does-import-work" class="level2">
<h2 class="anchored" data-anchor-id="how-does-import-work">how does <code>import</code> work?</h2>
<p>How do <code>import os, pandas</code> work? If <code>pandas</code> was not installed, what happen?</p>
</section>
<section id="how-can-i-import-my-code" class="level2">
<h2 class="anchored" data-anchor-id="how-can-i-import-my-code">how can I <code>import</code> my code?</h2>
<p>There are three ways to import our own code:</p>
<ul>
<li><strong>Being on the same directory</strong>: This is the quickest, however it scales quite poorly (imagine having all of pandas and scikit-learn in a single directory to do any data analysis project!)</li>
<li><strong>Appending our code location to PYTHONPATH</strong>: This is effective, but we will try to avoid it because it can bring problems in the future.</li>
<li><strong>Making our code installable</strong>: Since any code that‚Äôs installed can be imported, this shifts the question to ‚Äúhow to make our code installable‚Äù.</li>
</ul>
</section>
<section id="my-first-python-lib" class="level2">
<h2 class="anchored" data-anchor-id="my-first-python-lib">my first python lib</h2>
<p>We will create a new Python library, ‚ÄúIE Titanic utils‚Äù, to analyze the <a href="https://www.kaggle.com/c/titanic/data">Titanic dataset</a>. I will create a project <code>ie-titanic-utils</code>, add <code>readme.md</code> and <code>.gitignore</code> files.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mkdir</span> it-titanic-utils</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> init</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"# This is utility to help analyze Titanic dataset"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> readme.md</span>
<span id="cb1-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Invoke-WebRequest</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-Uri</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.toptal.com/developers/gitignore/api/python,jupyternotebooks"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Select-Object</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-ExpandProperty</span> Content <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Out-File</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-FilePath</span> .gitignore <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-Encoding</span> utf8</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> add readme.md .gitignore</span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> commit <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"initial commit"</span></span></code></pre></div>
<p>Now I will create <code>str_utils.py</code> file (using VS code for convenience), with a function called <code>tokenize</code> that takes a str sentence and splits it into a list of words.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>str_utils.py</strong></pre>
</div>
<div class="sourceCode" id="cb2" data-filename="str_utils.py" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> tokenize(sentence: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]:</span>
<span id="cb2-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sentence.split()</span></code></pre></div>
</div>
<p>In pwsh, I can import and use this function</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span></span>
<span id="cb3-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Python</span> 3.11.4 <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">tags/v3.11.4:d2340ef,</span> Jun  7 2023, 05:45:37<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[MSC</span> v.1934 64 bit <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">AMD64</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">]</span> on win32</span>
<span id="cb3-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Type</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"help"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"copyright"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"credits"</span> or <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"license"</span> for more information.</span>
<span id="cb3-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> from <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">str_utils</span> import tokenize</span>
<span id="cb3-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> tokenize<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Toi la Le Khac Tuan"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb3-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Toi'</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'la'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Le'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Khac'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Tuan'</span>]</span>
<span id="cb3-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span></span></code></pre></div>
</section>
<section id="the-pythonpath" class="level2">
<h2 class="anchored" data-anchor-id="the-pythonpath">the <code>PYTHONPATH</code></h2>
<p>We saw above that we could easily import our <code>tokenize</code> function. However, this only works if we are in the same directory. Why? Python looks in some predefined locations to know where to find what we want to import, called the ‚ÄúPATH‚Äù.</p>
<div id="e4b08fa3" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb4-2">sys.path <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># i will not execute this code</span></span></code></pre></div>
</details>
</div>
<p>Therefore, there are two ways of making our code <strong>globally importable</strong>:</p>
<ol type="1">
<li>Modify the ‚ÄúPATH‚Äù</li>
<li>Put our code inside a location predefined in the ‚ÄúPATH‚Äù</li>
</ol>
<p>The first option can be achieved like this:</p>
<div id="d729e316" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> sys.path.insert(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/home/username/ie-titanic-utils"</span>)</span>
<span id="cb5-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> str_utils  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Works!</span></span></code></pre></div>
</details>
</div>
<p>Or, alternatively, from outside of the interpreter: <code>export PYTHONPATH=/home/username/ie-titanic-utils</code>.</p>
<p>However, both are <strong>bad practices and should be avoided</strong>.</p>
</section>
<section id="what-does-import-do" class="level2">
<h2 class="anchored" data-anchor-id="what-does-import-do">what does <code>import</code> do?</h2>
<p>Python code is normally written in <code>.py</code> scripts. These scripts can be imported in the same way that any model or package from the standard library can:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> python3</span>
<span id="cb6-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> import <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">math</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Works, because it's in stdlib</span></span>
<span id="cb6-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> import <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">numpy</span> as np  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Works if you ran `pip install numpy` in advance</span></span>
<span id="cb6-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> import <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">str_utils</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Works if you are in the same directory</span></span>
<span id="cb6-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Hello,'</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'world!'</span>]</span>
<span id="cb6-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> </span></code></pre></div>
<p>When the user imports a script, <strong>Python runs the script</strong>. That‚Äôs the way all the possible functions and classes inside it are available.</p>
</section>
<section id="how-to-separate-running-code-from-reusable-pieces" class="level2">
<h2 class="anchored" data-anchor-id="how-to-separate-running-code-from-reusable-pieces">how to separate ‚Äúrunning code‚Äù from reusable pieces</h2>
<p>A Python module (any <code>.py</code> script) might contain code that we want to run, as well as code that we only want to import. To separate these, we use this trick:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ÓÇ∂</span> ie-titanic-utils ÓÇ∞ get-content <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-Tail</span> 2 .str_utils.py</span>
<span id="cb7-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">__name__</span> == <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb7-3">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">print</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">tokenize</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hello, world!"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">))</span></span>
<span id="cb7-4"></span>
<span id="cb7-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ÓÇ∂</span> ie-titanic-utils ÓÇ∞ python .str_utils.py <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The `print` runs</span></span>
<span id="cb7-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hello,'</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'world!'</span>]</span>
<span id="cb7-7"></span>
<span id="cb7-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ÓÇ∂</span> ie-titanic-utils ÓÇ∞ python</span>
<span id="cb7-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> from <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">str_utils</span> import tokenize</span>
<span id="cb7-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> tokenize<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hi, world!"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb7-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Hi,'</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'world!'</span>] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The `print` doesn't run!</span></span>
<span id="cb7-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span></span></code></pre></div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here is what Claude sonnet 3.5 gave me:</p>
<p>To separate code that we want to run directly from code that we only want to import, we should use the if <code>__name__ == "__main__"</code>: idiom in Python. This is a common pattern that allows a Python script to be both importable and executable. Here‚Äôs an explanation:</p>
<ol type="1">
<li>When a Python file is run directly, Python sets the special <code>__name__</code> variable to ‚Äú<code>__main__</code>‚Äù.</li>
<li>When a Python file is imported as a module,<code>__name__</code>is set to the name of the module.</li>
</ol>
<p>By using this idiom, we can control which code runs when the script is executed directly versus when it‚Äôs imported as a module.</p>
</div>
</div>
</section>
</section>
<section id="pip-vs.-conda" class="level1">
<h1>03&amp;04 <a href="https://github.com/astrojuanlu/ie-mbd-advanced-python/blob/main/sessions/03-04_pip-vs-conda.ipynb">pip vs.&nbsp;conda</a></h1>
<section id="managing-python-environments" class="level2">
<h2 class="anchored" data-anchor-id="managing-python-environments">managing python environments</h2>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://raw.githubusercontent.com/astrojuanlu/ie-mbd-advanced-python/e2224276f91529280ebfcd42ddc7dc22cf0d2010/img/python_comrades.png" class="img-fluid figure-img"></p>
<figcaption>stolen from the lecture</figcaption>
</figure>
</div>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>Simple is better than complex.</p>
<p>Complex is better than complicated.</p>
</blockquote>
<p>How do people install and upgrade Python? -&gt; Most of people choose Python.org, the same for me!</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>This way ships a tool to create development environments (<code>venv</code>). However, <code>venv</code> cannot create environments with different Python versions (you‚Äôre tied to the one you downloaded) and certain packages will require extra steps to be installed. Therefore, it <strong>is not</strong> for everyone.</p>
</div>
</div>
<p>Juan chose to use <code>conda</code>. As I am learning Docker, I choose Docker for this tutorial.</p>
<p>How do people create isolated development environments? -&gt; The most popular is <code>Virtualenv</code>. But normally when doing an analysis task, I use <code>venv</code> which is built-in python lib. Recently I followed my dev team to use <code>pipenv</code>, I do also see <code>poetry</code> is worth-learning approach.</p>
<blockquote class="blockquote">
<p>‚ÄúMore than a half of the users of Jupyter Notebook and JupyterLab choose Conda‚Äù</p>
</blockquote>
<p>As I think a model which is not deployed yet is useless model, I choose VS Code and Docker - more deployment-oriented.</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">summary</h2>
<blockquote class="blockquote">
<p>For the user, the most salient distinction is probably this: pip installs python packages within any environment; conda installs any package within conda environments.</p>
<p>‚ÄîJake Vanderplas</p>
</blockquote>
<p>However, I will be using <code>pipenv</code> to achieve what Juan done in upcoming sections. I will specify version of each package I used.</p>
</section>
<section id="pip-and-pypi" class="level2">
<h2 class="anchored" data-anchor-id="pip-and-pypi"><code>pip</code> and <code>PyPI</code></h2>
<p><code>pip</code> is the default Python installer. By default, it fetches packages from <a href="https://pypi.org/" class="uri">https://pypi.org/</a>, which is the community repository for Python packages.</p>
</section>
</section>
<section id="layout" class="level1">
<h1>05 layout</h1>
<p>here is my project‚Äôs layout:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ie-titanic-utils</span></span>
<span id="cb8-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îú‚îÄ</span> src</span>
<span id="cb8-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>  ‚îî‚îÄ ie_titanic_utils</span>
<span id="cb8-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     ‚îú‚îÄ __init__.py</span>
<span id="cb8-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     ‚îî‚îÄ ...</span>
<span id="cb8-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îú‚îÄ</span> tests</span>
<span id="cb8-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>  ‚îî‚îÄ ...</span>
<span id="cb8-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îú‚îÄ</span> .gitignore</span>
<span id="cb8-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îú‚îÄ</span> README.md</span>
<span id="cb8-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îî‚îÄ</span> pyproject.toml</span></code></pre></div>
<ul>
<li>The <code>src/package_name</code> contains the source code of the library. <code>package_name</code> must be Python identifier. It should contain a <code>__init__.py</code> that can be empty;</li>
<li>The <code>tests</code> directory contains the tests. It must not contain any <code>__init__.py</code> because it‚Äôs not meant to be imported as a package. In very specific cases it‚Äôs included inside <code>src/package_name</code>;</li>
<li>Every project contains a <code>README.md</code> that at least explains what the project is;</li>
<li><code>pyproject.toml</code> contains the metadata of the project. The absolutely required fields are <code>module</code>, <code>author</code>, and some extra information that tells Python how to install the package.</li>
</ul>
<section id="creating-a-package" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-package">creating a package</h2>
<ol type="1">
<li>run <code>flit init</code> to create the metadata</li>
</ol>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ÓÇ∂</span> ie-titanic-utils ÓÇ∞ flit init</span>
<span id="cb9-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pyproject.toml</span> exists <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> overwrite it<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">?</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">y/N</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span>: y</span>
<span id="cb9-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Module</span> name <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">ie_titanic_utils</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span>: ie_utils</span>
<span id="cb9-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Author:</span> Tuan Le Khac</span>
<span id="cb9-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Author</span> email: tuan.lekhac0905@gmail.com</span>
<span id="cb9-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Home</span> page: </span>
<span id="cb9-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Choose</span> a license <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">see</span> http://choosealicense.com/ for more info<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb9-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1.</span> MIT <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> simple and permissive</span>
<span id="cb9-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2.</span> Apache <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> explicitly grants patent rights</span>
<span id="cb9-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">3.</span> GPL <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> ensures that code based on this is shared with the same terms</span>
<span id="cb9-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">4.</span> Skip <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> choose a license later</span>
<span id="cb9-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Enter</span> 1-4: 4</span>
<span id="cb9-13"></span>
<span id="cb9-14"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Written</span> pyproject.toml<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">edit</span> that file to add optional extra info.</span></code></pre></div>
<ol start="2" type="1">
<li>place some code under the source directory. In <code>__init__.py</code> there must be a docstring giving a description of the project and a <code>__version__</code> variable indicating the version:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>__init__.py</strong></pre>
</div>
<div class="sourceCode" id="cb10" data-filename="__init__.py" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""IE utils (test package)."""</span></span>
<span id="cb10-2"></span>
<span id="cb10-3">__version__ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0.1.0"</span></span></code></pre></div>
</div>
<ol start="3" type="1">
<li>Install the code using <code>pip install</code>! (this did not work for me currently. edit: the project name should match the <code>src/package_name</code> omg)</li>
</ol>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ÓÇ∂</span> ie-titanic-utils ÓÇ∞ pip install .</span>
<span id="cb11-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Processing</span> .ie-titanic-utils</span>
<span id="cb11-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">...</span></span>
<span id="cb11-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Successfully</span> installed ie_titanic_utils-0.1.0</span>
<span id="cb11-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ÓÇ∂</span> ie-titanic-utils ÓÇ∞ python</span>
<span id="cb11-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Python</span> 3.11.4 <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">tags/v3.11.4:d2340ef,</span> Jun  7 2023, 05:45:37<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[MSC</span> v.1934 64 bit <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">AMD64</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">]</span> on win32</span>
<span id="cb11-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Type</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"help"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"copyright"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"credits"</span> or <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"license"</span> for more information.</span>
<span id="cb11-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> import <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ie_titanic_utils</span></span>
<span id="cb11-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span> ie_titanic_utils.__version__</span>
<span id="cb11-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0.1.0'</span></span>
<span id="cb11-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span>    </span></code></pre></div>
<ol start="4" type="1">
<li><code>readme.md</code> and a <code>.gitignore</code> files were created.</li>
<li>commit the change</li>
</ol>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> checkout <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-b</span> first_module <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># i should be using switch (-c) haha, checkout is old syntax</span></span>
<span id="cb12-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> status</span>
<span id="cb12-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> add .</span>
<span id="cb12-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> commit <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"initial very first module"</span></span>
<span id="cb12-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> checkout master</span>
<span id="cb12-6"></span>
<span id="cb12-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ÓÇ∂</span> ie-titanic-utils ÓÇ∞ git merge <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-ff</span> first_module</span>
<span id="cb12-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Merge</span> made by the <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ort'</span> strategy.</span>
<span id="cb12-9"> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pyproject.toml</span>                    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">30</span> ++++++++++++++++++++++++++++++</span>
<span id="cb12-10"> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">src/ie_titanic_utils/__init__.py</span>  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span>  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">6</span> ++++++</span>
<span id="cb12-11"> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">src/ie_titanic_utils/str_utils.py</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span>  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">6</span> ++++++</span>
<span id="cb12-12"> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">3</span> files changed, 42 insertions<span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">+</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb12-13"> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">create</span> mode 100644 pyproject.toml</span>
<span id="cb12-14"> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">create</span> mode 100644 src/ie_titanic_utils/__init__.py</span>
<span id="cb12-15"> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">create</span> mode 100644 src/ie_titanic_utils/str_utils.py</span>
<span id="cb12-16"></span>
<span id="cb12-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> branch <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> first_module</span>
<span id="cb12-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># git push origin master</span></span>
<span id="cb12-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># as I will not upload this code to GitHub</span></span>
<span id="cb12-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># https://stackoverflow.com/questions/32238616/git-push-fatal-origin-does-not-appear-to-be-a-git-repository-fatal-could-n</span></span></code></pre></div>
<p>Now if I log the git, I will see this:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ÓÇ∂</span> ie-titanic-utils ÓÇ∞ git log <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--graph</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--oneline</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--decorate</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--all</span></span>
<span id="cb13-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">*</span>   39105c7 <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">HEAD</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> master<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">)</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Merge</span> branch <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'first_module'</span></span>
<span id="cb13-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb13-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">*</span> 7a33844 initial very first module</span>
<span id="cb13-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">/</span></span>
<span id="cb13-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">*</span> 793bd67 initial commit</span></code></pre></div>
<p>Yeah til now I can create a ‚Äúpackage‚Äù in my computer and install so I can use it <strong>globally</strong>. But I have not use any env management yet.</p>
</section>
<section id="intermezzo-version-numbers" class="level2">
<h2 class="anchored" data-anchor-id="intermezzo-version-numbers">intermezzo: version numbers</h2>
<ul>
<li>Version numbers for Python packages are explained in <a href="https://www.python.org/dev/peps/pep-0440/">PEP 440</a></li>
<li>For libraries, the most widely used convention is <a href="https://semver.org/">semantic versioning</a>: X.Y.Z
<ul>
<li>Z <strong>must</strong> be incremented if only backwards compatible bug fixes are introduced (a bug fix is defined as an internal change that fixes incorrect behavior)</li>
<li>Y <strong>must</strong> be incremented every time there is new, backwards-compatible functionality</li>
<li>X <strong>must</strong> be incremented every time there are backwards-incompatible changes</li>
</ul></li>
<li>Between releases, the version should have the <code>.dev0</code> suffix</li>
<li>Recommendation: start with 0.1.dev0 (development version), then make a <code>0.1.0</code> release, then progress to <code>0.1.1</code> for quick fixes and <code>0.2.0</code> for new functionality, and when you want to make a promise of relative stability jump to <code>1.0.0</code>.</li>
<li>For applications, other conventions are more appropriate, like <a href="https://calver.org/">calendar versioning</a>: <code>[YY]YY.MM.??</code></li>
</ul>
</section>
<section id="project-requirements" class="level2">
<h2 class="anchored" data-anchor-id="project-requirements">project requirements</h2>
<p>Sometimes our project will depend on third-party libraries (pandas, scikit-learn). To make pip install those dependencies automatically, we can add them to our <code>pyproject.toml</code> under the <code>[tool.flit.metadata]</code> section, using the <code>requires</code> option:</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">build-system</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb14-2">requires = <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">"flit_core&gt;=3.4"</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb14-3">build-backend = "flit_core.buildapi"</span>
<span id="cb14-4"></span>
<span id="cb14-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">project</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb14-6">name = "ie_titanic_utils"</span>
<span id="cb14-7">authors = <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">{name = "Tuan Le Khac", email = "tuan.lekhac0905@gmail.com"}</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb14-8">readme = "readme.md"</span>
<span id="cb14-9">requires-python = "&gt;=3.11"</span>
<span id="cb14-10">dynamic = <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">"version", "description"</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb14-11">classifiers = [</span>
<span id="cb14-12">    "Programming Language :: Python :: 3",</span>
<span id="cb14-13">    "License :: OSI Approved :: MIT License",</span>
<span id="cb14-14">    "Operating System :: OS Independent",</span>
<span id="cb14-15">]</span>
<span id="cb14-16">requires = [</span>
<span id="cb14-17">    "pandas",</span>
<span id="cb14-18">    "matplotlib&gt;=2",</span>
<span id="cb14-19">]</span></code></pre></div>
<p>We might want to specify <em>optional</em> dependencies that should only be installed upon request, or for some specific purposes. A typical example will be development dependencies: we will need things like <code>pytest</code> and <code>black</code>, but we don‚Äôt want the user to install them as part as our library. To do that, we can specify <em>groups</em> of optional dependencies under the <code>tool.flit.metadata.requires-extra</code> section:</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb15-1">In my case, I use <span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">`project.optional-dependencies`</span>: flit_core.config.ConfigError: Use <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">project</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> table for metadata or <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">tool.flit.metadata</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>, not both.</span>
<span id="cb15-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">project.optional-dependencies</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb15-3">dev = [</span>
<span id="cb15-4">    "pytest&gt;=6.0",</span>
<span id="cb15-5">    "black&gt;=20.8b1",</span>
<span id="cb15-6">]</span></code></pre></div>
<p>That way, they will only get installed when <code>[dev]</code> is added after the name of our library:</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ÓÇ∂</span> ie-titanic-utils ÓÇ∞ pip install .<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">dev</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb16-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Successfully installed black-24.4.2 ie_titanic_utils-0.1.0 iniconfig-2.0.0 pytest-8.2.2</span></span></code></pre></div>
</section>
</section>
<section id="unit-test" class="level1">
<h1>06 <a href="https://github.com/astrojuanlu/ie-mbd-advanced-python/blob/main/sessions/06_unit-tests.ipynb">unit test</a></h1>
<blockquote class="blockquote">
<p>If you use software that lacks automated tests, you are the tests.</p>
<p>‚Äî Jenny Bryan (<span class="citation" data-cites="JennyBryan">@JennyBryan</span>) <a href="https://x.com/JennyBryan/status/1043307291909316609?ref_src=twsrc%5Etfw">September 22, 2018</a></p>
</blockquote>
<p>Testing is <strong>essential</strong>. Computers excel at doing repetitive tasks: they basically never make mistakes (the mistake might be in what we told the computer to do). Humans, on the other hand, fail more often, especially under pressure, or on Friday afternoons and Monday mornings. Therefore, instead of letting the humans be the tests, we will use the computer to <strong>frequently verify that our software works as specified</strong>.</p>
<p>I will be using <code>pytest</code> to achieve this.</p>
<section id="test-driven-development" class="level2">
<h2 class="anchored" data-anchor-id="test-driven-development">test-driven development</h2>
<p>The ‚Äútest-driven development mantra‚Äù is <span style="color:red;font-weight:bold;">Red</span> - <span style="color:green;font-weight:bold;">Green</span> - <span style="color:grey;font-weight:bold;">Refactor</span>:</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://raw.githubusercontent.com/astrojuanlu/ie-mbd-advanced-python/e2224276f91529280ebfcd42ddc7dc22cf0d2010/img/red-green-refactor.png" class="img-fluid figure-img"></p>
<figcaption>Make it work. Make it right. Make it fast.</figcaption>
</figure>
</div>
</div>
</div>
</div>
<ol type="1">
<li>Write a test. <span style="color:red;font-weight:bold;">Watch it fail</span>.</li>
<li>Write just enough code to <span style="color:green;font-weight:bold;">pass the test</span>.</li>
<li>Improve the code without breaking the test.</li>
</ol>
<p>Repeat.</p>
</section>
<section id="testing-in-python" class="level2">
<h2 class="anchored" data-anchor-id="testing-in-python">testing in Python</h2>
<p>Summary: use <code>pytest</code>. Everybody does. It rocks.</p>
<p><a href="https://docs.pytest.org/en/8.2.x/">pytest</a> is a testing framework for Python that makes writing tests extremely easy. It is much more powerful than the standard library equivalent, <code>unittest</code>. We can use by install it first <code>pip install pytest</code>.</p>
<p>We can write a function that test the <code>tokenize</code> funtion:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>tests/test_tokenize.py</strong></pre>
</div>
<div class="sourceCode" id="cb17" data-filename="tests/test_tokenize.py" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> ie_titanic_utils <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tokenize  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This will fail right away!</span></span>
<span id="cb17-2"></span>
<span id="cb17-3"></span>
<span id="cb17-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> test_tokenize_returns_expected_list():</span>
<span id="cb17-5">    sentence <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"This is a sentence"</span></span>
<span id="cb17-6">    expected_tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"This"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sentence"</span>]</span>
<span id="cb17-7"></span>
<span id="cb17-8">    tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenize(sentence)</span>
<span id="cb17-9"></span>
<span id="cb17-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">assert</span> tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> expected_tokens</span></code></pre></div>
</div>
<p>and we run it from the command line:</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ÓÇ∂</span> ie-titanic-utils ÓÇ∞ pytest</span>
<span id="cb18-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">============================================================================================</span> test session starts ============================================================================================</span>
<span id="cb18-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">platform</span> win32 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--</span> Python 3.11.4, pytest-8.2.2, pluggy-1.5.0</span>
<span id="cb18-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rootdir:</span> .ie-titanic-utils</span>
<span id="cb18-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">configfile:</span> pyproject.toml</span>
<span id="cb18-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">plugins:</span> anyio-3.7.1, time-machine-2.14.0</span>
<span id="cb18-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">collected</span> 1 item</span>
<span id="cb18-8"></span>
<span id="cb18-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">teststest_tokenize.py</span> .                                                                                                                                                                               <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">100%</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">]</span> </span>
<span id="cb18-10"></span>
<span id="cb18-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">=============================================================================================</span> 1 passed in 0.02s ============================================================================================= </span></code></pre></div>
<p>The test successed after I fixed the <code>__init__.py</code>:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/./__init__.py</strong></pre>
</div>
<div class="sourceCode" id="cb19" data-filename="src/./__init__.py" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> ie_titanic_utils.str_utils <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tokenize</span>
<span id="cb19-2">__all__ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tokenize"</span>]</span></code></pre></div>
</div>
</section>
</section>
<section id="oop" class="level1 page-columns page-full">
<h1>07&amp;08 <a href="https://github.com/astrojuanlu/ie-mbd-advanced-python/blob/main/sessions/07-08_object-oriented-programming.ipynb">oop</a></h1>
<section id="what-are-objects-anyway" class="level2">
<h2 class="anchored" data-anchor-id="what-are-objects-anyway">what are ‚Äúobjects‚Äù anyway?</h2>
<p>like pandas‚Äôs <code>DataFrame</code> or matplotlib‚Äôs <code>Figure</code>, an <em>object</em> is sthg that has:</p>
<ul>
<li>object-bound variables: call <strong>properties</strong>;</li>
<li>object-bound functions: call <strong>methods</strong>.</li>
</ul>
<p>if the object‚Äôs properties can change, we say they have <strong>states</strong>, in that case they are <strong>mutable</strong>. otherwise, they are <strong>stateless</strong> and <strong>immutable</strong>. a typical example is list (mutable) and tuple (immutable).</p>
<div id="420bf50e" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1">my_list <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb20-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(my_list)</span>
<span id="cb20-3">my_list.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb20-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(my_list)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1, 2, 3]
[1, 2, 3, 4]</code></pre>
</div>
</div>
<div id="3893a277" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The operator that creates tuples is not parentheses:</span></span>
<span id="cb22-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># is the comma!</span></span>
<span id="cb22-3">my_tuple <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Notice that I don't need parentheses!</span></span>
<span id="cb22-4">my_tuple</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>(1, 2, 3)</code></pre>
</div>
</div>
<div id="62ffbdb1" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span>(my_tuple))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Nothing that allows us to change the state of the tuple</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>['__add__', '__class__', '__class_getitem__', '__contains__', '__delattr__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__getitem__', '__getnewargs__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__iter__', '__le__', '__len__', '__lt__', '__mul__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__rmul__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', 'count', 'index']</code></pre>
</div>
</div>
<div id="38108e09" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1">my_tuple[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This wont work, "TypeError: 'tuple' object does not support item assignment"</span></span></code></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Immutable objects have the advantage that they can be <strong>hashed</strong>, that is: they can be transformed, using some cryptographical function, into something that uniquely represents that object. Mutable objects can‚Äôt, because the hash would have to change every time the state of the object changed. <strong>Dictionary keys have to be hashable objects</strong>.</p>
</div>
</div>
<div id="12fa6316" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1">{</span>
<span id="cb27-2">    my_tuple: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my_tuple"</span></span>
<span id="cb27-3">}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>{(1, 2, 3): 'my_tuple'}</code></pre>
</div>
</div>
<div id="249e2363" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hash</span>(my_tuple)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>529344067295497451</code></pre>
</div>
</div>
<div id="5ef6beee" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this wont work: "TypeError: unhashable type: 'list'"</span></span>
<span id="cb31-2">{</span>
<span id="cb31-3">    my_list: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my_list"</span></span>
<span id="cb31-4">}</span></code></pre></div>
</details>
</div>
<div id="0096641b" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this wont work: "TypeError: unhashable type: 'list'"</span></span>
<span id="cb32-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hash</span>(my_list)</span></code></pre></div>
</details>
</div>
</section>
<section id="classes-and-instances" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="classes-and-instances">classes and instances</h2>
<p>objects are defined by <strong>instantiating a class</strong>. a class is a <strong>template</strong> for objects, where we define it‚Äôs behaviours, an <strong>instance</strong> is a particular realization of that class.</p>
<section id="example" class="level3">
<h3 class="anchored" data-anchor-id="example">Example</h3>
<p>we want model the <code>User</code> of our company‚Äôs product, to later study their behaviours:</p>
<div id="4d14860f" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> User:</span>
<span id="cb33-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">pass</span></span>
<span id="cb33-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(User)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>type</code></pre>
</div>
</div>
<p><code>User</code> class is of type <code>type</code>, which means that is can be used to created new objects. Let‚Äôs create 2 instances:</p>
<div id="30996245" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1">user1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> User()</span>
<span id="cb35-2">user2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> User()</span>
<span id="cb35-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(user1)</span>
<span id="cb35-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(user2)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;__main__.User object at 0x000001B1AD8D4F90&gt;
&lt;__main__.User object at 0x000001B1AD8D4D90&gt;</code></pre>
</div>
</div>
<p>with a slight abuse of notation, we would say we have 2 <code>User</code> objects, or just 2 <code>User</code>s.</p>
</section>
<section id="using-the-instance-self" class="level3">
<h3 class="anchored" data-anchor-id="using-the-instance-self">Using the instance: <code>self</code></h3>
<p>let‚Äôs add a very simple <strong>method</strong> to demonstrate <em>explicit</em> <code>self</code>, a very important concept. a method is like a function bounded to the object, an can use it‚Äôs properties:</p>
<div id="ba8a0d18" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> User:</span>
<span id="cb37-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> whoami(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb37-3">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'This is : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
</details>
</div>
<div id="2441e1cb" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb38-1">user1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> User()</span>
<span id="cb38-2">user1.whoami()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>This is : &lt;__main__.User object at 0x000001B1AD8D4590&gt;</code></pre>
</div>
</div>
<p>why are methods (instead of plain functions) interesting? Because of <strong>duck typing</strong>:</p>
<blockquote class="blockquote">
<p>‚ÄúIf it walks like a duck and it quacks like a duck, then it must be a duck‚Äù ‚Äì <a href="https://en.wikipedia.org/wiki/Duck_typing" class="uri">https://en.wikipedia.org/wiki/Duck_typing</a></p>
</blockquote>
<p>if something has a method that I need, I don‚Äôt care about its type.</p>
<div id="5032dcea" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> do_stuff(obj):</span>
<span id="cb40-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> obj.mean()</span></code></pre></div>
</details>
</div>
<div id="e0da8b5a" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb41-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb41-3"></span>
<span id="cb41-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(do_stuff(np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)))</span>
<span id="cb41-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(do_stuff(pd.Series([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>2.0
2.0</code></pre>
</div>
</div>
<p>notice how we called <code>user1.test()</code> <strong>without passing an extra argument</strong>? This is because Python is automatically passing the instance. It‚Äôs the equivalent of doing this (<strong>never do this</strong>):</p>
<div id="8b163d53" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1">User.whoami(user1)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>This is : &lt;__main__.User object at 0x000001B1AD8D4590&gt;</code></pre>
</div>
</div>
<p>in fact, if we define a method without a first parameter, it will fail when we call it:</p>
<div id="5bf4beeb" class="cell" data-execution_count="18">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb45-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> TestClass:</span>
<span id="cb45-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> test():</span>
<span id="cb45-3">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">pass</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Don't do anything</span></span>
<span id="cb45-4"></span>
<span id="cb45-5">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TestClass()</span>
<span id="cb45-6">t.test()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fails: "TypeError: test() takes 0 positional arguments but 1 was given"</span></span></code></pre></div>
</details>
</div>
<p>this first parameter can be called anything, but <strong>everybody uses <code>self</code></strong>. Remember, conventions are important to minimize surprise and enhance collaboration!</p>
</section>
<section id="intermezzo-f-strings" class="level3">
<h3 class="anchored" data-anchor-id="intermezzo-f-strings">intermezzo: f-strings</h3>
<div id="669cec83" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"This is </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>user1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Python &gt;= 3.6</span></span>
<span id="cb46-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"This is </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(user1))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Python &lt; 3.6, equivalent</span></span>
<span id="cb46-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(User.whoami(user1))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DON'T use! (Although it's equivalent)   </span></span>
<span id="cb46-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># %timeit User.whoami(user1)  # They have about the same performance </span></span>
<span id="cb46-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># %timeit user1.whoami()</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>This is &lt;__main__.User object at 0x000001B1AD8D4590&gt;
This is &lt;__main__.User object at 0x000001B1AD8D4590&gt;
This is : &lt;__main__.User object at 0x000001B1AD8D4590&gt;
None</code></pre>
</div>
</div>
</section>
<section id="initializing-our-instances" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="initializing-our-instances">initializing our instances</h3>
<p>The ellipsis (<code>...</code>) is a built-in constant in Python. It‚Äôs an instance of the <code>ellipsis</code> (d·∫•u ch·∫•m l·ª≠ng) class.</p>
<div id="dd7c9d48" class="cell" data-execution_count="20">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb48-1">...</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>Ellipsis</code></pre>
</div>
</div>
<p>common uses of ellipsis:</p>
<ul>
<li>as a placeholder in function definitions or class bodies</li>
<li>in type hinting (especially for variable-length tuples)</li>
<li>in slicing operations (especially for multidimensional arrays in libraries like NumPy)</li>
</ul>
<div id="9042a8b1" class="cell" data-execution_count="21">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># As a placeholder</span></span>
<span id="cb50-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> function_to_be_implemented_later():</span>
<span id="cb50-3">    ...</span>
<span id="cb50-4"></span>
<span id="cb50-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># In type hinting</span></span>
<span id="cb50-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Tuple</span>
<span id="cb50-7"></span>
<span id="cb50-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> process_points(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>points: Tuple[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, ...]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb50-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> point <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> points:</span>
<span id="cb50-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Processing point: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>point<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb50-11"></span>
<span id="cb50-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Usage</span></span>
<span id="cb50-13">process_points((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Processing point: (1, 2)
Processing point: (3, 4, 5)
Processing point: (6,)</code></pre>
</div>
</div>
<div id="82041adf" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb52-1">user1.this_property <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ...  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># "99", whatever</span></span>
<span id="cb52-2">user1.this_property</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>Ellipsis</code></pre>
</div>
</div>
<p>however, this is considered a bad practice, and can confuse editors and static analysis tools. These properties should be specified on creation, in a way that I cannot have a user without <code>name</code> and <code>signup_date</code>. Python provides us a special method, <code>__init__</code> (this should not be confused with file <code>__init__.py</code> we put to project to tell Python our code is a package), that <strong>initializes</strong><sup>1</sup> the object:</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;This philosophy used to be summarized by the sentence ‚Äúwe are all consenting adults here‚Äù, which is nowadays being less used.</p></div></div><div id="ab86dd9f" class="cell" data-execution_count="23">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb54-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> User:</span>
<span id="cb54-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># "dunder init" = double underscore init</span></span>
<span id="cb54-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, name, signup_date):</span>
<span id="cb54-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> name</span>
<span id="cb54-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.signup_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> signup_date</span></code></pre></div>
</details>
</div>
<div id="9423fb8d" class="cell" data-execution_count="24">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb55-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> dt</span>
<span id="cb55-2">user1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> User(name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"John Doe"</span>, signup_date<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dt.datetime.now())</span>
<span id="cb55-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(user1.name, user1.signup_date, sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>John Doe
2024-08-01 23:07:08.587740</code></pre>
</div>
</div>
<p>that‚Äôs something! However, there are several things we can improve:</p>
<ul>
<li>it can be cumbersome to specify the date every time, and it would be nice to have some default.</li>
<li>the default representation of the instances contains some hexadecimal memory address and nothing else. It would be nice to at least see the user name and the signup date</li>
<li>nothing stops me from changing the name and signup_date of a existing user:</li>
</ul>
</section>
<section id="exercise" class="level3">
<h3 class="anchored" data-anchor-id="exercise">exercise</h3>
<ul>
<li>make <code>signup_date</code> optional by providing a default value;</li>
<li>make the <code>__repr__</code> method return a string containing the <code>name</code> and <code>signup_date</code>, which will override the default.</li>
</ul>
<div id="fd72f5b4" class="cell" data-execution_count="25">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb57-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> User:</span>
<span id="cb57-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, name, signup_date<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb57-3">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> signup_date <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb57-4">            signup_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dt.datetime.now() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Watch out with default parameters! They are created when the function is defined.</span></span>
<span id="cb57-5"></span>
<span id="cb57-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> name</span>
<span id="cb57-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.signup_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> signup_date</span>
<span id="cb57-8"></span>
<span id="cb57-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__repr__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb57-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"User(name='</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">', signup_date=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">repr</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.signup_date)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span></span></code></pre></div>
</details>
</div>
<div id="bd10d931" class="cell" data-execution_count="26">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb58-1">user1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> User(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"John Doe"</span>)</span>
<span id="cb58-2">user1</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>User(name='John Doe', signup_date=datetime.datetime(2024, 8, 1, 23, 7, 8, 618751))</code></pre>
</div>
</div>
</section>
<section id="extra-date-formatting" class="level3">
<h3 class="anchored" data-anchor-id="extra-date-formatting">extra: date formatting</h3>
<div id="fc4b84ad" class="cell" data-execution_count="27">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb60-1">dt.datetime.now().isoformat()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ISO 8601</span></span>
<span id="cb60-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If you don't like it, there's http://strftime.org/</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>'2024-08-01T23:07:08.625045'</code></pre>
</div>
</div>
<div id="b23b8c74" class="cell" data-execution_count="28">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb62-1">user1.signup_date.strftime(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%Y ::: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>'2024 ::: 01'</code></pre>
</div>
</div>
</section>
<section id="protecting-properties" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="protecting-properties">protecting properties</h3>
<p>in Python, there are <em>no private attributes</em> (neither properties nor methods), and in fact everything can be accessed <sup>2</sup>. However, we can ‚Äúhide‚Äù them by default in autocomplete and other environments by using a leading underscore <code>_</code>: this is usually called <strong>protected variables</strong>.</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;This philosophy used to be summarized by the sentence ‚Äúwe are all consenting adults here‚Äù, which is nowadays being less used.</p></div></div><p>there is a common pattern in which, if I want to make some property read-only, we can:</p>
<ul>
<li>make it protected</li>
<li>create a ‚Äúgetter‚Äù using the <span class="citation" data-cites="property">@property</span> decorator, which gets the value of the protected property with a public name</li>
</ul>
<div id="b008d693" class="cell" data-execution_count="29">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb64-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> User:</span>
<span id="cb64-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, name, signup_date<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb64-3">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> signup_date <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb64-4">            signup_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dt.datetime.now()</span>
<span id="cb64-5"></span>
<span id="cb64-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> name</span>
<span id="cb64-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._signup_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> signup_date</span>
<span id="cb64-8"></span>
<span id="cb64-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@property</span></span>
<span id="cb64-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> name(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb64-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._name</span>
<span id="cb64-12"></span>
<span id="cb64-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@property</span></span>
<span id="cb64-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> signup_date(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb64-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._signup_date</span>
<span id="cb64-16"></span>
<span id="cb64-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__repr__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb64-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"User(name='</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">', signup_date='</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>signup_date<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">')"</span></span></code></pre></div>
</details>
</div>
<div id="e9a3b5f8" class="cell" data-execution_count="30">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb65-1">user1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> User(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tuan Le"</span>)</span>
<span id="cb65-2">user1.name</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>'Tuan Le'</code></pre>
</div>
</div>
<div id="9fb2282d" class="cell" data-execution_count="31">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb67-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this wont work: "AttributeError: can't set attribute"</span></span>
<span id="cb67-2">user1.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tan Le"</span></span></code></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you see tutorials mentioning ‚Äútrue private variables‚Äù, they are wrong!</p>
</div>
</div>
<div id="88ed0501" class="cell" data-execution_count="32">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb68-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Test:</span>
<span id="cb68-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, name):</span>
<span id="cb68-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.__name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> name  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Not what you think!</span></span>
<span id="cb68-4">t1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Test(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"This name"</span>)</span></code></pre></div>
</details>
</div>
<div id="e79d62f4" class="cell" data-execution_count="33">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb69" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb69-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this wont work</span></span>
<span id="cb69-2">t1.__name</span></code></pre></div>
</details>
</div>
<div id="ed82f250" class="cell" data-execution_count="34">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb70-1">t1._Test__name  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># These are *NOT* "private" properties</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>'This name'</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The behavior you‚Äôre experiencing is due to a feature in Python called ‚Äúname mangling‚Äù for private attributes. Let‚Äôs break down what‚Äôs happening:</p>
<p>Double underscore prefix:</p>
<ul>
<li>When you define an attribute with a double underscore prefix (__) in a class, Python automatically mangles the name to avoid naming conflicts in inherited classes.</li>
<li>Name mangling process: Python changes the name from __name to _ClassName__name. In your case, it becomes _Test__name.</li>
<li>Accessing the attribute: Because of this name mangling, you can‚Äôt access t1.__name directly. Instead, you would need to use the mangled name.</li>
</ul>
<div id="950c80df" class="cell" data-execution_count="35">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb72-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Test:</span>
<span id="cb72-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, name):</span>
<span id="cb72-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.__name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> name  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This gets mangled</span></span>
<span id="cb72-4"></span>
<span id="cb72-5">t1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Test(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"This name"</span>)</span>
<span id="cb72-6"></span>
<span id="cb72-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This will raise an AttributeError</span></span>
<span id="cb72-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span>:</span>
<span id="cb72-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(t1.__name)</span>
<span id="cb72-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">AttributeError</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb72-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"AttributeError: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb72-12"></span>
<span id="cb72-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This will work</span></span>
<span id="cb72-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(t1._Test__name)</span>
<span id="cb72-15"></span>
<span id="cb72-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># You can see all attributes, including mangled ones</span></span>
<span id="cb72-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span>(t1))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>AttributeError: 'Test' object has no attribute '__name'
This name
['_Test__name', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__']</code></pre>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="inheritance" class="level2">
<h2 class="anchored" data-anchor-id="inheritance">inheritance</h2>
<div id="d54bc550" class="cell" data-execution_count="36">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb74-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> SpecialUser(User):</span>
<span id="cb74-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, name, age, signup_date<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb74-3">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initializes self._name and self._signup_date</span></span>
<span id="cb74-4">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(name, signup_date)</span>
<span id="cb74-5"></span>
<span id="cb74-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._age <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> age</span>
<span id="cb74-7"></span>
<span id="cb74-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@property</span></span>
<span id="cb74-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> age(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb74-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._age</span>
<span id="cb74-11"></span>
<span id="cb74-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> greet(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb74-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Hi! I'm </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</details>
</div>
<div id="dd17b672" class="cell" data-execution_count="37">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb75-1">s_user1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SpecialUser(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"John Doe"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>)</span>
<span id="cb75-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#s_user1</span></span></code></pre></div>
</details>
</div>
<div id="bb9e12fb" class="cell" data-execution_count="38">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb76-1">s_user1.name</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>'John Doe'</code></pre>
</div>
</div>
<div id="7742acf4" class="cell" data-execution_count="39">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb78" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb78-1">s_user1.greet()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Hi! I'm John Doe</code></pre>
</div>
</div>
<ul>
<li>the diamond problem: <a href="https://www.wikiwand.com/en/Multiple_inheritance#/The_diamond_problem" class="uri">https://www.wikiwand.com/en/Multiple_inheritance#/The_diamond_problem</a></li>
<li>???: <a href="https://softwareengineering.stackexchange.com/questions/238176/why-would-square-inheriting-from-rectangle-be-problematic-if-we-override-the-set/238184#238184" class="uri">https://softwareengineering.stackexchange.com/questions/238176/why-would-square-inheriting-from-rectangle-be-problematic-if-we-override-the-set/238184#238184</a></li>
<li>liskov substitution principle: <a href="https://www.wikiwand.com/en/Liskov_substitution_principle" class="uri">https://www.wikiwand.com/en/Liskov_substitution_principle</a></li>
<li>composition and inheritance: <a href="https://www.thedigitalcatonline.com/blog/2014/08/20/python-3-oop-part-3-delegation-composition-and-inheritance/" class="uri">https://www.thedigitalcatonline.com/blog/2014/08/20/python-3-oop-part-3-delegation-composition-and-inheritance/</a></li>
</ul>
<section id="more-special-methods" class="level3">
<h3 class="anchored" data-anchor-id="more-special-methods">more special methods</h3>
<p>go search for python data model</p>
</section>
</section>
</section>
<section id="flask" class="level1">
<h1>09&amp;10 <a href="https://github.com/astrojuanlu/ie-mbd-advanced-python/blob/main/sessions/09-10_flask.ipynb">flask</a></h1>
<ul>
<li>flask is a ‚Äúlightweight framework‚Äù or a ‚Äúmicroframework‚Äù. ‚ÄúIt is designed to make getting started quick and easy, with the ability to scale up to complex applications‚Äù, and therefore requires less context to get started with;</li>
<li>django is a ‚Äúbatteries included‚Äù framework that is more focused on good practices and encouraging a ‚Äúclean, pragmatic design‚Äù. It‚Äôs more complex and requires more experience to master.</li>
</ul>
</section>
<section id="conclusion" class="level1">
<h1><a href="https://github.com/astrojuanlu/ie-mbd-advanced-python/blob/main/sessions/99_conclusion.ipynb">conclusion</a></h1>
<section id="where-do-we-go-from-here" class="level2">
<h2 class="anchored" data-anchor-id="where-do-we-go-from-here">where do we go from here</h2>
<ul>
<li>Keep improving the art of Python packaging</li>
<li>Explore other options for high performance Python</li>
<li>Help ‚Äúbridging the gap‚Äù</li>
<li>Engage with the (open source) Python community</li>
</ul>
</section>
<section id="keep-improving-the-art-of-python-packaging" class="level2">
<h2 class="anchored" data-anchor-id="keep-improving-the-art-of-python-packaging">keep improving the art of python packaging</h2>
<ul>
<li>recommend: <code>pip-tools</code> + <code>requirements.in</code> = <code>requirements.txt</code></li>
<li>Poetry, Pipenv‚Ä¶ Yes, they work, but they are way more complex and have ‚Äúlock-in‚Äù</li>
<li>All companies I worked for struggle sooner or later with their code deployment practices. Now, you know better</li>
</ul>
</section>
<section id="explore-other-options-for-high-performance-python" class="level2">
<h2 class="anchored" data-anchor-id="explore-other-options-for-high-performance-python">explore other options for high performance python</h2>
<ul>
<li>Juan mentioned: Numba, Modin, Vaex, Dask, Spark, Coiled, Prefect</li>
<li>Now we have more: polar, pandas 2.0, aiflow, dagster, dbt, etc</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-07-08-advanced-python/setup_py_br.png" class="img-fluid figure-img"></p>
<figcaption>stolen from the lecture</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="other-resources" class="level1">
<h1>other resources</h1>
<ol type="1">
<li><a href="https://nbviewer.org/github/astrojuanlu/ie-mbd-advanced-python/tree/main/">NBViewer</a> for this lecture;</li>
<li><a href="https://pydata.org/">PyData</a>, a community for developers and users of open source data tools;</li>
<li><a href="https://git-scm.com/book/en/v2/">Pro Git</a>, <code>--distributed-is-the-new-centralized</code>;</li>
<li><a href="https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-pull-requests">Pull Requests</a>;</li>
<li><a href="https://docs.gitlab.com/ee/user/project/merge_requests/index.html">Merge Requests</a>;</li>
<li><a href="https://www.asmeurer.com/git-workflow/">Git Workflow</a>, the git workflow for contributing to open source repositories;</li>
<li><a href="https://www.toptal.com/developers/gitignore">Git Ignore</a> builder;</li>
<li><a href="https://www.atlassian.com/git/tutorials/rewriting-history">Git commit ‚Äìamend</a>, rewriting history;</li>
<li><a href="https://packaging.python.org/en/latest/tutorials/packaging-projects/">The right way to distribute Python code</a></li>
<li><a href="https://docs.python.org/3/tutorial/modules.html#packages">Python packaging</a></li>
<li><a href="https://docs.pytest.org/en/8.2.x/">Pytest</a>.</li>
</ol>


<!-- -->

</section>


 ]]></description>
  <category>python</category>
  <category>pydata</category>
  <guid>https://lktuan.github.io/blog/2024-07-08-advanced-python/</guid>
  <pubDate>Sun, 07 Jul 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-07-08-advanced-python/juan_r.png" medium="image" type="image/png" height="193" width="144"/>
</item>
<item>
  <title>Random youtube video: How are memories stored in neural networks?</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-06-26-hopfield-network/</link>
  <description><![CDATA[ 





<p>This video came across in my youtube recommendation, the title is <a href="https://www.youtube.com/watch?v=piF6D6CQxUw">‚ÄúHow are memories stored in neural networks? | The Hopfield Network #SoME2‚Äù</a> by <a href="https://www.youtube.com/@layerwiselectures"><strong>Layerwise Lectures</strong></a>.</p>
<p>This channel is interestingly has only 1 video, bio:</p>
<blockquote class="blockquote">
<p>Reality comes in layers - layers of abstraction. This channels tries to uncover them to gain insights on neuroscience and machine learning.</p>
</blockquote>
<p>You‚Äôll find how it interesting, below is my notes.</p>
<section id="where-is-your-memory" class="level1">
<h1>Where is your memory?</h1>
<ul>
<li>The Random Access Memory (RAM) of a nowaday typical computer is 8-32GB. That‚Äôs the part directly interact with CPU.</li>
<li>Aside from that, you may have hard disk with terabyte or so memory.</li>
<li>How about you ~ or your brain? Can we mearsure in bytes?</li>
<li>But the question should be asked in the first place is: Where is it?</li>
<li>Because memory in computer have <strong>physical</strong> location, to access a piece of data in RAM you have to know the the binary address associated with that location.</li>
<li>For the CPU, the matter comes down to just turning on the right wires to retreive the bits in desired location.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-06-26-hopfield-network/Where_is_your_memory.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Where is our memory?</figcaption>
</figure>
</div>
</div>
</div>
</div>
<ul>
<li>Imagine another kind of memory. Instead of specifying <strong>where</strong> of a memory, it‚Äôs a <em>binary address</em>, how about we could specify <strong>what</strong>, it‚Äôs <em>content</em>.</li>
<li>Our memory, if we provide a incomplete version of memory, it‚Äôs just sort of autocompletes. With the right software, computer can also do this, but it‚Äôs not how computer memory work on the basic level.</li>
<li>The point of this video is to convince you that autocompleting memories, also know as <strong>associative memory</strong>, is kind of natural behaviour of networks of neurons.</li>
<li>It‚Äôll become clear that it doesn‚Äôt really make sense to measure memory capacity in networks of neurons in the same way we measure computer memory.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-06-26-hopfield-network/Associative_networks.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Associative Networks</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>The biggest difference might be: computer memory have fixed location, but as we‚Äôll see, the memories in an associative networks rather have - <strong>a time</strong>.</p>
</section>
<section id="computer-memory-in-a-nutshell" class="level1">
<h1>Computer memory in a nutshell</h1>
<ul>
<li>Computer memory is measured in bits, binary switches of ones and zeros. A string of eight such bits can represent anything from letters to integers.</li>
<li>How do I get to a memory once it‚Äôs saved, say in RAM? Because on its own it doesn‚Äôt do much.</li>
<li>Broadly speaking, and glossing over tons of technical detail here, every piece of data in RAM is matched to a binary address.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-06-26-hopfield-network/computer_memory.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Memories are matched to addresses and that‚Äôs ultimately the only way to retrieve them</figcaption>
</figure>
</div>
</div>
</div>
</div>
<ul>
<li>Each piece of data is in a different physical location and can only be retrieved by knowing its address. How the reading and writing of memories is accomplished, is really the meat of programming and is another story.</li>
</ul>
</section>
<section id="modeling-neural-networks" class="level1">
<h1>Modeling neural networks</h1>
<ul>
<li>The aim of the video is to introduce how humain brain memory work, by introducing Hopefield Network.</li>
<li>More generally this lecture aim to be a modelling itself, a kind of the art of essential.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-06-26-hopfield-network/hopfield_networks.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Hopfield Network</figcaption>
</figure>
</div>
</div>
</div>
</div>
<ul>
<li>This is a picture depicted neuron,</li>
<li>it integrates electrical signals from other neurons to determine its own activity and then,</li>
<li>it broadcasts that activity back to the network.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-06-26-hopfield-network/a_neuron.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>A Neuron</figcaption>
</figure>
</div>
</div>
</div>
</div>
<ul>
<li>Mathematically the story goes something like this:</li>
<li>there‚Äôs electrical signals coming in from other neurons, which we will say are just some numbers.</li>
<li>then the synapses act as multipliers on these signals - another set of numbers,</li>
<li>and then the activity of the neuron is based on the sum of the weighted inputs, and by ‚Äúbased on‚Äù I mean that it‚Äôs fine to apply some function after computing the sum.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-06-26-hopfield-network/mathematical_expression_of_neuron.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Mathematical expression of Neuron</figcaption>
</figure>
</div>
</div>
</div>
</div>
<ul>
<li>It gets interesting once we turn this into a network, connecting the outputs of neurons to the inputs of other neurons.</li>
<li>This is a special type of neural network. It‚Äôs a <strong>recurrent network</strong>, meaning that there are <em>back and forth</em> connections between the neurons.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-06-26-hopfield-network/recurrent_network.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Recurrent Network</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="memories-in-dynamical-systems" class="level1">
<h1>Memories in dynamical systems</h1>
<ul>
<li>What does this have to do with memory? Well it needs to be somewhere in here doesn‚Äôt it? Where?</li>
<li>Remember the idea of an associative memory, which is the ability of a system to sort of ‚Äúpattern-autocomplete‚Äù.</li>
<li>Let‚Äôs try a definition of memory that‚Äôs slightly wider than maybe what we‚Äôre used to.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-06-26-hopfield-network/a_state_of_memory.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>A State in memory</figcaption>
</figure>
</div>
</div>
</div>
</div>
<ul>
<li>Let a memory system be a system that, after having been in a certain state, a configuration, it has the ability to return to that state later on.</li>
<li>The responsibility for this return in our computer is CPU.</li>
<li>Our network seems different though. So let‚Äôs get creative. There‚Äôs other things in our everyday lives that fall under our definition of memory.</li>
<li>For example, if below bottle‚Äôs crushed, in other words its configuration changed, it can sometimes return to its earlier state, which in that sense could be said to have been memorized.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-06-26-hopfield-network/a_plastic_bottle_in_our_memory.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>A plastic bottle in our memory</figcaption>
</figure>
</div>
</div>
</div>
</div>
<ul>
<li>A neural network is a system with a pattern of activity that dynamically evolves. If, somehow, we could construct our network such that it would have some <strong>preferred</strong> state and would return to that state over time if it was <strong>perturbed</strong>, then that could reasonably be qualified as a memory.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-06-26-hopfield-network/perturbed_states.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Perturbed states</figcaption>
</figure>
</div>
</div>
</div>
</div>
<ul>
<li>Let‚Äôs take a simple example of 8x8 neurons network. The way our system work is to decribe <strong>how the network change over time</strong> # Learning</li>
</ul>
</section>
<section id="memory-capacity-and-conclusion" class="level1">
<h1>Memory capacity and conclusion</h1>
</section>
<section id="resources" class="level1">
<h1>Resources</h1>
<p>This was the submission to the Summer of Math Exposition 2022 (#SoME2). All credit to <a href="https://www.youtube.com/@layerwiselectures">Layerwise Lectures</a>.</p>
<ol type="1">
<li>Orginal paper: Hopfield, J. J. (1982). Neural networks and physical systems with emergent collective computational abilities. Proceedings of the national academy of sciences, 79(8), 2554-2558.</li>
<li>Image: Neuron image by Santiago Ram√≥n y Cajal, The pyramidal neuron of the cerebral cortex, 1904 Ink and pencil on paper, 8 5/8 x 6 7/8 in.</li>
</ol>


<!-- -->

</section>

 ]]></description>
  <category>neural networks</category>
  <guid>https://lktuan.github.io/blog/2024-06-26-hopfield-network/</guid>
  <pubDate>Tue, 25 Jun 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-06-26-hopfield-network/neuron.png" medium="image" type="image/png" height="81" width="144"/>
</item>
<item>
  <title>Hi Docker üê≥</title>
  <dc:creator>Tuan Le Khac</dc:creator>
  <link>https://lktuan.github.io/blog/2024-06-24-docker/</link>
  <description><![CDATA[ 





<p>Edit: an other great source for Docker - <a href="https://levelup.gitconnected.com/working-with-docker-and-docker-compose-9773295b4d51" class="uri">https://levelup.gitconnected.com/working-with-docker-and-docker-compose-9773295b4d51</a></p>
<div class="columns">
<div class="column" style="width:40%;">
<p>Xu·∫•t ph√°t l√† d√¢n Kinh t·∫ø v√† hi·ªán t·∫°i ƒëi theo h∆∞·ªõng DS, m√¨nh kh√¥ng gi·ªèi l√†m vi·ªác v·ªõi c√°c c√¥ng c·ª• ph√°t tri·ªÉn ph·∫ßn m·ªÅm, Docker l√† m·ªôt trong s·ªë ƒë√≥. Tuy nhi√™n trong m·ªôt d·ª± √°n Data c·ªßa team, m√¨nh c·∫ßn s·ª≠ d·ª•ng c√°c c√¥ng v·ª• nh∆∞ Airflow, Airbyte hay DBT. H·∫ßu h·∫øt c√°c setup ƒë·ªÅu c·∫ßn Docker. Do ƒë√≥ th√¨, ph·∫£i h·ªçc th√¥i!</p>
<p>M√¨nh h·ªçc t·∫≠p theo video <a href="https://www.youtube.com/watch?v=Gh1Sgknc6Fg&amp;t=358s">‚ÄúH∆∞·ªõng d·∫´n t·ª´ A-Z t·ª± x√¢y d·ª±ng ·ª©ng d·ª•ng v·ªõi Docker‚Äù</a> c·ªßa anh <a href="https://www.youtube.com/@vietnh1009"><strong>Vi·ªát Nguy·ªÖn AI</strong></a>.</p>
</div><div class="column" style="width:10%;">
<!-- empty column to create gap -->
</div><div class="column" style="width:50%;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-06-24-docker/vs_cot_song.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>VS Code-song üò™, ·∫£nh nh·∫∑t t·ª´ J2Team community</figcaption>
</figure>
</div>
</div>
</div>
<section id="introduction-docker-desktop-docker-image-vs-docker-container" class="level1">
<h1>Introduction / Docker Desktop / Docker Image vs Docker Container</h1>
<ul>
<li>C√°ch c√†i ƒë·∫∑t: tr√™n trang get started, phi√™n b·∫£n Window (r·∫•t d·ªÖ ƒë·ªÉ m√¨nh follow do m√¨nh c≈©ng x√†i Win).</li>
<li>Nh·∫Øc l·∫°i v·ªÅ Docker Image v√† Docker Container: gi·ªëng nh∆∞ Class v√† Object trong OOP, Image ch·ªâ cho ch√∫ng ta bi·∫øt m·ªôt c√°ch l√Ω thuy·∫øt v·ªÅ th·ª±c th·ªÉ ƒë√≥, khi d·ª±a v√†o l√Ω thuy·∫øt ƒë√≥ t·∫°o ra m·ªôt Container th√¨ ch≈©ng ta m·ªõi c√≥ m·ªôt th·ª±c th·ªÉ d·ª± v√†o l√Ω thuy·∫øt ƒë√≥.</li>
<li>Tr∆∞·ªõc Docker Image, c√≤n c√≥ Dockerfile (gi·ªëng nh∆∞ c√¥ng th·ª©c n·∫•u ƒÉn) gi√∫p ƒë·ªãnh nghƒ©a m·ªôt s·ªë ph∆∞∆°ng th·ª©c t·∫°o ra Image.</li>
</ul>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-06-24-docker/class_vs_object.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Image vs Container ~ Class vs Object</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="docker-tutorial" class="level1">
<h1>Docker tutorial</h1>
<p>Th·ª±c h√†nh theo tutorial tr√™n Docker Desktop: ‚ÄúHow do I run a container?‚Äù</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Xem n·ªôi dung c·ªßa m·ªôt file th√¥ng qua powershell:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span> file_name</span></code></pre></div>
<p>Trong tr∆∞·ªùng h·ª£p th·ª±c h√†nh c·ªßa m√¨nh l√†</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> welcome-to-docker</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span> .<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\D</span>ockerfile</span></code></pre></div>
</div>
</div>
<p>N·ªôi dung Dockerfile:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource md number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Start your image with a node base image</span></span>
<span id="cb3-2">FROM node:18-alpine </span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># M·ªói custome docker image ƒë·ªÅu d·ª±a v√†o m·ªôt base image, nh∆∞ m·ªôt class con k·∫ø th·ª´a m·ªôt class cha. N∆°i t√¨m Docker Image: Docker Hub.</span></span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># The /app directory should act as the main application directory</span></span>
<span id="cb3-6">WORKDIR /app</span>
<span id="cb3-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Ch√∫ng ta l√†m vi·ªác ·ªü b√™n trong th∆∞ m·ª•c n√†o (n·∫øu kh√¥ng ƒë·ªÅ c·∫≠p th√¨ s·∫Ω t·∫°o trong m·ªôt th∆∞ m·ª•c m·∫∑c ƒë·ªãnh)</span></span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Copy the app package and package-lock.json file</span></span>
<span id="cb3-10">COPY package*.json ./</span>
<span id="cb3-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Copy c√°c file trong m√°y v√†o b√™n trong Docker Image - file n√†y ch·∫Øc l√† file c·∫•u h√¨nh</span></span>
<span id="cb3-12"></span>
<span id="cb3-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Copy local directories to the current local directory of our docker image (/app)</span></span>
<span id="cb3-14">COPY ./src ./src</span>
<span id="cb3-15">COPY ./public ./public</span>
<span id="cb3-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Copy c√°c th∆∞ m·ª•c source</span></span>
<span id="cb3-17"></span>
<span id="cb3-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Install node packages, install serve, build the app, and remove dependencies at the end</span></span>
<span id="cb3-19">RUN npm install \</span>
<span id="cb3-20">    &amp;&amp; npm install -g serve \</span>
<span id="cb3-21">    &amp;&amp; npm run build \</span>
<span id="cb3-22">    &amp;&amp; rm -fr node_modules</span>
<span id="cb3-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Run, c√†i ƒë·∫∑t c√°c th∆∞ vi·ªán, package</span></span>
<span id="cb3-24"></span>
<span id="cb3-25">EXPOSE 3000</span>
<span id="cb3-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># M·ªü m·ªôt c·ªïng ·ªü trong Docker container, sau n√†y ch√∫ng ta s·∫Ω k·∫øt n·ªëi c·ªïng n√†y v·ªõi m·ªôt c·ªïng trong m√°y c·ªßa ch√∫ng ta.</span></span>
<span id="cb3-27"></span>
<span id="cb3-28"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Start the app using serve command</span></span>
<span id="cb3-29">CMD <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> "serve", "-s", "build" </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb3-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Ch√∫ng ta mu·ªën ch·∫°y l·ªánh g√¨ trong CMD, ch·ªâ m·ªôt l·ªánh CMD (l·ªánh cu·ªëi c√πng) s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng trong m·ªôt Dockerfile.</span></span></code></pre></div>
<p>Build fist image:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">docker</span> build <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-t</span> welcome-to-docker .</span></code></pre></div>
<p>Breaking down this command:</p>
<blockquote class="blockquote">
<p>The -t flag tags your image with a name. (welcome-to-docker in this case). And the . lets Docker know where it can find the Dockerfile.</p>
</blockquote>
</section>
<section id="t·ª±-x√¢y-d·ª±ng-docker-image-ƒë·ªÉ-hu·∫•n-luy·ªán-m√¥-h√¨nh-ai" class="level1">
<h1>T·ª± x√¢y d·ª±ng Docker Image ƒë·ªÉ hu·∫•n luy·ªán m√¥ h√¨nh AI</h1>
<section id="gi·ªõi-thi·ªáu-v·ªÅ-script-python" class="level2">
<h2 class="anchored" data-anchor-id="gi·ªõi-thi·ªáu-v·ªÅ-script-python">Gi·ªõi thi·ªáu v·ªÅ script Python</h2>
<p>M√¨nh c√≥ m·ªôt file python ƒë∆°n gi·∫£n, hu·∫•n luy·ªán m·ªôt m√¥ h√¨nh <code>ml_project</code> Random forest ƒë·ªÉ nh·∫≠n di·ªán hoa di·ªÖn vƒ© t·ª´ b·ªô <code>iris</code> dataset v·ªõi th∆∞ vi·ªán <code>sklearn</code> nh∆∞ sau:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>iris_classification.py</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-filename="iris_classification.py" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| eval: false</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># importing required libraries</span></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># importing Scikit-learn library and datasets package</span></span>
<span id="cb5-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datasets</span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Splitting arrays or matrices into random train and test subsets</span></span>
<span id="cb5-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.model_selection <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> train_test_split</span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># importing random forest classifier from assemble module</span></span>
<span id="cb5-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.ensemble <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RandomForestClassifier</span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># importing scaler</span></span>
<span id="cb5-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.preprocessing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StandardScaler</span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># metrics are used to find accuracy or error</span></span>
<span id="cb5-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.metrics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> accuracy_score </span>
<span id="cb5-13"></span>
<span id="cb5-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loading the iris plants dataset (classification)</span></span>
<span id="cb5-15">iris <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datasets.load_iris()</span>
<span id="cb5-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dividing the datasets into two parts i.e. training datasets and test datasets</span></span>
<span id="cb5-17">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> iris.data[:, [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]]</span>
<span id="cb5-18">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> iris.target</span>
<span id="cb5-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># i.e. 70 % training dataset and 30 % test datasets</span></span>
<span id="cb5-20">X_train, X_test, y_train, y_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_test_split(X, y, test_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.20</span>, random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb5-21"></span>
<span id="cb5-22"></span>
<span id="cb5-23">scaler <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StandardScaler()</span>
<span id="cb5-24">x_train <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> scaler.fit_transform(X_train)</span>
<span id="cb5-25">x_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> scaler.transform(X_test)</span>
<span id="cb5-26"></span>
<span id="cb5-27">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RandomForestClassifier()</span>
<span id="cb5-28">model.fit(x_train, y_train)</span>
<span id="cb5-29">y_pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.predict(x_test)</span>
<span id="cb5-30"></span>
<span id="cb5-31"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> pred, label <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(y_pred, y_test):</span>
<span id="cb5-32">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prediction: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">. Label: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(pred, label))</span>
<span id="cb5-33"></span>
<span id="cb5-34"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Accuracy: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> accuracy_score(y_test, y_pred))</span></code></pre></div>
</div>
</section>
<section id="t√¨m-base-image-tr√™n-docker-hub" class="level2">
<h2 class="anchored" data-anchor-id="t√¨m-base-image-tr√™n-docker-hub">T√¨m Base Image tr√™n Docker Hub</h2>
<p>Ch√∫ng ta c√≥ th·ªÉ t√¨m c√°c class cha ~ base image tr√™n <code>hub.docker.com</code>, ch√∫ng ta mu·ªën app ml n√†y ch·∫°y tr√™n <code>ubuntu</code>, do ƒë√≥ c√≥ th·ªÉ start t·ª´ image <code>ubuntu</code>.</p>
<p>M√¨nh x√¢y d·ª±ng <code>Dockerfile</code> m·ªôt c√°ch ƒë∆°n gi·∫£n nh∆∞ sau:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Dockerfile</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="Dockerfile" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">FROM</span> ubuntu</span></code></pre></div>
</div>
<p>T·ª´ Dockerfile n√†y m√¨nh c√≥ th·ªÉ build image th√¥ng qua command sau:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">docker</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-t</span> ml_project .</span></code></pre></div>
<p>Run m·ªôt docker container (container v·ª´a run s·∫Ω l·∫≠p t·ª©c exit):</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">docker</span> run image_name container_name</span></code></pre></div>
<p>N·∫øu mu·ªën ‚Äúchui‚Äù v√†o b√™n trong container:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">docker</span> run <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-it</span> image_name container_name bash</span></code></pre></div>
<p><code>-it</code> nghƒ©a l√† ch√∫ng ta ch·∫°y container d∆∞·ªõi <strong>interactive</strong> mode, <code>bash</code> nghƒ©a l√† ch·∫°y trong <strong>bash</strong> mode, ch√∫ng ta c√≥ th·ªÉ th·ª±c hi·ªán c√°c c√¢u l·ªánh bash t·ª´ ƒë√¢y.</p>
</section>
<section id="c√†i-ƒë·∫∑t-c√°c-th∆∞-vi·ªán-trong-docker-image" class="level2">
<h2 class="anchored" data-anchor-id="c√†i-ƒë·∫∑t-c√°c-th∆∞-vi·ªán-trong-docker-image">C√†i ƒë·∫∑t c√°c th∆∞ vi·ªán trong Docker Image</h2>
<p>B√¢y gi·ªù ta m·ªõi ch·ªâ c√≥ duy nh·∫•t h·ªá ƒëi·ªÅu h√†nh ubuntu trong container, ch∆∞a c√≥ python ƒë·ªÉ ch·∫°y ·ª©ng d·ª•ng. Trong ubuntu, ta d√πng <code>apt-get</code> ƒë·ªÉ c√†i ƒë·∫∑t python. Ch√∫ng ta s·∫Ω th·ª±c hi·ªán c√°c l·ªánh tr√™n bash ·ªü container hi·ªán t·∫°i tr∆∞·ªõc, sau ƒë√≥ m·ªõi ƒë∆∞a v√†o Dockerfile v·ªõi l·ªánh <code>RUN</code>. D∆∞·ªõi ƒë√¢y l√† Dockerfile c·∫≠p nh·∫≠t:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Dockerfile</strong></pre>
</div>
<div class="sourceCode" id="cb10" data-filename="Dockerfile" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">FROM</span> ubuntu</span>
<span id="cb10-2"></span>
<span id="cb10-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">RUN</span> apt-get update</span>
<span id="cb10-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">RUN</span> apt-get <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> install python3</span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -y t·ª± ƒë·ªông ƒëi·ªÅn yes khi c√≥ c√°c c√¢u h·ªèi Y/N</span></span></code></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>S·ª≠ d·ª•ng exit() ho·∫∑c Ctrl-D ƒë·ªÉ tho√°t Python mode ho·∫∑c Container trong Powershell.</p>
</div>
</div>
<p>Ch√∫ng l·∫°i truy c·∫≠p bash c·ªßa container ƒëang ch·∫°y t·ª´ Docker desktop ho·∫∑c Powershell:</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="1">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lktuan.github.io/blog/2024-06-24-docker/bash_inside_container.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Bash inside container</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="copy-d·ªØ-li·ªáu-t·ª´-host-v√†o-docker-image" class="level2">
<h2 class="anchored" data-anchor-id="copy-d·ªØ-li·ªáu-t·ª´-host-v√†o-docker-image">Copy d·ªØ li·ªáu t·ª´ host v√†o Docker Image</h2>
<p>B√¢y gi·ªù ch√∫ng ta mu·ªën r·∫±ng sau khi v√†o container, ch√∫ng ta kh√¥ng ·ªü th∆∞ m·ª•c <code>root</code> n·ªØa m√† ·ªü <code>src</code> ~ ·ª©ng ch√∫ng c·ªßa ch√∫ng ta, v·ªõi m·ª•c ƒë√≠ch d·ªÖ l√†m vi·ªác h∆°n. Ch√∫ng ta th√™m c√∫ ph√°p <code>WORKDIR /src</code>. ƒê·ªìng th·ªùi c≈©ng c·∫ßn c√†i ƒë·∫∑t <code>sklearn</code> ƒë·ªÉ ·ª©ng d·ª•ng c√≥ th·ªÉ ch·∫°y. ƒê·ªìng th·ªùi, sau khi t·∫•t c·∫£ ƒë∆∞·ª£c c√†i ƒë·∫∑t, m√¨nh c≈©ng mu·ªën ch·∫°y lu√¥n ·ª©ng d·ª•ng, s·ª≠ d·ª•ng <code>CMD</code>.</p>
<p>C·∫≠p nh·∫≠t Dockerfile nh∆∞ sau:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Dockerfile</strong></pre>
</div>
<div class="sourceCode" id="cb11" data-filename="Dockerfile" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">FROM</span> ubuntu</span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">WORKDIR</span> /src</span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Khi ·ªü trong docker container, m·∫∑c ƒë·ªãnh ch√∫ng ta s·∫Ω ·ªü root, gi·ªù ta mu·ªën khi v√†o container, ch√∫ng ta s·∫Ω v√†o /src</span></span>
<span id="cb11-5"></span>
<span id="cb11-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">RUN</span> apt-get update</span>
<span id="cb11-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">RUN</span> apt-get <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> install python3</span>
<span id="cb11-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">RUN</span> apt-get <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> install python3-sklearn</span>
<span id="cb11-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -y t·ª± ƒë·ªông ƒëi·ªÅn yes khi c√≥ c√°c c√¢u h·ªèi Y/N</span></span>
<span id="cb11-10"></span>
<span id="cb11-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">COPY</span> iris_classification.py ./iris_classification.py </span>
<span id="cb11-12"></span>
<span id="cb11-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">CMD</span> [ <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"python3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iris_classification.py"</span> ]</span></code></pre></div>
</div>
</section>
</section>
<section id="end" class="level1">
<h1>End</h1>
<p>Sau khi ho√†n thi·ªán, m√¨nh kh√¥ng c·∫ßn ch·∫°y containter ·ªü interactive mode v√† t∆∞∆°ng t√°c b·∫±ng bash n·ªØa. L·ªánh run c√≥ th·ªÉ vi·∫øt g·ªçn nh∆∞ sau:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">docker</span> run ml_project</span></code></pre></div>
<p>B√†i th·ª±c h√†nh ƒë·∫øn ƒë√¢y k·∫øt th√∫c üéâ.</p>


<!-- -->

</section>

 ]]></description>
  <category>docker</category>
  <category>python</category>
  <guid>https://lktuan.github.io/blog/2024-06-24-docker/</guid>
  <pubDate>Sun, 23 Jun 2024 17:00:00 GMT</pubDate>
  <media:content url="https://lktuan.github.io/blog/2024-06-24-docker/docker.png" medium="image" type="image/png" height="76" width="144"/>
</item>
</channel>
</rss>
